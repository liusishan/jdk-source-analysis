<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.15">
<meta name="keywords" content="Java,JDK,Java source,Collection,ArrayList,Map,List,HashMap,ArrayDeque,Deque,Set,HashSet,LinkedList,Queue,TreeMap,TreeSet,Vector,Stack">
<meta name="author" content="D瓜哥">
<meta name="copyright" content="Apache-2.0">
<title>JDK 源码分析</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="assets/css/asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="assets/css/rouge-monokai.css">
<style>p>code{color: #d14 !important;background-color: #f5f5f5 !important;border: 1px solid #e1e1e8;white-space: nowrap;border-radius: 3px;}</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>JDK 源码分析</h1>
<div class="details">
<span id="author" class="author">D瓜哥</span><br>
<span id="email" class="email"><a href="https://www.diguage.com" class="bare">https://www.diguage.com</a></span><br>
<span id="revdate">2021-07-18</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_前言jdk_stl_源码分析计划">前言：JDK &amp; STL 源码分析计划</a></li>
<li><a href="#_集合类概述">1. 集合类概述</a></li>
<li><a href="#_迭代器_iterator_enumeration_spliterator_与_iterable">2. 迭代器 Iterator、 Enumeration、 Spliterator 与 Iterable</a></li>
<li><a href="#_collection">3. Collection</a></li>
<li><a href="#_abstractcollection">4. AbstractCollection</a></li>
<li><a href="#_list">5. List</a></li>
<li><a href="#_abstractlist">6. AbstractList</a></li>
<li><a href="#_abstractsequentiallist">7. AbstractSequentialList</a></li>
<li><a href="#_arraylist">8. <code>ArrayList</code></a></li>
<li><a href="#_linkedlist">9. LinkedList</a></li>
<li><a href="#_stack">10. Stack</a></li>
<li><a href="#_vector">11. Vector</a></li>
<li><a href="#_set">12. Set</a></li>
<li><a href="#_abstractset">13. AbstractSet</a></li>
<li><a href="#_sortedset">14. SortedSet</a></li>
<li><a href="#_navigableset">15. NavigableSet</a></li>
<li><a href="#_hashset">16. HashSet</a></li>
<li><a href="#_treeset">17. TreeSet</a></li>
<li><a href="#_linkedhashset">18. LinkedHashSet</a></li>
<li><a href="#_bitset">19. BitSet</a></li>
<li><a href="#_enumset">20. EnumSet</a></li>
<li><a href="#_map">21. Map</a></li>
<li><a href="#_sortedmap">22. SortedMap</a></li>
<li><a href="#_navigablemap">23. NavigableMap</a></li>
<li><a href="#_abstractmap">24. AbstractMap</a></li>
<li><a href="#_hashmap">25. HashMap</a></li>
<li><a href="#_treemap">26. TreeMap</a></li>
<li><a href="#_linkedhashmap">27. LinkedHashMap</a></li>
<li><a href="#_dictionary">28. Dictionary</a></li>
<li><a href="#_hashtable">29. Hashtable</a></li>
<li><a href="#_enummap">30. EnumMap</a></li>
<li><a href="#_weakhashmap">31. WeakHashMap</a></li>
<li><a href="#_identityhashmap">32. IdentityHashMap</a></li>
<li><a href="#_queue">33. Queue</a></li>
<li><a href="#_deque">34. Deque</a></li>
<li><a href="#_abstractqueue">35. AbstractQueue</a></li>
<li><a href="#_arraydeque">36. ArrayDeque</a></li>
<li><a href="#_priorityqueue">37. PriorityQueue</a></li>
<li><a href="#_工具类_arrays">38. 工具类 <code>Arrays</code></a></li>
<li><a href="#_工具类_collections">39. 工具类 <code>Collections</code></a></li>
<li><a href="#_并发库概述">40. 并发库概述</a></li>
<li><a href="#_thread">41. Thread</a></li>
<li><a href="#_locksupport">42. LockSupport</a></li>
<li><a href="#_abstractqueuedsynchronizer">43. AbstractQueuedSynchronizer</a></li>
<li><a href="#_reentrantlock">44. ReentrantLock</a></li>
<li><a href="#_reentrantreadwritelock">45. ReentrantReadWriteLock</a></li>
<li><a href="#_stampedlock">46. StampedLock</a></li>
<li><a href="#_semaphore">47. Semaphore</a></li>
<li><a href="#_countdownlatch">48. CountDownLatch</a></li>
<li><a href="#_cyclicbarrier">49. CyclicBarrier</a></li>
<li><a href="#_phaser">50. Phaser</a></li>
<li><a href="#_exchanger">51. Exchanger</a></li>
<li><a href="#_threadlocal">52. ThreadLocal</a></li>
<li><a href="#_atomicinteger">53. AtomicInteger</a></li>
<li><a href="#_longadder">54. LongAdder</a></li>
<li><a href="#_juc_包基础类分析">55. JUC 包基础类分析</a></li>
<li><a href="#_futuretask">56. FutureTask</a></li>
<li><a href="#_completablefuture">57. CompletableFuture</a></li>
<li><a href="#_threadpoolexecutor_源码分析">58. ThreadPoolExecutor 源码分析</a></li>
<li><a href="#_forkjointask">59. ForkJoinTask</a></li>
<li><a href="#_forkjoinpool">60. ForkJoinPool</a></li>
<li><a href="#_concurrenthashmap">61. <code>ConcurrentHashMap</code></a></li>
<li><a href="#_concurrentskiplistmap">62. <code>ConcurrentSkipListMap</code></a></li>
<li><a href="#_copyonwritearraylist">63. CopyOnWriteArrayList</a></li>
<li><a href="#_concurrentlinkedqueue">64. ConcurrentLinkedQueue</a></li>
<li><a href="#_arrayblockingqueue">65. ArrayBlockingQueue</a></li>
<li><a href="#_linkedblockingqueue">66. LinkedBlockingQueue</a></li>
<li><a href="#_priorityblockingqueue">67. PriorityBlockingQueue</a></li>
<li><a href="#_delayqueue">68. DelayQueue</a></li>
<li><a href="#_scheduledthreadpoolexecutor">69. <code>ScheduledThreadPoolExecutor</code></a></li>
<li><a href="#_classloader">70. ClassLoader</a></li>
<li><a href="#_field">71. Field</a></li>
<li><a href="#_proxy">72. Proxy</a></li>
<li><a href="#_serversocket">73. ServerSocket</a></li>
<li><a href="#_serviceloader">74. <code>ServiceLoader</code></a></li>
<li><a href="#_string">75. <code>String</code></a></li>
<li><a href="#_date">76. <code>Date</code></a></li>
<li><a href="#_serializable">77. <code>Serializable</code></a></li>
<li><a href="#_netty">78. Netty</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_前言jdk_stl_源码分析计划"><a class="anchor" href="#_前言jdk_stl_源码分析计划"></a>前言：JDK &amp; STL 源码分析计划</h2>
<div class="sectionbody">
<div class="paragraph">
<p>为了学好数据结构以及相关算法，同时也为了更好地理解 JDK 的底层实现，计划对 JDK 集合类的源码做一个系统的阅读分析。</p>
</div>
<div class="paragraph">
<p>欢迎随时提交 PR 或 Issue。建了一个 Gitter 聊天室，点击图标加入： <a href="https://gitter.im/source-analysis/community?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge"><span class="image"><img src="https://badges.gitter.im/source-analysis/community.svg" alt="community"></span></a>。</p>
</div>
<div class="paragraph">
<p>浏览请点击： <a href="https://diguage.github.io/jdk-source-analysis/">JDK 源码分析</a>。</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
本文档基于 <strong>OpenJDK 11.0.6 2020-01-14 LTS</strong> 的代码开展分析，请 PR 的小伙伴使用相同的 JDK。谢谢！
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_友情支持"><a class="anchor" href="#_友情支持"></a>友情支持</h3>
<div class="paragraph">
<p>如果您觉得这个笔记对您有所帮助，看在D瓜哥码字的辛苦上，请友情支持一下，D瓜哥感激不尽，😜</p>
</div>
<table class="tableblock frame-none grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="./images/alipay.png" alt="支付宝" width="95%" title="支付宝"></span></p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock"><span class="image"><img src="./images/wxpay.png" alt="微信" width="95%" title="微信"></span></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>有些打赏的朋友希望可以加个好友，欢迎关注D瓜哥的微信公众号，这样就可以通过公众号的回复直接给我发信息。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/wx-jike-log.png" alt="wx jike log" width="100%"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_官网及版本库"><a class="anchor" href="#_官网及版本库"></a>官网及版本库</h3>
<div class="paragraph">
<p>本文档的版本库托管在 Github 上，另外单独发布。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">“地瓜哥”博客网</dt>
<dd>
<p><a href="https://www.diguage.com/" class="bare" target="_blank" rel="noopener">https://www.diguage.com/</a> 。D瓜哥的个人博客。欢迎光临，不过，内容很杂乱，请见谅。不见谅，你来打我啊，😂😂</p>
</dd>
<dt class="hdlist1">本文档官网</dt>
<dd>
<p><a href="https://diguage.github.io/jdk-source-analysis/" class="bare" target="_blank" rel="noopener">https://diguage.github.io/jdk-source-analysis/</a> 。为了方便阅读，这里展示了处理好的文档。阅读请点击这个网址。</p>
</dd>
<dt class="hdlist1">本文档版本库</dt>
<dd>
<p><a href="https://github.com/diguage/jdk-source-analysis" class="bare" target="_blank" rel="noopener">https://github.com/diguage/jdk-source-analysis</a> 。欢迎大家发送 PR。</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_总体思路"><a class="anchor" href="#_总体思路"></a>总体思路</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>学习基本的数据结构认识。兵马未动粮草先行。先把基础理论搞清楚。</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>学Java的，可以从下面两本书中选一本：</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><a href="https://book.douban.com/subject/26745780/">数据结构与算法分析</a>&#8201;&#8212;&#8201;这本书的优点在于和 Java JDK 的集合类很贴近。</p>
</li>
<li>
<p><a href="https://book.douban.com/subject/19952400/">算法（第4版）</a>&#8201;&#8212;&#8201;这本书胜在图很多。</p>
</li>
</ol>
</div>
</li>
<li>
<p>学 C/C++ 的，可以看下面这套书：</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><a href="https://book.douban.com/subject/4065258/">算法：C语言实现 (第1～4部分)</a></p>
</li>
<li>
<p><a href="https://book.douban.com/subject/4191525/">算法：C语言实现 （第5部分）</a></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>自己实现一遍基本的数据结构；</p>
</li>
<li>
<p>阅读 JDK 或 STL 源码，做学习笔记。</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
对比一下自己的实现和这些经典代码的实现，总结自己差距，提高自己的编码能力。
</td>
</tr>
</table>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="https://book.douban.com/subject/1110934/">STL源码剖析 </a>&#8201;&#8212;&#8201;阅读源码时，建议参考一下本书的内容。</p>
</li>
<li>
<p>建议把网上的源码分析笔记都看一看，取长补短，补充自己的分析。</p>
</li>
<li>
<p>建议把网上相关面试题也看一看，检验自己的学习成果。</p>
</li>
</ol>
</div>
</li>
<li>
<p>相关联的 LeetCode 上的题都刷掉。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>还有两个想法：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>可以把 Redis 的实现也过一下，Redis 实现也有很多不错的思路。毕竟 Redis 是目前最常用的缓存解决方案。</p>
</li>
<li>
<p>Java 中有很多针对集合类做扩展的库，可以一并学了，这样就能更清楚了解 Java JDK 实现的不足，开阔自己的眼界：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="https://github.com/google/guava">google/guava: Google core libraries for Java</a></p>
</li>
<li>
<p><a href="https://commons.apache.org/proper/commons-collections/">Apache Commons Collections</a></p>
</li>
<li>
<p><a href="https://www.eclipse.org/collections/">Eclipse Collections - Features you want with the collections you need.</a></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_jdk_集合类"><a class="anchor" href="#_jdk_集合类"></a>JDK 集合类</h3>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Base + Iterator</strong></dt>
<dd>
<p>代码总行数： 103 + 135 + 302 + 195 + 838 + 127 + 734 + 480 = 2914 行，预计 5 个小时。</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.lang.Iterable</code></p>
</li>
<li>
<p><code>java.util.Iterator</code></p>
</li>
<li>
<p><code>java.util.PrimitiveIterator</code></p>
</li>
<li>
<p><code>java.util.ListIterator</code></p>
</li>
<li>
<p><code>java.util.Spliterator</code></p>
</li>
<li>
<p><code>java.util.Enumeration</code></p>
</li>
<li>
<p><code>java.util.Collection</code></p>
</li>
<li>
<p><code>java.util.AbstractCollection</code></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><strong>List</strong></dt>
<dd>
<p>代码总行数： 1063 + 942 + 253 + 1266 + 1509 + 141 + 1759 = 6933 行，预计 12 个小时。</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.List</code></p>
</li>
<li>
<p><code>java.util.AbstractList</code></p>
</li>
<li>
<p><code>java.util.AbstractSequentialList</code></p>
</li>
<li>
<p><code>java.util.LinkedList</code></p>
</li>
<li>
<p><code>java.util.Vector</code></p>
</li>
<li>
<p><code>java.util.Stack</code></p>
</li>
<li>
<p><code>java.util.ArrayList</code></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><strong>Queue</strong></dt>
<dd>
<p>代码总行数： 212 + 616 + 192 + 1233 + 987 = 3240 行，预计 6 个小时。</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Queue</code></p>
</li>
<li>
<p><code>java.util.Deque</code></p>
</li>
<li>
<p><code>java.util.AbstractQueue</code></p>
</li>
<li>
<p><code>java.util.ArrayDeque</code></p>
</li>
<li>
<p><code>java.util.PriorityQueue</code></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><strong>Set</strong></dt>
<dd>
<p>代码总行数： 732 + 186 + 264 + 491 + 323 + 361 + 560 + 195 + 1395 = 4507 行，预计 8 个小时。</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Set</code></p>
</li>
<li>
<p><code>java.util.AbstractSet</code></p>
</li>
<li>
<p><code>java.util.SortedSet</code></p>
</li>
<li>
<p><code>java.util.EnumSet</code></p>
</li>
<li>
<p><code>java.util.NavigableSet</code></p>
</li>
<li>
<p><code>java.util.HashSet</code></p>
</li>
<li>
<p><code>java.util.TreeSet</code></p>
</li>
<li>
<p><code>java.util.LinkedHashSet</code></p>
</li>
<li>
<p><code>java.util.BitSet</code></p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/java.util.Collection.png" alt="java.util.Collection">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Map</strong></dt>
<dd>
<p>代码总行数： 1687 + 284 + 424 + 857 + 3012 + 1339 + 812 + 1600 + 756 + 2444 + 155 + 1521 = 14891 行，预计 28 个小时。</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Map</code></p>
</li>
<li>
<p><code>java.util.SortedMap</code></p>
</li>
<li>
<p><code>java.util.NavigableMap</code></p>
</li>
<li>
<p><code>java.util.AbstractMap</code></p>
</li>
<li>
<p><code>java.util.TreeMap</code></p>
</li>
<li>
<p><code>java.util.WeakHashMap</code></p>
</li>
<li>
<p><code>java.util.EnumMap</code></p>
</li>
<li>
<p><code>java.util.IdentityHashMap</code></p>
</li>
<li>
<p><code>java.util.LinkedHashMap</code></p>
</li>
<li>
<p><code>java.util.HashMap</code></p>
</li>
<li>
<p><code>java.util.Dictionary</code></p>
</li>
<li>
<p><code>java.util.Hashtable</code></p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/java.util.Map.png" alt="java.util.Map">
</div>
</div>
<div class="paragraph">
<p>来张总体结构图：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/jdk-collection-classes.png" alt="jdk collection classes">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
这里没有包含并发相关的集合类。这块内容放到并发中一起搞。
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_集合类概述"><a class="anchor" href="#_集合类概述"></a>1. 集合类概述</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/java-collections-overview.png" alt="java collections overview">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_迭代器_iterator_enumeration_spliterator_与_iterable"><a class="anchor" href="#_迭代器_iterator_enumeration_spliterator_与_iterable"></a>2. 迭代器 Iterator、 Enumeration、 Spliterator 与 Iterable</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_涉及代码"><a class="anchor" href="#_涉及代码"></a>2.1. 涉及代码</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>java.util.Iterator</code></p>
</li>
<li>
<p><code>java.util.PrimitiveIterator</code></p>
</li>
<li>
<p><code>java.util.ListIterator</code></p>
</li>
<li>
<p><code>java.util.Spliterator</code></p>
</li>
<li>
<p><code>java.util.Enumeration</code></p>
</li>
<li>
<p><code>java.lang.Iterable</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_迭代器模式"><a class="anchor" href="#_迭代器模式"></a>2.2. 迭代器模式</h3>
<div class="paragraph">
<p>在进行代码分析之前，D瓜哥想先来讲解一下设计模式。然后结合 Java 中 <code>Iterator</code> 和 <code>Iteratable</code> ，具体分析一下迭代器在 Java 中的实现。</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="dlist">
<dl>
<dt class="hdlist1">迭代器模式（Iterator）</dt>
<dd>
<p>提供一种方法顺序访问一个聚合对象中各个元素，而不是暴露该对象的内部表示。</p>
</dd>
</dl>
</div>
</blockquote>
<div class="attribution">
&#8212; Erich Gamma、Richard Helm、Ralph Johnson、John Vlissides<br>
<cite>《设计模式》</cite>
</div>
</div>
<div class="paragraph">
<p>类图如下：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-8180ed1bc3655ed46a87e816db6f888d.svg" alt="Diagram" width="90%" height="486">
</div>
</div>
<div class="paragraph">
<p>当需要访问一个聚集对象，而且不管这些对象是什么都需要遍历的时候，就应该考虑用迭代器模式。</p>
</div>
<div class="paragraph">
<p>当需要对聚集有多种方式遍历时，可以考虑用迭代器模式。</p>
</div>
<div class="paragraph">
<p>为遍历不同的聚集结构提供如开始、下一个、是否结束、当前哪一项等统一的接口。</p>
</div>
<div class="paragraph">
<p>尽管我们不需要显式的引用迭代器，但系统本身还是通过迭代器来实现遍历的。总地来说，迭代器（<code>Iterator</code>）模式就是分离了集合对象的遍历行为，抽象出一个迭代器类来负责，这样既可以做到不暴露集合的内部结构，又可让外部代码透明地访问集合内部的数据。</p>
</div>
<div class="paragraph">
<p>请问： Java 中是如何应用迭代器模式呢？</p>
</div>
</div>
<div class="sect2">
<h3 id="_iterator"><a class="anchor" href="#_iterator"></a>2.3. <code>Iterator</code></h3>
<div class="paragraph">
<p>从上面的设计模式可以看出，迭代器模式就是为了遍历不同的聚集结构提供诸如开始、下一个、是否结束、当前元素等常见操作的统一接口。来看看 Java 集合类是如何提炼接口的。</p>
</div>
<div class="listingblock">
<div class="title">java.util.Iterator</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">();</span>

    <span class="no">E</span> <span class="nf">next</span><span class="o">();</span>

    <span class="k">default</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">UnsupportedOperationException</span><span class="o">(</span><span class="s">"remove"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">hasNext</span><span class="o">())</span>
            <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">next</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从上述代码中，可以看出 Java 提取了 <code>boolean hasNext()</code>、 <code>E next()</code>、 <code>void remove()</code> 等三个操作方法；在 Java 8 中，为了支持 Stream API，有增加了 <code>void forEachRemaining(Consumer&lt;? super E&gt; action)</code> 方法。</p>
</div>
<div class="paragraph">
<p>这里多扯一句，Java 在 1.2 以前迭代器是通过另外一个接口实现的：</p>
</div>
<div class="listingblock">
<div class="title">java.util.Enumeration</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Enumeration</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="nf">hasMoreElements</span><span class="o">();</span>

    <span class="no">E</span> <span class="nf">nextElement</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>与上面的 <code>java.util.Iterator</code> 对比可以看出，两者差别不大。那为什么 Java 在已有 <code>java.util.Iterator</code> 接口的情况下，还要推出 <code>java.util.Enumeration</code> 接口呢？在 <code>java.util.Iterator</code> 接口的 JavaDoc 中给出了如下理由：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Iterators allow the caller to remove elements from the underlying collection during the iteration with well-defined semantics.</p>
</li>
<li>
<p>Method names have been improved.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>我们都知道，在 Java 8 之前，接口中的方法不能有任何实现。所以，为了保持兼容性，不能在已有接口中增加方法。只能另起炉灶，把“洞”补上。这也就不难理解，为什么又搞出了个 <code>java.util.Iterator</code>。</p>
</div>
<div class="paragraph">
<p>这里再多提一句，需要增加自定义的迭代器实现时，请优先选择 <code>java.util.Iterator</code>。</p>
</div>
<div class="paragraph">
<p>请问：既然有迭代器接口定义了，那么 Java 又是如何生成迭代器实例呢？</p>
</div>
</div>
<div class="sect2">
<h3 id="_iterable"><a class="anchor" href="#_iterable"></a>2.4. <code>Iterable</code></h3>
<div class="paragraph">
<p>既然迭代器可以抽象成一个公共的接口，那么生成迭代器实例的这个操作，也可以抽象成一个接口。 Java 也确实是这样做的：</p>
</div>
<div class="listingblock">
<div class="title">java.lang.Iterable</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">();</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">T</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="no">T</span> <span class="n">t</span> <span class="o">:</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Spliterators</span><span class="o">.</span><span class="na">spliteratorUnknownSize</span><span class="o">(</span><span class="n">iterator</span><span class="o">(),</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从类的定义中，可以看到 <code>java.lang.Iterable</code> 提供了 <code>iterator()</code>，用于创建 <code>java.util.Iterator</code> 示例对象。</p>
</div>
<div class="paragraph">
<p>在 Java 8 中，为了支持 Lambda 表达式和 Stream API，又增加了 <code>forEach(Consumer&lt;? super T&gt; action)</code> 和 <code>spliterator()</code> 方法。</p>
</div>
<div class="paragraph">
<p>在思考实现原理的过程中，D瓜哥突然想到，<code>java.lang.Iterable</code> 就是一个工厂方法模式的应用。来分析一下：</p>
</div>
</div>
<div class="sect2">
<h3 id="_工厂方法模式"><a class="anchor" href="#_工厂方法模式"></a>2.5. 工厂方法模式</h3>
<div class="paragraph">
<p>先来看看工厂方法模式的定义：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="dlist">
<dl>
<dt class="hdlist1">工厂方法模式（Factory Method）</dt>
<dd>
<p>定义一个用于创建对象的接口，让子类决定实例化哪一个类。工厂方法使一个类的实例化延迟到其子类。</p>
</dd>
</dl>
</div>
</blockquote>
<div class="attribution">
&#8212; Erich Gamma、Richard Helm、Ralph Johnson、John Vlissides<br>
<cite>《设计模式》</cite>
</div>
</div>
<div class="paragraph">
<p>类图如下：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-db0e11d8a820919577b56d18fe8bc790.svg" alt="Diagram" width="90%" height="375">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.lang.Iterable</code> 就相当于 <code>Factory</code> 接口，也就是工厂；</p>
</li>
<li>
<p><code>java.util.Iterator</code> 就相当于工厂生成的产品 <code>Product</code>；</p>
</li>
<li>
<p><code>iterator()</code> 方法就是工厂方法 <code>factoryMethod()</code>；</p>
</li>
<li>
<p><code>java.lang.Iterable</code> 和 <code>java.util.Iterator</code> 子类，都放在了各个集合类中来具体实现。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在各个聚集类中，去实现 <code>java.lang.Iterable</code> 接口，然后根据聚集类的情况，返回对应的 <code>java.util.Iterator</code> 具体类对象即可。</p>
</div>
<div class="paragraph">
<p>细心的童鞋，可能发现还有个类似迭代器的类 <code>Spliterator</code>。这是个什么类？为啥要增加相关的接口呢？</p>
</div>
</div>
<div class="sect2">
<h3 id="_spliterator"><a class="anchor" href="#_spliterator"></a>2.6. <code>Spliterator</code></h3>

</div>
<div class="sect2">
<h3 id="ListIterator"><a class="anchor" href="#ListIterator"></a>2.7. <code>ListIterator</code></h3>
<div class="paragraph">
<p><code>java.util.Iterator</code> 是针对整个集合类抽象出来的通用迭代器。但是，可以思考一下，对于 <code>java.util.List</code> 是不是可以有更契合的迭代器？</p>
</div>
<div class="paragraph">
<p>关于这个问题的答案，JDK 给出了自己的答案：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// Query Operations</span>

    <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">();</span>

    <span class="no">E</span> <span class="nf">next</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="nf">hasPrevious</span><span class="o">();</span>

    <span class="no">E</span> <span class="nf">previous</span><span class="o">();</span>

    <span class="kt">int</span> <span class="nf">nextIndex</span><span class="o">();</span>

    <span class="kt">int</span> <span class="nf">previousIndex</span><span class="o">();</span>


    <span class="c1">// Modification Operations</span>

    <span class="kt">void</span> <span class="nf">remove</span><span class="o">();</span>

    <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>由于 <code>List</code> 是有序的，从代码中可以看出，所以，<code>ListIterator</code> 在 <code>Iterator</code> 基础之上，增加了获前后元素相关的方法；同时，还增加了修改相关的操作方法。</p>
</div>
<div class="paragraph">
<p>因为增加了 <code>hasPrevious()</code> 和 <code>previous()</code>，那么 <code>ListIterator</code> 就有了双向遍历的能力：既可以像传统迭代器那样，从前向后遍历；又可以逆向，从后想前遍历。这样在某些场景下就会特别方便。</p>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料"><a class="anchor" href="#_参考资料"></a>2.8. 参考资料</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.journaldev.com/13457/java-listiterator">Java ListIterator - ListIterator in Java - JournalDev</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_collection"><a class="anchor" href="#_collection"></a>3. Collection</h2>
<div class="sectionbody">
<div class="paragraph">
<p>有一个问题，我们思考一下：如果让你设计 JDK 集合框架，你会怎么设计？说的更具体一些，现在需要一个可以包含重复对象的 <code>Aggregation</code> 集合，请问怎么设计？</p>
</div>
<div class="paragraph">
<p>可以先设想一下，有哪些操作？</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>添加元素 <code>add()</code></p>
</li>
<li>
<p>删除元素 <code>remove()</code></p>
</li>
<li>
<p>是否包含元素 <code>boolean contain(Element e)</code></p>
</li>
<li>
<p>列表大小 <code>int size()</code></p>
</li>
<li>
<p>添加整个 <code>Bag</code> 元素 <code>addAll(Aggregation aggregation)</code></p>
</li>
<li>
<p>清空 <code>clear()</code></p>
</li>
<li>
<p>迭代器 <code>Iterator&lt;T&gt; iterator()</code></p>
</li>
<li>
<p>和数组互操作： <code>toArray()</code> 和 <code>addAll(T[] array)</code></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="title">java.util.Collection</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// Query Operations</span>

    <span class="kt">int</span> <span class="nf">size</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">);</span>

    <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">();</span>

    <span class="nc">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">();</span>

    <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">(</span><span class="no">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">);</span>

    <span class="c1">// Modification Operations</span>

    <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">);</span>


    <span class="c1">// Bulk Operations</span>

    <span class="kt">boolean</span> <span class="nf">containsAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="nf">removeAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">);</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="kt">boolean</span> <span class="nf">removeIf</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">filter</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
        <span class="kt">boolean</span> <span class="n">removed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">each</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">each</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">filter</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">each</span><span class="o">.</span><span class="na">next</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">each</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                <span class="n">removed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">removed</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kt">boolean</span> <span class="nf">retainAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">clear</span><span class="o">();</span>


    <span class="c1">// Comparison and hashing</span>

    <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">);</span>

    <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">();</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="nd">@Override</span>
    <span class="k">default</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Spliterators</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="nc">Stream</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">stream</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">spliterator</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * @since 1.8
     */</span>
    <span class="k">default</span> <span class="nc">Stream</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">parallelStream</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">StreamSupport</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">spliterator</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_abstractcollection"><a class="anchor" href="#_abstractcollection"></a>4. AbstractCollection</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_list"><a class="anchor" href="#_list"></a>5. List</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_abstractlist"><a class="anchor" href="#_abstractlist"></a>6. AbstractList</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_abstractsequentiallist"><a class="anchor" href="#_abstractsequentiallist"></a>7. AbstractSequentialList</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_类图"><a class="anchor" href="#_类图"></a>7.1. 类图</h3>
<div class="paragraph">
<p>先来看一下 <code>AbstractSequentialList</code> 的类图：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-736a0aa84d33ab4e8b57504bb28e1f96.svg" alt="Diagram" width="90%" height="524">
</div>
</div>
<div class="paragraph">
<p><code>AbstractSequentialList</code> 是 <a href="#"><code>java.util.LinkedList</code></a> 的父类，主要是基于 <a href="#ListIterator"><code>java.util.ListIterator</code></a> 实现了</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>get(int index)</code></p>
</li>
<li>
<p><code>set(int index, E element)</code></p>
</li>
<li>
<p><code>add(int index, E element)</code></p>
</li>
<li>
<p><code>remove(int index)</code></p>
</li>
<li>
<p><code>addAll(int index, Collection&lt;? extends E&gt; c)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>等与具体坐标相关的随机访问 List 的方法。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_arraylist"><a class="anchor" href="#_arraylist"></a>8. <code>ArrayList</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>对于每种抽象数据类型并不存在什么法则来告诉我们必须要有哪些操作，这是一个设计决策。--《数据结构与算法分析》</p>
</div>
<div class="sect2">
<h3 id="_类图_2"><a class="anchor" href="#_类图_2"></a>8.1. 类图</h3>
<div class="paragraph">
<p>先来看一下 <code>ArrayList</code> 的类图：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-be1d6d3223223995b14d8c807827607d.svg" alt="Diagram" width="90%" height="504">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>支持泛型，继承了 <code>AbstractList</code>，实现了 <code>List</code> 接口。</p>
</li>
<li>
<p><code>RandomAccess</code> 用来表明其支持快速（通常是固定时间）随机访问。在 <code>Collections.binarySearch()</code> 方法中，它要判断传入的list 是否 <code>RamdomAccess</code> 的实例，如果是，调用 <code>Collections.indexedBinarySearch(list, key)</code> 方法，如果不是，那么调用 <code>Collections.iteratorBinarySearch(list, key)</code> 方法。</p>
</li>
<li>
<p><code>Cloneable</code> 可以调用 <code>Object.clone()</code> 方法返回该对象的浅拷贝。</p>
</li>
<li>
<p><code>Serializable</code> 此类可被序列化</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>为什么还要再次实现 <code>List</code> 接口？（其父类已经实现此接口部分方法： <code>AbstractList</code> 实现 <code>List</code> 接口中除 <code>size()</code> , <code>get(int index)</code> 之外的所有函数）。</p>
</div>
</div>
</div>
<div class="paragraph">
<p><strong>抽象类实现接口，可以不真正实现所有方法（可以抽象实现）。</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_初始化"><a class="anchor" href="#_初始化"></a>8.2. 初始化</h3>
<div class="paragraph">
<p>首先，我们看一下 <code>ArrayList</code> 的初始化：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
</pre></td><td class="code"><pre><span class="cm">/**
 * Default initial capacity.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_CAPACITY</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

<span class="cm">/**
 * Shared empty array instance used for empty instances.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="no">EMPTY_ELEMENTDATA</span> <span class="o">=</span> <span class="o">{};</span>

<span class="cm">/**
 * Shared empty array instance used for default sized empty instances. We
 * distinguish this from EMPTY_ELEMENTDATA to know how much to inflate when
 * first element is added.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="no">DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span> <span class="o">=</span> <span class="o">{};</span>

<span class="cm">/**
 * The array buffer into which the elements of the ArrayList are stored.
 * The capacity of the ArrayList is the length of this array buffer. Any
 * empty ArrayList with elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA
 * will be expanded to DEFAULT_CAPACITY when the first element is added.
 */</span>
<span class="kd">transient</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span> <span class="c1">// non-private to simplify nested class access</span>

<span class="cm">/**
 * The size of the ArrayList (the number of elements it contains).
 *
 * @serial
 */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>

<span class="cm">/**
 * Constructs an empty list with the specified initial capacity.
 *
 * @param  initialCapacity  the initial capacity of the list
 * @throws IllegalArgumentException if the specified initial capacity
 *         is negative
 */</span>
<span class="kd">public</span> <span class="nf">ArrayList</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">initialCapacity</span><span class="o">];</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="no">EMPTY_ELEMENTDATA</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Illegal Capacity: "</span><span class="o">+</span>
                                           <span class="n">initialCapacity</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Constructs an empty list with an initial capacity of ten.
 */</span>
<span class="kd">public</span> <span class="nf">ArrayList</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="no">DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Constructs a list containing the elements of the specified
 * collection, in the order they are returned by the collection's
 * iterator.
 *
 * @param c the collection whose elements are to be placed into this list
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="nf">ArrayList</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">elementData</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">size</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// defend against c.toArray (incorrectly) not returning Object[]</span>
        <span class="c1">// (see e.g. https://bugs.openjdk.java.net/browse/JDK-6260652)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">elementData</span><span class="o">.</span><span class="na">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">)</span>
            <span class="n">elementData</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="c1">// replace with empty array.</span>
        <span class="k">this</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="no">EMPTY_ELEMENTDATA</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从上述代码中可以猜测，<strong><code>ArrayList</code> 内部使用数组来保存元素的，并且使用一个整型 <code>int</code> 变量来保存长度。</strong></p>
</div>
<div class="paragraph">
<p><code>ArrayList</code> 初始化工作分三种情况：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>无参构造函数初始化时，直接将内部数组初始化为 <code>DEFAULTCAPACITY_EMPTY_ELEMENTDATA</code>。在第一次添加元素时，再初始化为默认容量是 <code>10</code> 的数组。</p>
</li>
<li>
<p>指定容量大小进行初始化时，容量大于 <code>0</code> 则初始化为指定容量的数组；如果等于 <code>0</code> 则初始化为默认空数组 <code>EMPTY_ELEMENTDATA</code>。否则抛出异常。</p>
</li>
<li>
<p>如果使用 <code>Collection</code> 实例来初始化，不为空则将调用 <code>toArray()</code> 方法来初始化 <code>elementData</code>；如果为空则初始化为默认空数组 <code>EMPTY_ELEMENTDATA</code>。</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_添加元素"><a class="anchor" href="#_添加元素"></a>8.3. 添加元素</h3>
<div class="paragraph">
<p>在进行正常测试前，先展示一下"透视" <code>ArrayList</code> 的工具类：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-03 11:10
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayListBaseTest</span> <span class="o">{</span>
    <span class="cm">/**
     * 通过反射查看 {@link ArrayList} 的内部属性
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">xray</span><span class="o">(</span><span class="nc">ArrayList</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Field</span> <span class="n">elementData</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"elementData"</span><span class="o">);</span>
            <span class="n">elementData</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="nc">Object</span><span class="o">[]</span> <span class="n">objects</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Object</span><span class="o">[])</span> <span class="n">elementData</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
            <span class="nc">Field</span> <span class="n">sizeField</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"size"</span><span class="o">);</span>
            <span class="n">sizeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

            <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">objects</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">objects</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span> <span class="o">{</span>
                    <span class="o">++</span><span class="n">size</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"length = "</span> <span class="o">+</span> <span class="n">objects</span><span class="o">.</span><span class="na">length</span>
                    <span class="o">+</span> <span class="s">", size = "</span> <span class="o">+</span> <span class="n">sizeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">list</span><span class="o">)</span>
                    <span class="o">+</span> <span class="s">", arraySize = "</span> <span class="o">+</span> <span class="n">size</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>正式测试：将初始化长度设置为 <code>8</code>，同时将添加元素的个数设置为 <code>8 * 2</code> 来方便观察数组增长情况。通过上述的工具方法，可以将 <code>ArrayList</code> 内部的数据进一步展示出来：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddAtTail</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">initialCapacity</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">integers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">initialCapacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">initialCapacity</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">xray</span><span class="o">(</span><span class="n">integers</span><span class="o">);</span>
            <span class="n">integers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK 相关源代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre></td><td class="code"><pre><span class="cm">/**
 * Increases the capacity to ensure that it can hold at least the
 * number of elements specified by the minimum capacity argument.
 *
 * @param minCapacity the desired minimum capacity
 * @throws OutOfMemoryError if minCapacity is less than zero
 */</span>
<span class="kd">private</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">grow</span><span class="o">(</span><span class="kt">int</span> <span class="n">minCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span>
                                       <span class="n">newCapacity</span><span class="o">(</span><span class="n">minCapacity</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">grow</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">grow</span><span class="o">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Returns a capacity at least as large as the given minimum capacity.
 * Returns the current capacity increased by 50% if that suffices.
 * Will not return a capacity greater than MAX_ARRAY_SIZE unless
 * the given minimum capacity is greater than MAX_ARRAY_SIZE.
 *
 * @param minCapacity the desired minimum capacity
 * @throws OutOfMemoryError if minCapacity is less than zero
 */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="nf">newCapacity</span><span class="o">(</span><span class="kt">int</span> <span class="n">minCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// overflow-conscious code</span>
    <span class="kt">int</span> <span class="n">oldCapacity</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">newCapacity</span> <span class="o">=</span> <span class="n">oldCapacity</span> <span class="o">+</span> <span class="o">(</span><span class="n">oldCapacity</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newCapacity</span> <span class="o">-</span> <span class="n">minCapacity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">==</span> <span class="no">DEFAULTCAPACITY_EMPTY_ELEMENTDATA</span><span class="o">)</span>
            <span class="k">return</span> <span class="nc">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="no">DEFAULT_CAPACITY</span><span class="o">,</span> <span class="n">minCapacity</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">minCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// overflow</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">minCapacity</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">newCapacity</span> <span class="o">-</span> <span class="no">MAX_ARRAY_SIZE</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
        <span class="o">?</span> <span class="n">newCapacity</span>
        <span class="o">:</span> <span class="n">hugeCapacity</span><span class="o">(</span><span class="n">minCapacity</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">hugeCapacity</span><span class="o">(</span><span class="kt">int</span> <span class="n">minCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">minCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="c1">// overflow</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">OutOfMemoryError</span><span class="o">();</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">minCapacity</span> <span class="o">&gt;</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">)</span>
        <span class="o">?</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span>
        <span class="o">:</span> <span class="no">MAX_ARRAY_SIZE</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * This helper method split out from add(E) to keep method
 * bytecode size under 35 (the -XX:MaxInlineSize default value),
 * which helps when add(E) is called in a C1-compiled loop.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">,</span> <span class="kt">int</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">();</span>
    <span class="n">elementData</span><span class="o">[</span><span class="n">s</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Appends the specified element to the end of this list.
 *
 * @param e element to be appended to this list
 * @return {@code true} (as specified by {@link Collection#add})
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="n">add</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>经过测试发现，<code>ArrayList</code> 是在容量达到数组长度之后，再次添加才会扩容，扩容长度为 <code>int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1)</code>，最小为原始长度，最大不能超过 <code>int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8</code>。</p>
</div>
<div class="paragraph">
<p>之所以最大长度为 <code>Integer.MAX_VALUE</code> 减去 <code>8</code>，文档解释是因为某些 VM 保留数组头部用于存储一些 header words。但是在 <code>hugeCapacity(int minCapacity)</code> 方法中，在最小容量大于 <code>MAX_ARRAY_SIZE</code>，又可以返回 <code>Integer.MAX_VALUE</code>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddAtHeader</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">initialCapacity</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>
        <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">integers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">initialCapacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">initialCapacity</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">xray</span><span class="o">(</span><span class="n">integers</span><span class="o">);</span>
            <span class="n">integers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="cm">/**
 * Inserts the specified element at the specified position in this
 * list. Shifts the element currently at that position (if any) and
 * any subsequent elements to the right (adds one to their indices).
 *
 * @param index index at which the specified element is to be inserted
 * @param element element to be inserted
 * @throws IndexOutOfBoundsException {@inheritDoc}
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span><span class="o">)</span> <span class="o">==</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">).</span><span class="na">length</span><span class="o">)</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span>
                     <span class="n">elementData</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span>
                     <span class="n">s</span> <span class="o">-</span> <span class="n">index</span><span class="o">);</span>
    <span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * A version of rangeCheck used by add and addAll.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheckForAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从这里看出，在头部插入添加元素，实际就是将指定坐标位置以及右侧所有元素向后移动一位，腾出空间存放新元素。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="code"><pre><span class="cm">/**
 * Appends all of the elements in the specified collection to the end of
 * this list, in the order that they are returned by the
 * specified collection's Iterator.  The behavior of this operation is
 * undefined if the specified collection is modified while the operation
 * is in progress.  (This implies that the behavior of this call is
 * undefined if the specified collection is this list, and this
 * list is nonempty.)
 *
 * @param c collection containing elements to be added to this list
 * @return {@code true} if this list changed as a result of the call
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="kt">int</span> <span class="n">numNew</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">&gt;</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">).</span><span class="na">length</span> <span class="o">-</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span><span class="o">))</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">s</span><span class="o">,</span> <span class="n">numNew</span><span class="o">);</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Inserts all of the elements in the specified collection into this
 * list, starting at the specified position.  Shifts the element
 * currently at that position (if any) and any subsequent elements to
 * the right (increases their indices).  The new elements will appear
 * in the list in the order that they are returned by the
 * specified collection's iterator.
 *
 * @param index index at which to insert the first element from the
 *              specified collection
 * @param c collection containing elements to be added to this list
 * @return {@code true} if this list changed as a result of the call
 * @throws IndexOutOfBoundsException {@inheritDoc}
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

    <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
    <span class="n">modCount</span><span class="o">++;</span>
    <span class="kt">int</span> <span class="n">numNew</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span><span class="o">;</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">s</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">&gt;</span> <span class="o">(</span><span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">).</span><span class="na">length</span> <span class="o">-</span> <span class="o">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span><span class="o">))</span>
        <span class="n">elementData</span> <span class="o">=</span> <span class="n">grow</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">);</span>

    <span class="kt">int</span> <span class="n">numMoved</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">index</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">numMoved</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span>
                         <span class="n">elementData</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">,</span>
                         <span class="n">numMoved</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">numNew</span><span class="o">);</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">numNew</span><span class="o">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>向 <code>ArrayList</code> 中添加集合实例，则是集合示例转化成数组，然后利用数组拷贝的方式来高效完成添加工作。</p>
</div>
</div>
<div class="sect2">
<h3 id="_删除元素"><a class="anchor" href="#_删除元素"></a>8.4. 删除元素</h3>

</div>
<div class="sect2">
<h3 id="_测试遍历速度"><a class="anchor" href="#_测试遍历速度"></a>8.5. 测试遍历速度</h3>
<div class="paragraph">
<p><code>ArrayList</code> 的遍历方式有如下几种：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>标准迭代器方式</p>
</li>
<li>
<p>外部 <code>for</code> 循环 + <code>get(index)</code></p>
</li>
<li>
<p><code>forEach(lambda)</code> 方法</p>
</li>
<li>
<p><code>for(E e: arrayList)</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>基准测试当然非 Java Microbenchmark Harness 莫属了。直接上代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.openjdk.jmh.annotations.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-03 13:09
 */</span>
<span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="nc">Mode</span><span class="o">.</span><span class="na">Throughput</span><span class="o">)</span>
<span class="nd">@Warmup</span><span class="o">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">3</span><span class="o">)</span>
<span class="nd">@State</span><span class="o">(</span><span class="nc">Scope</span><span class="o">.</span><span class="na">Benchmark</span><span class="o">)</span>
<span class="nd">@Threads</span><span class="o">(</span><span class="mi">8</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayListIteratorSpeedTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">arrayList</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nd">@Setup</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">Iteration</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="mi">1_000_000</span><span class="o">;</span>
        <span class="n">arrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">capacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">capacity</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">arrayList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">iteratorValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">arrayList</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">iteratorValue</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testRandomAccess</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">randomAccessValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">arrayList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">randomAccessValue</span> <span class="o">=</span> <span class="n">arrayList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testForEachLambda</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">arrayList</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">devnull</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">devnull</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">forEachLambdaValue</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Benchmark</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testForEach</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">forEachValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Integer</span> <span class="n">integer</span> <span class="o">:</span> <span class="n">arrayList</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">forEachValue</span> <span class="o">=</span> <span class="n">integer</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>运行结果如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre></pre>
</div>
</div>
<div class="paragraph">
<p>在代码中，常常看到 <code>modCount</code> 属性，这个属性是从 <code>AbstractList</code> 继承到的一个重要属性。 这个属性用于在使用迭代器（<code>ListIterator</code>，<code>Iterator</code>）遍历的时候，用来检查列表中的元素是否发生结构性变化（列表元素数量发生改变）了，主要在多线程环境下需要使用，防止一个线程正在迭代遍历，另一个线程修改了这个列表的结构。<code>ArrayList</code> 是非线程安全的，多线程同时修改会抛出异常。<code>writeObject</code>（序列化时），也可能会抛出此异常。</p>
</div>
<div class="paragraph">
<p>检查到修改不一致就抛出异常是 fail-fast 机制，是 Java 集合(Collection)中的一种错误机制。它只能被用来检测错误，因为JDK并不保证 fail-fast 机制一定会发生。如果发生 fail-fast，则推荐使用 <code>JUC</code> 中对应的类。</p>
</div>
<div class="paragraph">
<p>简单来说，Java 的序列化机制是通过在运行时判断类的 <code>serialVersionUID</code> 来验证版本一致性的。在进行反序列化时，JVM会把传来的字节流中的 <code>serialVersionUID</code> 与本地相应实体（类）的 <code>serialVersionUID</code> 进行比较，如果相同就认为是一致的，可以进行反序列化，否则就会出现序列化版本不一致的异常。(InvalidCastException)</p>
</div>
<div class="paragraph">
<p><code>serialVersionUID</code> 有两种显示的生成方式：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>一个是默认的L类型数字，比如：private static final long serialVersionUID = 1L;</p>
</li>
<li>
<p>一个是根据类名、接口名、成员方法及属性等来生成一个64位的哈希字段。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>当实现 <code>java.io.Serializable</code> 接口的实体（类）没有显式地定义一个名为 <code>serialVersionUID</code>，类型为 <code>long</code> 的变量时，Java序列化机制会根据编译的class(它通过类名，方法名等诸多因素经过计算而得，理论上是一一映射的关系，也就是唯一的)自动生成一个 <code>serialVersionUID</code> 作序列化版本比较用，这种情况下，如果class文件(类名,方法明等)没有发生变化(增加空格,换行,增加注释,等等)，就算再编译多次，<code>serialVersionUID</code> 也不会变化的.</p>
</div>
<div class="paragraph">
<p>如果我们不希望通过编译来强制划分软件版本，即实现序列化接口的实体能够兼容先前版本，未作更改的类，就需要显式地定义一个名为 <code>serialVersionUID</code>，类型为 <code>long</code> 的变量，不修改这个变量值的序列化实体都可以相互进行串行化和反串行化。</p>
</div>
<div class="paragraph">
<p>3.观察3两个重要属性
关键字 transient（瞬态）被标记为transient的属性在对象被序列化的时候不会被保存。
why?
假如elementData的长度为10，而其中只有5个元素，那么在序列化的时候只需要存储5个元素，而数组中后面5个元素是不需要存储的。于是将elementData定义为transient，避免了Java自带的序列化机制，并定义了两个方法，实现了自己可控制的序列化操作。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//更新</span>
<span class="kd">public</span> <span class="no">E</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

	<span class="no">E</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
	<span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
	<span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//查找</span>

<span class="kd">public</span> <span class="no">E</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

	<span class="k">return</span> <span class="nf">elementData</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">//是否包含</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="nf">indexOf</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">indexOf</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]==</span><span class="kc">null</span><span class="o">)</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//反向查找</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">lastIndexOf</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]==</span><span class="kc">null</span><span class="o">)</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]))</span>
				<span class="k">return</span> <span class="n">i</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//容量判断</span>

<span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">size</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEmpty</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>1.浅克隆（shallow clone）</p>
</div>
<div class="paragraph">
<p>被复制对象的所有基础类型变量（byte,short,int,long,char,boolean,float,double）与原有对象中变量具有相同的值，修改其值不会影响原对象；而复制对象中引用类型（数组，类对象等）还是指向原来对象，修改其值会影响原对象。</p>
</div>
<div class="paragraph">
<p>2.深克隆（deep clone）</p>
</div>
<div class="paragraph">
<p>被复制对象的所有基础类型变量（byte,short,int,long,char,boolean,float,double）与原有对象中变量具有相同的值，修改其值不会影响原对象；并且复制对象中引用类型（数组，类对象等）指向被复制过的新对象，修改其值不会影响原对象。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nc">Object</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="nc">ArrayList</span><span class="o">&lt;?&gt;</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;?&gt;)</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
		<span class="n">v</span><span class="o">.</span><span class="na">elementData</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
		<span class="n">v</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">v</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CloneNotSupportedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// this shouldn't happen, since we are Cloneable</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">InternalError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">(</span><span class="no">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="c1">// Make a new array of a's runtime type, but my contents:</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">[])</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="n">a</span><span class="o">[</span><span class="n">size</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="k">return</span> <span class="n">a</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// Positional Access Operations</span>
<span class="c1">//得到指定索引处的元素</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="no">E</span> <span class="nf">elementData</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
<span class="o">}</span>
<span class="c1">//清空</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">modCount</span><span class="o">++;</span>

	<span class="c1">// clear to let GC do its work</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
		<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>


<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">removeRange</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">modCount</span><span class="o">++;</span>
	<span class="kt">int</span> <span class="n">numMoved</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">toIndex</span><span class="o">;</span>
	<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">,</span> <span class="n">elementData</span><span class="o">,</span> <span class="n">fromIndex</span><span class="o">,</span>
					 <span class="n">numMoved</span><span class="o">);</span>

	<span class="c1">// clear to let GC do its work</span>
	<span class="kt">int</span> <span class="n">newSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="o">(</span><span class="n">toIndex</span><span class="o">-</span><span class="n">fromIndex</span><span class="o">);</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">newSize</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">newSize</span><span class="o">;</span>
<span class="o">}</span>

 <span class="c1">//检查数否超出数组长度 用于添加元素时</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheck</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
<span class="o">}</span>
<span class="c1">//检查是否溢出</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheckForAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="nc">String</span> <span class="nf">outOfBoundsMsg</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">+</span><span class="s">", Size: "</span><span class="o">+</span><span class="n">size</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//删除指定集合的元素</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
	<span class="k">return</span> <span class="nf">batchRemove</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">//仅保留指定集合的元素</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">retainAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
	<span class="k">return</span> <span class="nf">batchRemove</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>
<span class="o">*</span> <span class="nd">@param</span> <span class="n">complement</span> <span class="n">true时从数组保留指定集合中元素的值</span><span class="err">，</span><span class="n">为false时从数组删除指定集合中元素的值</span><span class="err">。</span>
<span class="o">*</span> <span class="nd">@return</span> <span class="n">数组中重复的元素都会被删除</span><span class="o">(</span><span class="n">而不是仅删除一次或几次</span><span class="o">)</span><span class="err">，</span><span class="n">有任何删除操作都会返回true</span>
<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">batchRemove</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">complement</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kt">boolean</span> <span class="n">modified</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">r</span><span class="o">++)</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">r</span><span class="o">])</span> <span class="o">==</span> <span class="n">complement</span><span class="o">)</span>
				<span class="n">elementData</span><span class="o">[</span><span class="n">w</span><span class="o">++]</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">[</span><span class="n">r</span><span class="o">];</span>
	<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
		<span class="c1">// Preserve behavioral compatibility with AbstractCollection,</span>
		<span class="c1">// even if c.contains() throws.</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">elementData</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span>
							 <span class="n">elementData</span><span class="o">,</span> <span class="n">w</span><span class="o">,</span>
							 <span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">);</span>
			<span class="n">w</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">r</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">w</span> <span class="o">!=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// clear to let GC do its work</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">w</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
				<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
			<span class="n">modCount</span> <span class="o">+=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">w</span><span class="o">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">w</span><span class="o">;</span>
			<span class="n">modified</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">modified</span><span class="o">;</span>
<span class="o">}</span>
 <span class="c1">//保存数组实例的状态到一个流（即它序列化）。写入过程数组被更改会抛出异常</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectOutputStream</span> <span class="n">s</span><span class="o">)</span>
	<span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">{</span>
	<span class="c1">// Write out element count, and any hidden stuff</span>
	<span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="n">s</span><span class="o">.</span><span class="na">defaultWriteObject</span><span class="o">();</span>

	<span class="c1">// Write out size as capacity for behavioural compatibility with clone()</span>
	<span class="n">s</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>

	<span class="c1">// Write out all elements in the proper order.</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">s</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>
<span class="c1">//上面是写，这个就是读了。</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span> <span class="n">s</span><span class="o">)</span>
	<span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
	<span class="n">elementData</span> <span class="o">=</span> <span class="no">EMPTY_ELEMENTDATA</span><span class="o">;</span>

	<span class="c1">// Read in size, and any hidden stuff</span>
	<span class="n">s</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>

	<span class="c1">// Read in capacity</span>
	<span class="n">s</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span> <span class="c1">// ignored</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// be like clone(), allocate array based upon size not capacity</span>
		<span class="n">ensureCapacityInternal</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>

		<span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">;</span>
		<span class="c1">// Read in all elements in the proper order.</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">ListItr</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">实现Iterable</span>
<span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">ListItr</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">实现Iterable</span>
<span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">Itr</span><span class="o">();</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>//通用的迭代器实现 迭代器（Iterator）模式</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">Itr</span> <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="kt">int</span> <span class="n">cursor</span><span class="o">;</span>       <span class="c1">// index of next element to return</span>
	<span class="kt">int</span> <span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// index of last element returned; -1 if no such</span>
	<span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="n">size</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
		<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">];</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
		<span class="n">checkForComodification</span><span class="o">();</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">lastRet</span><span class="o">);</span>
			<span class="n">cursor</span> <span class="o">=</span> <span class="n">lastRet</span><span class="o">;</span>
			<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
			<span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">consumer</span><span class="o">.</span><span class="na">accept</span><span class="o">((</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">++]);</span>
		<span class="o">}</span>
		<span class="c1">// update once at end of iteration to reduce heap write traffic</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
		<span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">final</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>其中的ListItr继承Itr，实现了ListIterator接口，同时重写了hasPrevious()，nextIndex()， previousIndex()，previous()，set(E e)，add(E e)等方法，所以这也可以看出了Iterator和ListIterator的区别，就是ListIterator在Iterator的基础上增加了添加对象，修改对象，逆向遍历等方法，这些是Iterator不能实现的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ListItr</span> <span class="kd">extends</span> <span class="nc">Itr</span> <span class="kd">implements</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="nc">ListItr</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">();</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPrevious</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextIndex</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">previousIndex</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="no">E</span> <span class="nf">previous</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
		<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">];</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
		<span class="n">checkForComodification</span><span class="o">();</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">lastRet</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
			<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
			<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
			<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
			<span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
<span class="c1">//返回指定范围的子数组</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">subList</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">subListRangeCheck</span><span class="o">(</span><span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nf">SubList</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kt">void</span> <span class="nf">subListRangeCheck</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">fromIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"fromIndex = "</span> <span class="o">+</span> <span class="n">fromIndex</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">toIndex</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="s">"toIndex = "</span> <span class="o">+</span> <span class="n">toIndex</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">fromIndex</span> <span class="o">&gt;</span> <span class="n">toIndex</span><span class="o">)</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"fromIndex("</span> <span class="o">+</span> <span class="n">fromIndex</span> <span class="o">+</span>
										   <span class="s">") &gt; toIndex("</span> <span class="o">+</span> <span class="n">toIndex</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>其中的SubList继承AbstractList，实现了RandmAccess接口，类内部实现了对子序列的增删改查等方法，但它同时也充分利用了内部类的优点，就是共享ArrayList的全局变量，例如检查器变量modCount，数组elementData等，所以SubList进行的增删改查操作都是对ArrayList的数组进行的，并没有创建新的数组(不浪费内存资源)。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">SubList</span> <span class="kd">extends</span> <span class="nc">AbstractList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">RandomAccess</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">AbstractList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">parentOffset</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">offset</span><span class="o">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="o">;</span>

	<span class="nc">SubList</span><span class="o">(</span><span class="nc">AbstractList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">,</span>
			<span class="kt">int</span> <span class="n">offset</span><span class="o">,</span> <span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">parentOffset</span> <span class="o">=</span> <span class="n">fromIndex</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">fromIndex</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">toIndex</span> <span class="o">-</span> <span class="n">fromIndex</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="no">E</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="no">E</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
		<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="no">E</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="k">return</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">parent</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">index</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">++;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="no">E</span> <span class="nf">remove</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheck</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="no">E</span> <span class="n">result</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">--;</span>
		<span class="k">return</span> <span class="n">result</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">removeRange</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">parent</span><span class="o">.</span><span class="na">removeRange</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">fromIndex</span><span class="o">,</span>
						   <span class="n">parentOffset</span> <span class="o">+</span> <span class="n">toIndex</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">-=</span> <span class="n">toIndex</span> <span class="o">-</span> <span class="n">fromIndex</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">addAll</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="kt">int</span> <span class="n">cSize</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">cSize</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span>
			<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">parent</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">parentOffset</span> <span class="o">+</span> <span class="n">index</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
		<span class="k">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">+=</span> <span class="n">cSize</span><span class="o">;</span>
		<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nf">listIterator</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="n">rangeCheckForAdd</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">offset</span><span class="o">;</span>

		<span class="k">return</span> <span class="k">new</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;()</span> <span class="o">{</span>
			<span class="kt">int</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
			<span class="kt">int</span> <span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
			<span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>

			<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
			<span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">checkForComodification</span><span class="o">();</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
				<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
				<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">)];</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPrevious</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
			<span class="kd">public</span> <span class="no">E</span> <span class="nf">previous</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">checkForComodification</span><span class="o">();</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
				<span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
				<span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">=</span> <span class="n">i</span><span class="o">)];</span>
			<span class="o">}</span>

			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
				<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">consumer</span><span class="o">);</span>
				<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
				<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">elementData</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
				<span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">consumer</span><span class="o">.</span><span class="na">accept</span><span class="o">((</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">offset</span> <span class="o">+</span> <span class="o">(</span><span class="n">i</span><span class="o">++)]);</span>
				<span class="o">}</span>
				<span class="c1">// update once at end of iteration to reduce heap write traffic</span>
				<span class="n">lastRet</span> <span class="o">=</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
				<span class="n">checkForComodification</span><span class="o">();</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextIndex</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">int</span> <span class="nf">previousIndex</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">return</span> <span class="n">cursor</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
				<span class="n">checkForComodification</span><span class="o">();</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">lastRet</span><span class="o">);</span>
					<span class="n">cursor</span> <span class="o">=</span> <span class="n">lastRet</span><span class="o">;</span>
					<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
					<span class="n">expectedModCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">lastRet</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
				<span class="n">checkForComodification</span><span class="o">();</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">lastRet</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">checkForComodification</span><span class="o">();</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">;</span>
					<span class="nc">SubList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
					<span class="n">cursor</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
					<span class="n">lastRet</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
					<span class="n">expectedModCount</span> <span class="o">=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IndexOutOfBoundsException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>

			<span class="kd">final</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">expectedModCount</span> <span class="o">!=</span> <span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">)</span>
					<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">};</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">subList</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toIndex</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">subListRangeCheck</span><span class="o">(</span><span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nf">SubList</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span> <span class="n">fromIndex</span><span class="o">,</span> <span class="n">toIndex</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheck</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">rangeCheckForAdd</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">outOfBoundsMsg</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">+</span><span class="s">", Size: "</span><span class="o">+</span><span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">modCount</span> <span class="o">!=</span> <span class="k">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
		<span class="n">checkForComodification</span><span class="o">();</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="nc">ArrayList</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">offset</span><span class="o">,</span>
										   <span class="n">offset</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">modCount</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//按照比较器的判断逻辑进行排序</span>
<span class="nd">@Override</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">sort</span><span class="o">(</span><span class="nc">Comparator</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="nc">Arrays</span><span class="o">.</span><span class="na">sort</span><span class="o">((</span><span class="no">E</span><span class="o">[])</span> <span class="n">elementData</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="n">modCount</span><span class="o">++;</span>
<span class="o">}</span>
 <span class="n">以下基于</span> <span class="mf">1.8</span><span class="err">，</span><span class="n">和函数式编程相关的方法</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
	<span class="kd">final</span> <span class="no">E</span><span class="o">[]</span> <span class="n">elementData</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">[])</span> <span class="k">this</span><span class="o">.</span><span class="na">elementData</span><span class="o">;</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="k">new</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>


	<span class="kd">private</span> <span class="kd">final</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">;</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span> <span class="c1">// current index, modified on advance/split</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">fence</span><span class="o">;</span> <span class="c1">// -1 until used; then one past last index</span>
	<span class="kd">private</span> <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">;</span> <span class="c1">// initialized when fence set</span>

	<span class="cm">/** Create new spliterator covering the given  range */</span>
	<span class="nc">ArrayListSpliterator</span><span class="o">(</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="kt">int</span> <span class="n">origin</span><span class="o">,</span> <span class="kt">int</span> <span class="n">fence</span><span class="o">,</span>
						 <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">;</span> <span class="c1">// OK if null unless traversed</span>
		<span class="k">this</span><span class="o">.</span><span class="na">index</span> <span class="o">=</span> <span class="n">origin</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">fence</span> <span class="o">=</span> <span class="n">fence</span><span class="o">;</span>
		<span class="k">this</span><span class="o">.</span><span class="na">expectedModCount</span> <span class="o">=</span> <span class="n">expectedModCount</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kt">int</span> <span class="nf">getFence</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// initialize fence to size on first use</span>
		<span class="kt">int</span> <span class="n">hi</span><span class="o">;</span> <span class="c1">// (a specialized variant appears in method forEach)</span>
		<span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lst</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">((</span><span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">((</span><span class="n">lst</span> <span class="o">=</span> <span class="n">list</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
			<span class="k">else</span> <span class="o">{</span>
				<span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">hi</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">trySplit</span><span class="o">()</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">getFence</span><span class="o">(),</span> <span class="n">lo</span> <span class="o">=</span> <span class="n">index</span><span class="o">,</span> <span class="n">mid</span> <span class="o">=</span> <span class="o">(</span><span class="n">lo</span> <span class="o">+</span> <span class="n">hi</span><span class="o">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">;</span>
		<span class="k">return</span> <span class="o">(</span><span class="n">lo</span> <span class="o">&gt;=</span> <span class="n">mid</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="c1">// divide range in half unless too small</span>
			<span class="k">new</span> <span class="nc">ArrayListSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="n">list</span><span class="o">,</span> <span class="n">lo</span><span class="o">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">mid</span><span class="o">,</span>
										<span class="n">expectedModCount</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryAdvance</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">getFence</span><span class="o">(),</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
			<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span> <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span><span class="n">list</span><span class="o">.</span><span class="na">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
			<span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
				<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
			<span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="n">hi</span><span class="o">,</span> <span class="n">mc</span><span class="o">;</span> <span class="c1">// hoist accesses and checks from loop</span>
		<span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lst</span><span class="o">;</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">((</span><span class="n">lst</span> <span class="o">=</span> <span class="n">list</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">elementData</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">((</span><span class="n">hi</span> <span class="o">=</span> <span class="n">fence</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">mc</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">else</span>
				<span class="n">mc</span> <span class="o">=</span> <span class="n">expectedModCount</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">hi</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hi</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
					<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span> <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">a</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
					<span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">lst</span><span class="o">.</span><span class="na">modCount</span> <span class="o">==</span> <span class="n">mc</span><span class="o">)</span>
					<span class="k">return</span><span class="o">;</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">long</span> <span class="nf">estimateSize</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="n">getFence</span><span class="o">()</span> <span class="o">-</span> <span class="n">index</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kt">int</span> <span class="nf">characteristics</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">ORDERED</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">SIZED</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">SUBSIZED</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeIf</span><span class="o">(</span><span class="nc">Predicate</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">filter</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">filter</span><span class="o">);</span>
	<span class="c1">// figure out which elements are to be removed</span>
	<span class="c1">// any exception thrown from the filter predicate at this stage</span>
	<span class="c1">// will leave the collection unmodified</span>
	<span class="kt">int</span> <span class="n">removeCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
	<span class="kd">final</span> <span class="nc">BitSet</span> <span class="n">removeSet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BitSet</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
		<span class="kd">final</span> <span class="no">E</span> <span class="n">element</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">filter</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="n">element</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">removeSet</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
			<span class="n">removeCount</span><span class="o">++;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">// shift surviving elements left over the spaces left by removed elements</span>
	<span class="kd">final</span> <span class="kt">boolean</span> <span class="n">anyToRemove</span> <span class="o">=</span> <span class="n">removeCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">anyToRemove</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">newSize</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">removeCount</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">,</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">newSize</span><span class="o">);</span> <span class="n">i</span><span class="o">++,</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">removeSet</span><span class="o">.</span><span class="na">nextClearBit</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
			<span class="n">elementData</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
		<span class="o">}</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">k</span><span class="o">=</span><span class="n">newSize</span><span class="o">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">k</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">elementData</span><span class="o">[</span><span class="n">k</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  <span class="c1">// Let gc do its work</span>
		<span class="o">}</span>
		<span class="k">this</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">newSize</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="n">modCount</span><span class="o">++;</span>
	<span class="o">}</span>

	<span class="k">return</span> <span class="n">anyToRemove</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">replaceAll</span><span class="o">(</span><span class="nc">UnaryOperator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">operator</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">operator</span><span class="o">);</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
	<span class="kd">final</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
		<span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="na">apply</span><span class="o">((</span><span class="no">E</span><span class="o">)</span> <span class="n">elementData</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="n">modCount</span><span class="o">++;</span>
<span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>总结，
  	List接口可调整大小的数组实现。实现所有可选的List操作，并允许所有元素，包括null，元素可重复。
  	除了列表接口外，该类提供了一种方法来操作该数组的大小来存储该列表中的数组的大小。</p>
</div>
<div class="literalblock">
<div class="content">
<pre>时间复杂度：
方法size、isEmpty、get、set、iterator和listIterator的调用是常数时间的。
	添加删除的时间复杂度为O(N)。其他所有操作也都是线性时间复杂度。</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>容量：
	每个ArrayList都有容量，容量大小至少为List元素的长度，默认初始化为10。
 容量可以自动增长。
 如果提前知道数组元素较多，可以在添加元素前通过调用ensureCapacity()方法提前增加容量以减小后期容量自动增长的开销。
 也可以通过带初始容量的构造器初始化这个容量。</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre> 线程不安全：
 	ArrayList不是线程安全的。
 	如果需要应用到多线程中，需要在外部做同步。
**指导意义**
那种遍历性能更优？应该使用哪种遍历方式？
《编写高质量代码：改善Java程序的151个建议》一书认为使用传统的下标遍历是优于增强型for循环的，而《Effective Java中文版 第2版》推荐的是增强型for循环，说for-each循环没有性能损失。何解？
在ArrayList大小为十万之前，五种遍历方式时间消耗几乎一样
即便在千万大小的ArrayList中，几种遍历方式相差也不过50ms左右（for-each循环较大），且在常用的十万左右时间几乎相等，考虑foreach简洁的优点，我们大可选用foreach这种简便方式进行遍历。</pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/compareListLoop.png" alt="compareListLoop">
</div>
</div>
<div class="paragraph">
<p>这是对ArrayList效率影响比较大的一个因素。
每当执行Add等添加元素的方法，都会检查内部数组的容量是否不够了，如果是，它就会以当前容量 的 1.5 倍来重新构建一个数组，将旧元素Copy到新数组中，然后丢弃旧数组，在这个临界点的扩容操作，应该来说是比较影响效率的。 正确的预估可能的元素，是提高ArrayList使用效率的重要途径。</p>
</div>
</div>
<div class="sect2">
<h3 id="_问题"><a class="anchor" href="#_问题"></a>8.6. 问题</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Java 中有很多标识类的接口。这些表示类有什么意义？是否在 Java 虚拟机中对其进行了特殊处理？</p>
</li>
<li>
<p>在实现 <code>java.io.Serializable</code> 时，如果不声明 <code>serialVersionUID</code> 变量时，是否会生成这个值？默认的值是什么？在序列化时，是如何保存这个值？在反序列化时，如何从对象的字节码中获取这个值？比较后，如果不同又怎么处理的？</p>
</li>
<li>
<p>在 <code>ArrayList</code> 中有 <code>writeObject(java.io.ObjectOutputStream s)</code> 和 <code>readObject(java.io.ObjectInputStream s)</code> 方法。在单例模式中，为了解决反序列化的问题，会添加 <code>readResolve()</code> 方法。这三个方法有什么用？什么时候被什么调用？被什么调用？设置断点调试一下，看 <strong>调用栈</strong>。</p>
</li>
<li>
<p>ArrayList 在扩容时，使用的是 <code>oldCapacity + (oldCapacity &gt;&gt; 1)</code>，这里 <code>oldCapacity &gt;&gt; 1</code> 就是直接移位将 oldCapacity 的值减半，取到的值就是 oldCapacity/2 后的最大正整数。</p>
</li>
<li>
<p>ArrayList 中有 <code>rangeCheck(int index)</code> 和 <code>rangeCheckForAdd(int index)</code>，区别就是前者没有做负数检查。为什么会有这种区别？为什么不检查负数？再为什么不检查负数为什么还能抛出 <code>ArrayIndexOutOfBoundsException</code> 异常？（文档中）</p>
</li>
<li>
<p>《数据结构与算法分析》 中提到 <code>Iterator</code> 和 <code>ListIterator</code> 的区别以及 <code>ListIterator</code> 中一个特殊的使用。再次看书来确认一下。</p>
</li>
<li>
<p>通过指令来对比 Iterat or 和 foreach 之间的性能差异。</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_2"><a class="anchor" href="#_参考资料_2"></a>8.7. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.hollischuang.com/archives/1144">单例与序列化的那些事儿-HollisChuang&#8217;s Blog</a></p>
</li>
<li>
<p><a href="http://www.hollischuang.com/archives/197">深度分析Java的枚举类型—-枚举的线程安全性及序列化问题-HollisChuang&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_linkedlist"><a class="anchor" href="#_linkedlist"></a>9. LinkedList</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>LinkedList</code> 底层使用的是 双向链表 数据结构（JDK1.6 之前为循环链表，JDK1.7 取消了循环。注意双向链表和双向循环链表的区别。）</p>
</div>
<div class="sect2">
<h3 id="_类图_3"><a class="anchor" href="#_类图_3"></a>9.1. 类图</h3>
<div class="paragraph">
<p>先来看一下 <code>LinkedList</code> 的类图：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-614c82a0467bab7cc67d50c13bad8c62.svg" alt="Diagram" width="90%" height="612">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_初始化_2"><a class="anchor" href="#_初始化_2"></a>9.2. 初始化</h3>
<div class="paragraph">
<p>先看看 <code>LinkedList</code> 中内部属性和构造函数：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="code"><pre><span class="kd">transient</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

<span class="cm">/**
 * Pointer to first node.
 */</span>
<span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">first</span><span class="o">;</span>

<span class="cm">/**
 * Pointer to last node.
 */</span>
<span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">last</span><span class="o">;</span>

<span class="cm">/*
void dataStructureInvariants() {
    assert (size == 0)
        ? (first == null &amp;&amp; last == null)
        : (first.prev == null &amp;&amp; last.next == null);
}
*/</span>

<span class="cm">/**
 * Constructs an empty list.
 */</span>
<span class="kd">public</span> <span class="nf">LinkedList</span><span class="o">()</span> <span class="o">{</span>
<span class="o">}</span>

<span class="cm">/**
 * Constructs a list containing the elements of the specified
 * collection, in the order they are returned by the collection's
 * iterator.
 *
 * @param  c the collection whose elements are to be placed into this list
 * @throws NullPointerException if the specified collection is null
 */</span>
<span class="kd">public</span> <span class="nf">LinkedList</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">();</span>
    <span class="n">addAll</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="no">E</span> <span class="n">item</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>

    <span class="nc">Node</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从这里一眼即可看出内部使用一个双向链表来保存数据。初始化工作也及其干净，什么也不干。另外一个构造函数后面再分析。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
D瓜哥觉得使用初始化的头尾节点更方便代码书写，少了很多繁琐的判断。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_分析工具"><a class="anchor" href="#_分析工具"></a>9.3. 分析工具</h3>
<div class="paragraph">
<p>使用反射来获取内部属性，然后做进一步分析。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-03 16:16
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LinkedListBaseTest</span> <span class="o">{</span>
    <span class="cm">/**
     * 使用反射读取 LinkedList 内部属性
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">xray</span><span class="o">(</span><span class="nc">LinkedList</span><span class="o">&lt;?&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">LinkedList</span><span class="o">&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Field</span> <span class="n">nodeField</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"first"</span><span class="o">);</span>
            <span class="n">nodeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="nc">Object</span> <span class="n">node</span> <span class="o">=</span> <span class="n">nodeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"length="</span> <span class="o">+</span> <span class="n">length</span><span class="o">(</span><span class="n">node</span><span class="o">)</span> <span class="o">+</span> <span class="s">", size="</span> <span class="o">+</span> <span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">length</span><span class="o">(</span><span class="nc">Object</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">nodeClass</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
            <span class="nc">Field</span> <span class="n">nextField</span> <span class="o">=</span> <span class="n">nodeClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"next"</span><span class="o">);</span>
            <span class="n">nextField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">nextField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
                <span class="n">result</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_添加元素_2"><a class="anchor" href="#_添加元素_2"></a>9.4. 添加元素</h3>
<div class="paragraph">
<p>测试代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddAtTail</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">xray</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK 源码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="cm">/**
 * Links e as last element.
 */</span>
<span class="kt">void</span> <span class="nf">linkLast</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="n">l</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="n">last</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="k">else</span>
        <span class="n">l</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="n">size</span><span class="o">++;</span>
    <span class="n">modCount</span><span class="o">++;</span>
<span class="o">}</span>

<span class="cm">/**
 * Appends the specified element to the end of this list.
 *
 * &lt;p&gt;This method is equivalent to {@link #addLast}.
 *
 * @param e element to be appended to this list
 * @return {@code true} (as specified by {@link Collection#add})
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">linkLast</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>再来看看从头部插入元素：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAddAtHeader</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">xray</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
            <span class="n">list</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK 源码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="cm">/**
 * Links e as first element.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">linkFirst</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="kc">null</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
    <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="k">else</span>
        <span class="n">f</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
    <span class="n">size</span><span class="o">++;</span>
    <span class="n">modCount</span><span class="o">++;</span>
<span class="o">}</span>

<span class="cm">/**
 * Inserts the specified element at the beginning of this list.
 *
 * @param e the element to add
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addFirst</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">linkFirst</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从这里就能看出，<code>LinkedList</code> 在 <code>add(e)</code>、<code>addLast(e)</code> 或者 <code>addFirst(e)</code> 时，都是对链表的首尾进行操作，会比较高效。</p>
</div>
</div>
<div class="sect2">
<h3 id="_redis_的_linkedlist"><a class="anchor" href="#_redis_的_linkedlist"></a>9.5. Redis 的 linkedlist</h3>
<div class="paragraph">
<p>Redis 底层也有很多地方使用到 linkedlist，并且也是双向链表。</p>
</div>
<div class="listingblock">
<div class="title">adlist.h</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">listNode</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">listNode</span> <span class="o"><strong></span><span class="n">prev</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">listNode</span> <span class="o"></strong></span><span class="n">next</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o"><strong></span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span> <span class="n">listNode</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">listIter</span> <span class="p">{</span>
    <span class="n">listNode</span> <span class="o"></strong></span><span class="n">next</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>
<span class="p">}</span> <span class="n">listIter</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">list</span> <span class="p">{</span>
    <span class="n">listNode</span> <span class="o"><strong></span><span class="n">head</span><span class="p">;</span>
    <span class="n">listNode</span> <span class="o"></strong></span><span class="n">tail</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o"><strong></span><span class="p">(</span><span class="o"></strong></span><span class="n">dup</span><span class="p">)(</span><span class="kt">void</span> <span class="o"><strong></span><span class="n">ptr</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o"></strong></span><span class="n">free</span><span class="p">)(</span><span class="kt">void</span> <span class="o"><strong></span><span class="n">ptr</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o"></strong></span><span class="n">match</span><span class="p">)(</span><span class="kt">void</span> <span class="o"><strong></span><span class="n">ptr</span><span class="p">,</span> <span class="kt">void</span> <span class="o"></strong></span><span class="n">key</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">list</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Redis 的 linkedlist 实现特点是：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>双向：节点带有前后指针；</p>
</li>
<li>
<p>无环：首尾没有相连，所以没有构成环状；</p>
</li>
<li>
<p>链表保存了首尾指针；</p>
</li>
<li>
<p>多态：可以保存不同类型的值，这里成为泛型也许更符合 Java 中的语义。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Redis 在 2014 年实现了 <a href="#quicklist">quicklist</a>，并使用 quicklist 代替了 linkedlist。所以，现在 linkedlist 几乎已经是废弃状态。</p>
</div>
</div>
<div class="sect2">
<h3 id="_redis_的_ziplist"><a class="anchor" href="#_redis_的_ziplist"></a>9.6. Redis 的 ziplist</h3>
<div class="paragraph">
<p>Redis 官方在 ziplist.c 文件的注释中对 ziplist 进行了定义：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The ziplist is a specially encoded dually linked list that is designed
to be very memory efficient. It stores both strings and integer values,
where integers are encoded as actual integers instead of a series of
characters. It allows push and pop operations on either side of the list
in O(1) time. However, because every operation requires a reallocation of
the memory used by the ziplist, the actual complexity is related to the
amount of memory used by the ziplist.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; ziplist.c
</div>
</div>
<div class="paragraph">
<p>就是说，ziplist 是一个经过特殊编码的双向链表，它的设计目标就是为了提高存储效率。ziplist 可以用于存储字符串或整数，其中整数是按真正的二进制表示进行编码的，而不是编码成字符串序列。它能以 O(1) 的时间复杂度在表的两端提供 <code>push</code> 和 <code>pop</code> 操作。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="linenums">The general layout of the ziplist is as follows:

&lt;zlbytes&gt; &lt;zltail&gt; &lt;zllen&gt; &lt;entry&gt; &lt;entry&gt; ... &lt;entry&gt; &lt;zlend&gt;

NOTE: all fields are stored in little endian, if not specified otherwise.</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/redis/redis-ziplist-structure.jpg" alt="redis ziplist structure">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>&lt;zlbytes&gt;</code>: 32bit，表示ziplist占用的字节总数（也包括&lt;zlbytes&gt;本身占用的4个字节）。</p>
</li>
<li>
<p><code>&lt;zltail&gt;</code>: 32bit，表示ziplist表中最后一项（entry）在ziplist中的偏移字节数。</p>
<div class="paragraph">
<p><code>&lt;zltail&gt;</code> 的存在，使得我们可以很方便地找到最后一项（不用遍历整个ziplist），从而可以在ziplist尾端快速地执行push或pop操作。</p>
</div>
</li>
<li>
<p><code>&lt;zllen&gt;</code>: 16bit， 表示ziplist中数据项（entry）的个数。zllen字段因为只有16bit，所以可以表达的最大值为2<sup>16</sup>-1。<code>&lt;zllen&gt;</code> 等于16bit全为1的情况，那么 <code>&lt;zllen&gt;</code> 就不表示数据项个数了，这时要想知道 ziplist 中数据项总数，那么必须对ziplist从头到尾遍历各个数据项，才能计数出来。</p>
</li>
<li>
<p><code>&lt;entry&gt;</code>: 表示真正存放数据的数据项，长度不定。一个数据项（entry）也有它自己的内部结构，这个稍后再解释。</p>
</li>
<li>
<p><code>&lt;zlend&gt;</code>: ziplist 最后 1 个字节，是一个结束标记，值固定等于 255。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>ziplist 将表中每一项存放在前后连续的地址空间内，一个ziplist整体占用一大块内存。它是一个表（list），但其实不是一个链表（linked list）。</p>
</div>
<div class="paragraph">
<p>ziplist 为了在细节上节省内存，对于值的存储采用了变长的编码方式。</p>
</div>
<div class="paragraph">
<p>每一个数据项&lt;entry&gt;的构成：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="linenums">&lt;prevlen&gt; &lt;encoding&gt; &lt;entry-data&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>&lt;prevlen&gt;</code>: 表示前一个数据项占用的总字节数。
<div class="olist arabic">
<ol class="arabic">
<li>
<p>如果前一个数据项占用字节数小于254，那么 <code>&lt;prevlen&gt;</code> 就只用一个字节来表示，这个字节的值就是前一个数据项的占用字节数： <code>&lt;prevlen from 0 to 253&gt; &lt;encoding&gt; &lt;entry&gt;</code></p>
</li>
<li>
<p>如果前一个数据项占用字节数大于等于254，那么 <code>&lt;prevlen&gt;</code> 就用5个字节来表示，其中第1个字节的值是254（作为这种情况的一个标记），而后面4个字节组成一个整型值，来真正存储前一个数据项的占用字节数</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>0xFE &lt;4 bytes unsigned little endian prevlen&gt; &lt;encoding&gt; &lt;entry&gt;  <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
</li>
</ol>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>&lt;encoding&gt;</code>: 表示当前数据项的类型，整型或者字符串。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>&lt;entry-data&gt;</code>: 数据</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>关于 <code>&lt;encoding&gt; &lt;entry-data&gt;</code> 的编码，直接引用官方文档：</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The encoding field of the entry depends on the content of the
entry. When the entry is a string, the first 2 bits of the encoding first
byte will hold the type of encoding used to store the length of the string,
followed by the actual length of the string. When the entry is an integer
the first 2 bits are both set to 1. The following 2 bits are used to specify
what kind of integer will be stored after this header. An overview of the
different types and encodings is as follows. The first byte is always enough
to determine the kind of entry.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>|00pppppp| - 1 byte
     String value with length less than or equal to 63 bytes (6 bits).
     "pppppp" represents the unsigned 6 bit length.
|01pppppp|qqqqqqqq| - 2 bytes
     String value with length less than or equal to 16383 bytes (14 bits).
     IMPORTANT: The 14 bit number is stored in big endian.
|10000000|qqqqqqqq|rrrrrrrr|ssssssss|tttttttt| - 5 bytes
     String value with length greater than or equal to 16384 bytes.
     Only the 4 bytes following the first byte represents the length
     up to 32^2-1. The 6 lower bits of the first byte are not used and
     are set to zero.
     IMPORTANT: The 32 bit number is stored in big endian.
|11000000| - 3 bytes
     Integer encoded as int16_t (2 bytes).
|11010000| - 5 bytes
     Integer encoded as int32_t (4 bytes).
|11100000| - 9 bytes
     Integer encoded as int64_t (8 bytes).
|11110000| - 4 bytes
     Integer encoded as 24 bit signed (3 bytes).
|11111110| - 2 bytes
     Integer encoded as 8 bit signed (1 byte).
|1111xxxx| - (with xxxx between 0000 and 1101) immediate 4 bit integer.
     Unsigned integer from 0 to 12. The encoded value is actually from
     1 to 13 because 0000 and 1111 can not be used, so 1 should be
     subtracted from the encoded 4 bit value to obtain the right value.
|11111111| - End of ziplist special entry.</pre>
</div>
</div>
</blockquote>
<div class="attribution">
&#8212; ziplist.c
</div>
</div>
<div class="paragraph">
<p>引用在网上找的例子，来做个说明：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/redis/redis-ziplist-sample.png" alt="redis ziplist sample">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>这个ziplist一共包含 33 个字节。字节编号从 <code>byte[0]</code> 到 <code>byte[32]</code>。图中每个字节的值使用 16 进制表示。</p>
</li>
<li>
<p>头 4 个字节（<code>0x21000000</code>）是按小端（little endian）模式存储的 <code>&lt;zlbytes&gt;</code> 字段。什么是小端呢？就是指数据的低字节保存在内存的低地址中（参见维基百科词条 <a href="https://en.wikipedia.org/wiki/Endianness" target="_blank" rel="noopener">Endianness</a>）。因此，这里 <code>&lt;zlbytes&gt;</code> 的值应该解析成 <code>0x00000021</code>，用十进制表示正好就是33。</p>
</li>
<li>
<p>接下来 4 个字节（<code>byte[4..7]</code>）是 <code>&lt;zltail&gt;</code>，用小端存储模式来解释，它的值是 <code>0x0000001D</code>（值为29），表示最后一个数据项在 <code>byte[29]</code> 的位置（那个数据项为 <code>0x05FE14</code>）。</p>
</li>
<li>
<p>再接下来 2 个字节（<code>byte[8..9]</code>），值为 <code>0x0004</code>，表示这个 ziplist 里一共存有4项数据。</p>
</li>
<li>
<p>接下来 6 个字节（<code>byte[10..15]</code>）是第 1 个数据项。其中，<code>prevlen=0</code>，因为它前面没有数据项；<code>len=4</code>，相当于前面定义的9种情况中的第1种，表示后面4个字节按字符串存储数据，数据的值为：<code>name</code>。</p>
</li>
<li>
<p>接下来 8 个字节（<code>byte[16..23]</code>）是第 2 个数据项，与前面数据项存储格式类似，存储 1 个字符串：<code>tielei</code>。</p>
</li>
<li>
<p>接下来 5 个字节（<code>byte[24..28]</code>）是第 3 个数据项，与前面数据项存储格式类似，存储 1 个字符串： <code>age</code>。</p>
</li>
<li>
<p>接下来3个字节（<code>byte[29..31]</code>）是最后一个数据项，它的格式与前面的数据项存储格式不太一样。其中，第 1 个字节 <code>prevlen=5</code>，表示前一个数据项占用 5 个字节；第 2 个字节 = <code>FE</code>，相当于前面定义的9种情况中的第8种，所以后面还有1个字节用来表示真正的数据，并且以整数表示。它的值是20（0x14）。</p>
</li>
<li>
<p>最后1个字节（<code>byte[32]</code>）表示 <code>&lt;zlend&gt;</code>，是固定的值255（0xFF）。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>有两个问题需要注意：</p>
</div>
<div class="qlist qanda">
<ol>
<li>
<p><em>如何反向遍历 ziplist ？</em></p>
<p><code>&lt;prevlen&gt;</code>: 表示前一个数据项占用的总字节数。那么就能找到前一个元素的起始位置，就能实现反向遍历。</p>
</li>
<li>
<p><em>如何从 ziplist 中添加/删除数据？删除数据后，对应位置的 Bits 位怎么处理？</em></p>
<p>在某个/某些节点的前面添加新节点之后， 程序必须沿着路径挨个检查后续的节点，是否满足新长度的编码要求， 直到遇到一个能满足要求的节点（如果有一个能满足，则这个节点之后的其他节点也满足）， 或者到达 ziplist 的末端 zlend 为止， 这种检查操作的复杂度为 O(N<sup>2</sup>) 。</p>
<div class="paragraph">
<p>因为只有在新添加节点的后面有连续多个长度接近 254 的节点时， 这种连锁更新才会发生， 所以可以普遍地认为， 这种连锁更新发生的概率非常小， 在一般情况下， 将添加操作看成是 O(N) 复杂度也是可以的。</p>
</div>
<div class="paragraph">
<p>删除元素就进行内存移位，覆盖 target 原本的数据，然后通过内存重分配，收缩多余空间。</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Redis 在下面这个几个地方使用了 ziplist：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>列表包含少量的列表项，并且列表项只是整数或者短小的字符串时。（在下面 <a href="#quicklist">quicklist</a> 小节中，在最新版 Redis 中测试，显示的是 quicklist，而 quicklist 内部使用的是 ziplist 来存储数据，只是外面被 quicklist 包裹着。）</p>
</li>
<li>
<p>在哈希键值包含少量键值对，并且每个键值对只包含整数或短小字符串时。</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="nv">$ </span>redis-cli <span class="nt">--raw</span>

127.0.0.1:6379&gt; HMSET site domain <span class="s2">"https://www.diguage.com"</span> owner <span class="s2">"D瓜哥"</span>
OK

127.0.0.1:6379&gt; HGET site domain
https://www.diguage.com

127.0.0.1:6379&gt; HGET site owner
D瓜哥

127.0.0.1:6379&gt; TYPE site
<span class="nb">hash

</span>127.0.0.1:6379&gt; OBJECT encoding site
ziplist
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="quicklist"><a class="anchor" href="#quicklist"></a>9.7. quicklist</h3>
<div class="paragraph">
<p>Redis 对外暴露的 list 数据类型，它底层实现所依赖的内部数据结构就是 quicklist。</p>
</div>
<div class="paragraph">
<p>list 是一个能维持数据项先后顺序的列表（各个数据项的先后顺序由插入位置决定），便于在表的两端追加和删除数据，而对于中间位置的存取具有 O(N) 的时间复杂度。</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>quicklist.c - A doubly linked list of ziplists</p>
</div>
</blockquote>
<div class="attribution">
&#8212; redis/quicklist.c
</div>
</div>
<div class="paragraph">
<p>Redis 在 <code>quicklist.c</code> 就说明了，quicklist 是一个双向链表，而且是一个 ziplist 的双向链表。quicklist 的每个节点都是一个 ziplist。这样设计大概又是一个空间和时间的折中：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>双向链表便于在表的两端进行 <code>push</code> 和 <code>pop</code> 操作，但是它的内存开销比较大。首先，它在每个节点上除了要保存数据之外，还要额外保存两个指针；其次，双向链表的各个节点是单独的内存块，地址不连续，节点多了容易产生内存碎片。</p>
</li>
<li>
<p>ziplist 由于是一整块连续内存，所以存储效率很高。但是，它不利于修改操作，每次数据变动都会引发一次内存的 <code>realloc</code> 。特别是当 ziplist 长度很长的时候，一次 <code>realloc</code> 可能会导致大批量的数据拷贝，进一步降低性能。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>于是，结合了双向链表和 ziplist 的优点，quicklist 就应运而生了。</p>
</div>
<div class="paragraph">
<p>新问题：到底一个 quicklist 节点包含多长的 ziplist 合适呢？</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>每个quicklist节点上的ziplist越短，则内存碎片越多。</p>
</li>
<li>
<p>每个quicklist节点上的ziplist越长，则为ziplist分配大块连续内存空间的难度就越大。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Redis 提供了一个配置参数 <code>list-max-ziplist-size</code> 让使用者可以来根据自己的情况进行调整:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>list-max-ziplist-size -2</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个参数可正可负：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>当取正值的时候，表示按照数据项个数来限定每个 quicklist 节点上的 ziplist 长度。</p>
</li>
<li>
<p>当取负值的时候，表示按照占用字节数来限定每个 quicklist 节点上的 ziplist 长度。这时，它只能取 <code>-1</code> 到 <code>-5</code> 这五个值，每个值含义如下：</p>
<div class="ulist">
<ul>
<li>
<p><code>-5</code>: 每个 quicklist 节点上的 ziplist 大小不能超过 64 Kb。（注：1kb &#8658; 1024 bytes）</p>
</li>
<li>
<p><code>-4</code>: 每个 quicklist 节点上的 ziplist 大小不能超过 32 Kb。</p>
</li>
<li>
<p><code>-3</code>: 每个 quicklist 节点上的 ziplist 大小不能超过 16 Kb。</p>
</li>
<li>
<p><code>-2</code>: 每个 quicklist 节点上的 ziplist 大小不能超过 8 Kb。（-2是Redis给出的默认值）</p>
</li>
<li>
<p><code>-1</code>: 每个 quicklist 节点上的 ziplist 大小不能超过 4 Kb。</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>list的设计目标是能够用来存储很长的数据列表的。当列表很长的时候，最容易被访问的很可能是两端的数据，中间的数据被访问的频率比较低。list 还提供了一个选项，能够把中间的数据节点进行压缩，从而进一步节省内存空间。Redis 的配置参数 <code>list-compress-depth</code> 就是用来完成这个设置的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>list-compress-depth 0 // 0 是特殊值，表示都不压缩，默认值。</code></pre>
</div>
</div>
<div class="paragraph">
<p>这个参数表示一个quicklist两端不被压缩的节点个数。注：这里的节点个数是指quicklist双向链表的节点个数，而不是指ziplist里面的数据项个数。一个 quicklist 节点上的 ziplist，如果被压缩，就是整体被压缩的。</p>
</div>
<div class="paragraph">
<p>Redis 对于 quicklist 内部节点的压缩算法，采用的 <a href="https://en.wikipedia.org/wiki/LZ4_(compression_algorithm)" target="_blank" rel="noopener">LZF</a> ——一种无损压缩算法。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>添加过程中，如何处理中间位置的压缩工作？</p>
</li>
<li>
<p>头部或者尾部删除，导致 quicklistNode 的非压缩节点不符合设置，怎么处理？</p>
</li>
<li>
<p>如果中间删除，节点为压缩节点，怎么处理？</p>
</li>
</ol>
</div>
</div>
</div>
<div class="listingblock">
<div class="title">quicklist.h</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
</pre></td><td class="code"><pre><span class="cm">/* Node, quicklist, and Iterator are the only data structures used currently. <strong>/</span>

<span class="cm">/</strong> quicklistNode is a 32 byte struct describing a ziplist for a quicklist.
 * We use bit fields keep the quicklistNode at 32 bytes.
 * count: 16 bits, max 65536 (max zl bytes is 65k, so max count actually &lt; 32k).
 * encoding: 2 bits, RAW=1, LZF=2.
 * container: 2 bits, NONE=1, ZIPLIST=2.
 * recompress: 1 bit, bool, true if node is temporarry decompressed for usage.
 * attempted_compress: 1 bit, boolean, used for verifying during testing.
 * extra: 10 bits, free for future use; pads out the remainder of 32 bits <strong>/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklistNode</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">quicklistNode</span> <span class="o"></strong></span><span class="n">prev</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">quicklistNode</span> <span class="o"><strong></span><span class="n">next</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o"></strong></span><span class="n">zl</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>             <span class="cm">/* ziplist size in bytes <strong>/</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>     <span class="cm">/</strong> count of items in ziplist <strong>/</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">encoding</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>   <span class="cm">/</strong> RAW==1 or LZF==2 <strong>/</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">container</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/</strong> NONE==1 or ZIPLIST==2 <strong>/</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recompress</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/</strong> was this node previous compressed? <strong>/</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">attempted_compress</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/</strong> node can't compress; too small <strong>/</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extra</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/</strong> more bits to steal for future usage <strong>/</span>
<span class="p">}</span> <span class="n">quicklistNode</span><span class="p">;</span>

<span class="cm">/</strong> quicklistLZF is a 4+N byte struct holding 'sz' followed by 'compressed'.
 * 'sz' is byte length of 'compressed' field.
 * 'compressed' is LZF data with total (compressed) length 'sz'
 * NOTE: uncompressed length is stored in quicklistNode-&gt;sz.
 * When quicklistNode-&gt;zl is compressed, node-&gt;zl points to a quicklistLZF <strong>/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklistLZF</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span> <span class="cm">/</strong> LZF size in bytes*/</span>
    <span class="kt">char</span> <span class="n">compressed</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">quicklistLZF</span><span class="p">;</span>

<span class="cm">/* Bookmarks are padded with realloc at the end of of the quicklist struct.
 * They should only be used for very big lists if thousands of nodes were the
 * excess memory usage is negligible, and there's a real need to iterate on them
 * in portions.
 * When not used, they don't add any memory overhead, but when used and then
 * deleted, some overhead remains (to avoid resonance).
 * The number of bookmarks used should be kept to minimum since it also adds
 * overhead on node deletion (searching for a bookmark to update). <strong>/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklistBookmark</span> <span class="p">{</span>
    <span class="n">quicklistNode</span> <span class="o"></strong></span><span class="n">node</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o"><strong></span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">quicklistBookmark</span><span class="p">;</span>

<span class="cm">/</strong> quicklist is a 40 byte struct (on 64-bit systems) describing a quicklist.
 * 'count' is the number of total entries.
 * 'len' is the number of quicklist nodes.
 * 'compress' is: -1 if compression disabled, otherwise it's the number
 *                of quicklistNodes to leave uncompressed at ends of quicklist.
 * 'fill' is the user-requested (or default) fill factor.
 * 'bookmakrs are an optional feature that is used by realloc this struct,
 *      so that they don't consume memory when not used. <strong>/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklist</span> <span class="p">{</span>
    <span class="n">quicklistNode</span> <span class="o"></strong></span><span class="n">head</span><span class="p">;</span>
    <span class="n">quicklistNode</span> <span class="o"><strong></span><span class="n">tail</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">;</span>        <span class="cm">/</strong> total count of all entries in all ziplists <strong>/</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>          <span class="cm">/</strong> number of quicklistNodes <strong>/</span>
    <span class="kt">int</span> <span class="n">fill</span> <span class="o">:</span> <span class="n">QL_FILL_BITS</span><span class="p">;</span>              <span class="cm">/</strong> fill factor for individual nodes <strong>/</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">compress</span> <span class="o">:</span> <span class="n">QL_COMP_BITS</span><span class="p">;</span> <span class="cm">/</strong> depth of end nodes not to compress;0=off <strong>/</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bookmark_count</span><span class="o">:</span> <span class="n">QL_BM_BITS</span><span class="p">;</span>
    <span class="n">quicklistBookmark</span> <span class="n">bookmarks</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">quicklist</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklistIter</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">quicklist</span> <span class="o"></strong></span><span class="n">quicklist</span><span class="p">;</span>
    <span class="n">quicklistNode</span> <span class="o"><strong></span><span class="n">current</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o"></strong></span><span class="n">zi</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span> <span class="cm">/* offset in current ziplist <strong>/</span>
    <span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>
<span class="p">}</span> <span class="n">quicklistIter</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">quicklistEntry</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">quicklist</span> <span class="o"></strong></span><span class="n">quicklist</span><span class="p">;</span>
    <span class="n">quicklistNode</span> <span class="o"><strong></span><span class="n">node</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o"></strong></span><span class="n">zi</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">longval</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">quicklistEntry</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/redis/redis-quicklist-structure.png" alt="redis quicklist structure">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="nv">$ </span>redis-cli <span class="nt">--raw</span>

127.0.0.1:6379&gt; RPUSH names diguage <span class="s2">"D瓜哥"</span> <span class="s2">"https://www.diguage.com/"</span>
2

127.0.0.1:6379&gt; LRANGE names 0 <span class="nt">-1</span>
diguage
D瓜哥
https://www.diguage.com/

127.0.0.1:6379&gt; TYPE names
list

127.0.0.1:6379&gt; OBJECT encoding names
quicklist
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_3"><a class="anchor" href="#_参考资料_3"></a>9.8. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.diguage.com/post/redis-core-data-structure-1/" target="_blank" rel="noopener">Redis 核心数据结构（一） - "地瓜哥"博客网</a>&#8201;&#8212;&#8201;本文中的 Redis 内容是这篇文章的一个拷贝。请以原文为准备，本文尽量同步更新。</p>
</li>
<li>
<p><a href="http://zhangtielei.com/posts/blog-redis-ziplist.html" target="_blank" rel="noopener">Redis内部数据结构详解(4)——ziplist</a></p>
</li>
<li>
<p><a href="http://zhangtielei.com/posts/blog-redis-quicklist.html" target="_blank" rel="noopener">Redis内部数据结构详解(5)——quicklist</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>ArrayList更适合随机访问，而LinkedList更适合插入和删除。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>对add(E e)方法的分析，可以得知LinkedList添加数据的效率高；</p>
</li>
<li>
<p>对remove(int index)方法的分析，可以了解到LinkedList删除数据的效率高；</p>
</li>
<li>
<p>对get(int index),set(int index, E element)方法的分析，可以看出LinkdedList查询的效率不高（需要定位，最差要遍历一半）；</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>核心数据结构通过内部类体现，Node就是实际的结点，存放了结点元素和前后结点的引用。</p>
</div>
<div class="paragraph">
<p>在1.7之前LinkedList是通过headerEntry实现的一个首尾相连的循环链表的。<br>
从1.7开始，LinkedList是一个Node实现的非循环链表。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="no">E</span> <span class="n">item</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>

    <span class="nc">Node</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>代码开始</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">java.util</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.function.Consumer</span><span class="o">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_类的继承关系"><a class="anchor" href="#_类的继承关系"></a>9.9. 类的继承关系</h3>
<div class="imageblock">
<div class="content">
<img src="./images/DiagramForLinkedList.png" alt="DiagramForLinkedList">
</div>
</div>
<div class="paragraph">
<p>继承自AbstractSequentialList，一个LinkedList抽象的实现；
重点关注实现了Deque接口。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span>
    <span class="kd">extends</span> <span class="nc">AbstractSequentialList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span>
    <span class="kd">implements</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;,</span> <span class="nc">Deque</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;,</span> <span class="nc">Cloneable</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">Serializable</span>
<span class="o">{</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_类的属性"><a class="anchor" href="#_类的属性"></a>9.10. 类的属性</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//存储元素个数</span>
    <span class="kd">transient</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="c1">//存储头结点</span>
    <span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">first</span><span class="o">;</span>

    <span class="c1">//存储尾结点</span>
    <span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">last</span><span class="o">;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_类的构造器"><a class="anchor" href="#_类的构造器"></a>9.11. 类的构造器</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//无参构造器</span>
    <span class="kd">public</span> <span class="nf">LinkedList</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="c1">//通过一个集合初始化LinkedList，元素顺序由这个集合的迭代器返回顺序决定</span>
    <span class="kd">public</span> <span class="nf">LinkedList</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//调用无参构造器</span>
        <span class="k">this</span><span class="o">();</span>
        <span class="c1">//添加元素</span>
        <span class="n">addAll</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
    <span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_类的方法"><a class="anchor" href="#_类的方法"></a>9.12. 类的方法</h3>
<div class="paragraph">
<p>主要的方法的基础是link和unlink方法组,Node&lt;E&gt; node(int index)定位方法（均不是public）</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/linkedlist-insert-node.png" alt="linkedlist insert node">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//在指定节点前插入节点，节点succ不能为空</span>
    <span class="kt">void</span> <span class="nf">linkBefore</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">succ</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//获取succ的前结点</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">succ</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="n">pred</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">succ</span><span class="o">);</span>
        <span class="n">succ</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span><span class="c1">//如果前结点为空</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="n">size</span><span class="o">++;</span>
        <span class="n">modCount</span><span class="o">++;</span>
    <span class="o">}</span>
    <span class="c1">//把对应参数作为第一个节点，内部使用</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">linkFirst</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//获取头结点</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="c1">//定义新结点</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="kc">null</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">f</span><span class="o">);</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span><span class="c1">//头结点为null</span>
            <span class="c1">// 赋值尾结点（结果只有一个元素）</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="c1">//把原来的首结点的引用指向这个新加的结点</span>
            <span class="n">f</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="n">size</span><span class="o">++;</span>
        <span class="n">modCount</span><span class="o">++;</span>
        <span class="c1">//LinkedList也采用了“快速失败”的机制，通过记录modCount参数来实现。在面对并发的修改时，</span>
        <span class="c1">//迭代器很快就会完全失败，而不是冒着在将来某个不确定时间发生任意不确定行为的风险。</span>

    <span class="o">}</span>

    <span class="c1">//把对应参数作为尾节点（和前一个方法类似）</span>
    <span class="kt">void</span> <span class="nf">linkLast</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 获取尾结点，l为final类型，不可更改</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="n">l</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="n">l</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
        <span class="n">size</span><span class="o">++;</span>
        <span class="n">modCount</span><span class="o">++;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/linkedlist-remove-node.png" alt="linkedlist remove node">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">      <span class="c1">//删除指定节点并返回被删除的元素值</span>
      <span class="no">E</span> <span class="nf">unlink</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">// assert x != null;</span>
          <span class="kd">final</span> <span class="no">E</span> <span class="n">element</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
          <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
          <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>

          <span class="k">if</span> <span class="o">(</span><span class="n">prev</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">first</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="n">prev</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
              <span class="n">x</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>

          <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">last</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
              <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
              <span class="n">x</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>

          <span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="n">size</span><span class="o">--;</span>
          <span class="n">modCount</span><span class="o">++;</span>
          <span class="k">return</span> <span class="n">element</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="c1">//删除首节点并返回删除前首节点的值，内部使用</span>
    <span class="kd">private</span> <span class="no">E</span> <span class="nf">unlinkFirst</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// assert f == first &amp;&amp; f != null;</span>
        <span class="kd">final</span> <span class="no">E</span> <span class="n">element</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
        <span class="n">f</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">f</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">size</span><span class="o">--;</span>
        <span class="n">modCount</span><span class="o">++;</span>
        <span class="k">return</span> <span class="n">element</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//删除尾节点并返回删除前尾节点的值，内部使用</span>
    <span class="kd">private</span> <span class="no">E</span> <span class="nf">unlinkLast</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// assert l == last &amp;&amp; l != null;</span>
        <span class="kd">final</span> <span class="no">E</span> <span class="n">element</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
        <span class="n">l</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">l</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">prev</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">first</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">else</span>
            <span class="n">prev</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">size</span><span class="o">--;</span>
        <span class="n">modCount</span><span class="o">++;</span>
        <span class="k">return</span> <span class="n">element</span><span class="o">;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//获取第一个元素</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">getFirst</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//获取最后一个元素</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">getLast</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
    <span class="o">}</span>

<span class="c1">//删除第一个元素并返回删除的元素</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">removeFirst</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="k">return</span> <span class="nf">unlinkFirst</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
    <span class="o">}</span>
<span class="c1">//删除最后一个元素并返回删除的值</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">removeLast</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="k">return</span> <span class="nf">unlinkLast</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
    <span class="o">}</span>
<span class="c1">//添加元素作为第一个元素</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addFirst</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">linkFirst</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
 <span class="c1">//添加元素作为最后一个元素</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addLast</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">linkLast</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
 <span class="c1">//检查是否包含某个元素，返回bool</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">indexOf</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//返回列表长度</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//添加一个元素，默认添加到末尾作为最后一个元素</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">linkLast</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="c1">//删除指定元素，默认从first节点开始，删除第一次出现的那个元素（需要迭代）</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">unlink</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">unlink</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//添加指定集合的元素到列表，从最后开始添加</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//调用addAll(int index, Collection&lt;? extends E&gt; c)</span>
        <span class="k">return</span> <span class="nf">addAll</span><span class="o">(</span><span class="n">size</span><span class="o">,</span> <span class="n">c</span><span class="o">);</span>
    <span class="o">}</span>
   <span class="c1">//从指定位置往后追加，index和之后的元素向后顺延</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">addAll</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkPositionIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="c1">//转化成数组</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">toArray</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">numNew</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">numNew</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">pred</span><span class="o">,</span> <span class="n">succ</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span><span class="c1">//如果不是从末尾开始添加，获取新加串的前后结点</span>
            <span class="n">succ</span> <span class="o">=</span> <span class="n">node</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">succ</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//遍历数组并添加到列表中</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Object</span> <span class="n">o</span> <span class="o">:</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span> <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">newNode</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Node</span><span class="o">&lt;&gt;(</span><span class="n">pred</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">first</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span><span class="c1">//如果存在前节点，前节点会向后指向新加的节点</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">;</span><span class="c1">//新加的节点成为前一个节点</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">succ</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">pred</span><span class="o">;</span><span class="c1">//如果是从最后开始添加的，则最后添加的节点成为尾节点</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">succ</span><span class="o">;</span><span class="c1">//如果不是从最后开始添加的，则最后添加的节点向后指向之前得到的后续第一个节点</span>
            <span class="n">succ</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pred</span><span class="o">;</span><span class="c1">//后续的第一个节点也应改为向前指向最后一个添加的节点</span>
        <span class="o">}</span>

        <span class="n">size</span> <span class="o">+=</span> <span class="n">numNew</span><span class="o">;</span>
        <span class="n">modCount</span><span class="o">++;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//清空表</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//方便gc回收垃圾</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">x</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">x</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">modCount</span><span class="o">++;</span>
    <span class="o">}</span>

    <span class="c1">//获取指定索引的节点的值</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkElementIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">node</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">item</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//修改指定索引的值并返回之前的值</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkElementIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">node</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="no">E</span> <span class="n">oldVal</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="c1">//只是把item替换掉</span>
        <span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">oldVal</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//在指定位置后面添加元素</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkPositionIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">size</span><span class="o">)</span>
            <span class="n">linkLast</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
        <span class="k">else</span>
            <span class="nf">linkBefore</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">node</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//删除指定位置的元素</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">remove</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkElementIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">unlink</span><span class="o">(</span><span class="n">node</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//检查索引是否超出范围（checkElementIndex调用），因为元素索引是0~size-1的，所以index必须满足0&lt;=index&lt;size</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isElementIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//检查位置是否超出范围（checkPositionIndex调用），index必须在index~size之间（含），如果超出，返回false</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isPositionIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//异常详情</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">outOfBoundsMsg</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Index: "</span><span class="o">+</span><span class="n">index</span><span class="o">+</span><span class="s">", Size: "</span><span class="o">+</span><span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//检查元素索引是否超出范围（set,get,remove时检查），若已超出，就抛出异常</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkElementIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isElementIndex</span><span class="o">(</span><span class="n">index</span><span class="o">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//检查位置是否超出范围（为添加和迭代检查使用），若已超出，就抛出异常</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkPositionIndex</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isPositionIndex</span><span class="o">(</span><span class="n">index</span><span class="o">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IndexOutOfBoundsException</span><span class="o">(</span><span class="n">outOfBoundsMsg</span><span class="o">(</span><span class="n">index</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="c1">//获取指定位置的节点</span>
    <span class="c1">//该方法返回双向链表中指定位置处的节点，而链表中是没有下标索引的，要指定位置出的元素，就要遍历该链表，从源码的实现中，我们看到这里有一个加速动作。</span>
    <span class="c1">//源码中先将index与长度size的一半比较，如果index&lt;size/2，就只从位置0往后遍历到位置index处，而如果index&gt;size/2，就只从位置size往前遍历到位置index处。这样可以减少一部分不必要的遍历。</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">node</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// assert isElementIndex(index);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">index</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">index</span><span class="o">;</span> <span class="n">i</span><span class="o">--)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//获取第一个指定元素的索引位置并返回索引，不存在就返回-1</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">indexOf</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
                <span class="n">index</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">))</span>
                    <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
                <span class="n">index</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//获取最后一个指定元素索引的索引并返回索引，不存在就返回-1</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">lastIndexOf</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">index</span><span class="o">--;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">index</span><span class="o">--;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">))</span>
                    <span class="k">return</span> <span class="n">index</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Queue操作</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//提供普通队列和双端队列的功能，FIFO</span>
     <span class="c1">//出队（从前端），获得第一个元素，不存在会返回null，不会删除元素（节点）</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">peek</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">f</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//出队（从前端），不删除元素，若为null会抛出异常而不是返回null</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">element</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getFirst</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//出队（从前端），如果不存在会返回null，存在的话会返回值并移除这个元素（节点）</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">poll</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">unlinkFirst</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//出队（从前端），如果不存在会抛出异常而不是返回null，存在的话会返回值并移除这个元素（节点）</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">removeFirst</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//入队（从后端），始终返回true</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Deque（双端队列）操作</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//入队（从前端），始终返回true</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offerFirst</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addFirst</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//入队（从后端），始终返回true</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offerLast</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addLast</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//出队（从前端），获得第一个元素，不存在会返回null，不会删除元素（节点）</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">peekFirst</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">f</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
     <span class="o">}</span>
     <span class="c1">//出队（从后端），获得最后一个元素，不存在会返回null，不会删除元素（节点）</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">peekLast</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//出队（从前端），获得第一个元素，不存在会返回null，会删除元素（节点）</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">pollFirst</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">unlinkFirst</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//出队（从后端），获得最后一个元素，不存在会返回null，会删除元素（节点）</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">pollLast</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">unlinkLast</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//入栈，从前面添加</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">push</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">addFirst</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//出栈，返回栈顶元素，从前面移除（会删除）</span>
    <span class="kd">public</span> <span class="no">E</span> <span class="nf">pop</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">removeFirst</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//删除列表中第一出现o的节点</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeFirstOccurrence</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">remove</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//逆向搜索，删除第一次出现o的节点</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">removeLastOccurrence</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">unlink</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">last</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">unlink</span><span class="o">(</span><span class="n">x</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre> 通用迭代器实现  继承自AbstractSequentialList的方法，AbstractSequentialList抽象类中
 public Iterator&lt;E&gt; iterator() {
       return listIterator();
 }
通用迭代器与ArrayList不同，ArrayList自己实现了Iterator，说明linkedlist的迭代器天生支持反向迭代。</pre>
</div>
</div>
<div class="paragraph">
<p>ListIterator迭代器实现与ArrayList类似
其中的ListItr继承Itr，实现了ListIterator接口，同时重写了hasPrevious()，nextIndex()， previousIndex()，previous()，set(E e)，add(E e)等方法，
所以这也可以看出了Iterator和ListIterator的区别，就是ListIterator在Iterator的基础上增加了添加对象，修改对象，
逆向遍历等方法。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="kd">public</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">listIterator</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkPositionIndex</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ListItr</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">ListItr</span> <span class="kd">implements</span> <span class="nc">ListIterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lastReturned</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">nextIndex</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>

        <span class="nc">ListItr</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// assert isPositionIndex(index);</span>
            <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">size</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">node</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
            <span class="n">nextIndex</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">nextIndex</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">hasNext</span><span class="o">())</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>

            <span class="n">lastReturned</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
            <span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="n">nextIndex</span><span class="o">++;</span>
            <span class="k">return</span> <span class="n">lastReturned</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasPrevious</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">nextIndex</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="no">E</span> <span class="nf">previous</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">hasPrevious</span><span class="o">())</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>

            <span class="n">lastReturned</span> <span class="o">=</span> <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="n">last</span> <span class="o">:</span> <span class="n">next</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
            <span class="n">nextIndex</span><span class="o">--;</span>
            <span class="k">return</span> <span class="n">lastReturned</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">nextIndex</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">nextIndex</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">previousIndex</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">nextIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lastReturned</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>

            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lastNext</span> <span class="o">=</span> <span class="n">lastReturned</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="n">unlink</span><span class="o">(</span><span class="n">lastReturned</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="n">lastReturned</span><span class="o">)</span>
                <span class="n">next</span> <span class="o">=</span> <span class="n">lastNext</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="n">nextIndex</span><span class="o">--;</span>
            <span class="n">lastReturned</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">expectedModCount</span><span class="o">++;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lastReturned</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="n">lastReturned</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
            <span class="n">lastReturned</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">linkLast</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="k">else</span>
                <span class="nf">linkBefore</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
            <span class="n">nextIndex</span><span class="o">++;</span>
            <span class="n">expectedModCount</span><span class="o">++;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">==</span> <span class="n">expectedModCount</span> <span class="o">&amp;&amp;</span> <span class="n">nextIndex</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="na">item</span><span class="o">);</span>
                <span class="n">lastReturned</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
                <span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="n">nextIndex</span><span class="o">++;</span>
            <span class="o">}</span>
            <span class="n">checkForComodification</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">void</span> <span class="nf">checkForComodification</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//节点的数据结构内部类，包含前后节点的引用和当前节点</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="no">E</span> <span class="n">item</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>

        <span class="nc">Node</span><span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">item</span> <span class="o">=</span> <span class="n">element</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//反向迭代器（实现Deque接口）</span>
    <span class="c1">//Deque接口定义的方法，实现Iterator接口，用listIterator迭代器返回一个迭代在此双端队列逆向顺序的元素</span>
    <span class="kd">public</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">descendingIterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DescendingIterator</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">DescendingIterator</span> <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ListItr</span> <span class="n">itr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ListItr</span><span class="o">(</span><span class="n">size</span><span class="o">());</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">itr</span><span class="o">.</span><span class="na">hasPrevious</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="no">E</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">itr</span><span class="o">.</span><span class="na">previous</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">itr</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">superClone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;)</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CloneNotSupportedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InternalError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//与ArrayList一样都是调用super。clone()</span>
    <span class="c1">//protected native Object clone() throws CloneNotSupportedException;</span>
    <span class="c1">//被复制对象的所有变量都含有与原来的对象相同的值，而所有的对其他对象的引用仍然指向原来的对象。</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">clone</span> <span class="o">=</span> <span class="n">superClone</span><span class="o">();</span>

        <span class="c1">// Put clone into "virgin" state</span>
        <span class="n">clone</span><span class="o">.</span><span class="na">first</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="na">last</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">clone</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">clone</span><span class="o">.</span><span class="na">modCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="c1">// Initialize clone with our elements</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="n">clone</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">clone</span><span class="o">;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>转换成数组</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="kd">public</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">size</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">++]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="c1">//如果没有参数，就默认生成一个Object数组，如果给了T类型，就将节点内容放入a数组，</span>
    <span class="c1">//如果a的长度小于链表，就使用反射生成一个链表大小的数组，这个时候由于类型是T，所以无法直接实例化。</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span><span class="o">[]</span> <span class="nf">toArray</span><span class="o">(</span><span class="no">T</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">[])</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">reflect</span><span class="o">.</span><span class="na">Array</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span>
                                <span class="n">a</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getComponentType</span><span class="o">(),</span> <span class="n">size</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">++]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="n">size</span><span class="o">)</span>
            <span class="n">a</span><span class="o">[</span><span class="n">size</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果声明该方法，它将会被ObjectOutputStream调用而不是默认的序列化进程。如果你是第一次看见它，
你会很惊奇尽管它们被外部类调用但事实上这是两个private的方法。并且它们既不存在于java.lang.Object，也没有在Serializable中声明。
那么ObjectOutputStream如何使用它们的呢？这个吗，ObjectOutputStream使用了反射来寻找是否声明了这两个方法。
因为ObjectOutputStream使用getPrivateMethod，所以这些方法不得不被声明为priate以至于供ObjectOutputStream来使用。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">876323262645176354L</span><span class="o">;</span>
    <span class="c1">//定义了自己的序列化方法，通过反射调用</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">writeObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectOutputStream</span> <span class="n">s</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="c1">// Write out any hidden serialization magic</span>
        <span class="n">s</span><span class="o">.</span><span class="na">defaultWriteObject</span><span class="o">();</span>

        <span class="c1">// Write out size</span>
        <span class="n">s</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>

        <span class="c1">// Write out all elements in the proper order.</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">x</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
            <span class="n">s</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="na">item</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">readObject</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">ObjectInputStream</span> <span class="n">s</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
        <span class="c1">// Read in any hidden serialization magic</span>
        <span class="n">s</span><span class="o">.</span><span class="na">defaultReadObject</span><span class="o">();</span>

        <span class="c1">// Read in size</span>
        <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>

        <span class="c1">// Read in all elements in the proper order.</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
            <span class="n">linkLast</span><span class="o">((</span><span class="no">E</span><span class="o">)</span><span class="n">s</span><span class="o">.</span><span class="na">readObject</span><span class="o">());</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java">    <span class="c1">//以下关于1.8函数式编程</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">LLSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;(</span><span class="k">this</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">LLSpliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">BATCH_UNIT</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="o">;</span>  <span class="c1">// batch array size increment</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_BATCH</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="o">;</span>  <span class="c1">// max batch array size;</span>
        <span class="kd">final</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">;</span> <span class="c1">// null OK unless traversed</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">current</span><span class="o">;</span>      <span class="c1">// current node; null until initialized</span>
        <span class="kt">int</span> <span class="n">est</span><span class="o">;</span>              <span class="c1">// size estimate; -1 until first needed</span>
        <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">;</span> <span class="c1">// initialized when est set</span>
        <span class="kt">int</span> <span class="n">batch</span><span class="o">;</span>            <span class="c1">// batch size for splits</span>

        <span class="nc">LLSpliterator</span><span class="o">(</span><span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">,</span> <span class="kt">int</span> <span class="n">est</span><span class="o">,</span> <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">list</span> <span class="o">=</span> <span class="n">list</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">est</span> <span class="o">=</span> <span class="n">est</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">expectedModCount</span> <span class="o">=</span> <span class="n">expectedModCount</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getEst</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">s</span><span class="o">;</span> <span class="c1">// force initialization</span>
            <span class="kd">final</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">lst</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">est</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">lst</span> <span class="o">=</span> <span class="n">list</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">est</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">else</span> <span class="o">{</span>
                    <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">modCount</span><span class="o">;</span>
                    <span class="n">current</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">first</span><span class="o">;</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">est</span> <span class="o">=</span> <span class="n">lst</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">estimateSize</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="n">getEst</span><span class="o">();</span> <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="nf">trySplit</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">getEst</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">batch</span> <span class="o">+</span> <span class="no">BATCH_UNIT</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="no">MAX_BATCH</span><span class="o">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="no">MAX_BATCH</span><span class="o">;</span>
                <span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">n</span><span class="o">];</span>
                <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">do</span> <span class="o">{</span> <span class="n">a</span><span class="o">[</span><span class="n">j</span><span class="o">++]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">;</span> <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">);</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                <span class="n">batch</span> <span class="o">=</span> <span class="n">j</span><span class="o">;</span>
                <span class="n">est</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">j</span><span class="o">;</span>
                <span class="k">return</span> <span class="nc">Spliterators</span><span class="o">.</span><span class="na">spliterator</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">ORDERED</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forEachRemaining</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">getEst</span><span class="o">())</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">current</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="n">est</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">do</span> <span class="o">{</span>
                    <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                    <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">p</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryAdvance</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="no">E</span><span class="o">&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">getEst</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">--</span><span class="n">est</span><span class="o">;</span>
                <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">item</span><span class="o">;</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">list</span><span class="o">.</span><span class="na">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">characteristics</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">ORDERED</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">SIZED</span> <span class="o">|</span> <span class="nc">Spliterator</span><span class="o">.</span><span class="na">SUBSIZED</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>LinkedList与ArrayList的区别：
LinkedList与ArrayList在性能上各有优缺点，都有各自适用的地方，总结如下：</p>
</div>
<div class="paragraph">
<p>ArrayList是实现了基于动态数组的数据结构，LinkedList基于链表的数据结构。<br>
LinkedList不支持高效的随机元素访问。<br>
ArrayList的空间浪费主要体现在在list列表的结尾预留一定的容量空间，<br>
而LinkedList的空间花费则体现在它的每一个元素都需要消耗相当的空间（需要附加的空间来表明数据元素的逻辑关系），就存储密度来说，ArrayList是优于LinkedList的。 +　　
当操作是在一列数据的后面添加数据而不是在前面或中间,并且需要随机地访问其中的元素时,使用ArrayList会提供比较好的性能，<br>
当你的操作是在一列数据的前面或中间添加或删除数据,并且按照顺序访问其中的元素时,就应该使用LinkedList了。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stack"><a class="anchor" href="#_stack"></a>10. Stack</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="./diag-ed946db2eaa1bc342b024b4603e1bdb7.svg" alt="Diagram" width="90%" height="632">
</div>
</div>
<div class="paragraph">
<p><code>Stack</code> 的实现极其简单。可以用几句话概括完：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>Stack</code> 直接继承至 <code>Vector</code>，在其基础之上，只是增加了栈相关的操作；</p>
</li>
<li>
<p>在方法上使用 <code>synchronized</code> 来实现线程安全；</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vector"><a class="anchor" href="#_vector"></a>11. Vector</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="./diag-5000daf84d61359eb49e6e0c1e6587f4.svg" alt="Diagram" width="90%" height="524">
</div>
</div>
<div class="paragraph">
<p><code>Vector</code> 内部实现与 <code>ArrayList</code> 类似，都是使用数组来存储元素。不同的是，<code>Vector</code> 在方法上加了 <code>synchronized</code> 修饰词，来实现线程安全。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_set"><a class="anchor" href="#_set"></a>12. Set</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_abstractset"><a class="anchor" href="#_abstractset"></a>13. AbstractSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_sortedset"><a class="anchor" href="#_sortedset"></a>14. SortedSet</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_redis_的_skiplist"><a class="anchor" href="#_redis_的_skiplist"></a>14.1. Redis 的 SkipList</h3>
<div class="paragraph">
<p>跳跃表是一种有序数据结构，支持平均 O(logN)、最坏 O(N) 复杂度的节点查找；大部分情况效率可以和平衡树相媲美，实现却比平衡树简单。</p>
</div>
<div class="paragraph">
<p>跳跃表就是 Redis 中有序集合键的底层实现之一。</p>
</div>
<div class="listingblock">
<div class="title">server.h</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="p">{</span>
    <span class="n">sds</span> <span class="n">ele</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">score</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="o"><strong></span><span class="n">backward</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">zskiplistLevel</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="o"></strong></span><span class="n">forward</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">span</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">level</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">zskiplistNode</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">zskiplist</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="o"><strong></span><span class="n">header</span><span class="p">,</span> <span class="o"></strong></span><span class="n">tail</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span> <span class="n">zskiplist</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">zset</span> <span class="p">{</span>
    <span class="n">dict</span> <span class="o"><strong></span><span class="n">dict</span><span class="p">;</span>
    <span class="n">zskiplist</span> <span class="o"></strong></span><span class="n">zsl</span><span class="p">;</span>
<span class="p">}</span> <span class="n">zset</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>skiplist，顾名思义，首先它是一个list。实际上，它是在有序链表的基础上发展起来的。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/redis/skiplist.png" alt="skiplist" width="100%">
</div>
</div>
<div class="paragraph">
<p>当我们想查找数据的时候，可以先沿着跨度大的链进行查找。当碰到比待查数据大的节点时，再回到跨度小的链表中进行查找。</p>
</div>
<div class="paragraph">
<p>skiplist正是受这种多层链表的想法的启发而设计出来的。按照上面生成链表的方式，上面每一层链表的节点个数，是下面一层的节点个数的一半，这样查找过程就非常类似于一个二分查找，使得查找的时间复杂度可以降低到 O(logN)。但是，存在的一个问题是：如果插入新节点后就会打乱上下相邻两层节点是 2:1 的对应关系。如果要维持，则需要调整后面所有的节点。</p>
</div>
<div class="paragraph">
<p>skiplist为了避免这一问题，它不要求上下相邻两层链表之间的节点个数有严格的对应关系，而是为每个节点随机出一个层数(level)。</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/redis/redis-skiplist-insertions.png" alt="redis skiplist insertions" width="100%">
</div>
</div>
<div class="paragraph">
<p>插入操作只需要修改插入节点前后的指针，而不需要对很多节点都进行调整。这就降低了插入操作的复杂度。实际上，这是 skiplist 的一个很重要的特性，这让它在插入性能上明显优于平衡树的方案。</p>
</div>
<div class="paragraph">
<p>skiplist，翻译成中文，可以翻译成“跳表”或“跳跃表”，指的就是除了最下面第1层链表之外，它会产生若干层稀疏的链表，这些链表里面的指针故意跳过了一些节点（而且越高层的链表跳过的节点越多）。这就使得我们在查找数据的时候能够先在高层的链表中进行查找，然后逐层降低，最终降到第1层链表来精确地确定数据位置。在这个过程中，我们跳过了一些节点，从而也就加快了查找速度。</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>在中间插入一个有比较高 Level 的节点，如何维护前面节点到这个节点的这些链接？</p>
</li>
<li>
<p>在平衡树种，如何做范围查找？先确定边界，然后其他节点怎么查找？</p>
</li>
</ol>
</div>
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/redis/redis_skiplist_example.png" alt="redis skiplist example" width="100%">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>skiplist 中 key 允许重复。</p>
</li>
<li>
<p>在比较时，不仅比较分数（即key），还要比较数据自身。</p>
</li>
<li>
<p>第一层链表是双向链表，并且反向指针只有一个。</p>
</li>
<li>
<p>在 skiplist 中可以很方便计算每个元素的排名。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Redis 中的有序集合（sorted set），是在 skiplist, dict 和 ziplist 基础上构建起来的:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>当数据较少时，sorted set是由一个 ziplist 来实现的。其中集合元素按照分值从小到大排序。</p>
</li>
<li>
<p>当数据多的时候，sorted set 是由一个叫 zset 的数据结构来实现的，这个 zset 包含一个 dict + 一个 skiplist。dict 用来查询数据到分数(score)的对应关系，而 skiplist 用来根据分数查询数据（可能是范围查找）。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>转换的条件是：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>有序集合保存的元素数量小于 128 个；（通过参数 <code>zset-max-ziplist-entries</code> 来调节，默认为 128。）</p>
</li>
<li>
<p>有序集合保存的所有元素成员的长度都要小于 64 个字节；（通过参数 <code>zset-max-ziplist-value</code> 来调节，默认为 64。）</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>在 <code>t_zset.c/zsetConvert</code> 中执行转换操作。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="code"><pre><span class="nv">$ </span>redis-cli <span class="nt">--raw</span>

127.0.0.1:6379&gt; ZADD NameRanking 1 <span class="s2">"D瓜哥"</span>
1

127.0.0.1:6379&gt; ZADD NameRanking 2 <span class="s2">"https://www.diguage.com"</span>
1

127.0.0.1:6379&gt; ZADD NameRanking 3 <span class="s2">"https://github.com/diguage"</span>
1

127.0.0.1:6379&gt; ZRANGE NameRanking 0 <span class="nt">-1</span> WITHSCORES
D瓜哥
1
https://www.diguage.com
2
https://github.com/diguage
3

127.0.0.1:6379&gt; TYPE NameRanking
zset

127.0.0.1:6379&gt; OBJECT encoding NameRanking
ziplist

127.0.0.1:6379&gt; ZADD NameRanking 4 <span class="s2">"1234567890123456789012345678901234567890123456789012345678901234"</span>
1

127.0.0.1:6379&gt; ZRANGE NameRanking 0 <span class="nt">-1</span> WITHSCORES
D瓜哥
1
https://www.diguage.com
2
https://github.com/diguage
3
1234567890123456789012345678901234567890123456789012345678901234
4

127.0.0.1:6379&gt; OBJECT encoding NameRanking
ziplist

127.0.0.1:6379&gt; ZADD NameRanking 5 <span class="s2">"12345678901234567890123456789012345678901234567890123456789012345"</span>
1

127.0.0.1:6379&gt; ZRANGE NameRanking 0 <span class="nt">-1</span> WITHSCORES
D瓜哥
1
https://www.diguage.com
2
https://github.com/diguage
3
1234567890123456789012345678901234567890123456789012345678901234
4
12345678901234567890123456789012345678901234567890123456789012345
5

127.0.0.1:6379&gt; OBJECT encoding NameRanking
skiplist

127.0.0.1:6379&gt; TYPE NameRanking
zset
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 JDK 中，也有 skiplist 的实现，在 <code>ConcurrentSkipListMap</code> 中。不过，它不是作为一个独立的 <code>Collection</code> 来实现的，而是作为 <code>Map</code> 的一部分来实现的。</p>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_4"><a class="anchor" href="#_参考资料_4"></a>14.2. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.diguage.com/post/redis-core-data-structure-2/" target="_blank" rel="noopener">Redis 核心数据结构（二） - "地瓜哥"博客网</a>&#8201;&#8212;&#8201;本文中的 Redis 内容是这篇文章的一个拷贝。请以原文为准备，本文尽量同步更新。</p>
</li>
<li>
<p><a href="ftp://ftp.cs.umd.edu/pub/skipLists/skiplists.pdf">William Pugh《Skip Lists: A Probabilistic Alternative to Balanced Trees》</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA4NTg1MjM0Mg==&amp;mid=2657261425&amp;idx=1&amp;sn=d840079ea35875a8c8e02d9b3e44cf95&amp;scene=21#wechat_redirect">Redis为什么用跳表而不用平衡树？- 张铁蕾</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_navigableset"><a class="anchor" href="#_navigableset"></a>15. NavigableSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_hashset"><a class="anchor" href="#_hashset"></a>16. HashSet</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_redis_中的_set"><a class="anchor" href="#_redis_中的_set"></a>16.1. Redis 中的 Set</h3>
<div class="paragraph">
<p>Redis 中的集合对象编码可以是：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>intset</p>
</li>
<li>
<p>hashtable</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>转换的条件是：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>集合对象保存的所有元素都是整数值；</p>
</li>
<li>
<p>集合对象保存的元素个数不超过 512 个；（通过参数 <code>set-max-intset-entries</code> 来调整，默认是 512）</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre>127.0.0.1:6379&gt; SADD num 1 3 5
<span class="o">(</span>integer<span class="o">)</span> 3
127.0.0.1:6379&gt; OBJECT encoding num
<span class="s2">"intset"</span>

127.0.0.1:6379&gt; sadd num <span class="s2">"seven"</span>
<span class="o">(</span>integer<span class="o">)</span> 1
127.0.0.1:6379&gt; OBJECT encoding num
<span class="s2">"hashtable"</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>t_set.c/setTypeConvert</code> 中执行转换操作。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_treeset"><a class="anchor" href="#_treeset"></a>17. TreeSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_linkedhashset"><a class="anchor" href="#_linkedhashset"></a>18. LinkedHashSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_bitset"><a class="anchor" href="#_bitset"></a>19. BitSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_enumset"><a class="anchor" href="#_enumset"></a>20. EnumSet</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_map"><a class="anchor" href="#_map"></a>21. Map</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_sortedmap"><a class="anchor" href="#_sortedmap"></a>22. SortedMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_navigablemap"><a class="anchor" href="#_navigablemap"></a>23. NavigableMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_abstractmap"><a class="anchor" href="#_abstractmap"></a>24. AbstractMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_hashmap"><a class="anchor" href="#_hashmap"></a>25. HashMap</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_hashmap_问题集"><a class="anchor" href="#_hashmap_问题集"></a>25.1. HashMap 问题集</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>如果判断是否到达容量阈值？</p>
</li>
<li>
<p>为什么</p>
</li>
<li>
<p>遍历查找时，如果保证可以让红黑树的节点也可以使用next方法来查找？</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_redis_中的字典"><a class="anchor" href="#_redis_中的字典"></a>25.2. Redis 中的字典</h3>
<div class="paragraph">
<p>Redis 底层中的字典就是一个典型的 Hash 实现。</p>
</div>
<div class="listingblock">
<div class="title">dict.h</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">dictEntry</span> <span class="p">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="kt">void</span> <span class="o"><strong></span><span class="n">key</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="o"></strong></span><span class="n">val</span><span class="p">;</span>
        <span class="kt">uint64_t</span> <span class="n">u64</span><span class="p">;</span>
        <span class="kt">int64_t</span> <span class="n">s64</span><span class="p">;</span>
        <span class="kt">double</span> <span class="n">d</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">v</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">dictEntry</span> <span class="o"><strong></span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dictEntry</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">dictType</span> <span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="p">(</span><span class="o"></strong></span><span class="n">hashFunction</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="o"><strong></span><span class="n">key</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o"></strong></span><span class="p">(</span><span class="o"><strong></span><span class="n">keyDup</span><span class="p">)(</span><span class="kt">void</span> <span class="o"></strong></span><span class="n">privdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o"><strong></span><span class="n">key</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o"></strong></span><span class="p">(</span><span class="o"><strong></span><span class="n">valDup</span><span class="p">)(</span><span class="kt">void</span> <span class="o"></strong></span><span class="n">privdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o"><strong></span><span class="n">obj</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o"></strong></span><span class="n">keyCompare</span><span class="p">)(</span><span class="kt">void</span> <span class="o"><strong></span><span class="n">privdata</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o"></strong></span><span class="n">key1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o"><strong></span><span class="n">key2</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o"></strong></span><span class="n">keyDestructor</span><span class="p">)(</span><span class="kt">void</span> <span class="o"><strong></span><span class="n">privdata</span><span class="p">,</span> <span class="kt">void</span> <span class="o"></strong></span><span class="n">key</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o"><strong></span><span class="n">valDestructor</span><span class="p">)(</span><span class="kt">void</span> <span class="o"></strong></span><span class="n">privdata</span><span class="p">,</span> <span class="kt">void</span> <span class="o"><strong></span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span> <span class="n">dictType</span><span class="p">;</span>

<span class="cm">/</strong> This is our hash table structure. Every dictionary has two of this as we
 * implement incremental rehashing, for the old to the new table. <strong>/</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">dictht</span> <span class="p">{</span>
    <span class="n">dictEntry</span> <span class="o"></strong>*</span><span class="n">table</span><span class="p">;</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sizemask</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dictht</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">dict</span> <span class="p">{</span>
    <span class="n">dictType</span> <span class="o"><strong></span><span class="n">type</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o"></strong></span><span class="n">privdata</span><span class="p">;</span>
    <span class="n">dictht</span> <span class="n">ht</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="kt">long</span> <span class="n">rehashidx</span><span class="p">;</span> <span class="cm">/* rehashing not in progress if rehashidx == -1 <strong>/</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iterators</span><span class="p">;</span> <span class="cm">/</strong> number of iterators currently running */</span>
<span class="p">}</span> <span class="n">dict</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>dictEntry</code> 保存一个键值对。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>table</code> 属性是一个数组，数组中每个元素都是一个指向 <code>dictEntry</code> 结构的指针。</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>通常使用 <code>ht[0]</code>，<code>ht[1]</code> 在 Rehash 时才会用到。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>添加新元素时，和 Java 一样，计算 Key 的哈希值，然后再根据哈希值与长度掩码（<code>sizemask</code>）相与得到数组下标。</p>
</div>
<div class="paragraph">
<p>Redis 底层使用 <a href="https://en.wikipedia.org/wiki/MurmurHash" target="_blank" rel="noopener">MurmurHash2</a> 算法来计算键的哈希值。</p>
</div>
<div class="sect3">
<h4 id="_rehash_操作"><a class="anchor" href="#_rehash_操作"></a>25.2.1. Rehash 操作</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>计算新的数组长度</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>如果是扩容，则 <code>used * 2</code>；</p>
</li>
<li>
<p>如果是缩容，则是第一个大于等于 <code>used</code> 的 2<sup>n</sup>。&#8201;&#8212;&#8201;这点和 Java 不同，<code>HashMap</code> 中没有自动缩容的机制。</p>
</li>
</ol>
</div>
</li>
<li>
<p>将 <code>ht[0]</code> 中的所有键值对重新 Rehash，重新计算哈希值和索引值，放置到 <code>ht[1]</code> 上；</p>
</li>
<li>
<p>迁移完成后，将 <code>ht[1]</code> 设置为 <code>ht[0]</code>，为 <code>ht[1]</code> 创建一个空白哈希表。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>还有几点需要特别注意：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>根据是否正在执行 <code>BGSAVE</code> 或 <code>BGREADWRITEAOF</code> 命令，使用不同的负载阈值来决定是否开启对哈希表的自动扩展工作；</p>
</li>
<li>
<p>当哈希表负载因子小于 0.1 时，会自动开始对哈希表缩容；</p>
</li>
<li>
<p>Rehash 过程是渐进式的：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>开始 Rehash 后，每次对自动进行的添加、删除、查找或更新时，程序会自动将对应的键值对从 <code>ht[0]</code> Rehash 到 <code>ht[1]</code> 上；rehashidx 属性值增一。</p>
</li>
<li>
<p>记得有后台定时任务来自动扩展的，怎么没有看到说明文档？</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Redis 在哈希对象上的编码有可能是：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ziplist</p>
</li>
<li>
<p>hashtable</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>转换条件是：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>哈希对象保存的所有键值对象字符串长度都小于 64 个字节；（通过参数 <code>hash-max-ziplist-value</code> 来调节，默认为 64）</p>
</li>
<li>
<p>哈希对象保存的键值对数量小于 512 个；（通过参数 <code>hash-max-ziplist-entries</code> 来调节，默认为 512）</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="nv">$ </span>redis-cli <span class="nt">--raw</span>

127.0.0.1:6379&gt; HMSET profile name <span class="s2">"D瓜哥"</span> site <span class="s2">"https://www.diguage.com"</span> job <span class="s2">"Developer"</span>
OK

127.0.0.1:6379&gt; TYPE profile
<span class="nb">hash

</span>127.0.0.1:6379&gt; OBJECT encoding profile
ziplist

127.0.0.1:6379&gt; HSET profile address <span class="s2">"1234567890123456789012345678901234567890123456789012345678901234"</span> <i class="conum" data-value="1"></i><b>(1)</b>
1

127.0.0.1:6379&gt; HVALS profile
D瓜哥
https://www.diguage.com
Developer
1234567890123456789012345678901234567890123456789012345678901234
127.0.0.1:6379&gt; OBJECT encoding profile
ziplist

127.0.0.1:6379&gt; HSET profile address <span class="s2">"12345678901234567890123456789012345678901234567890123456789012345"</span> <i class="conum" data-value="2"></i><b>(2)</b>
0

127.0.0.1:6379&gt; HVALS profile
https://www.diguage.com
D瓜哥
12345678901234567890123456789012345678901234567890123456789012345
Developer

127.0.0.1:6379&gt; OBJECT encoding profile
hashtable
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>这是 64 个字符。</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>这是 65 个字符。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>通过 <code>t_hash.c/hashTypeConvertZiplist</code> 方法来转换。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_5"><a class="anchor" href="#_参考资料_5"></a>25.3. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.diguage.com/post/redis-core-data-structure-2/" target="_blank" rel="noopener">Redis 核心数据结构（二） - "地瓜哥"博客网</a>&#8201;&#8212;&#8201;本文中的 Redis 内容是这篇文章的一个拷贝。请以原文为准备，本文尽量同步更新。</p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzA4NTg1MjM0Mg==&amp;mid=2657261203&amp;idx=1&amp;sn=f7ff61ce42e29b874a8026683875bbb1&amp;scene=21#wechat_redirect">Redis内部数据结构详解(1)——dict</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_简介"><a class="anchor" href="#_简介"></a>25.4. 简介</h3>
<div class="paragraph">
<p>HashMap是基于哈希表实现的，用来存储key-value形式的键值对，允许key和value都为null值；
HashMap是非线程安全的，只是用于单线程环境下，多线程环境下可以采用concurrent并发包下的concurrentHashMap；
HashMap实现了Serializable接口，支持序列化，实现了Cloneable接口，能被克隆。</p>
</div>
</div>
<div class="sect2">
<h3 id="_签名"><a class="anchor" href="#_签名"></a>25.5. 签名</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span>
    <span class="kd">extends</span> <span class="nc">AbstractMap</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span>
    <span class="kd">implements</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;,</span> <span class="nc">Cloneable</span><span class="o">,</span> <span class="nc">Serializable</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>可以看到HashMap 实现了Cloneable和Serializable标记接口：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>标记接口Cloneable，用于表明HashMap对象会重写java.lang.Object#clone()方法，HashMap实现的是浅拷贝（shallow copy）。</p>
</li>
<li>
<p>标记接口Serializable，用于表明HashMap对象可以被序列化。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>HashMap继承了AbstractMap抽象类，同时也实现了Map接口。</strong></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
在语法层面继承接口Map是多余的，这么做仅仅是为了让阅读代码的人明确知道HashMap是属于Map体系的，起到了文档的作用。
AbstractMap相当于个辅助类，Map的一些操作这里面已经提供了默认实现，后面具体的子类如果没有特殊行为，可直接使用AbstractMap提供的实现。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>AbstractMap相当于个辅助类，Map的一些操作这里面已经提供了默认实现，后面具体的子类如果没有特殊行为，可直接使用AbstractMap提供的实现。</p>
</div>
<div class="paragraph">
<p>接口java.util.Map,主要有四个常用的实现类，分别是HashMap、Hashtable、LinkedHashMap和TreeMap，类继承关系如下图所示：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/map_structure.png" alt="map structure">
</div>
</div>
<div class="paragraph">
<p>下面针对各个实现类的特点做一些说明：</p>
</div>
<div class="paragraph">
<p>(1) HashMap：它根据键的hashCode值存储数据，大多数情况下可以直接定位到它的值，因而具有很快的访问速度，但遍历顺序却是不确定的。<br>
HashMap最多只允许一条记录的键为null，允许多条记录的值为null。HashMap非线程安全，即任一时刻可以有多个线程同时写HashMap，<br>
可能会导致数据的不一致。如果需要满足线程安全，可以用 Collections的synchronizedMap方法使HashMap具有线程安全的能力，<br>
或者使用ConcurrentHashMap。</p>
</div>
<div class="paragraph">
<p>(2) Hashtable：Hashtable是遗留类，很多映射的常用功能与HashMap类似，不同的是它承自Dictionary类，并且是线程安全的，<br>
任一时间只有一个线程能写Hashtable，并发性不如ConcurrentHashMap，因为ConcurrentHashMap引入了分段锁。<br>
Hashtable不建议在新代码中使用，不需要线程安全的场合可以用HashMap替换，需要线程安全的场合可以用ConcurrentHashMap替换。<br></p>
</div>
<div class="paragraph">
<p>(3) LinkedHashMap：LinkedHashMap是HashMap的一个子类，保存了记录的插入顺序，在用Iterator遍历LinkedHashMap时，先得到的记录肯定是先插入的，也可以在构造时带参数，按照访问次序排序。</p>
</div>
<div class="paragraph">
<p>(4) TreeMap：TreeMap实现SortedMap接口，能够把它保存的记录根据键排序，默认是按键值的升序排序，也可以指定排序的比较器，当用Iterator遍历TreeMap时，得到的记录是排过序的。如果使用排序的映射，建议使用TreeMap。在使用TreeMap时，key必须实现Comparable接口或者在构造TreeMap传入自定义的Comparator，否则会在运行时抛出java.lang.ClassCastException类型的异常。</p>
</div>
<div class="paragraph">
<p>对于上述四种Map类型的类，要求映射中的key是不可变对象。不可变对象是该对象在创建后它的哈希值不会被改变。如果对象的哈希值发生变化，Map对象很可能就定位不到映射的位置了。</p>
</div>
<div class="paragraph">
<p>通过上面的比较，我们知道了HashMap是Java的Map家族中一个普通成员，鉴于它可以满足大多数场景的使用条件，所以是使用频度最高的一个。下文我们主要结合源码，从存储结构、常用方法分析、扩容等方面了解一下HashMap的工作原理。</p>
</div>
</div>
<div class="sect2">
<h3 id="_存储结构"><a class="anchor" href="#_存储结构"></a>25.6. 存储结构</h3>
<div class="paragraph">
<p>HashMap是基于哈希表存储的，在JDK1.6，JDK1.7版本采用数组(桶位) + 链表实现存储元素和解决冲突，同一hash值的链表都存储在一个链表里。
但是当位于一个桶中的元素较多，即hash值相等的元素较多时，通过key值依次查找的效率较低。但是到JDK1.8版本时HashMap采用位桶 + 链表 + 红黑树实现，
当链表长度超过阈值（8）时，将链表转换为红黑树，这样大大减少了查找时间。</p>
</div>
</div>
<div class="sect2">
<h3 id="_实现原理"><a class="anchor" href="#_实现原理"></a>25.7. 实现原理</h3>
<div class="paragraph">
<p>首先有一个元素是链表的数组，当添加一个元素（key-value）时，就首先计算元素key的hash值，以此确定元素在数组中的位置，但是可能存在同一hash值的元素
已经被放在数组同一位置了（也就出现了Hash冲突），这时就添加到同一hash值的元素的后面，他们在数组的同一位置，但是形成了链表，同一个链表上的Hash值是
相同的，所以说数组存放的是链表。而当链表长度太长时，链表就转换为红黑树，这样大大提高了查找的效率。<br>
当链表数组的容量超过初始容量的0.75（阀值）时，将链表数组扩大2倍，然后把原来数组中的链表重新散列，把原链表数组中的元素迁移到新的数组中。</p>
</div>
<div class="paragraph">
<p>HashMap原理图：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/jdk1.8HashMap.png" alt="jdk1.8HashMap">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_源码剖析"><a class="anchor" href="#_源码剖析"></a>25.8. 源码剖析</h3>
<div class="sect3">
<h4 id="_重要属性"><a class="anchor" href="#_重要属性"></a>25.8.1. 重要属性</h4>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="cm">/**
 *  序列号
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">362498820763181265L</span><span class="o">;</span>

<span class="cm">/**
 *  默认初始容量（容量为HashMap中槽的数目）是16，且必须是2的整数次幂。
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_INITIAL_CAPACITY</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="o">;</span> <span class="c1">// aka 16</span>

<span class="cm">/**
 * 最大容量（必须是2的幂且小于2的30次方，传入容量过大将被这个值替换）
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="o">;</span>

<span class="cm">/**
 * 默认装载因子为0.75
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">float</span> <span class="no">DEFAULT_LOAD_FACTOR</span> <span class="o">=</span> <span class="mf">0.75f</span><span class="o">;</span>

<span class="cm">/**
 * 当put一个元素到某个桶位，其链表长度达到8时将链表转换为红黑树
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">TREEIFY_THRESHOLD</span> <span class="o">=</span> <span class="mi">8</span><span class="o">;</span>

<span class="cm">/**
 * 一个桶位上的链表长度小于这个值时将红黑树转链表
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">UNTREEIFY_THRESHOLD</span> <span class="o">=</span> <span class="mi">6</span><span class="o">;</span>

<span class="cm">/**
 * 树的最小的容量，至少是 4 x TREEIFY_THRESHOLD = 32
 * 然后为了避免(resizing 和 treeification thresholds) 设置成64
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MIN_TREEIFY_CAPACITY</span> <span class="o">=</span> <span class="mi">64</span><span class="o">;</span>

<span class="cm">/**
 * 实际存放元素的个数，不等于数组的长度
 */</span>
<span class="kd">transient</span> <span class="kt">int</span> <span class="n">size</span><span class="o">;</span>

<span class="cm">/**
 * 达到这个阈值就要进行扩容，其等于容量 * 装载因子
 */</span>
<span class="kt">int</span> <span class="n">threshold</span><span class="o">;</span>

<span class="cm">/**
 * 实际装载因子
 */</span>
<span class="kd">final</span> <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">;</span>

<span class="cm">/**
 * 每次扩容和更改map结构的计数器
 * 如果在使用迭代器的过程中有其他线程修改了map，将抛出ConcurrentModificationException，
 * 这就是所谓fail-fast策略（速错），这一策略的实现就是通过modCount
 */</span>
<span class="kd">transient</span> <span class="kt">int</span> <span class="n">modCount</span><span class="o">;</span>

<span class="cm">/*
 * 存放具体key-value对元素的集和
 */</span>
<span class="kd">transient</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">entrySet</span><span class="o">;</span>

<span class="cm">/*
 * 存储元素的数组，总是2的幂次倍
 */</span>
<span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">table</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">加载因子</div>
<div class="paragraph">
<p>加载因子（默认0.75）：为什么需要使用加载因子，为什么需要扩容呢？因为如果加载因子很大，
说明利用的空间很多，如果一直不进行扩容的话，链表就会越来越长，这样查找的效率很低，
因为链表的长度很大（当然最新版本使用了红黑树后会改进很多），扩容之后，将原来链表数
组的每一个链表分成奇偶两个子链表分别挂在新链表数组的散列位置，这样就减少了每个链表
的长度，增加查找效率。HashMap本来是以空间换时间，所以装载因子没必要太大。但是装载因子太小
又会导致空间浪费。如果关注内存，装载因子可以稍大，如果主要关注查找性能，装载因子可以稍小。</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_数据结构"><a class="anchor" href="#_数据结构"></a>25.8.2. 数据结构</h4>
<div class="ulist">
<ul>
<li>
<p>桶位数组</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="cm">/**
 * 1.存储元素（桶位）的数组
 */</span>
<span class="kd">transient</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;[]</span> <span class="n">table</span><span class="o">;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>数组元素Node&lt;K,V&gt;</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">//Node是单向链表，它实现了Map.Entry接口</span>
<span class="kd">static</span> <span class="kd">class</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">;</span>
    <span class="kd">final</span> <span class="no">K</span> <span class="n">key</span><span class="o">;</span>
    <span class="no">V</span> <span class="n">value</span><span class="o">;</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>  <span class="c1">//下一个节点</span>

    <span class="nc">Node</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="no">K</span> <span class="nf">getKey</span><span class="o">()</span>        <span class="o">{</span> <span class="k">return</span> <span class="n">key</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">getValue</span><span class="o">()</span>      <span class="o">{</span> <span class="k">return</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">key</span> <span class="o">+</span> <span class="s">"="</span> <span class="o">+</span> <span class="n">value</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hashCode</span><span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="o">^</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hashCode</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">setValue</span><span class="o">(</span><span class="no">V</span> <span class="n">newValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">V</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">newValue</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;)</span><span class="n">o</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
                    <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">()))</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
其实Node就是一个基于单向链表数据结构的存储key和value的一个对象。next指向下一个Node.实现了Map.Entry接口
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>红黑树</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">LinkedHashMap</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;</span> <span class="n">parent</span><span class="o">;</span>  <span class="c1">//父节点</span>
    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;</span> <span class="n">left</span><span class="o">;</span>    <span class="c1">//左子树</span>
    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;</span> <span class="n">right</span><span class="o">;</span>   <span class="c1">//右子树</span>
    <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">&gt;</span> <span class="n">prev</span><span class="o">;</span>    <span class="c1">// needed to unlink next upon deletion</span>
    <span class="kt">boolean</span> <span class="n">red</span><span class="o">;</span>           <span class="c1">//颜色属性</span>
    <span class="nc">TreeNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">val</span><span class="o">,</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">val</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 返回当前节点的根节点
     */</span>
    <span class="kd">final</span> <span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">root</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="k">this</span><span class="o">,</span> <span class="n">p</span><span class="o">;;)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="na">parent</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">r</span><span class="o">;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">transient 关键字</div>
<div class="paragraph">
<p>Java序列化会把某一个类存储以文件形式存储在物理空间，但是以文件形式存储某些信息时，容易涉及到安全问题，因为数据位于Java运行环境之外，
不在Java安全机制的控制之中。对于这些需要保密的字段，不应保存在永久介质中 ，或者不应简单地不加处理地保存下来 ，为了保证安全性。
应该在这些字段前加上transient关键字。它的意思是临时的，即不会随类一起序列化到本地，所以当还原后，这个关键字定义的变量也就不再存在。</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_构造函数"><a class="anchor" href="#_构造函数"></a>25.8.3. 构造函数</h4>
<div class="ulist">
<ul>
<li>
<p>默认构造函数HashMap()</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nf">HashMap</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">//初始话加载因子为默认0.75；其他属性均为默认</span>
  <span class="k">this</span><span class="o">.</span><span class="na">loadFactor</span> <span class="o">=</span> <span class="no">DEFAULT_LOAD_FACTOR</span><span class="o">;</span> <span class="c1">// all other fields defaulted</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
这是一个默认构造器，潜在的问题是初始容量16太小了，可能中间需要不断扩容的问题，会影响插入的效率。
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>指定初始容量和加载因子的构造函数HashMap(int, float)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nf">HashMap</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span> <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//初始容量不能小于0</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Illegal initial capacity: "</span> <span class="o">+</span>
                <span class="n">initialCapacity</span><span class="o">);</span>
    <span class="c1">// 初始容量不能大于最大值，否则为最大值</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span>
        <span class="n">initialCapacity</span> <span class="o">=</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">;</span>
    <span class="c1">// 填充因子不能小于或等于0，不能为非数字</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">loadFactor</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nc">Float</span><span class="o">.</span><span class="na">isNaN</span><span class="o">(</span><span class="n">loadFactor</span><span class="o">))</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Illegal load factor: "</span> <span class="o">+</span>
                <span class="n">loadFactor</span><span class="o">);</span>
    <span class="c1">//初始话加载因子</span>
    <span class="k">this</span><span class="o">.</span><span class="na">loadFactor</span> <span class="o">=</span> <span class="n">loadFactor</span><span class="o">;</span>
    <span class="c1">//初始化(阀值)threshold，数组元素数量达到该值时会扩容</span>
    <span class="k">this</span><span class="o">.</span><span class="na">threshold</span> <span class="o">=</span> <span class="n">tableSizeFor</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * tableSizeFor的功能主要是用来保证容量应该大于cap,且为2的整数
 */</span>
<span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">tableSizeFor</span><span class="o">(</span><span class="kt">int</span> <span class="n">cap</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
      <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="o">;</span>
      <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">2</span><span class="o">;</span>
      <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="o">;</span>
      <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">8</span><span class="o">;</span>
      <span class="n">n</span> <span class="o">|=</span> <span class="n">n</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">16</span><span class="o">;</span>
      <span class="k">return</span> <span class="o">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">?</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">:</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="qlist qanda">
<ol>
<li>
<p><em>这里可能还有一个疑问，明明给的是初始容量，为什么要计算阀值，而不是容量呢？</em></p>
<p>其实这也是jdk1.8的改变，它将table的初始化放入了resize()中，而且压根就没有capacity这个属性，
所以这里只能重新计算threshold，而resize()后面就会根据threshold来重新计算capacity，来进行
table数组的初始化，然后在重新按照装载因子计算threshold。</p>
</li>
</ol>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
可以指定初始容量，以及装载因子，但是一般情况下指定装载因子意义不大，采用默认0.75就可以。
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>指定初始容量的构造函数HashMap(int initialCapacity)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nf">HashMap</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">initialCapacity</span><span class="o">,</span> <span class="no">DEFAULT_LOAD_FACTOR</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
用这种构造函数创建HashMap的对象，如果知道map要存放的元素个数，可以直接指定容量的大小，
减除不停的扩容，提高效率
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>将已有Map放入当前map的构造函数HashMap(Map&lt;? extends K, ? extends V&gt; m)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nf">HashMap</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">loadFactor</span> <span class="o">=</span> <span class="no">DEFAULT_LOAD_FACTOR</span><span class="o">;</span>  <span class="c1">//初始化加载因子</span>
   <span class="n">putMapEntries</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// 其实就是一个一个取出m中的元素调用putVal,一个个放入table中的过程。</span>
<span class="kd">final</span> <span class="kt">void</span> <span class="nf">putMapEntries</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">evict</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">table</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// pre-size</span>
            <span class="kt">float</span> <span class="n">ft</span> <span class="o">=</span> <span class="o">((</span><span class="kt">float</span><span class="o">)</span><span class="n">s</span> <span class="o">/</span> <span class="n">loadFactor</span><span class="o">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="no">F</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="o">((</span><span class="n">ft</span> <span class="o">&lt;</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">?</span>
                    <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">ft</span> <span class="o">:</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">)</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="n">tableSizeFor</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">)</span>   <span class="c1">//如果m中的元素个数大于阀值，调用resize进行扩容</span>
            <span class="n">resize</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">:</span> <span class="n">m</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="no">K</span> <span class="n">key</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
            <span class="no">V</span> <span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="n">putVal</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">evict</span><span class="o">);</span>  <span class="c1">//调用putVal向map中添加元素</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hashmap存取机制"><a class="anchor" href="#_hashmap存取机制"></a>25.8.4. HashMap存取机制</h4>
<div class="sect4">
<h5 id="_1_添加元素"><a class="anchor" href="#_1_添加元素"></a>1.添加元素</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="no">V</span> <span class="nf">put</span><span class="o">(</span><span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">putVal</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>    <span class="c1">//调用putVal()方法</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK1.8计算hash值</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hash</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">h</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">key</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">(</span><span class="n">h</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">())</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">16</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>JDK1.7计算hash值</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="kt">int</span> <span class="nf">hash</span><span class="o">(</span><span class="nc">Object</span> <span class="n">k</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">hashSeed</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">h</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="k">instanceof</span> <span class="nc">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sun</span><span class="o">.</span><span class="na">misc</span><span class="o">.</span><span class="na">Hashing</span><span class="o">.</span><span class="na">stringHash32</span><span class="o">((</span><span class="nc">String</span><span class="o">)</span> <span class="n">k</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">h</span> <span class="o">^=</span> <span class="n">k</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
    <span class="n">h</span> <span class="o">^=</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">20</span><span class="o">)</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">12</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">h</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">7</span><span class="o">)</span> <span class="o">^</span> <span class="o">(</span><span class="n">h</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
JDK1.8计算hash值的方法进行了改进，取得key的hashcode后，高16位与低16位异或运算重新计算hash值。
key有可能是null，key为null时，hash值为0，放在数组的0位置。
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">putVal()方法</dt>
<dd>
<p>执行过程如图：</p>
</dd>
</dl>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/hashmap_put.png" alt="hashmap put">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="no">V</span> <span class="nf">putVal</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="no">K</span> <span class="n">key</span><span class="o">,</span> <span class="no">V</span> <span class="n">value</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">onlyIfAbsent</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">evict</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">i</span><span class="o">;</span>
    <span class="c1">//table未初始化或者长度为0，进行扩容</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="c1">//可以看到put元素时，如果数组没有初始化，会调用resize()方法进行初始化。后面分析resize()方法</span>
        <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="n">tab</span> <span class="o">=</span> <span class="n">resize</span><span class="o">()).</span><span class="na">length</span><span class="o">;</span>

    <span class="cm">/*
     * 这里就是HASH算法了，用来定位桶位的方式，可以看到是采用容量-1和键的hash值进行与运算
     * n-1,的原因就是n一定是一个2的整数幂，而(n - 1) &amp; hash其实质就是n%hash,但是取余运算
     * 的效率明显不如位运算与，并且(n - 1) &amp; hash也能保证散列均匀，不会产生只有偶数位有值的现象
     */</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="cm">/*
         * 当这里是空桶位时，就直接构造新的Node节点，将其放入桶位中(此时，这个结点是放在数组中)
         * newNode()方法，就是对new Node(,,,)的包装,同时也可以看到Node中的hash值就是重新计算的hash(key)
         */</span>
        <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="c1">//桶中已经存在元素</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span> <span class="no">K</span> <span class="n">k</span><span class="o">;</span>
        <span class="c1">// 比较桶中第一个元素(数组中的结点)的hash值相等，key相等</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
            <span class="c1">//比较桶中第一个元素(数组中的结点)的hash值相等，key相等</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">p</span> <span class="k">instanceof</span> <span class="nc">TreeNode</span><span class="o">)</span>
            <span class="c1">// hash值不相等，即key不相等；为红黑树结点</span>
            <span class="n">e</span> <span class="o">=</span> <span class="o">((</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;)</span><span class="n">p</span><span class="o">).</span><span class="na">putTreeVal</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span> <span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>  <span class="c1">// 放入树中</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 为链表结点</span>
            <span class="c1">// 在链表最末插入结点</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">binCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">;</span> <span class="o">++</span><span class="n">binCount</span><span class="o">)</span> <span class="o">{</span>
              <span class="c1">// 到达链表的尾部</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 在尾部插入新结点</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">newNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="c1">// 结点数量达到阈值，转化为红黑树</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">binCount</span> <span class="o">&gt;=</span> <span class="no">TREEIFY_THRESHOLD</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="c1">// -1 for 1st</span>
                        <span class="n">treeifyBin</span><span class="o">(</span><span class="n">tab</span><span class="o">,</span> <span class="n">hash</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span> <span class="c1">// 跳出循环</span>
                <span class="o">}</span>
                <span class="c1">// 判断链表中结点的key值与插入的元素的key值是否相等</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
                    <span class="k">break</span><span class="o">;</span>   <span class="c1">// 相等，跳出循环</span>
                <span class="c1">// 用于遍历桶中的链表，与前面的e = p.next组合，可以遍历链表</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">// 表示在桶中找到key值、hash值与插入元素相等的结点</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// existing mapping for key</span>
            <span class="no">V</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>  <span class="c1">// 记录e的value</span>
            <span class="c1">// onlyIfAbsent为false或者旧值为null</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">onlyIfAbsent</span> <span class="o">||</span> <span class="n">oldValue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">e</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>  <span class="c1">//用新值替换旧值</span>
            <span class="n">afterNodeAccess</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>   <span class="c1">// 访问后回调</span>
            <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>      <span class="c1">// 返回旧值</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// 结构性修改</span>
    <span class="o">++</span><span class="n">modCount</span><span class="o">;</span>
    <span class="c1">// 实际大小大于阈值则扩容</span>
    <span class="k">if</span> <span class="o">(++</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">)</span>
        <span class="n">resize</span><span class="o">();</span>
    <span class="n">afterNodeInsertion</span><span class="o">(</span><span class="n">evict</span><span class="o">);</span>  <span class="c1">// 插入后回调</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>  <span class="c1">// 返回null</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">resize()方法</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="nf">resize</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 当前table保存</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">oldTab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
    <span class="c1">// 保存table大小</span>
    <span class="kt">int</span> <span class="n">oldCap</span> <span class="o">=</span> <span class="o">(</span><span class="n">oldTab</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">oldTab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="c1">// 保存当前阈值</span>
    <span class="kt">int</span> <span class="n">oldThr</span> <span class="o">=</span> <span class="n">threshold</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">newCap</span><span class="o">,</span> <span class="n">newThr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="c1">// 之前table大小大于0</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">oldCap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 之前table大于最大容量</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">oldCap</span> <span class="o">&gt;=</span> <span class="no">MAXIMUM_CAPACITY</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 阈值为最大整形</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">oldTab</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 容量翻倍，使用左移，效率更高</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">newCap</span> <span class="o">=</span> <span class="n">oldCap</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&lt;</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">&amp;&amp;</span>
            <span class="n">oldCap</span> <span class="o">&gt;=</span> <span class="no">DEFAULT_INITIAL_CAPACITY</span><span class="o">)</span>
            <span class="c1">// 阈值翻倍</span>
            <span class="n">newThr</span> <span class="o">=</span> <span class="n">oldThr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// double threshold</span>
    <span class="o">}</span>
    <span class="c1">// 之前阈值大于0</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">oldThr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="n">newCap</span> <span class="o">=</span> <span class="n">oldThr</span><span class="o">;</span>
    <span class="c1">// oldCap = 0并且oldThr = 0，使用缺省值（如使用HashMap()构造函数，之后再插入一个元素会调用resize函数，会进入这一步）</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="n">newCap</span> <span class="o">=</span> <span class="no">DEFAULT_INITIAL_CAPACITY</span><span class="o">;</span>
        <span class="n">newThr</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="no">DEFAULT_LOAD_FACTOR</span> <span class="o">*</span> <span class="no">DEFAULT_INITIAL_CAPACITY</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 新阈值为0</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newThr</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">float</span> <span class="n">ft</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="n">newCap</span> <span class="o">*</span> <span class="n">loadFactor</span><span class="o">;</span>
        <span class="n">newThr</span> <span class="o">=</span> <span class="o">(</span><span class="n">newCap</span> <span class="o">&lt;</span> <span class="no">MAXIMUM_CAPACITY</span> <span class="o">&amp;&amp;</span> <span class="n">ft</span> <span class="o">&lt;</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span><span class="no">MAXIMUM_CAPACITY</span> <span class="o">?</span>
                  <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="n">ft</span> <span class="o">:</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">newThr</span><span class="o">;</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">"rawtypes"</span><span class="o">,</span><span class="s">"unchecked"</span><span class="o">})</span>
    <span class="c1">// 初始化table</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">newTab</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[])</span><span class="k">new</span> <span class="nc">Node</span><span class="o">[</span><span class="n">newCap</span><span class="o">];</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">newTab</span><span class="o">;</span>
    <span class="c1">// 之前的table已经初始化过</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">oldTab</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 复制元素，重新进行hash</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">oldCap</span><span class="o">;</span> <span class="o">++</span><span class="n">j</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">oldTab</span><span class="o">[</span><span class="n">j</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">oldTab</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                    <span class="n">newTab</span><span class="o">[</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">newCap</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">e</span> <span class="k">instanceof</span> <span class="nc">TreeNode</span><span class="o">)</span>
                    <span class="o">((</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;)</span><span class="n">e</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">newTab</span><span class="o">,</span> <span class="n">j</span><span class="o">,</span> <span class="n">oldCap</span><span class="o">);</span>
                <span class="k">else</span> <span class="o">{</span> <span class="c1">// preserve order</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">loHead</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">loTail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">hiHead</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">hiTail</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>
                    <span class="c1">// 将同一桶中的元素根据(e.hash &amp; oldCap)是否为0进行分割，分成两个不同的链表，完成rehash</span>
                    <span class="k">do</span> <span class="o">{</span>
                        <span class="n">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">&amp;</span> <span class="n">oldCap</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">loTail</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">loHead</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">loTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="n">loTail</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">else</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">hiTail</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                                <span class="n">hiHead</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="k">else</span>
                                <span class="n">hiTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                            <span class="n">hiTail</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">loTail</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">loTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="n">newTab</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">loHead</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">hiTail</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">hiTail</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="n">newTab</span><span class="o">[</span><span class="n">j</span> <span class="o">+</span> <span class="n">oldCap</span><span class="o">]</span> <span class="o">=</span> <span class="n">hiHead</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">newTab</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
扩容实际上就是创建一个容量是原来容量两倍的数组，
把原来数组中的元素经过重新散列，然后添加到新的数组中。
扩容会伴随着一次重新hash分配，并且会遍历hash表中所有
的元素，是非常耗时的。在编写程序中，要尽量避免resize。
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">putAll()方法</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">putAll</span><span class="o">(</span><span class="nc">Map</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">K</span><span class="o">,</span> <span class="o">?</span> <span class="kd">extends</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">m</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">//内部也是调用putVal()方法，将m中的元素循环放入table中</span>
  <span class="n">putMapEntries</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_获取元素"><a class="anchor" href="#_获取元素"></a>获取元素</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="cm">/**
 * 通过key获取value
 */</span>
<span class="kd">public</span> <span class="no">V</span> <span class="nf">get</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">getNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">getNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">first</span><span class="o">,</span> <span class="n">e</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">;</span> <span class="no">K</span> <span class="n">k</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">first</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//如果Node链表的第一个元素相等</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">first</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span> <span class="c1">// always check first node</span>
            <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
            <span class="k">return</span> <span class="n">first</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//红黑树查找</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">first</span> <span class="k">instanceof</span> <span class="nc">TreeNode</span><span class="o">)</span>
                <span class="k">return</span> <span class="o">((</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;)</span><span class="n">first</span><span class="o">).</span><span class="na">getTreeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
            <span class="c1">//链表查找</span>
            <span class="k">do</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
                    <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
                    <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//找不到返回null</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * 判断是否包含指定key
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">containsKey</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">getNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>  <span class="c1">//返回node是否为null</span>
<span class="o">}</span>

<span class="cm">/**
 * 判断是否包含指定value
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">containsValue</span><span class="o">(</span><span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="no">V</span> <span class="n">v</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//按照单链表的方式进行遍历，</span>
            <span class="c1">//因为HashMap中 TreeNode 节点也存在next成员，可以用链表的方式进行遍历</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">];</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">==</span> <span class="n">value</span> <span class="o">||</span>
                        <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">v</span><span class="o">)))</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
get方法相对put要简单的多，分析源码可以看出hash算法的精髓，不用遍历就可以直接通过
计算key的hash值，得到查找元素在数组中的桶位，然后比较hash值、key是否相等来获取node。
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_移除元素"><a class="anchor" href="#_移除元素"></a>移除元素</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="no">V</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">e</span> <span class="o">=</span> <span class="n">removeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">removeNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">,</span>
                           <span class="kt">boolean</span> <span class="n">matchValue</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">movable</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">;</span> <span class="kt">int</span> <span class="n">n</span><span class="o">,</span> <span class="n">index</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="o">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">index</span> <span class="o">=</span> <span class="o">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">hash</span><span class="o">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//node就是要查找的结点</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="kc">null</span><span class="o">,</span> <span class="n">e</span><span class="o">;</span> <span class="no">K</span> <span class="n">k</span><span class="o">;</span> <span class="no">V</span> <span class="n">v</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
            <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span> <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="k">instanceof</span> <span class="nc">TreeNode</span><span class="o">)</span>
                <span class="n">node</span> <span class="o">=</span> <span class="o">((</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;)</span><span class="n">p</span><span class="o">).</span><span class="na">getTreeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">key</span><span class="o">);</span>
            <span class="k">else</span> <span class="o">{</span>
                <span class="k">do</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span>
                        <span class="o">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)</span> <span class="o">==</span> <span class="n">key</span> <span class="o">||</span>
                         <span class="o">(</span><span class="n">key</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">k</span><span class="o">))))</span> <span class="o">{</span>
                        <span class="n">node</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">//这里p保存的是父节点，因为这里涉及到链表删除的操作</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">while</span> <span class="o">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="cm">/*
         * 当matchValue为false时，直接短路后面的运算，
         * 进行删除操作，而不用关注value值是否相等或者equals
         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(!</span><span class="n">matchValue</span> <span class="o">||</span> <span class="o">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">value</span><span class="o">)</span> <span class="o">==</span> <span class="n">value</span> <span class="o">||</span>
                             <span class="o">(</span><span class="n">value</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">v</span><span class="o">))))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">node</span> <span class="k">instanceof</span> <span class="nc">TreeNode</span><span class="o">)</span>
                <span class="c1">//movable用在树的删除上</span>
                <span class="o">((</span><span class="nc">TreeNode</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;)</span><span class="n">node</span><span class="o">).</span><span class="na">removeTreeNode</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">tab</span><span class="o">,</span> <span class="n">movable</span><span class="o">);</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">node</span> <span class="o">==</span> <span class="n">p</span><span class="o">)</span>
                 <span class="c1">//要删除节点就是链表的头节点，则将子节点放进桶位</span>
                <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="k">else</span>
                <span class="c1">//删除节点后节点，父节点的next重新连接</span>
                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
            <span class="o">++</span><span class="n">modCount</span><span class="o">;</span> <span class="c1">//删除操作也是要记录进modCount</span>
            <span class="o">--</span><span class="n">size</span><span class="o">;</span>
            <span class="n">afterNodeRemoval</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">node</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * jdk1.8新增的重载方法，matchValue为true时，
 * 只有当key和value都相等时，才会删除
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">removeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_小结"><a class="anchor" href="#_小结"></a>25.9. 小结</h3>
<div class="paragraph">
<p>本文对JDK1.8 HashMap的原代码进行了简要的分析，主要目的是了解其内部的
存储机制和实现原理，从而达到在编程中更高效的使用HashMap。<br></p>
</div>
<div class="paragraph">
<p>HashMap 内部是基于一个数组来实现的，数组中的每个元素称为一个桶(bucket)。
当数组中被占用的桶的数量超过了装载因子和数组容量设定的阈值后，会对数组进行扩容，
容量将扩展为原来的2倍。哈希表中所有的 Entry 会被重新散列到新的位置中。<br></p>
</div>
<div class="paragraph">
<p>因为两个不同的key在散列时有可能发生冲突，HashMap为了避免哈希冲突带来的影响
做了几点优化。在进行散列处理时，将高位与低位进行异或，从而减小冲突的概率。
当不同的node被散列到同一个桶中时，每个桶中使用单向链表的方式来保存数据。
在Java 8 的实现中，如果一个桶中的Node数量超过了阈值(TREEIFY_THRESHOLD = 8)，
就会将单链表转化为红黑树，当低于阈值(UNTREEIFY_THRESHOLD = 6)时重新转化为
单链表。<br></p>
</div>
<div class="paragraph">
<p>分析了HashMap的resize方法可以知道，HashMap在进行扩容时是非常耗性能的操作，
所以在使用HashMap的时候，应该先估算一下map的大小，初始化的时候给一个大致的数值，
避免map进行频繁的扩容。</p>
</div>
</div>
<div class="sect2">
<h3 id="_参考"><a class="anchor" href="#_参考"></a>25.10. 参考</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://blog.jrwang.me/2016/java-collections-hashmap/">Java 容器源码分析之 HashMap</a><br></p>
</li>
<li>
<p><a href="http://www.tuicode.com/article/56da289f8e6d72823e30a024">JDK1.8源码分析之HashMap（一）</a><br></p>
</li>
<li>
<p><a href="http://blog.csdn.net/tuke_tuke/article/details/51588156"> Java中HashMap底层实现原理(JDK1.8)源码分析</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/ToBeAProgrammer/p/4787761.html">基于jdk1.8的HashMap源码学习笔记</a><br></p>
</li>
<li>
<p><a href="http://tech.meituan.com/java-hashmap.html">Java 8系列之重新认识HashMap</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_jdk_1_8_的实现"><a class="anchor" href="#_jdk_1_8_的实现"></a>25.11. JDK 1.8 的实现</h3>
<div class="paragraph">
<p><strong>继上一章介绍了HashMap的签名、数据结构以及存储原理之后，相信大家对HashMap有了更加深入的理解，在使用时也会得心应手。</strong><br>
<strong>本章将继续介绍HashMap的使用，主要是分析HashMap的三种遍历方式。</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_hashmap遍历"><a class="anchor" href="#_hashmap遍历"></a>25.12. HashMap遍历</h3>
<hr>
<div class="ulist">
<ul>
<li>
<p><strong>HashMap提供了三种遍历方式：</strong></p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>遍历所有的Key：Set&lt;K&gt; keySet()</p>
</li>
<li>
<p>遍历所有的Entry：Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet()</p>
</li>
<li>
<p>遍历所有的Value（不常用）：Collection&lt;V&gt; values()</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>这三个方法的基本用法将不在详细介绍，它们都是返回可迭代的Set或者Collection。要弄清楚这三个方法
的内部实现机制，首先主要来看一下内部抽象类#HashIterator#。<br></p>
</div>
<div class="ulist">
<ul>
<li>
<p>HashIterator内部类：</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">HashIterator</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">next</span><span class="o">;</span>        <span class="c1">// next entry to return</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">current</span><span class="o">;</span>     <span class="c1">// current entry</span>
    <span class="kt">int</span> <span class="n">expectedModCount</span><span class="o">;</span>  <span class="c1">// for fast-fail</span>
    <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>             <span class="c1">// current slot</span>

    <span class="nc">HashIterator</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//用expectedModCount保存刚创建迭代器时的modCount，</span>
        <span class="c1">//实现fail-fast机制需要对比该值和使用时的modCount</span>
        <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="c1">//找到第一个有效的槽</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// advance to first entry</span>
            <span class="k">do</span> <span class="o">{}</span> <span class="k">while</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">next</span> <span class="o">=</span> <span class="n">t</span><span class="o">[</span><span class="n">index</span><span class="o">++])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">hasNext</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">next</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">nextNode</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">t</span><span class="o">;</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="cm">/*
         * fail-fast 检查
         * 当另外一个线程对当前Map修改时，会修改modCount，
         * 当前线程遍历正在，如果expectedModCount和modCount
         * 不相等，就会抛出ConcurrentModificationException异常
         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
        <span class="c1">// table数组中没有元素，抛出NoSuchElementException异常</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">();</span>
        <span class="c1">//next = e.next</span>
        <span class="c1">//遍历是通过单链表的方式来访问的，即便是红黑树也可以这样来遍历</span>
        <span class="c1">//TreeNode中也存在next引用，也可以看做单链表</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="n">current</span> <span class="o">=</span> <span class="n">e</span><span class="o">).</span><span class="na">next</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//如果到达当前链表末尾next == null</span>
            <span class="c1">//寻找下一个有效的槽</span>
            <span class="k">do</span> <span class="o">{}</span> <span class="k">while</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">next</span> <span class="o">=</span> <span class="n">t</span><span class="o">[</span><span class="n">index</span><span class="o">++])</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">();</span>
        <span class="c1">//fail-fast 检查</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">expectedModCount</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
        <span class="n">current</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="no">K</span> <span class="n">key</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
        <span class="c1">//调用removeNode移除Entry</span>
        <span class="n">removeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="c1">//更新expectedModCount</span>
        <span class="n">expectedModCount</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">KeyIterator</span> <span class="kd">extends</span> <span class="nc">HashIterator</span>
    <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">K</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="no">K</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">nextNode</span><span class="o">().</span><span class="na">key</span><span class="o">;</span> <span class="o">}</span>  <span class="c1">//返回Key</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">ValueIterator</span> <span class="kd">extends</span> <span class="nc">HashIterator</span>
    <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="no">V</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">nextNode</span><span class="o">().</span><span class="na">value</span><span class="o">;</span> <span class="o">}</span> <span class="c1">// 返回Value</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">EntryIterator</span> <span class="kd">extends</span> <span class="nc">HashIterator</span>
    <span class="kd">implements</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">nextNode</span><span class="o">();</span> <span class="o">}</span> <span class="c1">// 返回Entry</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>KeyIterator、ValueIterator 和 EntryIterator 都继承了 HashIterator，区别只在于 next() 方法返回的是 Key、Value 还是 Entry。</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet()</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="nf">entrySet</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">es</span><span class="o">;</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">es</span> <span class="o">=</span> <span class="n">entrySet</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">(</span><span class="n">entrySet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EntrySet</span><span class="o">())</span> <span class="o">:</span> <span class="n">es</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kd">class</span> <span class="nc">EntrySet</span> <span class="kd">extends</span> <span class="nc">AbstractSet</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">size</span><span class="o">()</span>                 <span class="o">{</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span> <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">clear</span><span class="o">()</span>               <span class="o">{</span> <span class="nc">HashMap</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span> <span class="o">}</span>
  <span class="c1">//返回一个迭代器</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="nf">iterator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">EntryIterator</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">contains</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">))</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;)</span> <span class="n">o</span><span class="o">;</span>
    <span class="nc">Object</span> <span class="n">key</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">candidate</span> <span class="o">=</span> <span class="n">getNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">candidate</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">candidate</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="k">instanceof</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,?&gt;)</span> <span class="n">o</span><span class="o">;</span>
      <span class="nc">Object</span> <span class="n">key</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
      <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
      <span class="k">return</span> <span class="nf">removeNode</span><span class="o">(</span><span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Spliterator</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="nf">spliterator</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">EntrySpliterator</span><span class="o">&lt;&gt;(</span><span class="nc">HashMap</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">forEach</span><span class="o">(</span><span class="nc">Consumer</span><span class="o">&lt;?</span> <span class="kd">super</span> <span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;[]</span> <span class="n">tab</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">mc</span> <span class="o">=</span> <span class="n">modCount</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Node</span><span class="o">&lt;</span><span class="no">K</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">];</span> <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
          <span class="n">action</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">modCount</span> <span class="o">!=</span> <span class="n">mc</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ConcurrentModificationException</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>理解了 HashIterator 后再看 entrySet() 和 EntrySet 类就比较容易理解了，注意到 HashMap 的实现中使用了一个 entrySet 成员来缓存结果。 keySet() 和 values() 的实现也是类似的，只是 values() 返回的是 Collection ，因为值不能保证唯一性，而键是可以的。</p>
</div>
</div>
<div class="sect2">
<h3 id="_注意"><a class="anchor" href="#_注意"></a>25.13. 注意</h3>
<div class="paragraph">
<p><strong>对于Map中的Key是包装类型时，从map总get元素时要特别注意，get元素的key也必须是对应的包装类型，否者不能获得到对应的value。
因为get方法内部通过key查找对应的value时，key用的是equals方法比较，所以key的数据类型也必须相同。<br>
例如：</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kt">long</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">123</span><span class="o">;</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="nc">Maps</span><span class="o">.</span><span class="na">newHashMap</span><span class="o">();</span>
<span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="mi">123L</span><span class="o">,</span><span class="s">"java"</span><span class="o">);</span>
<span class="nc">String</span> <span class="n">value</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>  <span class="c1">// value是null？还是java？</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_小结_2"><a class="anchor" href="#_小结_2"></a>25.13.1. 小结</h4>
<div class="paragraph">
<p>有关HashMap的遍历就介绍这写，遍历HashMap一共有三种方式，一般遍历key和遍历Entry用的比较多，而且遍历Entry要比遍历
key效率要更快些。对于HashMap的源码暂时就分析这么多，由于本人还是一个菜鸟，水平有限，有些地方也许没有分析的透彻，希望
大家可以见谅，同时，本次HashMap的源码分析也有很多地方没有讲到，比如：HashMap的存储结构红黑树，以后有时间再来研究一下红黑树
的实现原理，这里先推荐一篇讲解红黑树的文章<a href="http://tech.meituan.com/redblack-tree.html">红黑树深入剖析及Java实现</a>。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_参考_2"><a class="anchor" href="#_参考_2"></a>25.14. 参考</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://blog.jrwang.me/2016/java-collections-hashmap/">Java 容器源码分析之 HashMap - JR&#8217;s Blog</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_treemap"><a class="anchor" href="#_treemap"></a>26. TreeMap</h2>
<div class="sectionbody">
<div class="paragraph">
<p>先看一个问题：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testQuestion</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">TreeMap</span><span class="o">&lt;</span><span class="nc">Pair</span><span class="o">,</span> <span class="nc">Pair</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeMap</span><span class="o">&lt;&gt;();</span>
        <span class="nc">Pair</span> <span class="n">pair</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Pair</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>

        <span class="n">data</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">pair</span><span class="o">,</span> <span class="n">pair</span><span class="o">);</span>
        <span class="nc">Pair</span> <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="k">new</span> <span class="nc">Pair</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
        <span class="c1">// 请问，这里会输出 true ？还是 false ？</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pair</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">value</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">class</span> <span class="nc">Pair</span> <span class="kd">implements</span> <span class="nc">Comparable</span><span class="o">&lt;</span><span class="nc">Pair</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">key</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">time</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Pair</span><span class="o">(</span><span class="kt">int</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nf">Pair</span><span class="o">(</span><span class="kt">int</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">time</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="nc">Pair</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Long</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">time</span><span class="o">,</span> <span class="n">o</span><span class="o">.</span><span class="na">time</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">Pair</span> <span class="n">pair</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Pair</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">key</span> <span class="o">==</span> <span class="n">pair</span><span class="o">.</span><span class="na">key</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hash</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>TreeMap</code> 底层是一个红黑树。</p>
</div>
<div class="paragraph">
<p>先定义一个测试实体类：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="code"><pre>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">sortFactor</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Person</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">id</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nf">Person</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">,</span> <span class="kt">int</span> <span class="n">sortFactor</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">sortFactor</span> <span class="o">=</span> <span class="n">sortFactor</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">o</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">getClass</span><span class="o">()</span> <span class="o">!=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Person</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">id</span> <span class="o">==</span> <span class="n">person</span><span class="o">.</span><span class="na">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">hash</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Person{"</span> <span class="o">+</span>
                    <span class="s">"id="</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
                    <span class="s">", age="</span> <span class="o">+</span> <span class="n">sortFactor</span> <span class="o">+</span>
                    <span class="sc">'}'</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSort</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Comparator</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">comparator</span>
                <span class="o">=</span> <span class="nc">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">sortFactor</span><span class="o">);</span>
        <span class="nc">TreeMap</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeMap</span><span class="o">&lt;&gt;(</span><span class="n">comparator</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="n">person</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">Person</span> <span class="n">param</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="o">);</span>
                <span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">param</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">person</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">person</span><span class="o">.</span><span class="na">sortFactor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//</span>
        <span class="n">map</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
        <span class="o">});</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------------"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Person</span> <span class="n">person</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">navigableKeySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------------"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Person</span> <span class="n">person</span> <span class="o">:</span> <span class="n">map</span><span class="o">.</span><span class="na">descendingKeySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>修改排序字段，打印时，依然可以保持有序性。<em>这个实现是怎么回事？</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDuplicateSortFactor</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Comparator</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">&gt;</span> <span class="n">comparator</span>
                <span class="o">=</span> <span class="nc">Comparator</span><span class="o">.</span><span class="na">comparingInt</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">sortFactor</span><span class="o">);</span>
        <span class="nc">TreeMap</span><span class="o">&lt;</span><span class="nc">Person</span><span class="o">,</span> <span class="nc">Person</span><span class="o">&gt;</span> <span class="n">treeMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeMap</span><span class="o">&lt;&gt;(</span><span class="n">comparator</span><span class="o">);</span>
        <span class="nc">Person</span> <span class="n">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="nc">Person</span> <span class="n">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="k">assert</span> <span class="o">!</span><span class="n">p1</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">p2</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">p1</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">p2</span><span class="o">));</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Person</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="n">treeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">person</span><span class="o">,</span> <span class="n">person</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">assert</span> <span class="o">(</span><span class="n">treeMap</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">treeMap</span><span class="o">.</span><span class="na">forEach</span><span class="o">((</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------------"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"kid= %-4d kfactor= %-8d%n"</span><span class="o">,</span> <span class="n">k</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">k</span><span class="o">.</span><span class="na">sortFactor</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"vid= %-4d vfactor= %-8d%n"</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="na">id</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="na">sortFactor</span><span class="o">);</span>
        <span class="o">});</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>由此看出，<code>TreeMap</code> 不能接受排序因子相同的值。如果存在，则后来者把前者的 <code>Value</code> 覆盖掉。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPut</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">TreeMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">treeMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TreeMap</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">treeMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">100</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_linkedhashmap"><a class="anchor" href="#_linkedhashmap"></a>27. LinkedHashMap</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/LinkedHashMap.png" alt="LinkedHashMap">
</div>
</div>
<div class="paragraph">
<p>问题：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>new LinkedHashMap&lt;&gt;(10, 0.75F, true)</code> 和 <code>new LinkedHashMap&lt;&gt;()</code> 除了容量之外，还有什么差别吗？</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dictionary"><a class="anchor" href="#_dictionary"></a>28. Dictionary</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_hashtable"><a class="anchor" href="#_hashtable"></a>29. Hashtable</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/Hashtable-lock.png" alt="Hashtable lock">
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_6"><a class="anchor" href="#_参考资料_6"></a>29.1. 参考资料</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cnblogs.com/chengxiao/p/6842045.html">ConcurrentHashMap实现原理及源码分析 - dreamcatcher-cx - 博客园</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enummap"><a class="anchor" href="#_enummap"></a>30. EnumMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_weakhashmap"><a class="anchor" href="#_weakhashmap"></a>31. WeakHashMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_identityhashmap"><a class="anchor" href="#_identityhashmap"></a>32. IdentityHashMap</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_queue"><a class="anchor" href="#_queue"></a>33. Queue</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_deque"><a class="anchor" href="#_deque"></a>34. Deque</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_abstractqueue"><a class="anchor" href="#_abstractqueue"></a>35. AbstractQueue</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_arraydeque"><a class="anchor" href="#_arraydeque"></a>36. ArrayDeque</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_priorityqueue"><a class="anchor" href="#_priorityqueue"></a>37. PriorityQueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p>对于 <code>PriorityQueue</code> 来说，最重要的一点就是要清楚他是基于堆结构实现，可以用它来实现优先队列。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PriorityQueue-offer.png" alt="PriorityQueue offer">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PriorityQueue-poll.png" alt="PriorityQueue poll">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/PriorityQueue-remove2.png" alt="PriorityQueue remove2">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSize</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">PriorityQueue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PriorityQueue</span><span class="o">&lt;&gt;(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
        <span class="nc">PriorityQueue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PriorityQueue</span><span class="o">&lt;&gt;(</span><span class="n">capacity</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">capacity</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">hasSize</span><span class="o">(</span><span class="n">capacity</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">contains</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">queue</span><span class="o">).</span><span class="na">doesNotContain</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
        <span class="c1">// 可见，默认就是最小堆。</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">num</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>从上述例子中可以看出，<code>PriorityQueue</code> 的长度是回增长的。所以，如果需要定长的优先队列，则需要将多余数据"弹出"。</p>
</div>
<div class="sect2">
<h3 id="_参考资料_7"><a class="anchor" href="#_参考资料_7"></a>37.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.pdai.tech/md/java/collection/java-collection-PriorityQueue.html">Collection - PriorityQueue源码解析 | Java 全栈知识体系</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_工具类_arrays"><a class="anchor" href="#_工具类_arrays"></a>38. 工具类 <code>Arrays</code></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_工具类_collections"><a class="anchor" href="#_工具类_collections"></a>39. 工具类 <code>Collections</code></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_并发库概述"><a class="anchor" href="#_并发库概述"></a>40. 并发库概述</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/java-concurrent-overview.png" alt="java concurrent overview">
</div>
</div>
<div class="sect2">
<h3 id="_happy_before_原则"><a class="anchor" href="#_happy_before_原则"></a>40.1. Happy-Before 原则</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Single Thread Rule 单一线程原则</p>
</li>
<li>
<p>Monitor Lock Rule 管程锁定规则</p>
</li>
<li>
<p>Volatile Variable Rule <code>volatile</code> 变量规则</p>
</li>
<li>
<p>Thread Start Rule 线程启动规则</p>
</li>
<li>
<p>Thread Join Rule 线程加入规则</p>
</li>
<li>
<p>Thread Interruption Rule 线程中断规则</p>
</li>
<li>
<p>Finalizer Rule 对象终结规则</p>
</li>
<li>
<p>Transitivity 传递性</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_thread"><a class="anchor" href="#_thread"></a>41. Thread</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在JDK1.2之后，Java线程模型已经确定了基于操作系统原生线程模型实现。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/jvm-thread-to-os-thread.jpeg" alt="jvm thread to os thread">
</div>
</div>
<div class="paragraph">
<p>Java线程最终会映射为系统内核原生线程，所以Java线程调度最终取决于系操作系统，而目前主流的操作系统内核线程调度基本都是使用抢占式线程调度。也就是可以死记硬背一下：<strong>Java线程是使用抢占式线程调度方式进行线程调度的。</strong></p>
</div>
<div class="paragraph">
<p>线程状态在 <code>Thread</code> 类已经通过一个枚举给出了所有可能：</p>
</div>
<div class="listingblock">
<div class="title">Thread</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Thread</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="c1">// ……</span>
    <span class="cm">/**
     * A thread state.  A thread can be in one of the following states:
     * &lt;ul&gt;
     * &lt;li&gt;{@link #NEW}&lt;br&gt;
     *     A thread that has not yet started is in this state.
     *     &lt;/li&gt;
     * &lt;li&gt;{@link #RUNNABLE}&lt;br&gt;
     *     A thread executing in the Java virtual machine is in this state.
     *     &lt;/li&gt;
     * &lt;li&gt;{@link #BLOCKED}&lt;br&gt;
     *     A thread that is blocked waiting for a monitor lock
     *     is in this state.
     *     &lt;/li&gt;
     * &lt;li&gt;{@link #WAITING}&lt;br&gt;
     *     A thread that is waiting indefinitely for another thread to
     *     perform a particular action is in this state.
     *     &lt;/li&gt;
     * &lt;li&gt;{@link #TIMED_WAITING}&lt;br&gt;
     *     A thread that is waiting for another thread to perform an action
     *     for up to a specified waiting time is in this state.
     *     &lt;/li&gt;
     * &lt;li&gt;{@link #TERMINATED}&lt;br&gt;
     *     A thread that has exited is in this state.
     *     &lt;/li&gt;
     * &lt;/ul&gt;
     *
     * &lt;p&gt;
     * A thread can be in only one state at a given point in time.
     * These states are virtual machine states which do not reflect
     * any operating system thread states.
     *
     * @since   1.5
     * @see #getState
     */</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="nc">State</span> <span class="o">{</span>
        <span class="cm">/**
         * Thread state for a thread which has not yet started.
         */</span>
        <span class="no">NEW</span><span class="o">,</span>

        <span class="cm">/**
         * Thread state for a runnable thread.  A thread in the runnable
         * state is executing in the Java virtual machine but it may
         * be waiting for other resources from the operating system
         * such as processor.
         */</span>
        <span class="no">RUNNABLE</span><span class="o">,</span>

        <span class="cm">/**
         * Thread state for a thread blocked waiting for a monitor lock.
         * A thread in the blocked state is waiting for a monitor lock
         * to enter a synchronized block/method or
         * reenter a synchronized block/method after calling
         * {@link Object#wait() Object.wait}.
         */</span>
        <span class="no">BLOCKED</span><span class="o">,</span>

        <span class="cm">/**
         * Thread state for a waiting thread.
         * A thread is in the waiting state due to calling one of the
         * following methods:
         * &lt;ul&gt;
         *   &lt;li&gt;{@link Object#wait() Object.wait} with no timeout&lt;/li&gt;
         *   &lt;li&gt;{@link #join() Thread.join} with no timeout&lt;/li&gt;
         *   &lt;li&gt;{@link LockSupport#park() LockSupport.park}&lt;/li&gt;
         * &lt;/ul&gt;
         *
         * &lt;p&gt;A thread in the waiting state is waiting for another thread to
         * perform a particular action.
         *
         * For example, a thread that has called {@code Object.wait()}
         * on an object is waiting for another thread to call
         * {@code Object.notify()} or {@code Object.notifyAll()} on
         * that object. A thread that has called {@code Thread.join()}
         * is waiting for a specified thread to terminate.
         */</span>
        <span class="no">WAITING</span><span class="o">,</span>

        <span class="cm">/**
         * Thread state for a waiting thread with a specified waiting time.
         * A thread is in the timed waiting state due to calling one of
         * the following methods with a specified positive waiting time:
         * &lt;ul&gt;
         *   &lt;li&gt;{@link #sleep Thread.sleep}&lt;/li&gt;
         *   &lt;li&gt;{@link Object#wait(long) Object.wait} with timeout&lt;/li&gt;
         *   &lt;li&gt;{@link #join(long) Thread.join} with timeout&lt;/li&gt;
         *   &lt;li&gt;{@link LockSupport#parkNanos LockSupport.parkNanos}&lt;/li&gt;
         *   &lt;li&gt;{@link LockSupport#parkUntil LockSupport.parkUntil}&lt;/li&gt;
         * &lt;/ul&gt;
         */</span>
        <span class="no">TIMED_WAITING</span><span class="o">,</span>

        <span class="cm">/**
         * Thread state for a terminated thread.
         * The thread has completed execution.
         */</span>
        <span class="no">TERMINATED</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// ……</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/thread-lifecycle.jpeg" alt="thread lifecycle">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/thread-states.jpeg" alt="thread states">
</div>
</div>
<div class="paragraph">
<p>Java 对象内存占用大小：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>对象头在32位系统上占用8bytes，64位系统上占用16bytes。开启（-XX:+UseCompressedOops）对象头大小为12bytes（64位机器）。</p>
</li>
<li>
<p>64位机器上，数组对象的对象头占用24个字节，启用压缩之后占用16个字节。之所以比普通对象占用内存多是因为需要额外的空间存储数组的长度。</p>
</li>
<li>
<p>64位机器上reference类型占用8个字节，开启指针压缩后占用4个字节。</p>
</li>
<li>
<p>复合对象，直接计算当前对象占用空间大小，包括当前类及超类的基本类型实例字段大小、引用类型实例字段引用大小、实例基本类型数组总占用空间、实例引用类型数组引用本身占用空间大小; 但是不包括超类继承下来的和当前类声明的实例引用字段的对象本身的大小、实例引用数组引用的对象本身的大小。</p>
</li>
<li>
<p>对齐填充是以每个对象为单位进行的。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>HotSpot的对齐方式为8字节对齐： <code>（对象头 + 实例数据 + padding） % 8等于0且0 &#8656; padding &lt; 8</code>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.openjdk.jol.info.ClassLayout</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.openjdk.jol.vm.VM</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-08 16:10
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JolTest</span> <span class="o">{</span>
    <span class="cm">/**
     * Java Object Layout
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="no">VM</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">details</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--o = 12--------------"</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">()</span> <span class="o">{};</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">o</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--o2 = 12--------------"</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">o2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
            <span class="kd">private</span> <span class="kt">long</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">};</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">o2</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--\"119\"--------------"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">s</span> <span class="o">=</span> <span class="s">"119"</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--119L--------------"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="mi">119L</span><span class="o">).</span><span class="na">toPrintable</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--o[] = 16--------------"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]).</span><span class="na">toPrintable</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--o[1]--------------"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">ClassLayout</span><span class="o">.</span><span class="na">parseInstance</span><span class="o">(</span><span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="k">new</span> <span class="nc">Object</span><span class="o">()}).</span><span class="na">toPrintable</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>join()</code> 方法的本质是当前线程对象实例调用线程 <code>wait()</code> 方法。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.DelayQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Delayed</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-12 18:07
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testState</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"StartTime: "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">i</span><span class="o">++;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"testState: is interrupted at "</span>
                        <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  EndTime: "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
        <span class="o">});</span>
        <span class="c1">// NEW</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// RUNNABLE</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="c1">// TIMED_WAITING</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">9200</span><span class="o">);</span>
        <span class="c1">// RUNNABLE ??</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="c1">// TERMINATED</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBlockState</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread2 got monitor lock..."</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t2</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterrupt</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kd">class</span> <span class="nc">InterruptTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">();</span>
                <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"InterruptTask was interrupted at "</span>
                                <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                    <span class="o">}</span>
<span class="c1">//                    try {</span>
<span class="c1">//                        Thread.sleep(5 * 1000);</span>
<span class="c1">//                    } catch (InterruptedException e) {</span>
<span class="c1">//                        e.printStackTrace();</span>
<span class="c1">//                    }</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">InterruptTask</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// TODO</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptStatus1</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kd">class</span> <span class="nc">InterruptTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">i</span><span class="o">++;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">InterruptTask</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread.isInterrupted() = "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread.isInterrupted() = "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// TODO</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptStatus2</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kd">class</span> <span class="nc">IntDelay</span> <span class="kd">implements</span> <span class="nc">Delayed</span> <span class="o">{</span>

            <span class="kd">private</span> <span class="kt">int</span> <span class="n">num</span><span class="o">;</span>
            <span class="kd">private</span> <span class="kt">long</span> <span class="n">deadline</span><span class="o">;</span>

            <span class="kd">public</span> <span class="nf">IntDelay</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">num</span> <span class="o">=</span> <span class="n">num</span><span class="o">;</span>
                <span class="n">deadline</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getDelay</span><span class="o">(</span><span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">deadline</span> <span class="o">-</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="nc">Delayed</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">IntDelay</span> <span class="n">param</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IntDelay</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
                <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">num</span><span class="o">,</span> <span class="n">param</span><span class="o">.</span><span class="na">num</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kd">class</span> <span class="nc">InterruptTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
                <span class="nc">DelayQueue</span><span class="o">&lt;</span><span class="nc">IntDelay</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DelayQueue</span><span class="o">&lt;&gt;();</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">IntDelay</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Wait  "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                    <span class="n">queue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Taken "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"current.isInterrupted() = "</span> <span class="o">+</span> <span class="n">current</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"current.isInterrupted() = "</span> <span class="o">+</span> <span class="n">current</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">InterruptTask</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread.isInterrupted() = "</span> <span class="o">+</span> <span class="n">thread</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testWaitLock</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="c1">// 测试 wait 是否释放锁</span>
        <span class="c1">// 根据运行结果来看，thread1 和 thread2 是交叉执行的，</span>
        <span class="c1">// 则：线程在 wait 时，是释放了锁的，</span>
        <span class="c1">// 再次获取锁后，会接着上次执行点继续执行。</span>
        <span class="c1">//</span>
        <span class="c1">// 这里还有一点需要注意：wait 需要在锁对象上执行，否则会报错。</span>
        <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread1 start to wait..."</span><span class="o">);</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">wait</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread1 weak up..."</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread2 got monitor lock..."</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSleepLock</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="c1">// 测试 sleep 是否释放锁</span>
        <span class="c1">// 根据输出来看，thread1 执行完后再次执行的 thread2</span>
        <span class="c1">// 则：线程在 sleep 时，不释放锁。</span>
        <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread1 start to wait..."</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread1 weak up..."</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"thread2 got monitor lock..."</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testJoin</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">JoinMain</span><span class="o">.</span><span class="na">AddThread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JoinMain</span><span class="o">.</span><span class="na">AddThread</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// 执行这句话，则下面的输出会等 thread 执行完成后，i值等于100000；</span>
        <span class="c1">// 如果注释掉，则瞬间向下执行，i值很小。</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">JoinMain</span><span class="o">.</span><span class="na">i</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">JoinMain</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">volatile</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AddThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testYield</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="nc">Integer</span> <span class="n">key</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="nc">Integer</span> <span class="n">key2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="o">++</span><span class="n">num</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Integer</span> <span class="n">num</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">key2</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
                <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key2</span><span class="o">,</span> <span class="o">++</span><span class="n">num</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="c1">// 如果 Thread.yield() 没有让出 CPU，则两个值相差不多；否则相差很大。</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">replace</span><span class="o">(</span><span class="s">","</span><span class="o">,</span> <span class="s">"\n"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testChildThread</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// TODO 如何掩饰父子线程？如何在父子线程之间传递数据？</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Thread</span><span class="o">&gt;</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">Thread</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
            <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">threadLocal</span> <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="mi">119</span><span class="o">);</span>

            <span class="nc">Thread</span> <span class="n">child</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="o">});</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"id=%d, parentId=%d %n"</span><span class="o">,</span> <span class="n">thread</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="mi">123</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">threads</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">thread1</span><span class="o">);</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptNoAction</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 虽然给线程发出了中断信号，但程序中并没有响应中断信号的逻辑，所以程序不会有任何反应。</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptAction</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
                <span class="c1">// 响应中断</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Java技术栈线程被中断，程序退出。"</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptFailure</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 响应中断</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Java技术栈线程被中断，程序退出。"</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// sleep() 方法被中断后会清除中断标记，所以循环会继续运行。。</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Java技术栈线程休眠被中断，程序退出。"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getState</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 线程苏醒，继续执行……"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span> <span class="c1">// 注意加上这句话！否则线程还没启动就被终端了</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterruptSleep</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 响应中断</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Java技术栈线程被中断，程序退出。"</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// sleep() 方法被中断后会清除中断标记，所以循环会继续运行。。</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Java技术栈 线程 休眠被中断，程序退出。"</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getState</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 线程苏醒，继续执行……"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span> <span class="c1">// 注意加上这句话！否则线程还没启动就被终端了</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSynchronized</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">money</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>

            <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">increase</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start to increase"</span><span class="o">);</span>
                <span class="n">money</span> <span class="o">-=</span> <span class="mi">10</span><span class="o">;</span>
                <span class="kt">double</span> <span class="kt">var</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kt">var</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">PI</span> <span class="o">*</span> <span class="nc">Math</span><span class="o">.</span><span class="na">E</span> <span class="o">*</span> <span class="n">i</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2000000</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"fire"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"finish increasing."</span> <span class="o">+</span> <span class="kt">var</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">decrease</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start to decrease"</span><span class="o">);</span>
                <span class="n">money</span> <span class="o">+=</span> <span class="mi">20</span><span class="o">;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"finish decreasing."</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Account</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nl">account:</span><span class="o">:</span><span class="n">increase</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nl">account:</span><span class="o">:</span><span class="n">decrease</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">30</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">account</span><span class="o">.</span><span class="na">money</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>线程休眠苏醒后，中断信号就会被清除！所以，如果要响应这种中断，还需要再异常捕获代码段再次中断才行！</p>
</div>
<div class="paragraph">
<p>线程上下文切换(<code>Context Switch</code>)，都保存了哪些信息？怎么保存的？</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows 系统中，https://docs.microsoft.com/zh-cn/sysinternals/downloads/process-explorer[Process Explorer] 可以查看上下文切换信息。</p>
</li>
<li>
<p>阿里巴巴推出的 <a href="https://github.com/alibaba/arthas">Alibaba Arthas</a> 也是一个诊断利器。</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_参考资料_8"><a class="anchor" href="#_参考资料_8"></a>41.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2019/06/23/java-concurrency-thread-state/">Java线程生命周期与状态切换 - Throwable&#8217;s Blog</a></p>
</li>
<li>
<p><a href="https://www.iteye.com/blog/yueyemaitian-2033046">一个对象占用多少字节？ - 田麦 - ITeye博客</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/zhanjindong/p/3757767.html">一个Java对象到底占用多大内存？ - zhanjindong - 博客园</a></p>
</li>
<li>
<p><a href="https://zhuanlan.zhihu.com/p/45667127">一文搞懂 Java 线程中断 - 知乎</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/justloveyou_/article/details/54929949">Java 并发：线程间通信与协作_Java_Rico&#8217;s Blogs-CSDN博客</a></p>
</li>
<li>
<p><a href="https://blog.csdn.net/zheng548/article/details/54426947">synchronized和锁(ReentrantLock) 区别_Java_小风筝-CSDN博客</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_locksupport"><a class="anchor" href="#_locksupport"></a>42. LockSupport</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-16 19:16
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockSupportTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="s">"t1"</span><span class="o">));</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="s">"t2"</span><span class="o">));</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">t2</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"finish..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">LockSupportTest</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"in "</span> <span class="o">+</span> <span class="n">name</span><span class="o">);</span>
                <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testParkAndUnpark</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--m1------"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--t1------"</span><span class="o">);</span>
            <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--t2------"</span><span class="o">);</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">thread</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--m2------"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>synchronized</code> 关键字在方法上使用时，在方法修饰符上增加了一个标志位 <code>flags: (0x0021) ACC_PUBLIC, ACC_SYNCHRONIZED</code>。而用在代码块时，则是生成了 <code>monitorenter</code> 和 <code>monitorexit</code> 指令。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-08 19:26
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SynchronizedTest</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">lockMethod</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"lock method"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lockObject</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"lock object"</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInstanceLock</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">SynMain</span> <span class="n">main</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SynMain</span><span class="o">();</span>
    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nl">main:</span><span class="o">:</span><span class="n">getInstanceLock1</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nl">main:</span><span class="o">:</span><span class="n">getInstanceLock2</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nl">SynMain:</span><span class="o">:</span><span class="n">getStaticLock1</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nl">SynMain:</span><span class="o">:</span><span class="n">getStaticLock2</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
  <span class="o">}</span>


  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SynMain</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">getStaticLock1</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"getStaticLock1 get lock, running..."</span><span class="o">);</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">getStaticLock2</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"getStaticLock2 get lock, running..."</span><span class="o">);</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">getInstanceLock1</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"getInstanceLock1 get lock, running..."</span><span class="o">);</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">getInstanceLock2</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"getInstanceLock2 get lock, running..."</span><span class="o">);</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>可以利用 jclasslib Bytecode viewer 工具，或者 <code>javap -c -v XXX.class</code> 来查看。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_abstractqueuedsynchronizer"><a class="anchor" href="#_abstractqueuedsynchronizer"></a>43. AbstractQueuedSynchronizer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Doug Lea</p>
</div>
<div class="paragraph">
<p>在 Java 5 之后，JDK 内置了大量的并发工具类。粗略去看这些工具类的源码，你会发现，大多数都在内部继承了 <code>AbstractQueuedSynchronizer</code>。由此可见，<code>AbstractQueuedSynchronizer</code> 的核心地位。想搞清楚这些并发工具类的原理，<code>AbstractQueuedSynchronizer</code> 的源码可以说是不可不看。</p>
</div>
<div class="sect2">
<h3 id="_clh_lock_queue_介绍"><a class="anchor" href="#_clh_lock_queue_介绍"></a>43.1. CLH lock queue 介绍</h3>
<div class="imageblock">
<div class="content">
<img src="./images/AbstractQueuedSynchronizer-CLH-queue.png" alt="AbstractQueuedSynchronizer CLH queue">
</div>
</div>
<div class="paragraph">
<p>终于看明白了 CLH lock queue。CLH 通过自旋来锁定当前节点。自旋的好处是线程不需要睡眠和唤醒，减小了系统调用的开销。</p>
</div>
<div class="paragraph">
<p>AQS 中线程不是一直在自旋的，而可能会反复的睡眠和唤醒，这就需要前继释放锁的时候通过 next 指针找到其后继将其唤醒，也就是 AQS 的等待队列中后继是被前继唤醒的。AQS 结合了自旋和睡眠/唤醒两种方法的优点。</p>
</div>
<div class="paragraph">
<p><em>AQS 结合了自旋和睡眠/唤醒两种方法的优点。</em> 这句话该如何理解？刚刚想到的一点： AQS 中会先自旋两次，如果不成功则休眠。应该是这样来使用两者的好处！</p>
</div>
<div class="paragraph">
<p>自己实现一个 CLH 锁！</p>
</div>
</div>
<div class="sect2">
<h3 id="_核心点"><a class="anchor" href="#_核心点"></a>43.2. 核心点</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>模板方法模式</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>boolean tryAcquire(int arg)</code></p>
</li>
<li>
<p><code>boolean tryRelease(int arg)</code></p>
</li>
<li>
<p><code>int tryAcquireShared(int arg)</code></p>
</li>
<li>
<p><code>boolean tryReleaseShared(int arg)</code></p>
</li>
<li>
<p><code>boolean isHeldExclusively()</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>基于 <code>AbstractQueuedSynchronizer</code>，我们实现一个互斥锁：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.AbstractQueuedSynchronizer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Condition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-31 10:27
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Mutex</span> <span class="kd">implements</span> <span class="nc">Lock</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Sync</span> <span class="kd">extends</span> <span class="nc">AbstractQueuedSynchronizer</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryRelease</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">getState</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalMonitorStateException</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
            <span class="n">setState</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">isHeldExclusively</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">getState</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">Condition</span> <span class="nf">newCodition</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">ConditionObject</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Sync</span> <span class="n">sync</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Sync</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">sync</span><span class="o">.</span><span class="na">acquire</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lockInterruptibly</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">sync</span><span class="o">.</span><span class="na">acquireInterruptibly</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryLock</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">tryAcquire</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">tryLock</span><span class="o">(</span><span class="kt">long</span> <span class="n">time</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">tryAcquireSharedNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">time</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">unlock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">sync</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Condition</span> <span class="nf">newCondition</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">newCodition</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isLocked</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">isHeldExclusively</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasQueuedThreads</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">hasQueuedThreads</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>互斥锁，也可以称为独占锁，顾名思义就是同一个时刻只能有一个线程获取到锁，而其他获取锁的线程只能在同步队列中等待，只有获取锁的线程释放了锁，后继的线程才能获取锁。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.invoke.MethodHandles</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.invoke.VarHandle</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-31 11:41
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AbstractQueuedSynchronizerTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testNode</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">AqsNode</span> <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AqsNode</span><span class="o">();</span>
        <span class="nc">AqsNode</span> <span class="n">next</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AqsNode</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">);</span>
        <span class="n">head</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="n">next</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
        <span class="nc">AqsNode</span> <span class="n">tail</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AqsNode</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">);</span>
        <span class="n">next</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span>
        <span class="n">tail</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Thread</span><span class="o">&gt;</span> <span class="n">threads</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">AqsNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span> <span class="n">node</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">threads</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">thread</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threads</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AqsNode</span> <span class="o">{</span>

        <span class="kd">static</span> <span class="kd">final</span> <span class="nc">AqsNode</span> <span class="no">SHARED</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AqsNode</span><span class="o">();</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="nc">AqsNode</span> <span class="no">EXCLUSIVE</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">CANCELLED</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">SIGNAL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">CONDITION</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">;</span>
        <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">PROPAGATE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">;</span>

        <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">waitStatus</span><span class="o">;</span>

        <span class="kd">volatile</span> <span class="nc">AqsNode</span> <span class="n">prev</span><span class="o">;</span>

        <span class="kd">volatile</span> <span class="nc">AqsNode</span> <span class="n">next</span><span class="o">;</span>

        <span class="kd">volatile</span> <span class="nc">Thread</span> <span class="n">thread</span><span class="o">;</span>

        <span class="nc">AqsNode</span> <span class="n">nextWaiter</span><span class="o">;</span>

        <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isShared</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">nextWaiter</span> <span class="o">==</span> <span class="no">SHARED</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="nc">AqsNode</span> <span class="nf">predecessor</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">AqsNode</span> <span class="n">p</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
            <span class="k">else</span>
                <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">AqsNode</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">}</span>

        <span class="nc">AqsNode</span><span class="o">(</span><span class="nc">AqsNode</span> <span class="n">nextWaiter</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">nextWaiter</span> <span class="o">=</span> <span class="n">nextWaiter</span><span class="o">;</span>
            <span class="no">THREAD</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="nc">AqsNode</span><span class="o">(</span><span class="kt">int</span> <span class="n">waitStatus</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">WAITSTATUS</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">waitStatus</span><span class="o">);</span>
            <span class="no">THREAD</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">compareAndSetWaitStatus</span><span class="o">(</span><span class="kt">int</span> <span class="n">expect</span><span class="o">,</span> <span class="kt">int</span> <span class="n">update</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">WAITSTATUS</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">expect</span><span class="o">,</span> <span class="n">update</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">compareAndSetNext</span><span class="o">(</span><span class="nc">AqsNode</span> <span class="n">expect</span><span class="o">,</span> <span class="nc">AqsNode</span> <span class="n">update</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="no">NEXT</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">expect</span><span class="o">,</span> <span class="n">update</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="kt">void</span> <span class="nf">setPrevRelaxed</span><span class="o">(</span><span class="nc">AqsNode</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">PREV</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">p</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">VarHandle</span> <span class="no">NEXT</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">VarHandle</span> <span class="no">PREV</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">VarHandle</span> <span class="no">THREAD</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">VarHandle</span> <span class="no">WAITSTATUS</span><span class="o">;</span>

        <span class="kd">static</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">MethodHandles</span><span class="o">.</span><span class="na">Lookup</span> <span class="n">l</span> <span class="o">=</span> <span class="nc">MethodHandles</span><span class="o">.</span><span class="na">lookup</span><span class="o">();</span>
                <span class="no">NEXT</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">findVarHandle</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"next"</span><span class="o">,</span> <span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="no">PREV</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">findVarHandle</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"prev"</span><span class="o">,</span> <span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="no">THREAD</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">findVarHandle</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"thread"</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="no">WAITSTATUS</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="na">findVarHandle</span><span class="o">(</span><span class="nc">AqsNode</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"waitStatus"</span><span class="o">,</span> <span class="kt">int</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ReflectiveOperationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExceptionInInitializerError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCustomLock</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Mutex</span> <span class="n">mutex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Mutex</span><span class="o">();</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"thread=%d running time=%d%n"</span><span class="o">,</span>
                            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="n">time</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">time</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"thread=%d finished%n"</span><span class="o">,</span>
                            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">mutex</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>

                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50000</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"All task were finished."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>运行结果显示，指定时刻，只有一个线程在运行。</p>
</div>
<div class="paragraph">
<p>查看 <code>AbstractQueuedSynchronizer</code> 继承关系可以看出，在 <code>ReentrantLock</code>，<code>ReentrantReadWriteLock</code> 和 <code>Semaphore</code> 三个类中实现了公平锁和非公平锁。</p>
</div>
</div>
<div class="sect2">
<h3 id="_node_详解"><a class="anchor" href="#_node_详解"></a>43.3. <code>Node</code> 详解</h3>
<div class="ulist">
<ul>
<li>
<p><code>waitStatus</code>：当前 <code>Node</code> 的等待状态，有五个可选值。</p>
</li>
<li>
<p><code>prev</code>：当前 <code>Node</code> 实例的前驱节点引用。</p>
</li>
<li>
<p><code>next</code>：当前 <code>Node</code> 实例的后继节点引用。</p>
</li>
<li>
<p><code>thread</code>：当前 <code>Node</code> 实例持有的线程实例引用。</p>
</li>
<li>
<p><code>nextWaiter</code>：这个值是一个比较容易令人生疑的值，虽然表面上它称为"下一个等待的节点"，但是实际上它有三种取值的情况。</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>值为静态实例 <code>Node.EXCLUSIVE</code>(也就是 <code>null</code>)，代表当前的 <code>Node</code> 实例是独占模式。</p>
</li>
<li>
<p>值为静态实例 <code>Node.SHARED</code>，代表当前的 <code>Node</code> 实例是共享模式。</p>
</li>
<li>
<p>值为非 <code>Node.EXCLUSIVE</code> 和 <code>Node.SHARED</code> 的其他节点实例，代表 <code>Condition</code> 等待队列中当前节点的下一个等待节点。</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_node_中一些常量定义"><a class="anchor" href="#_node_中一些常量定义"></a>43.3.1. <code>Node</code> 中一些常量定义</h4>
<div class="paragraph">
<p>区分共享锁还是独占式锁的常量，是如何被使用的？独占锁为何没有初始化？</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>static final Node SHARED = new Node();</code></p>
</li>
<li>
<p><code>static final Node EXCLUSIVE = null;</code>&#8201;&#8212;&#8201;为何没有被初始化？</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>共享锁的话，大家使用同一个 <code>Node</code> 实例，而独自锁则是每个任务使用一个 <code>Node</code> 实例。可以这样理解吗？</p>
</div>
<div class="paragraph">
<p>节点的状态</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>static final int CANCELLED =  1;</code>&#8201;&#8212;&#8201;表示当前的线程被取消；</p>
</li>
<li>
<p><code>static final int SIGNAL    = -1;</code>&#8201;&#8212;&#8201;表示当前节点的后继节点包含的线程需要运行，也就是unpark；</p>
</li>
<li>
<p><code>static final int CONDITION = -2;</code>&#8201;&#8212;&#8201;表示当前节点在等待condition，也就是在condition队列中；</p>
</li>
<li>
<p><code>static final int PROPAGATE = -3;</code>&#8201;&#8212;&#8201;表示当前场景下后续的acquireShared能够得以执行；</p>
</li>
<li>
<p><code>0</code>&#8201;&#8212;&#8201;表示当前节点在sync队列中，等待着获取锁。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>模板方法：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>isHeldExclusively()</code>&#8201;&#8212;&#8201;该线程是否正在独占资源。只有用到condition才需要去实现它。</p>
</li>
<li>
<p><code>tryAcquire(int)</code>&#8201;&#8212;&#8201;独占方式。尝试获取资源，成功则返回true，失败则返回false。</p>
</li>
<li>
<p><code>tryRelease(int)</code>&#8201;&#8212;&#8201;独占方式。尝试释放资源，成功则返回true，失败则返回false。</p>
</li>
<li>
<p><code>tryAcquireShared(int)</code>&#8201;&#8212;&#8201;共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。</p>
</li>
<li>
<p><code>tryReleaseShared(int)</code>&#8201;&#8212;&#8201;共享方式。尝试释放资源，成功则返回true，失败则返回false。</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_独占模式"><a class="anchor" href="#_独占模式"></a>43.4. 独占模式</h3>
<div class="paragraph">
<p>独占模式的同步器的一个显著特点就是：头节点的第一个有效(非取消)的后继节点，总是尝试获取资源，一旦获取资源成功就会解除阻塞并且晋升为头节点，原来所在节点会移除出同步等待队列，原来的队列长度就会减少1，然后头结点的第一个有效的后继节点继续开始竞争资源。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
</pre></td><td class="code"><pre>    <span class="cm">/**
     * Checks and updates status for a node that failed to acquire.
     * Returns true if thread should block. This is the main signal
     * control in all acquire loops.  Requires that pred == node.prev.
     *
     * @param pred node's predecessor holding status
     * @param node the node
     * @return {@code true} if thread should block
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="nc">Node</span> <span class="n">pred</span><span class="o">,</span> <span class="nc">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 如果前一个节点已经在排队，则新加入的节点就应该 park</span>
        <span class="kt">int</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="na">waitStatus</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">==</span> <span class="nc">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">)</span>
            <span class="cm">/*
             * This node has already set status asking a release
             * to signal it, so it can safely park.
             */</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="c1">// 如果前一个节点已经取消，则删除取消节点</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ws</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="cm">/*
             * Predecessor was cancelled. Skip over predecessors and
             * indicate retry.
             */</span>
            <span class="c1">// 跳过已经取消的节点</span>
            <span class="k">do</span> <span class="o">{</span>
                <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="na">prev</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">pred</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">);</span>
            <span class="c1">// 加入队列</span>
            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="cm">/*
             * waitStatus must be 0 or PROPAGATE.  Indicate that we
             * need a signal, but don't park yet.  Caller will need to
             * retry to make sure it cannot acquire before parking.
             */</span>
            <span class="c1">// 如果前一个节点没有取消，则尝试将前一个节点设置为 Node.SIGNAL</span>
            <span class="n">pred</span><span class="o">.</span><span class="na">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">ws</span><span class="o">,</span> <span class="nc">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Convenience method to interrupt current thread.
     */</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">selfInterrupt</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Convenience method to park and then check if interrupted.
     *
     * @return {@code true} if interrupted
     */</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">parkAndCheckInterrupt</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/*
     * Various flavors of acquire, varying in exclusive/shared and
     * control modes.  Each is mostly the same, but annoyingly
     * different.  Only a little bit of factoring is possible due to
     * interactions of exception mechanics (including ensuring that we
     * cancel if tryAcquire throws exception) and other control, at
     * least not without hurting performance too much.
     */</span>

    <span class="cm">/**
     * Acquires in exclusive uninterruptible mode for thread already in
     * queue. Used by condition wait methods as well as acquire.
     *
     * @param node the node
     * @param arg the acquire argument
     * @return {@code true} if interrupted while waiting
     */</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">acquireQueued</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Node</span> <span class="n">node</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="nc">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
                    <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC</span>
                    <span class="k">return</span> <span class="n">interrupted</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">// 此时 node 节点已经通过 addWaiter 方法加入到队列中</span>
                <span class="c1">// 1、如果前一个节点是 SIGNAL，则返回 true，park 该线程</span>
                <span class="c1">// 2.1 如果前一个节点取消，则通过遍历将之前的连续的取消节点全部删除，</span>
                <span class="c1">//     返回 false，再次自旋尝试获取锁</span>
                <span class="c1">// 2.2 如果前一个节点没有取消，则将前一个节点尝试修改为 SIGNAL。</span>
                <span class="c1">//     那么下一次循环时，走第一个判断，返回 true，park 该线程。</span>
                <span class="c1">//     或者前驱节点已经弹出队列，则该线程尝试获取锁。</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">))</span>
                    <span class="n">interrupted</span> <span class="o">|=</span> <span class="n">parkAndCheckInterrupt</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">interrupted</span><span class="o">)</span>
                <span class="n">selfInterrupt</span><span class="o">();</span>
            <span class="k">throw</span> <span class="n">t</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>可以画一下流程图：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>以 <code>ReentrantLock</code> 为例，在独占模式下，获取锁的过程</p>
</li>
<li>
<p>以 <code>ReentrantLock</code> 为例，在独占模式下，释放锁的过程</p>
</li>
<li>
<p>使用 <code>Condition</code> 对象，<code>await()</code> 的过程</p>
</li>
<li>
<p>使用 <code>Condition</code> 对象，<code>signal()</code> 的过程</p>
</li>
<li>
<p>以 <code>Semaphore</code> 为例，在共享模式下，获取锁的过程</p>
</li>
<li>
<p>以 <code>Semaphore</code> 为例，在共享模式下，释放锁的过程</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_共享模式"><a class="anchor" href="#_共享模式"></a>43.5. 共享模式</h3>
<div class="paragraph">
<p>共享模式的同步器的一个显著特点就是：头节点的第一个有效(非取消)的后继节点，总是尝试获取资源，一旦获取资源成功就会解除阻塞并且晋升为头节点，原来所在节点会移除出同步等待队列，原来的队列长度就会减少1，重新设置头节点的过程会传播唤醒的状态，简单来说就是唤醒一个有效的后继节点，只要一个节点可以晋升为头节点，它的后继节点就能被唤醒。节点的唤醒顺序遵循类似于FIFO的原则，通俗说就是先阻塞或者阻塞时间最长则先被唤醒。</p>
</div>
</div>
<div class="sect2">
<h3 id="_conditionobject"><a class="anchor" href="#_conditionobject"></a>43.6. <code>ConditionObject</code></h3>
<div class="paragraph">
<p>关于这段代码的研究，可以参看 <a href="#"><code>java.util.concurrent.ArrayBlockingQueue</code></a>。<code>ArrayBlockingQueue</code> 在实现 <code>poll(long, java.util.concurrent.TimeUnit)</code> 方法时，使用了 <code>Condition notEmpty</code> 对象来调用 <code>ConditionObject.awaitNanos(long)</code> 方法。</p>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_9"><a class="anchor" href="#_参考资料_9"></a>43.7. 参考资料</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
访问一些页面时发现一些页面已经不能访问了，后续再搜索补上吧。
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2019/04/07/java-juc-aqs-source-code/">JUC同步器框架AbstractQueuedSynchronizer源码图文分析 - Throwable&#8217;s Blog</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/dennyzhangdd/p/7218510.html">《The java.util.concurrent Synchronizer Framework》 JUC同步器框架（AQS框架）原文翻译 - 只会一点java - 博客园</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/waterystone/p/4920797.html">Java并发之AQS详解 - waterystone - 博客园</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/chengxiao/archive/2017/07/24/7141160.html">Java并发包基石-AQS详解 - dreamcatcher-cx - 博客园</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/leesf456/p/5350186.html">【JUC】JDK1.8源码分析之AbstractQueuedSynchronizer（二） - leesf - 博客园</a></p>
</li>
<li>
<p><a href="http://www.infoq.com/cn/articles/jdk1.8-abstractqueuedsynchronizer">深度解析Java 8：JDK1.8 AbstractQueuedSynchronizer的实现分析（上）</a></p>
</li>
<li>
<p><a href="http://www.infoq.com/cn/articles/java8-abstractqueuedsynchronizer">深度解析Java 8：AbstractQueuedSynchronizer的实现分析（下）</a></p>
</li>
<li>
<p><a href="http://www.molotang.com/articles/480.html">Lock、ReentrantLock和AbstractQueuedSynchronizer的源码要点分析整理 | 三石·道</a></p>
</li>
<li>
<p><a href="http://zhanjindong.com/2015/03/10/java-concurrent-package-aqs-overview">Java并发包源码学习之AQS框架（一）概述 - Jindong Zhan</a></p>
</li>
<li>
<p><a href="http://zhanjindong.com/2015/03/11/java-concurrent-package-aqs-clh-and-spin-lock">Java并发包源码学习之AQS框架（二）CLH lock queue和自旋锁 - Jindong Zhan</a></p>
</li>
<li>
<p><a href="http://zhanjindong.com/2015/03/14/java-concurrent-package-aqs-locksupport-and-thread-interrupt">Java并发包源码学习之AQS框架（三）LockSupport和interrupt - Jindong Zhan</a></p>
</li>
<li>
<p><a href="http://zhanjindong.com/2015/03/15/java-concurrent-package-aqs-AbstractQueuedSynchronizer">Java并发包源码学习之AQS框架（四）AbstractQueuedSynchronizer源码分析 - Jindong Zhan</a></p>
</li>
<li>
<p><a href="http://ifeve.com/introduce-abstractqueuedsynchronizer/">AbstractQueuedSynchronizer的介绍和原理分析 | 并发编程网 - ifeve.com</a></p>
</li>
<li>
<p><a href="http://coderbee.net/index.php/concurrent/20131209/614">JUC 源码分析 一 AbstractQueuedSynchronizer | 码蜂笔记</a></p>
</li>
<li>
<p><a href="http://www.hiyangqi.com/java%20concurrency/java-concurrency-AQS.html">Java 多线程基本工具的原理AQS</a></p>
</li>
<li>
<p><a href="http://www.tqcto.com/article/internet/5807.html">JUC 源码分析 3 AbstractQueuedSynchronizer 共享模式 与 CountDownLatch - 互联网 - 爱上编程技术博客</a></p>
</li>
<li>
<p><a href="http://jiangwenfeng762.iteye.com/blog/1293814">通过CountDownLatch来分析AbstractQueuedSynchronizer的源码 - - ITeye技术网站</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reentrantlock"><a class="anchor" href="#_reentrantlock"></a>44. ReentrantLock</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>ReentrantLock</code> 是重入锁，也是排他锁。</p>
</div>
<div class="sect2">
<h3 id="_谈谈_synchronized_和_reentrantlock_的区别"><a class="anchor" href="#_谈谈_synchronized_和_reentrantlock_的区别"></a>44.1. 谈谈 synchronized 和 ReentrantLock 的区别</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>两者都是可重入锁</p>
<div class="paragraph">
<p>两者都是可重入锁。“可重入锁”概念是：自己可以再次获取自己的内部锁。比如一个线程获得了某个对象的锁，此时这个对象锁还没有释放，当其再次想要获取这个对象的锁的时候还是可以获取的，如果不可锁重入的话，就会造成死锁。同一个线程每次获取锁，锁的计数器都自增1，所以要等到锁的计数器下降为0时才能释放锁。</p>
</div>
</li>
<li>
<p>synchronized 依赖于 JVM 而 ReentrantLock 依赖于 API</p>
<div class="paragraph">
<p>synchronized 是依赖于 JVM 实现的，前面我们也讲到了 虚拟机团队在 JDK1.6 为 synchronized 关键字进行了很多优化，但是这些优化都是在虚拟机层面实现的，并没有直接暴露给我们。ReentrantLock 是 JDK 层面实现的（也就是 API 层面，需要 lock() 和 unlock() 方法配合 try/finally 语句块来完成），所以我们可以通过查看它的源代码，来看它是如何实现的。</p>
</div>
</li>
<li>
<p>ReentrantLock 比 synchronized 增加了一些高级功能</p>
<div class="paragraph">
<p>相比synchronized，ReentrantLock增加了一些高级功能。主要来说主要有三点：<strong>①等待可中断；②可实现公平锁；③可实现选择性通知（锁可以绑定多个条件）</strong></p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><strong>ReentrantLock提供了一种能够中断等待锁的线程的机制</strong>，通过lock.lockInterruptibly()来实现这个机制。也就是说正在等待的线程可以选择放弃等待，改为处理其他事情。</p>
</li>
<li>
<p><strong>ReentrantLock可以指定是公平锁还是非公平锁。</strong>*而synchronized只能是非公平锁。所谓的公平锁就是先等待的线程先获得锁。 ReentrantLock默认情况是非公平的，可以通过 ReentrantLock类的ReentrantLock(boolean fair)构造方法来制定是否是公平的。</p>
</li>
<li>
<p>synchronized关键字与wait()和notify()/notifyAll()方法相结合可以实现等待/通知机制，ReentrantLock类当然也可以实现，但是需要借助于Condition接口与newCondition() 方法。Condition是JDK1.5之后才有的，它具有很好的灵活性，比如可以实现多路通知功能也就是在一个Lock对象中可以创建多个Condition实例（即对象监视器），<strong>线程对象可以注册在指定的Condition中，从而可以有选择性的进行线程通知，在调度线程上更加灵活。 在使用notify()/notifyAll()方法进行通知时，被通知的线程是由 JVM 选择的，用ReentrantLock类结合Condition实例可以实现“选择性通知”</strong>，这个功能非常重要，而且是Condition接口默认提供的。而synchronized关键字就相当于整个Lock对象中只有一个Condition实例，所有的线程都注册在它一个身上。如果执行notifyAll()方法的话就会通知所有处于等待状态的线程这样会造成很大的效率问题，而Condition实例的signalAll()方法 只会唤醒注册在该Condition实例中的所有等待线程。</p>
<div class="paragraph">
<p>如果你想使用上述功能，那么选择ReentrantLock是一个不错的选择。</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>性能已不是选择标准</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Condition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-13 17:10
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReentrantLockTest</span> <span class="o">{</span>
    <span class="cm">/**
     * 测试可重入性
     */</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReentrant</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">SumTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SumTask</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">SumTask</span><span class="o">.</span><span class="na">i</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SumTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1_000_000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">i</span><span class="o">++;</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testExtraUnlock</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Locking..."</span><span class="o">);</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finished..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInterrupt</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">InterruptTask</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
<span class="c1">//        Thread.sleep(2);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finished..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">InterruptTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="kd">public</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100_000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="n">j</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"InterruptTask was interrupted."</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"i="</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">isHeldByCurrentThread</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"i="</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCondition</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
        <span class="nc">Condition</span> <span class="n">condition</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConditionTask</span><span class="o">(</span><span class="n">lock</span><span class="o">,</span> <span class="n">condition</span><span class="o">));</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="n">condition</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ConditionTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Lock</span> <span class="n">lock</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Condition</span> <span class="n">condition</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">ConditionTask</span><span class="o">(</span><span class="nc">Lock</span> <span class="n">lock</span><span class="o">,</span> <span class="nc">Condition</span> <span class="n">condition</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">lock</span> <span class="o">=</span> <span class="n">lock</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">condition</span> <span class="o">=</span> <span class="n">condition</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="n">condition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Thread is going on..."</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testExclusive</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="s">"t1"</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t1 : "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">throwable</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>

        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="s">"t2"</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"t2 : "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">throwable</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">15000</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"DONE"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="code"><pre>    <span class="cm">/**
     * Acquires in exclusive mode, aborting if interrupted.
     * Implemented by first checking interrupt status, then invoking
     * at least once {@link #tryAcquire}, returning on
     * success.  Otherwise the thread is queued, possibly repeatedly
     * blocking and unblocking, invoking {@link #tryAcquire}
     * until success or the thread is interrupted.  This method can be
     * used to implement method {@link Lock#lockInterruptibly}.
     *
     * @param arg the acquire argument.  This value is conveyed to
     *        {@link #tryAcquire} but is otherwise uninterpreted and
     *        can represent anything you like.
     * @throws InterruptedException if the current thread is interrupted
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">acquireInterruptibly</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span>
            <span class="n">doAcquireInterruptibly</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>先判断是否有中断，有则响应。从这里就可以看出，在加锁之前也可以被中断。</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reentrantreadwritelock"><a class="anchor" href="#_reentrantreadwritelock"></a>45. ReentrantReadWriteLock</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantReadWriteLock</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-16 17:07
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReentrantReadWriteLockTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">handleRead</span><span class="o">(</span><span class="nc">Lock</span> <span class="n">lock</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">" : read done!"</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleWrite</span><span class="o">(</span><span class="nc">Lock</span> <span class="n">lock</span><span class="o">,</span> <span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">" : write done!"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ReentrantReadWriteLock</span> <span class="n">readWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">();</span>
        <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">ReadLock</span> <span class="n">readLock</span> <span class="o">=</span> <span class="n">readWriteLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
        <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">WriteLock</span> <span class="n">writeLock</span> <span class="o">=</span> <span class="n">readWriteLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>

        <span class="nc">Runnable</span> <span class="n">readTask</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">handleRead</span><span class="o">(</span><span class="n">readLock</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="nc">Runnable</span> <span class="n">writeTask</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">handleWrite</span><span class="o">(</span><span class="n">writeLock</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">writeTask</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">readTask</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stampedlock"><a class="anchor" href="#_stampedlock"></a>46. StampedLock</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ThreadLocalRandom</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.StampedLock</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-16 23:15
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StampedLockTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">StampedLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StampedLock</span><span class="o">();</span>
        <span class="nc">Point</span> <span class="n">point</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Point</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="nc">ThreadLocalRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">();</span>
                <span class="n">point</span><span class="o">.</span><span class="na">move</span><span class="o">(</span><span class="n">random</span><span class="o">.</span><span class="na">nextDouble</span><span class="o">(</span><span class="mi">100</span><span class="o">),</span> <span class="n">random</span><span class="o">.</span><span class="na">nextDouble</span><span class="o">(</span><span class="mi">100</span><span class="o">));</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"move point..."</span><span class="o">);</span>
            <span class="o">});</span>

            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="kt">double</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">point</span><span class="o">.</span><span class="na">distanceFromOrigin</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"current distance = "</span> <span class="o">+</span> <span class="n">distance</span><span class="o">);</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Point</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">double</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">StampedLock</span> <span class="n">lock</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Point</span><span class="o">(</span><span class="nc">StampedLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">lock</span> <span class="o">=</span> <span class="n">lock</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">void</span> <span class="nf">move</span><span class="o">(</span><span class="kt">double</span> <span class="n">deltaX</span><span class="o">,</span> <span class="kt">double</span> <span class="n">deltaxY</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="n">deltaX</span><span class="o">;</span>
                <span class="n">y</span> <span class="o">+=</span> <span class="n">deltaxY</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">stamp</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="kt">double</span> <span class="nf">distanceFromOrigin</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">tryOptimisticRead</span><span class="o">();</span>
            <span class="kt">double</span> <span class="n">currentX</span> <span class="o">=</span> <span class="n">x</span><span class="o">,</span> <span class="n">currentY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">lock</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">stamp</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">stamp</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">currentX</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
                    <span class="n">currentY</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">stamp</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nc">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">currentX</span> <span class="o">*</span> <span class="n">currentX</span> <span class="o">+</span> <span class="n">currentY</span> <span class="o">*</span> <span class="n">currentY</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_semaphore"><a class="anchor" href="#_semaphore"></a>47. Semaphore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>信号量</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Semaphore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-16 16:51
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemaphoreTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
        <span class="nc">Semaphore</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="n">semaphore</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Ok..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">semaphore</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">Semaphore</span> <span class="n">semaphore</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">semaphore</span> <span class="o">=</span> <span class="n">semaphore</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">semaphore</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">" :done!"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReentrant</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 将 Semaphore 的参数分别设置成 1 和 5 运行看结果</span>
        <span class="c1">// 递归调用的次数跟 Semaphore 的参数一致</span>
        <span class="c1">// 说明，如果 Semaphore 参数为 1 时，它不支持重入。</span>
        <span class="nc">Semaphore</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
            <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Semaphore</span> <span class="n">semaphore</span><span class="o">;</span>
            <span class="kd">private</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

            <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">Semaphore</span> <span class="n">semaphore</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">this</span><span class="o">.</span><span class="na">semaphore</span> <span class="o">=</span> <span class="n">semaphore</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">semaphore</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">len</span><span class="o">++);</span>
                    <span class="n">run</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="n">semaphore</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_countdownlatch"><a class="anchor" href="#_countdownlatch"></a>48. CountDownLatch</h2>
<div class="sectionbody">
<div class="paragraph">
<p>"Count Down" 在英语中意为倒计数，一个典型场景就是火箭🚀发射时的倒计时。它允许一个或多个线程等待其他线程完成操作。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CountDownLatch</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-16 17:23
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountDownLatchTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">CountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="n">latch</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Fire..."</span><span class="o">);</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"All task were done."</span><span class="o">);</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">5</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Terminal at "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CountDownLatch</span> <span class="n">latch</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">CountDownLatch</span> <span class="n">latch</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">latch</span> <span class="o">=</span> <span class="n">latch</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
                <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">" time = "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">time</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">" sleep = "</span> <span class="o">+</span> <span class="n">time</span> <span class="o">+</span> <span class="s">": check finished."</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>下面，我们开始看 <code>CountDownLatch</code> 源码：</p>
</div>
<div class="paragraph">
<p><code>CountDownLatch</code> 类中存在一个内部类 <code>Sync</code>，继承自 <code>AbstractQueuedSynchronizer</code>，代码如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="cm">/**
 * Synchronization control For CountDownLatch.
 * Uses AQS state to represent count.
 */</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Sync</span> <span class="kd">extends</span> <span class="nc">AbstractQueuedSynchronizer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">4982264981922014374L</span><span class="o">;</span>

    <span class="nc">Sync</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">setState</span><span class="o">(</span><span class="n">count</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kt">int</span> <span class="nf">getCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getState</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">tryAcquireShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">getState</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryReleaseShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">releases</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Decrement count; signal when transition to zero</span>
        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetState</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="n">nextc</span><span class="o">))</span>
                <span class="k">return</span> <span class="n">nextc</span> <span class="o">==</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Sync</span> <span class="n">sync</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>管中窥豹，从这里也可以看出 <code>CountDownLatch</code> 中的等待控制几乎都是依赖 <code>AbstractQueuedSynchronizer</code> 来实现的。</p>
</div>
<div class="sect2">
<h3 id="_await"><a class="anchor" href="#_await"></a>48.1. <code>await()</code></h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="code"><pre><span class="cm">/**
 * Causes the current thread to wait until the latch has counted down to
 * zero, unless the thread is {@linkplain Thread#interrupt interrupted}.
 *
 * &lt;p&gt;If the current count is zero then this method returns immediately.
 *
 * &lt;p&gt;If the current count is greater than zero then the current
 * thread becomes disabled for thread scheduling purposes and lies
 * dormant until one of two things happen:
 * &lt;ul&gt;
 * &lt;li&gt;The count reaches zero due to invocations of the
 * {@link #countDown} method; or
 * &lt;li&gt;Some other thread {@linkplain Thread#interrupt interrupts}
 * the current thread.
 * &lt;/ul&gt;
 *
 * &lt;p&gt;If the current thread:
 * &lt;ul&gt;
 * &lt;li&gt;has its interrupted status set on entry to this method; or
 * &lt;li&gt;is {@linkplain Thread#interrupt interrupted} while waiting,
 * &lt;/ul&gt;
 * then {@link InterruptedException} is thrown and the current thread's
 * interrupted status is cleared.
 *
 * @throws InterruptedException if the current thread is interrupted
 *         while waiting
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="n">sync</span><span class="o">.</span><span class="na">acquireSharedInterruptibly</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>对 <code>await()</code> 的处理直接委托给了 <code>sync</code> 的 <code>acquireSharedInterruptibly(1)</code> 方法，当然这个方法是从 <code>AbstractQueuedSynchronizer</code> 继承而来的。来看一下这个方法：</p>
</div>
<div class="listingblock">
<div class="title">AbstractQueuedSynchronizer</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre>    <span class="cm">/**
     * Acquires in shared mode, aborting if interrupted.  Implemented
     * by first checking interrupt status, then invoking at least once
     * {@link #tryAcquireShared}, returning on success.  Otherwise the
     * thread is queued, possibly repeatedly blocking and unblocking,
     * invoking {@link #tryAcquireShared} until success or the thread
     * is interrupted.
     * @param arg the acquire argument.
     * This value is conveyed to {@link #tryAcquireShared} but is
     * otherwise uninterpreted and can represent anything
     * you like.
     * @throws InterruptedException if the current thread is interrupted
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">acquireSharedInterruptibly</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span>
            <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tryAcquireShared</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">doAcquireSharedInterruptibly</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>结合上面提到的 <code>Sync</code> 中的 <code>tryAcquireShared(int acquires)</code> 方法，可以看出，当 <code>getState()</code> 不为零时，就会导致 <code>tryAcquireShared(arg)</code> 结果返回小于零，进而调用 <code>doAcquireSharedInterruptibly(arg)</code>，将线程进入排队，然后挂起线程。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CountDownLatch-await-park.png" alt="CountDownLatch await park">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CountDownLatch-await-unpark.png" alt="CountDownLatch await unpark">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_countdown"><a class="anchor" href="#_countdown"></a>48.2. <code>countDown()</code></h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="cm">/**
 * Decrements the count of the latch, releasing all waiting threads if
 * the count reaches zero.
 *
 * &lt;p&gt;If the current count is greater than zero then it is decremented.
 * If the new count is zero then all waiting threads are re-enabled for
 * thread scheduling purposes.
 *
 * &lt;p&gt;If the current count equals zero then nothing happens.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">countDown</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">sync</span><span class="o">.</span><span class="na">releaseShared</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>这里的 <code>releaseShared(1)</code> 方法是从 <code>AbstractQueuedSynchronizer</code> 继承过来的，来看一下这个方法的实现：</p>
</div>
<div class="listingblock">
<div class="title">AbstractQueuedSynchronizer</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre>    <span class="cm">/**
     * Releases in shared mode.  Implemented by unblocking one or more
     * threads if {@link #tryReleaseShared} returns true.
     *
     * @param arg the release argument.  This value is conveyed to
     *        {@link #tryReleaseShared} but is otherwise uninterpreted
     *        and can represent anything you like.
     * @return the value returned from {@link #tryReleaseShared}
     */</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">releaseShared</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tryReleaseShared</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">doReleaseShared</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>结合上面提到的 <code>Sync</code> 中的 <code>tryReleaseShared(int releases)</code> 方法，我们可以看出：<code>countDown()</code> 方法直接减少锁存器计数，如果不为零，则无所作为；减少到零，则释放所有上述通过 <code>await()</code> 方法挂起的所有等待线程。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CountDownLatch-countDown-1.png" alt="CountDownLatch countDown 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CountDownLatch-countDown-2.png" alt="CountDownLatch countDown 2">
</div>
</div>
<div class="qlist qanda">
<ol>
<li>
<p><em><code>CountDownLatch</code> 为什么使用共享锁？</em></p>
<p>答：前面我们分析 <code>ReentrantReadWriteLock</code> 的时候学习过AQS的共享锁模式，比如当前锁是由一个线程获取为互斥锁，那么这时候所有需要获取共享锁的线程都要进入AQS队列中进行排队，当这个互斥锁释放的时候，会一个接着一个地唤醒这些连续的排队的等待获取共享锁的线程，注意，这里的用语是“一个接着一个地唤醒”，也就是说这些等待获取共享锁的线程不是一次性唤醒的。</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_10"><a class="anchor" href="#_参考资料_10"></a>48.3. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.cnblogs.com/leesf456/p/5406191.html">【JUC】JDK1.8源码分析之CountDownLatch（五） - leesf - 博客园</a></p>
</li>
<li>
<p><a href="https://juejin.im/post/5d0660f2518825092c7170dd">死磕 java同步系列之CountDownLatch源码解析 - 掘金</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cyclicbarrier"><a class="anchor" href="#_cyclicbarrier"></a>49. CyclicBarrier</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.BrokenBarrierException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CyclicBarrier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-16 17:24
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CyclicBarrierTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">CyclicBarrier</span> <span class="n">barrier</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CyclicBarrier</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span>
                <span class="o">()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"集合完毕，出发……"</span><span class="o">));</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="n">barrier</span><span class="o">,</span> <span class="s">"Task-"</span> <span class="o">+</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)));</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finished."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">CyclicBarrier</span> <span class="n">barrier</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">CyclicBarrier</span> <span class="n">barrier</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">barrier</span> <span class="o">=</span> <span class="n">barrier</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">" start..."</span><span class="o">);</span>
                <span class="n">barrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">" running..."</span><span class="o">);</span>
                <span class="n">barrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="o">|</span> <span class="nc">BrokenBarrierException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_phaser"><a class="anchor" href="#_phaser"></a>50. Phaser</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_exchanger"><a class="anchor" href="#_exchanger"></a>51. Exchanger</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_threadlocal"><a class="anchor" href="#_threadlocal"></a>52. ThreadLocal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>原以为神秘兮兮的 <code>ThreadLocal</code> 是何方神圣？没想到，点开代码，竟然如此简单明了，直接上代码：</p>
</div>
<div class="listingblock">
<div class="title">Thread</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="cm">/* ThreadLocal values pertaining to this thread. This map is maintained
 * by the ThreadLocal class. */</span>
<span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">ThreadLocalMap</span> <span class="n">threadLocals</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">ThreadLocal</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="code"><pre><span class="cm">/**
 * Get the map associated with a ThreadLocal. Overridden in
 * InheritableThreadLocal.
 *
 * @param  t the current thread
 * @return the map
 */</span>
<span class="nc">ThreadLocalMap</span> <span class="nf">getMap</span><span class="o">(</span><span class="nc">Thread</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">threadLocals</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Returns the value in the current thread's copy of this
 * thread-local variable.  If the variable has no value for the
 * current thread, it is first initialized to the value returned
 * by an invocation of the {@link #initialValue} method.
 *
 * @return the current thread's value of this thread-local
 */</span>
<span class="kd">public</span> <span class="no">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
    <span class="nc">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ThreadLocalMap</span><span class="o">.</span><span class="na">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">getEntry</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
            <span class="no">T</span> <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span><span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="nf">setInitialValue</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * Sets the current thread's copy of this thread-local variable
 * to the specified value.  Most subclasses will have no need to
 * override this method, relying solely on the {@link #initialValue}
 * method to set the values of thread-locals.
 *
 * @param value the value to be stored in the current thread's copy of
 *        this thread-local.
 */</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
    <span class="nc">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">map</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">createMap</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThreadLocalMap</span> <span class="o">{</span>

    <span class="cm">/**
     * The entries in this hash map extend WeakReference, using
     * its main ref field as the key (which is always a
     * ThreadLocal object).  Note that null keys (i.e. entry.get()
     * == null) mean that the key is no longer referenced, so the
     * entry can be expunged from table.  Such entries are referred to
     * as "stale entries" in the code that follows.
     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="kd">extends</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">ThreadLocal</span><span class="o">&lt;?&gt;&gt;</span> <span class="o">{</span>
        <span class="cm">/** The value associated with this ThreadLocal. */</span>
        <span class="nc">Object</span> <span class="n">value</span><span class="o">;</span>

        <span class="nc">Entry</span><span class="o">(</span><span class="nc">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">k</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">// ……</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>简单解释一下：</p>
</div>
<div class="paragraph">
<p>当前线程调用 <code>ThreadLocal</code> 类的 <code>set</code> 或 <code>get</code> 方法时，其实是调用的当前线程的 <code>ThreadLocal.ThreadLocalMap threadLocals</code> 变量的 <code>set(ThreadLocal&lt;?&gt; key, Object value)</code> 和 <code>Entry getEntry(ThreadLocal&lt;?&gt; key)</code>。还有一点需要稍加注意：虽然 <code>ThreadLocal.ThreadLocalMap</code> 名称是以 <code>Map</code> 结尾，但是它并没有实现 <code>Map</code> 接口，只是操作上有些类似。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ThreadLocal-set-get.jpeg" alt="ThreadLocal set get">
</div>
</div>
<div class="paragraph">
<p>有一点需要特别注意：<code>ThreadLocalMap</code> 中使用的 <code>key</code> 为 <code>ThreadLocal</code> 的弱引用,而 <code>value</code> 是强引用。所以，如果 <code>ThreadLocal</code> 没有被外部强引用的情况下，在垃圾回收的时候，<code>key</code> 会被清理掉，而 <code>value</code> 不会被清理掉。这样一来，<code>ThreadLocalMap</code> 中就会出现 <code>key</code> 为 <code>null</code> 的 <code>Entry</code>。假如我们不做任何措施的话，<code>value</code> 永远无法被 GC 回收，这个时候就可能会产生内存泄露。<code>ThreadLocalMap</code> 实现中已经考虑了这种情况，在调用 <code>set()</code>、<code>get()</code>、<code>remove()</code> 方法的时候，会清理掉 <code>key</code> 为 <code>null</code> 的记录。使用完 <code>ThreadLocal</code> 方法后 最好手动调用 <code>remove()</code> 方法。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-09 20:20
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocalTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">FirstApp</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInheritableThreadLocal</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// TODO: InheritableThreadLocal</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FirstApp</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">threadLocal</span>
                <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"FirstApp-1"</span><span class="o">);</span>

        <span class="kd">private</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">threadLocal2</span>
                <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"FirstApp-2"</span><span class="o">);</span>

        <span class="kd">private</span> <span class="nc">SecondApp</span> <span class="n">secondApp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecondApp</span><span class="o">();</span>
        <span class="kd">private</span> <span class="nc">ThridApp</span> <span class="n">thridApp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThridApp</span><span class="o">();</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadLocal2</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">secondApp</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
            <span class="n">thridApp</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SecondApp</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">threadLocal</span>
                <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"SecondApp"</span><span class="o">);</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThridApp</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">threadLocal</span>
                <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">threadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">"new-ThridApp-value"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>关注一下： <code>java.lang.InheritableThreadLocal</code>。</p>
</div>
<div class="paragraph">
<p>JDK 的 <code>InheritableThreadLocal</code> 类可以完成父线程到子线程的值传递。但对于使用线程池等会池化复用线程的执行组件的情况，线程由线程池创建好，并且线程是池化起来反复使用的；这时父子线程关系的 <code>ThreadLocal</code> 值传递已经没有意义，应用需要的实际上是把任务提交给线程池时的 <code>ThreadLocal</code> 值传递到 任务执行时。为了解决这个问题，阿里巴巴研发了 <a href="https://github.com/alibaba/transmittable-thread-local">alibaba/transmittable-thread-local</a> 库。</p>
</div>
<div class="paragraph">
<p>哈希冲突了怎么解决？</p>
</div>
<div class="sect2">
<h3 id="_参考资料_11"><a class="anchor" href="#_参考资料_11"></a>52.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://snailclimb.gitee.io/javaguide/#/docs/java/Multithread/JavaConcurrencyAdvancedCommonInterviewQuestions?id=_33-threadlocal%e5%8e%9f%e7%90%86">JavaGuide
之 ThreadLocal</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/dennyzhangdd/p/7978455.html">ThreadLocal终极源码剖析-一篇足矣！ - 只会一点java - 博客园</a></p>
</li>
<li>
<p><a href="http://www.throwable.club/2019/02/17/java-concurrency-threadlocal-source-code/">ThreadLocal源码分析-黄金分割数的使用 - Throwable&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_atomicinteger"><a class="anchor" href="#_atomicinteger"></a>53. AtomicInteger</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>AtomicInteger</code> 类主要利用 CAS (compare and swap) + volatile 和 native 方法来保证原子操作，从而避免 <code>synchronized</code> 的高开销，执行效率大为提升。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_longadder"><a class="anchor" href="#_longadder"></a>54. LongAdder</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.LongAdder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-09 14:23
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LongAdderTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">LongAdder</span> <span class="n">adder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LongAdder</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">processors</span> <span class="o">=</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">processors</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">processors</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">processors</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">adder</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">adder</span><span class="o">.</span><span class="na">sum</span><span class="o">());</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_juc_包基础类分析"><a class="anchor" href="#_juc_包基础类分析"></a>55. JUC 包基础类分析</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JUC 包中有一些提交比较小的类，这类类单列出来重量太小，不够篇幅。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_futuretask"><a class="anchor" href="#_futuretask"></a>56. FutureTask</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_类图_4"><a class="anchor" href="#_类图_4"></a>56.1. 类图</h3>
<div class="paragraph">
<p>先来看一下 <code>ArrayList</code> 的类图：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-cadbe24dc7871bade7fa15b1dbddb3ba.svg" alt="Diagram" width="90%" height="308">
</div>
</div>
<div class="paragraph">
<p>实现了 <code>Runnable</code> 的 <code>run()</code>，在方法结束时，获取返回值。</p>
</div>
<div class="paragraph">
<p><code>V get()</code> 方法之所以能阻塞直到方法执行，拿到结果，是因为在 <code>get()</code> 方法通过 <code>awaitDone(boolean timed, long nanos)</code> 执行了一个无限循环。在循环过程中，不断获取任务执行的状态，进一步获取结果或者响应中断请求。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="code"><pre><span class="cm">/**
 * @throws CancellationException {@inheritDoc}
 */</span>
<span class="kd">public</span> <span class="no">V</span> <span class="nf">get</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span><span class="o">,</span> <span class="nc">ExecutionException</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&lt;=</span> <span class="no">COMPLETING</span><span class="o">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">awaitDone</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="mi">0L</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">report</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Awaits completion or aborts on interrupt or timeout.
 *
 * @param timed true if use timed waits
 * @param nanos time to wait, if timed
 * @return state upon completion or at timeout
 */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="nf">awaitDone</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">timed</span><span class="o">,</span> <span class="kt">long</span> <span class="n">nanos</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// The code below is very delicate, to achieve these goals:</span>
    <span class="c1">// - call nanoTime exactly once for each call to park</span>
    <span class="c1">// - if nanos &lt;= 0L, return promptly without allocation or nanoTime</span>
    <span class="c1">// - if nanos == Long.MIN_VALUE, don't underflow</span>
    <span class="c1">// - if nanos == Long.MAX_VALUE, and nanoTime is non-monotonic</span>
    <span class="c1">//   and we suffer a spurious wakeup, we will do no worse than</span>
    <span class="c1">//   to park-spin for a while</span>
    <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>    <span class="c1">// Special value 0L means not yet parked</span>
    <span class="nc">WaitNode</span> <span class="n">q</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="n">queued</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;</span> <span class="no">COMPLETING</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">q</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">q</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="no">COMPLETING</span><span class="o">)</span>
            <span class="c1">// We may have already promised (via isDone) that we are done</span>
            <span class="c1">// so never return empty-handed or throw InterruptedException</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">removeWaiter</span><span class="o">(</span><span class="n">q</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">q</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">timed</span> <span class="o">&amp;&amp;</span> <span class="n">nanos</span> <span class="o">&lt;=</span> <span class="mi">0L</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
            <span class="n">q</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WaitNode</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">queued</span><span class="o">)</span>
            <span class="n">queued</span> <span class="o">=</span> <span class="no">WAITERS</span><span class="o">.</span><span class="na">weakCompareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">q</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">waiters</span><span class="o">,</span> <span class="n">q</span><span class="o">);</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">timed</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">parkNanos</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">startTime</span> <span class="o">==</span> <span class="mi">0L</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// first time</span>
                <span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">startTime</span> <span class="o">==</span> <span class="mi">0L</span><span class="o">)</span>
                    <span class="n">startTime</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
                <span class="n">parkNanos</span> <span class="o">=</span> <span class="n">nanos</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="kt">long</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">nanos</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">removeWaiter</span><span class="o">(</span><span class="n">q</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">state</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">parkNanos</span> <span class="o">=</span> <span class="n">nanos</span> <span class="o">-</span> <span class="n">elapsed</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="c1">// nanoTime may be slow; recheck before parking</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="no">COMPLETING</span><span class="o">)</span>
                <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">parkNanos</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span>
            <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_12"><a class="anchor" href="#_参考资料_12"></a>56.2. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2019/07/02/java-concurrency-listenable-future/">JUC线程池扩展可回调的Future - Throwable&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_completablefuture"><a class="anchor" href="#_completablefuture"></a>57. CompletableFuture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Java 中的 Promise。</p>
</div>
<div class="paragraph">
<p>问题：在一大堆任务中，如何获取第一个完成的返回值？</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.*</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-19 16:04
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">ExecutionException</span><span class="o">,</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="nc">FutureTask</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">futureTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FutureTask</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">());</span>

        <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">futureTask</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"FutureTask..."</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">futureTask</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"FutureTask done."</span><span class="o">);</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">""</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"All tasks were done."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">second</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">ThreadLocalRandom</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">();</span>
                <span class="n">second</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">second</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">second</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_13"><a class="anchor" href="#_参考资料_13"></a>57.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.baeldung.com/java-completablefuture">Guide To CompletableFuture | Baeldung</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_threadpoolexecutor_源码分析"><a class="anchor" href="#_threadpoolexecutor_源码分析"></a>58. ThreadPoolExecutor 源码分析</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10.1123%;">
<col style="width: 37.0786%;">
<col style="width: 10.1123%;">
<col style="width: 42.6968%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">状态名称</th>
<th class="tableblock halign-left valign-top">比特位</th>
<th class="tableblock halign-left valign-top">十进制</th>
<th class="tableblock halign-left valign-top">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RUNNING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">111-00000000000000000000000000000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">-536870912</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">运行中状态，可以接收新的任务和执行任务队列中的任务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SHUTDOWN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">000-00000000000000000000000000000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">shutdown状态，不再接收新的任务，但是会执行任务队列中的任务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">STOP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">001-00000000000000000000000000000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">536870912</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">停止状态，不再接收新的任务，也不会执行任务队列中的任务，中断所有执行中的任务</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIDYING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">010-00000000000000000000000000000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">1073741824</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">整理中状态，所有任务已经终结，工作线程数为0，过渡到此状态的工作线程会调用钩子方法 <code>terminated()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TERMINATED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">011-00000000000000000000000000000</p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock">1610612736</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">终结状态，钩子方法 <code>terminated()</code> 执行完毕</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>由于运行状态值存放在高3位，所以可以直接通过十进制值（甚至可以忽略低29位，直接用ctl进行比较，或者使用ctl和线程池状态常量进行比较）来比较和判断线程池的状态：工作线程数为0的前提下：<code>RUNNING(-536870912)</code> &lt; <code>SHUTDOWN(0)</code> &lt; <code>STOP(536870912)</code> &lt; <code>TIDYING(1073741824)</code> &lt; <code>TERMINATED(1610612736)</code>。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ThreadPoolExecutor-states.jpeg" alt="ThreadPoolExecutor states">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td><td class="code"><pre>    <span class="cm">/**
     * Executes the given task sometime in the future.  The task
     * may execute in a new thread or in an existing pooled thread.
     *
     * If the task cannot be submitted for execution, either because this
     * executor has been shutdown or because its capacity has been reached,
     * the task is handled by the current {@link RejectedExecutionHandler}.
     *
     * @param command the task to execute
     * @throws RejectedExecutionException at discretion of
     *         {@code RejectedExecutionHandler}, if the task
     *         cannot be accepted for execution
     * @throws NullPointerException if {@code command} is null
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">command</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="cm">/*
         * Proceed in 3 steps:
         *
         * 1. If fewer than corePoolSize threads are running, try to
         * start a new thread with the given command as its first
         * task.  The call to addWorker atomically checks runState and
         * workerCount, and so prevents false alarms that would add
         * threads when it shouldn't, by returning false.
         *
         * 2. If a task can be successfully queued, then we still need
         * to double-check whether we should have added a thread
         * (because existing ones died since last checking) or that
         * the pool shut down since entry into this method. So we
         * recheck state and if necessary roll back the enqueuing if
         * stopped, or start a new thread if there are none.
         *
         * 3. If we cannot queue task, then we try to add a new
         * thread.  If it fails, we know we are shut down or saturated
         * and so reject the task.
         */</span>
        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="c1">// 如果当前工作线程数小于核心线程数，则创建新的线程并执行传入的任务</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">addWorker</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span>
                <span class="c1">// 创建核心线程成功则直接返回</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="c1">// 创建核心线程失败，则在其他任务提交时，已经创建了足够多的线程数</span>
            <span class="c1">// 或者线程池关闭等等，总之线程池状态已经发生变化，</span>
            <span class="c1">// 则更新 ctl 的临时变量</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// 运行到这里说明创建核心线程失败，则当前工作线程已经大于等于 corePoolSize</span>
        <span class="c1">// 判断线程池是否运行并且尝试用非阻塞方法向任务队列中添加任务（失败则返回 false）</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isRunning</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">command</span><span class="o">))</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">recheck</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="c1">// 向任务队列投放任务成功，对线程池状态做二次检查</span>
            <span class="c1">// 如果线程池状态不是运行中，则从任务队列中移除任务并执行拒绝策略</span>
            <span class="k">if</span> <span class="o">(!</span> <span class="n">isRunning</span><span class="o">(</span><span class="n">recheck</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">remove</span><span class="o">(</span><span class="n">command</span><span class="o">))</span>
                <span class="c1">// 执行拒绝策略 -- 结束</span>
                <span class="n">reject</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
            <span class="c1">// 走到下面的 else if 分支，则说明</span>
            <span class="c1">// 0、线程池可能是 RUNNING 状态</span>
            <span class="c1">// 1、任务移除失败（失败原因可能是任务已经被执行）</span>
            <span class="c1">// 如果当前线程数为0，则创建一个非核心线程并传入任务为 null -- 结束</span>
            <span class="c1">// 创建的线程不会马上执行任务，而是等待获取任务队列中的任务去执行</span>
            <span class="c1">// 如果当前线程数不为0，则什么也不做。因为任务已经成功加入队列，总会执行。</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">recheck</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
                <span class="n">addWorker</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 执行到这里说明：</span>
        <span class="c1">// 0、线程池中的工作线程总数已经大于等于 corePoolSize</span>
        <span class="c1">// 1、线程池可能不是 RUNNING 状态</span>
        <span class="c1">// 2、线程池可能是 RUNNING 状态同时任务队列已经满了</span>
        <span class="c1">// 如果向任务队列投放任务失败，则会尝试创建非核心线程传入任务执行</span>
        <span class="c1">// 创建非核心线程失败，此时需要拒绝执行任务</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">addWorker</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span>
            <span class="c1">// 执行拒绝策略 -- 结束</span>
            <span class="n">reject</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>为什么需要二次检查线程池的运行状态，当前工作线程数量为 <code>0</code>，尝试创建一个非核心线程并且传入的任务对象为 <code>null</code>？这个可以看API注释：</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>如果一个任务成功加入任务队列，我们依然需要二次检查是否需要添加一个工作线程（因为所有存活的工作线程有可能在最后一次检查之后已经终结）或者执行当前方法的时候线程池是否已经 <code>shutdown</code> 了。所以我们需要二次检查线程池的状态，必要时把任务从任务队列中移除或者在没有可用的工作线程的前提下新建一个工作线程。</p>
</div>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ThreadPoolExecutor-process.jpeg" alt="ThreadPoolExecutor process">
</div>
</div>
<div class="paragraph">
<p><code>runWorker()</code> 方法的核心流程：</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ThreadPoolExecutor-runWorker.jpeg" alt="ThreadPoolExecutor runWorker">
</div>
</div>
<div class="sect2">
<h3 id="_大纲"><a class="anchor" href="#_大纲"></a>58.1. 大纲</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>基本使用</p>
</li>
<li>
<p>使用 <code>Executors</code> 创建线程池</p>
</li>
<li>
<p>自定义任务，并提交任务</p>
</li>
<li>
<p>获取返回结果</p>
</li>
<li>
<p>线程池的类图结构</p>
</li>
<li>
<p>创建执行线程</p>
</li>
<li>
<p>取出任务执行</p>
</li>
<li>
<p>如何实现 <code>invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</code> ？</p>
</li>
<li>
<p>如何实现 <code>invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit)</code> ?</p>
</li>
<li>
<p>如何实现 <code>invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks)</code> ?</p>
</li>
<li>
<p>如何实现 <code>invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit)</code> ？</p>
</li>
<li>
<p>如何判断线程超时？以及超时后如何杀掉线程？</p>
</li>
<li>
<p>如何终止任务？温柔终止？或者野蛮终止？</p>
</li>
<li>
<p>线程池在jDK5、6、7中有哪些升级变化？</p>
</li>
<li>
<p>拒绝策略</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_核心点_2"><a class="anchor" href="#_核心点_2"></a>58.2. 核心点</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>关键参数</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>corePoolSize</code></p>
</li>
<li>
<p><code>maximumPoolSize</code></p>
</li>
<li>
<p><code>BlockingQueue</code></p>
</li>
<li>
<p><code>RejectedExecutionHandler</code></p>
</li>
<li>
<p><code>keepAliveTime</code></p>
</li>
<li>
<p><code>threadFactory</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><code>RejectedExecutionHandler</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>AbortPolicy</code></p>
</li>
<li>
<p><code>CallerRunsPolicy</code></p>
</li>
<li>
<p><code>DiscardPolicy</code></p>
</li>
<li>
<p><code>DiscardOldestPolicy</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>在生产环境，为了避免首次调用超时，可以调用 <code>executor.prestartAllCoreThreads()</code> 预创建所有 <code>core</code> 线程，避免来一个创一个带来首次调用慢的问题。</p>
</div>
</div>
<div class="sect2">
<h3 id="_问题_2"><a class="anchor" href="#_问题_2"></a>58.3. 问题</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>任务添加后，如何执行？</p>
</li>
<li>
<p>一个任务执行完成后，如何在同一个线程执行下一个任务？</p>
</li>
<li>
<p>在 <code>corePoolSize</code> 比 <code>maximumPoolSize</code> 小的情况下，如何判定一个线程是否超时？并且如何删除一个线程？</p>
</li>
<li>
<p>任务添加后，</p>
</li>
<li>
<p>如何返回任务执行的结果？</p>
</li>
<li>
<p>这个线程池还有哪些可以改进的地方？比如 Guava 中提供了哪些线程池？</p>
</li>
<li>
<p>如何改造成添加任务，如果没有达到 <code>maxPoolSize</code> 则先创建线程？</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_tomcat_改进"><a class="anchor" href="#_tomcat_改进"></a>58.3.1. Tomcat 改进</h4>
<div class="paragraph">
<p>可不可以自己封装一个Queue，在插入时增加以下逻辑呢？</p>
</div>
<div class="ulist">
<ul>
<li>
<p>如果当前有空闲线程等待接客，则把任务加入队列让孩儿们去抢。</p>
</li>
<li>
<p>如果没有空闲的了，总线程数又没到达max，那就返回false，让Executor去创建线程。</p>
</li>
<li>
<p>如果总线程数已达到max，则继续把任务加入队列缓冲一下。</p>
</li>
<li>
<p>如果缓冲队列也满了，抛出拒绝异常。</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/apache/tomcat/blob/master/java/org/apache/tomcat/util/threads/TaskQueue.java" class="bare">https://github.com/apache/tomcat/blob/master/java/org/apache/tomcat/util/threads/TaskQueue.java</a></div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TaskQueue</span> <span class="kd">extends</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="nc">ThreadPoolExecutor</span> <span class="n">parent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//we can't do any checks</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parent</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="c1">//we are maxed out on threads, simply queue the object</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getPoolSize</span><span class="o">()</span> <span class="o">==</span> <span class="n">parent</span><span class="o">.</span><span class="na">getMaximumPoolSize</span><span class="o">())</span> <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="c1">//we have idle threads, just add it to the queue</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getSubmittedCount</span><span class="o">()&lt;=(</span><span class="n">parent</span><span class="o">.</span><span class="na">getPoolSize</span><span class="o">()))</span> <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="c1">//if we have less threads than maximum force creation of a new thread</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getPoolSize</span><span class="o">()&lt;</span><span class="n">parent</span><span class="o">.</span><span class="na">getMaximumPoolSize</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="c1">//if we reached here, we need to add it to the queue</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>如何判断当前有没有空闲的线程等待接客？Tomcat 则靠扩展 <code>Executor</code>，增加一个当前请求数的计数器，在 <code>execute()</code> 方法前加1，再重载 <code>afterExecute()</code> 方法减1，然后判断当前线程总数是否大于当前请求总数就知道有咩有围观群众。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_需要注意的点"><a class="anchor" href="#_需要注意的点"></a>58.4. 需要注意的点</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>线程池如何初始化？</p>
</li>
<li>
<p>任务如何添加？</p>
</li>
<li>
<p>任务如何执行？</p>
</li>
<li>
<p>任务如何终止？</p>
</li>
<li>
<p>遇到异常如何处理？</p>
</li>
<li>
<p>线程池队列已满，如何拒绝？</p>
</li>
<li>
<p>任务执行过程中出现异常，如何处理？关闭该线程，重启一个吗？</p>
</li>
<li>
<p>？？</p>
</li>
<li>
<p>任务如何存放？</p>
</li>
<li>
<p>任务存放后，如何取出来？</p>
</li>
<li>
<p>如何做到不断地一个一个执行下去？</p>
</li>
<li>
<p>为什么 <code>Worker</code> 继承 <code>AbstractQueuedSynchronizer</code> ？AQS起什么作用？是否需要先研究一下？</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_收获"><a class="anchor" href="#_收获"></a>58.5. 收获</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>可以继承 <code>ThreadPoolExecutor</code>，实现 <code>beforeExecute()</code> 和 <code>afterExecute()</code> 等方法，来加入执行时的回调。类似的回调，还有 <code>terminated()</code></p>
</li>
<li>
<p>添加任务时， <code>execute()</code> 方法的第二种情况，为什么还有再次检查？</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Callable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Future</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.LinkedBlockingQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ThreadPoolExecutor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-10 10:50
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPoolExecutorTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testStatus</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="no">COUNT_BITS</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">SIZE</span> <span class="o">-</span> <span class="mi">3</span><span class="o">;</span>
        <span class="kt">int</span> <span class="no">COUNT_MASK</span> <span class="o">=</span> <span class="o">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>

        <span class="c1">// runState is stored in the high-order bits</span>
        <span class="kt">int</span> <span class="no">RUNNING</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">;</span>
        <span class="kt">int</span> <span class="no">SHUTDOWN</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">;</span>
        <span class="kt">int</span> <span class="no">STOP</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">;</span>
        <span class="kt">int</span> <span class="no">TIDYING</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">;</span>
        <span class="kt">int</span> <span class="no">TERMINATED</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="no">COUNT_BITS</span><span class="o">;</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%32s // %d%n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toBinaryString</span><span class="o">(</span><span class="no">RUNNING</span><span class="o">),</span> <span class="no">RUNNING</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%32s // %d%n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toBinaryString</span><span class="o">(</span><span class="no">SHUTDOWN</span><span class="o">),</span> <span class="no">SHUTDOWN</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%32s // %d%n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toBinaryString</span><span class="o">(</span><span class="no">STOP</span><span class="o">),</span> <span class="no">STOP</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%32s // %d%n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toBinaryString</span><span class="o">(</span><span class="no">TIDYING</span><span class="o">),</span> <span class="no">TIDYING</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%32s // %d%n"</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toBinaryString</span><span class="o">(</span><span class="no">TERMINATED</span><span class="o">),</span> <span class="no">TERMINATED</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testPoolSize</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolExecutor</span> <span class="n">executorService</span>
                <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">6</span><span class="o">));</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="s">"Task-"</span> <span class="o">+</span> <span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finish all thread..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCallable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolExecutor</span> <span class="n">executorService</span>
                <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">6</span><span class="o">));</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">10</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">CallableTask</span><span class="o">(</span><span class="s">"CallableTask-"</span> <span class="o">+</span> <span class="n">i</span><span class="o">));</span>

            <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">"::"</span> <span class="o">+</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="o">|</span> <span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finish all thread..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testComplete</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolExecutor</span> <span class="n">executorService</span>
                <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">6</span><span class="o">));</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">10</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">CallableTask</span><span class="o">(</span><span class="s">"CallableTask-"</span> <span class="o">+</span> <span class="n">i</span><span class="o">));</span>
            <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">future</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Future</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">"::"</span> <span class="o">+</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="o">|</span> <span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executorService</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finish all thread..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">CallableTask</span> <span class="kd">implements</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">CallableTask</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="c1">//返回执行当前 Callable 的线程名字</span>
            <span class="k">return</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">" Start. Time = "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>

            <span class="n">processCommand</span><span class="o">();</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">" End. Time = "</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">processCommand</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_思考题"><a class="anchor" href="#_思考题"></a>58.6. 思考题</h3>
<div class="paragraph">
<p>自己实现一个线程池。</p>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_14"><a class="anchor" href="#_参考资料_14"></a>58.7. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2019/07/15/java-concurrency-thread-pool-executor/">JUC线程池ThreadPoolExecutor源码分析 - Throwable&#8217;s Blog</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/leesf456/p/5585627.html">【JUC】JDK1.8源码分析之ThreadPoolExecutor（一） - leesf - 博客园</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s/baYuX8aCwQ9PP6k7TDl2Ww">Java线程池实现原理及其在美团业务中的实践</a></p>
</li>
<li>
<p><a href="http://calvin1978.blogcn.com/articles/java-threadpool.html">Java ThreadPool的正确打开方式 | 江南白衣</a></p>
</li>
<li>
<p><a href="http://calvin1978.blogcn.com/articles/tomcat-threadpool.html">Tomcat线程池，更符合大家想象的可扩展线程池 | 江南白衣</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s/YAeneN-x_En55FlC2mVcaA">每天都在用，但你知道 Tomcat 的线程池有多努力吗？</a></p>
</li>
<li>
<p><a href="http://www.throwable.club/2019/07/15/java-concurrency-thread-pool-executor/" class="bare">http://www.throwable.club/2019/07/15/java-concurrency-thread-pool-executor/</a>[JUC线程池ThreadPoolExecutor源码分析 - Throwable&#8217;s Blog</p>
</li>
<li>
<p><a href="http://jindong.io/2015/03/30/java-concurrent-package-ThreadPoolExecutor/">Java并发包源码学习之线程池（一）ThreadPoolExecutor源码分析 - Jindong</a></p>
</li>
<li>
<p><a href="http://my.oschina.net/zouqun/blog/407149">ThreadPoolExecutor简介与源码分析 - 邹胜群的个人页面 - 开源中国社区</a></p>
</li>
<li>
<p><a href="http://onlychoice.github.io/blog/2013/09/13/java-concurrent-source-code-reading-2/">Java并发源码分析 - ThreadPoolExecutor - SHOW ME THE CODE</a></p>
</li>
<li>
<p><a href="http://blog.csdn.net/xieyuooo/article/details/8718741">Java线程池架构原理和源码解析(ThreadPoolExecutor) - xieyuooo的专栏 - 博客频道 - CSDN.NET</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/skywang12345/p/java_threads_category.html">Java多线程系列目录(共43篇) - 如果天空不死 - 博客园</a></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>搞清楚了 <code>ctl</code> 的含义，高三位是状态，低29位是线程数</p>
</li>
<li>
<p>主要属性的含义，主要方法的实现，任务添加后，三种不同的处理方式</p>
</li>
<li>
<p>线程池状态变换</p>
</li>
<li>
<p>线程池拒绝策略的实现</p>
</li>
<li>
<p>带返回值的任务的实现方式，<code>Callable</code>，<code>Future</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="http://www.molotang.com/articles/514.html">ThreadPoolExecutor的基本使用 | 三石·道</a></p>
</li>
<li>
<p><a href="http://www.molotang.com/articles/522.html">ThreadPoolExecutor的任务提交、任务处理、线程复用和维护相关源码分析 | 三石·道</a></p>
</li>
<li>
<p><a href="http://www.molotang.com/articles/526.html">ThreadPoolExecutor的生命周期相关源码分析 | 三石·道</a></p>
</li>
<li>
<p><a href="http://www.molotang.com/articles/553.html">ThreadPoolExecutor的任务饱和丢弃策略及源码实现 | 三石·道</a></p>
</li>
<li>
<p><a href="http://ifeve.com/java-threadpool/">聊聊并发（三）Java线程池的分析和使用 | 并发编程网 - ifeve.com</a></p>
</li>
<li>
<p><a href="http://www.infoq.com/cn/articles/executor-framework-thread-pool-task-execution-part-01?utm_campaign=rightbar_v2&amp;utm_source=infoq&amp;utm_medium=articles_link&amp;utm_content=link_text">戏（细）说Executor框架线程池任务执行全过程（上）</a></p>
</li>
<li>
<p><a href="http://www.infoq.com/cn/articles/executor-framework-thread-pool-task-execution-part-02?utm_campaign=rightbar_v2&amp;utm_source=infoq&amp;utm_medium=articles_link&amp;utm_content=link_text">戏（细）说Executor框架线程池任务执行全过程（下）</a></p>
</li>
<li>
<p><a href="http://blog.csdn.net/techq/article/details/6818201">ThreadPoolExecutor 源码分析 - techq’s blog - 博客频道 - CSDN.NET</a></p>
</li>
<li>
<p><a href="http://blog.sina.com.cn/s/blog_753035050100wbtm.html">JAVA线程池(ThreadPoolExecutor)源码分析_journeylin_新浪博客</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/rilley/archive/2012/02/07/2341767.html">ThreadPoolExecutor源码分析 - rilley - 博客园</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_forkjointask"><a class="anchor" href="#_forkjointask"></a>59. ForkJoinTask</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_类图_5"><a class="anchor" href="#_类图_5"></a>59.1. 类图</h3>
<div class="paragraph">
<p>先来看一下 <code>ForkJoinTask</code> 的类图：</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-b88382a15c90d0dea886ce6414727659.svg" alt="Diagram" width="90%" height="200">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_forkjoinpool"><a class="anchor" href="#_forkjoinpool"></a>60. ForkJoinPool</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/ForkJoinPool-fork-join.webp" alt="ForkJoinPool fork join">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ForkJoinPool-work-stealing.webp" alt="ForkJoinPool work stealing">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ForkJoinPool-invoke-link.png" alt="ForkJoinPool invoke link">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ForkJoinPool-data-structures.png" alt="ForkJoinPool data structures">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ForkJoinPool-ctl.png" alt="ForkJoinPool ctl">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ForkJoinPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ForkJoinTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.RecursiveTask</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-12 10:54
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForkJoinPoolTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ForkJoinPool</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">homePath</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"user.home"</span><span class="o">);</span>
        <span class="nc">FileCountTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileCountTask</span><span class="o">(</span><span class="n">homePath</span><span class="o">);</span>
        <span class="nc">ForkJoinTask</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Integer</span> <span class="n">count</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"file count = "</span> <span class="o">+</span> <span class="n">count</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="o">|</span> <span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">pool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">pool</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"All thread finish..."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FileCountTask</span> <span class="kd">extends</span> <span class="nc">RecursiveTask</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">File</span> <span class="n">file</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">FileCountTask</span><span class="o">(</span><span class="nc">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">file</span> <span class="o">=</span> <span class="n">file</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nf">FileCountTask</span><span class="o">(</span><span class="nc">String</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="nc">Integer</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">isFile</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">File</span><span class="o">[]</span> <span class="n">files</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">files</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">files</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
                <span class="o">}</span>
                <span class="nc">List</span><span class="o">&lt;</span><span class="nc">FileCountTask</span><span class="o">&gt;</span> <span class="n">subTasks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">File</span> <span class="n">f</span> <span class="o">:</span> <span class="n">files</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
                        <span class="nc">FileCountTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileCountTask</span><span class="o">(</span><span class="n">f</span><span class="o">);</span>
                        <span class="n">subTasks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
                        <span class="n">task</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">FileCountTask</span> <span class="n">subTask</span> <span class="o">:</span> <span class="n">subTasks</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="n">subTask</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%8d     %s %n"</span><span class="o">,</span> <span class="n">count</span><span class="o">,</span> <span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">count</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_15"><a class="anchor" href="#_参考资料_15"></a>60.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://blog.csdn.net/u010841296/article/details/83963637">ForkJoinPool实现原理和源码解析_Java_Java程序员的进阶之路-CSDN博客</a></p>
</li>
<li>
<p><a href="https://segmentfault.com/a/1190000016781127">Java多线程进阶（四三）—— J.U.C之executors框架：Fork/Join框架（1） 原理 - 透彻理解Java并发编程 - SegmentFault 思否</a></p>
</li>
<li>
<p><a href="https://segmentfault.com/a/1190000016877931">Java多线程进阶（四四）—— J.U.C之executors框架：Fork/Join框架（2）实现 - 透彻理解Java并发编程 - SegmentFault 思否</a></p>
</li>
<li>
<p><a href="https://liuyehcf.github.io/2017/08/01/Java-concurrent-Fork-Join-%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/">Java-concurrent-Fork-Join-源码剖析 | Liuye Blog</a></p>
</li>
<li>
<p><a href="https://www.jianshu.com/p/32a15ef2f1bf">JUC源码分析-线程池篇（四）：ForkJoinPool - 1 - 简书</a></p>
</li>
<li>
<p><a href="https://www.jianshu.com/p/6a14d0b54b8d">JUC源码分析-线程池篇（五）：ForkJoinPool - 2 - 简书</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concurrenthashmap"><a class="anchor" href="#_concurrenthashmap"></a>61. <code>ConcurrentHashMap</code></h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/ConcurrentHashMap-segment-lock.png" alt="ConcurrentHashMap segment lock">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/JDK1.8-ConcurrentHashMap-Structure.jpg" alt="JDK1.8 ConcurrentHashMap Structure">
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_16"><a class="anchor" href="#_参考资料_16"></a>61.1. 参考资料</h3>
<div class="ulist">
<ul>
<li>
<p><a href="http://note.youdao.com/share/?spm=5176.100239.blogcont36781.3.nHffVb&amp;id=dde7a10b98aee57676408bc475ab0680&amp;type=note#/">ConcurrentHashMap源码分析&#8212;&#8203;Java8</a></p>
</li>
<li>
<p><a href="http://www.cnblogs.com/huaizuo/p/5413069.html">探索jdk8之ConcurrentHashMap 的实现机制 - 淮左 - 博客园</a>&#8201;&#8212;&#8201;参考资料非常棒，建议都看看！</p>
</li>
<li>
<p><a href="http://blog.csdn.net/u010723709/article/details/48007881">ConcurrentHashMap源码分析（JDK8版本） - 惟愿无事 - 博客频道 - CSDN.NET</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/chengxiao/p/6842045.html">ConcurrentHashMap实现原理及源码分析 - dreamcatcher-cx - 博客园</a></p>
</li>
<li>
<p><a href="https://www.jianshu.com/p/d10256f0ebea">ConcurrentHashMap 原理解析（JDK1.8） - 简书</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concurrentskiplistmap"><a class="anchor" href="#_concurrentskiplistmap"></a>62. <code>ConcurrentSkipListMap</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p>没想到 JDK 中，居然有跳跃表的实现！</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/ConcurrentSkipListMap-search.jpg" alt="ConcurrentSkipListMap search">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_copyonwritearraylist"><a class="anchor" href="#_copyonwritearraylist"></a>63. CopyOnWriteArrayList</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="#"><code>ReentrantReadWriteLock</code></a> 读写锁的思想非常类似，也就是读读共享、写写互斥、读写互斥、写读互斥。JDK 中提供了 <code>CopyOnWriteArrayList</code> 类比相比于在读写锁的思想又更进一步。为了将读取的性能发挥到极致，<code>CopyOnWriteArrayList</code> 读取是完全不用加锁的，并且更厉害的是：写入也不会阻塞读取操作。只有写入和写入之间需要进行同步等待。这样一来，读操作的性能就会大幅度提升。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="code"><pre><span class="cm">/** The array, accessed only via getArray/setArray. */</span>
<span class="kd">private</span> <span class="kd">transient</span> <span class="kd">volatile</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">array</span><span class="o">;</span>

<span class="cm">/**
 * Gets the array.  Non-private so as to also be accessible
 * from CopyOnWriteArraySet class.
 */</span>
<span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="nf">getArray</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">array</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * Sets the array.
 */</span>
<span class="kd">final</span> <span class="kt">void</span> <span class="nf">setArray</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
<span class="kd">static</span> <span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="no">E</span> <span class="nf">elementAt</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">a</span><span class="o">,</span> <span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">a</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
<span class="o">}</span>

<span class="cm">/**
 * {@inheritDoc}
 *
 * @throws IndexOutOfBoundsException {@inheritDoc}
 */</span>
<span class="kd">public</span> <span class="no">E</span> <span class="nf">get</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">elementAt</span><span class="o">(</span><span class="n">getArray</span><span class="o">(),</span> <span class="n">index</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Appends the specified element to the end of this list.
 *
 * @param e element to be appended to this list
 * @return {@code true} (as specified by {@link Collection#add})
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">es</span> <span class="o">=</span> <span class="n">getArray</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="n">es</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">es</span><span class="o">[</span><span class="n">len</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
        <span class="n">setArray</span><span class="o">(</span><span class="n">es</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

    <span class="cm">/**
 * Removes the element at the specified position in this list.
 * Shifts any subsequent elements to the left (subtracts one from their
 * indices).  Returns the element that was removed from the list.
 *
 * @throws IndexOutOfBoundsException {@inheritDoc}
 */</span>
<span class="kd">public</span> <span class="no">E</span> <span class="nf">remove</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">es</span> <span class="o">=</span> <span class="n">getArray</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">es</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="no">E</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">elementAt</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">index</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">numMoved</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">newElements</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">numMoved</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
            <span class="n">newElements</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">newElements</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="o">];</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">newElements</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">index</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">es</span><span class="o">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">newElements</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span>
                             <span class="n">numMoved</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">setArray</span><span class="o">(</span><span class="n">newElements</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CopyOnWriteArrayList</code> 类的所有可变操作（<code>add</code>，<code>set</code> 等等）都是通过创建底层数组的新副本来实现的。当 <code>List</code> 需要被修改的时候，我并不修改原有内容，而是对原有数据进行一次复制，将修改的内容写入副本。写完之后，再将修改完的副本替换原来的数据，这样就可以保证写操作不会影响读操作了。</p>
</div>
<div class="paragraph">
<p>从 <code>CopyOnWriteArrayList</code> 的名字就能看出 <code>CopyOnWriteArrayList</code> 是满足 <code>CopyOnWrite</code> 的 <code>ArrayList</code>，所谓 <code>CopyOnWrite</code> 也就是说：在计算机，如果你想要对一块内存进行修改时，我们不在原有内存块中进行写操作，而是将内存拷贝一份，在新的内存中进行写操作，写完之后呢，就将指向原来内存指针指向新的内存，原来的内存就可以被回收掉了。</p>
</div>
<div class="sect2">
<h3 id="_参考资料_17"><a class="anchor" href="#_参考资料_17"></a>63.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://snailclimb.gitee.io/javaguide/#/docs/java/Multithread/%E5%B9%B6%E5%8F%91%E5%AE%B9%E5%99%A8%E6%80%BB%E7%BB%93">JavaGuide 之 并发容器总结</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concurrentlinkedqueue"><a class="anchor" href="#_concurrentlinkedqueue"></a>64. ConcurrentLinkedQueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>ConcurrentLinkedQueue</code> 主要使用 CAS 非阻塞算法来实现线程安全。这是一个非阻塞队列。对比来看，<code>LinkedBlockingQueue</code> 是一个可以阻塞的队列。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_arrayblockingqueue"><a class="anchor" href="#_arrayblockingqueue"></a>65. ArrayBlockingQueue</h2>
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="./images/BlockingQueue.png" alt="BlockingQueue">
</div>
</div>
<div class="sect2">
<h3 id="_方法组"><a class="anchor" href="#_方法组"></a>65.1. 方法组</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 8%;">
<col style="width: 45%;">
<col style="width: 34%;">
<col style="width: 13%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">插入</th>
<th class="tableblock halign-left valign-top">移除</th>
<th class="tableblock halign-left valign-top">检查</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">抛异常</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean add(E e)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean remove(Object o)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E element()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">特定值</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean offer(E e)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E poll()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E peek()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">阻塞</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>void put(E e)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E take()</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">超时</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean offer(E e, long timeout, TimeUnit unit)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>E poll(long timeout, TimeUnit unit)</code></p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>四组方法：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>抛异常</strong>：如果试图的操作无法立即执行，抛一个异常。</p>
</li>
<li>
<p><strong>特定值</strong>：如果试图的操作无法立即执行，返回一个特定的值(通常是 <code>true</code>, <code>false</code> 或 <code>null</code>)。</p>
</li>
<li>
<p><strong>阻塞</strong>：如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行。</p>
</li>
<li>
<p><strong>超时</strong>：如果试图的操作无法立即执行，该方法调用将会发生阻塞，直到能够执行，但等待时间不会超过给定值。返回一个特定值以告知该操作是否成功(典型的是 true / false)。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>ArrayBlockingQueue</code> 是 <code>BlockingQueue</code> 接口的有界队列实现类，底层采用数组来实现。<code>ArrayBlockingQueue</code> 一旦创建，容量不能改变。</p>
</div>
<div class="paragraph">
<p><code>ArrayBlockingQueue</code> 默认情况下不能保证线程访问队列的公平性，所谓公平性是指严格按照线程等待的绝对时间顺序，即最先等待的线程能够最先访问到 <code>ArrayBlockingQueue</code>。而非公平性则是指访问 <code>ArrayBlockingQueue</code> 的顺序不是遵守严格的时间顺序，有可能存在，当 <code>ArrayBlockingQueue</code> 可以被访问时，长时间阻塞的线程依然无法访问到 <code>ArrayBlockingQueue</code>。如果保证公平性，通常会降低吞吐量。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="code"><pre><span class="cm">/**
 * Inserts element at current put position, advances, and signals.
 * Call only when holding lock.
 */</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">enqueue</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// assert lock.isHeldByCurrentThread();</span>
    <span class="c1">// assert lock.getHoldCount() == 1;</span>
    <span class="c1">// assert items[putIndex] == null;</span>
    <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">items</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">items</span><span class="o">;</span>
    <span class="n">items</span><span class="o">[</span><span class="n">putIndex</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(++</span><span class="n">putIndex</span> <span class="o">==</span> <span class="n">items</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="n">putIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">count</span><span class="o">++;</span>
    <span class="n">notEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * Extracts element at current take position, advances, and signals.
 * Call only when holding lock.
 */</span>
<span class="kd">private</span> <span class="no">E</span> <span class="nf">dequeue</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// assert lock.isHeldByCurrentThread();</span>
    <span class="c1">// assert lock.getHoldCount() == 1;</span>
    <span class="c1">// assert items[takeIndex] != null;</span>
    <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">items</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">items</span><span class="o">;</span>
    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="no">E</span> <span class="n">e</span> <span class="o">=</span> <span class="o">(</span><span class="no">E</span><span class="o">)</span> <span class="n">items</span><span class="o">[</span><span class="n">takeIndex</span><span class="o">];</span>
    <span class="n">items</span><span class="o">[</span><span class="n">takeIndex</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(++</span><span class="n">takeIndex</span> <span class="o">==</span> <span class="n">items</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="n">takeIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">count</span><span class="o">--;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">itrs</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">itrs</span><span class="o">.</span><span class="na">elementDequeued</span><span class="o">();</span>
    <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
<span class="o">}</span>



<span class="cm">/**
 * Inserts the specified element at the tail of this queue if it is
 * possible to do so immediately without exceeding the queue's capacity,
 * returning {@code true} upon success and throwing an
 * {@code IllegalStateException} if this queue is full.
 *
 * @param e the element to add
 * @return {@code true} (as specified by {@link Collection#add})
 * @throws IllegalStateException if this queue is full
 * @throws NullPointerException if the specified element is null
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/**
 * Inserts the specified element at the tail of this queue if it is
 * possible to do so immediately without exceeding the queue's capacity,
 * returning {@code true} upon success and {@code false} if this queue
 * is full.  This method is generally preferable to method {@link #add},
 * which can fail to insert an element only by throwing an exception.
 *
 * @throws NullPointerException if the specified element is null
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lock</span><span class="o">;</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">items</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">else</span> <span class="o">{</span>
            <span class="n">enqueue</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="no">E</span> <span class="nf">poll</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lock</span><span class="o">;</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="n">dequeue</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>底层使用数组来实现，长度确定后就不再变化，通过下标循环往复地使用数组，类似与将数组组成了一个圆。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ArrayBlockingQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-22 15:11
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ArrayBlockingQueueTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testTimeoutPoll</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;(</span><span class="mi">5</span><span class="o">);</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Long</span> <span class="n">num</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"poll:"</span> <span class="o">+</span> <span class="n">num</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">parkNanos</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="mi">10</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>poll(long, java.util.concurrent.TimeUnit)</code> 方法，其实就是使用 <code>Condition notEmpty</code> 对象来调用 <code>ConditionObject.awaitNanos(long)</code> 方法，在其中再调用了 <a href="#"><code>LockSupport.parkNanos(java.lang.Object, long)</code></a> 方法来实现"休眠等待"。</p>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_18"><a class="anchor" href="#_参考资料_18"></a>65.2. 参考资料</h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.pdai.tech/md/java/thread/java-thread-x-juc-collection-BlockingQueue.html">JUC集合: BlockingQueue详解 | Java 全栈知识体系</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_linkedblockingqueue"><a class="anchor" href="#_linkedblockingqueue"></a>66. LinkedBlockingQueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>LinkedBlockingQueue</code> 底层是一个单向链表结构。如果需要的话，这一链式结构可以选择一个上限。如果没有定义上限，将使用 <code>Integer.MAX_VALUE</code> 作为上限。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_priorityblockingqueue"><a class="anchor" href="#_priorityblockingqueue"></a>67. PriorityBlockingQueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>PriorityBlockingQueue</code> 是一个支持优先级的无界阻塞队列。默认情况下元素采用自然顺序进行排序，也可以通过自定义类实现 <code>compareTo()</code> 方法来指定元素排序规则，或者初始化时通过构造器参数 <code>Comparator</code> 来指定排序规则。</p>
</div>
<div class="paragraph">
<p><code>PriorityBlockingQueue</code> 并发控制采用的是 <code>ReentrantLock</code>，队列为无界队列（<code>ArrayBlockingQueue</code> 是有界队列，<code>LinkedBlockingQueue</code> 也可以通过在构造函数中传入 <code>capacity</code> 指定队列最大的容量，但是 <code>PriorityBlockingQueue</code> 只能指定初始的队列大小，后面插入元素的时候，如果空间不够的话会自动扩容）。</p>
</div>
<div class="sect2">
<h3 id="_参考资料_19"><a class="anchor" href="#_参考资料_19"></a>67.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.javadoop.com/post/java-concurrent-queue">解读 java 并发队列 BlockingQueue_Javadoop</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_delayqueue"><a class="anchor" href="#_delayqueue"></a>68. DelayQueue</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>DelayQueue</code> 对元素进行持有直到一个特定的延迟到期。注入其中的元素必须实现 <code>java.util.concurrent.Delayed</code> 接口，该接口定义:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">java.util.concurrent</span><span class="o">;</span>

<span class="cm">/**
 * A mix-in style interface for marking objects that should be
 * acted upon after a given delay.
 *
 * &lt;p&gt;An implementation of this interface must define a
 * {@code compareTo} method that provides an ordering consistent with
 * its {@code getDelay} method.
 *
 * @since 1.5
 * @author Doug Lea
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Delayed</span> <span class="kd">extends</span> <span class="nc">Comparable</span><span class="o">&lt;</span><span class="nc">Delayed</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="cm">/**
     * Returns the remaining delay associated with this object, in the
     * given time unit.
     *
     * @param unit the time unit
     * @return the remaining delay; zero or negative values indicate
     * that the delay has already elapsed
     */</span>
    <span class="kt">long</span> <span class="nf">getDelay</span><span class="o">(</span><span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>加入延迟队列的元素都必须实现 <code>Delayed</code> 接口。延迟队列内部是利用 <code>PriorityQueue</code> 实现的，所以还是利用优先队列！<code>Delayed</code> 接口继承了 <code>Comparable</code>。因此优先队列是通过 <code>delay</code> 来排序的。</p>
</div>
<div class="paragraph">
<p>示例如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.concurrent</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.DelayQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Delayed</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-22 16:38
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DelayQueueTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">DelayQueue</span><span class="o">&lt;</span><span class="nc">IntDelay</span><span class="o">&gt;</span> <span class="n">delayQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DelayQueue</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">delayQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">IntDelay</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">delayQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">IntDelay</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">delayQueue</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">delay</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">delay</span><span class="o">.</span><span class="na">num</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">IntDelay</span> <span class="kd">implements</span> <span class="nc">Delayed</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kt">int</span> <span class="n">num</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">long</span> <span class="n">deadline</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">IntDelay</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">num</span> <span class="o">=</span> <span class="n">num</span><span class="o">;</span>
            <span class="n">deadline</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getDelay</span><span class="o">(</span><span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">deadline</span> <span class="o">-</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="nc">Delayed</span> <span class="n">o</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">IntDelay</span> <span class="n">param</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IntDelay</span><span class="o">)</span> <span class="n">o</span><span class="o">;</span>
            <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">num</span><span class="o">,</span> <span class="n">param</span><span class="o">.</span><span class="na">num</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scheduledthreadpoolexecutor"><a class="anchor" href="#_scheduledthreadpoolexecutor"></a>69. <code>ScheduledThreadPoolExecutor</code></h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>Timer</code>、<code>ScheduledThreadPool</code> 和 <code>DelayQueue</code>，总结的说下它们都是通过优先队列来获取最早需要执行的任务，因此插入和删除任务的时间复杂度都为 O(logn)，并且 <code>Timer</code> 、<code>ScheduledThreadPool</code> 的周期性任务是通过重置任务的下一次执行时间来完成的。</p>
</div>
<div class="paragraph">
<p>问题就出在时间复杂度上，插入删除时间复杂度是O(logn)，那么假设频繁插入删除次数为 <code>m</code>，总的时间复杂度就是 O(mlogn)，这种时间复杂度满足不了 Kafka 这类中间件对性能的要求，而时间轮算法的插入删除时间复杂度是 O(1)。我们来看看时间轮算法是如何实现的。</p>
</div>
<div class="sect2">
<h3 id="_参考资料_20"><a class="anchor" href="#_参考资料_20"></a>69.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://mp.weixin.qq.com/s/xBB72hJGn8geZ7SkM0FqJw" target="_blank" rel="noopener">面试官：知道时间轮算法吗？在Netty和Kafka中如何应用的？</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_classloader"><a class="anchor" href="#_classloader"></a>70. ClassLoader</h2>
<div class="sectionbody">
<div class="paragraph">
<p>虽然对 <code>ClassLoader</code> 的双亲委派流程比较了解，但是一直没有仔细专研过代码实现。今天翻看代码，代码写的简单明了：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
</pre></td><td class="code"><pre><span class="cm">/**
 * Loads the class with the specified &lt;a href="#binary-name"&gt;binary name&lt;/a&gt;.  The
 * default implementation of this method searches for classes in the
 * following order:
 *
 * &lt;ol&gt;
 *
 *   &lt;li&gt;&lt;p&gt; Invoke {@link #findLoadedClass(String)} to check if the class
 *   has already been loaded.  &lt;/p&gt;&lt;/li&gt;
 *
 *   &lt;li&gt;&lt;p&gt; Invoke the {@link #loadClass(String) loadClass} method
 *   on the parent class loader.  If the parent is {@code null} the class
 *   loader built into the virtual machine is used, instead.  &lt;/p&gt;&lt;/li&gt;
 *
 *   &lt;li&gt;&lt;p&gt; Invoke the {@link #findClass(String)} method to find the
 *   class.  &lt;/p&gt;&lt;/li&gt;
 *
 * &lt;/ol&gt;
 *
 * &lt;p&gt; If the class was found using the above steps, and the
 * {@code resolve} flag is true, this method will then invoke the {@link
 * #resolveClass(Class)} method on the resulting {@code Class} object.
 *
 * &lt;p&gt; Subclasses of {@code ClassLoader} are encouraged to override {@link
 * #findClass(String)}, rather than this method.  &lt;/p&gt;
 *
 * &lt;p&gt; Unless overridden, this method synchronizes on the result of
 * {@link #getClassLoadingLock getClassLoadingLock} method
 * during the entire class loading process.
 *
 * @param  name
 *         The &lt;a href="#binary-name"&gt;binary name&lt;/a&gt; of the class
 *
 * @param  resolve
 *         If {@code true} then resolve the class
 *
 * @return  The resulting {@code Class} object
 *
 * @throws  ClassNotFoundException
 *          If the class could not be found
 */</span>
<span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">resolve</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span>
<span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">getClassLoadingLock</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// First, check if the class has already been loaded</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">findLoadedClass</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">t0</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">parent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">findBootstrapClassOrNull</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ClassNotFoundException thrown if class not found</span>
                <span class="c1">// from the non-null parent class loader</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// If still not found, then invoke findClass in order</span>
                <span class="c1">// to find the class.</span>
                <span class="kt">long</span> <span class="n">t1</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">findClass</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>

                <span class="c1">// this is the defining class loader; record the stats</span>
                <span class="nc">PerfCounter</span><span class="o">.</span><span class="na">getParentDelegationTime</span><span class="o">().</span><span class="na">addTime</span><span class="o">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="o">);</span>
                <span class="nc">PerfCounter</span><span class="o">.</span><span class="na">getFindClassTime</span><span class="o">().</span><span class="na">addElapsedTimeFrom</span><span class="o">(</span><span class="n">t1</span><span class="o">);</span>
                <span class="nc">PerfCounter</span><span class="o">.</span><span class="na">getFindClasses</span><span class="o">().</span><span class="na">increment</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resolve</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">resolveClass</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * Finds the class with the specified &lt;a href="#binary-name"&gt;binary name&lt;/a&gt;.
 * This method should be overridden by class loader implementations that
 * follow the delegation model for loading classes, and will be invoked by
 * the {@link #loadClass loadClass} method after checking the
 * parent class loader for the requested class.
 *
 * @implSpec The default implementation throws {@code ClassNotFoundException}.
 *
 * @param  name
 *         The &lt;a href="#binary-name"&gt;binary name&lt;/a&gt; of the class
 *
 * @return  The resulting {@code Class} object
 *
 * @throws  ClassNotFoundException
 *          If the class could not be found
 *
 * @since  1.2
 */</span>
<span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">findClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">ClassNotFoundException</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>如果自定义 <code>ClassLoader</code>，最简单的办法就是重载 <code>Class&lt;?&gt; findClass(String name)</code> 方法就可以了。或者为了避免双亲委托机制，可以自己定义一个类加载器，然后重写 <code>loadClass()</code> 即可。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Objects</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-10 17:23
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClassLoaderTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ClassLodarDemo's ClassLoader is "</span> <span class="o">+</span> <span class="nc">ClassLoaderTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"The Parent of ClassLodarDemo's ClassLoader is "</span> <span class="o">+</span> <span class="nc">ClassLoaderTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getParent</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"The GrandParent of ClassLodarDemo's ClassLoader is "</span> <span class="o">+</span> <span class="nc">ClassLoaderTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">().</span><span class="na">getParent</span><span class="o">().</span><span class="na">getParent</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span><span class="o">,</span> <span class="nc">NoSuchMethodException</span><span class="o">,</span>
            <span class="nc">IllegalAccessException</span><span class="o">,</span> <span class="nc">InvocationTargetException</span><span class="o">,</span>
            <span class="nc">InstantiationException</span> <span class="o">{</span>
        <span class="nc">DiguageClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiguageClassLoader</span><span class="o">();</span>
        <span class="c1">// 如何识别内部类？</span>
        <span class="c1">// 如何获取内部类的正确类名？</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span>
                <span class="s">"com.diguage.truman.ClassLoaderTest.HelloWorld"</span><span class="o">);</span>
        <span class="nc">Object</span> <span class="n">instance</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">().</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">instance</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">HelloWorld</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"Hello, https://www.diguage.com/"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DiguageClassLoader</span> <span class="kd">extends</span> <span class="nc">ClassLoader</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">findClass</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ClassNotFoundException</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">isNull</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"class name is null."</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\."</span><span class="o">,</span> <span class="s">"/"</span><span class="o">)</span> <span class="o">+</span> <span class="s">".class"</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">index</span><span class="o">)</span> <span class="o">+</span> <span class="s">"$"</span>
                    <span class="o">+</span> <span class="n">fileName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">getResourceAsStream</span><span class="o">(</span><span class="n">fileName</span><span class="o">);</span>
            <span class="nc">ByteArrayOutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">size</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bytes</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">outputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytecodes</span> <span class="o">=</span> <span class="n">outputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">bytecodes</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ClassNotFoundException</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">+</span> <span class="s">"$"</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
            <span class="k">return</span> <span class="nf">defineClass</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="n">bytecodes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bytecodes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>jdk.internal.loader.ClassLoaders.PlatformClassLoader</code></p>
</li>
<li>
<p><code>jdk.internal.loader.ClassLoaders.AppClassLoader</code></p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-f048d9dc5a51201c7c695da8d17ddaae.svg" alt="Diagram" width="90%" height="250">
</div>
<div class="title">Figure 1. JDK 8 及以前的加载体系</div>
</div>
<div class="paragraph">
<p>在 JDK 8 及以前，<code>AppClassLoader</code> 和 <code>ExtClassLoader</code> 这两个类都是 <code>sun.misc.Launcher</code> 中的内部类。 <code>BootstrapClassLoader</code> 是由 C++ 代码实现的。所以，不存在 Java 类定义。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/load-class-process.png" alt="load class process">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-31f1b7cfea3d9b7591a184a4e9863532.svg" alt="Diagram" width="90%" height="250">
</div>
<div class="title">Figure 2. JDK 9 之后的加载体系</div>
</div>
<div class="paragraph">
<p>在 JDK 9 以后，<code>AppClassLoader</code>，<code>PlatformClassLoader</code> 和 <code>BootClassLoader</code> 三个类都定义在 <code>jdk.internal.loader.ClassLoaders</code> 中。<code>BootClassLoader</code> 是由 Java 和 C++ 混合实现，所以有类的定义。</p>
</div>
<div class="paragraph">
<p><code>ClassLoader</code> 提供的资源加载的方法中的核心方法是 <code>ClassLoader#getResource(String name)</code>，它是基于用户应用程序的 ClassPath 搜索资源，遵循"资源加载的双亲委派模型"，资源名称必须使用路径分隔符 <code>/</code> 去分隔目录，但是不能以 <code>/</code> 作为资源名的起始字符，其他几个方法都是基于此方法进行衍生，添加复数操作等其他操作。<code>getResource(String name)</code> 方法不会显示抛出异常，当资源搜索失败的时候，会返回 <code>null</code>。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>如何识别内部类？</p>
</li>
<li>
<p>如何获取内部类的正确类名？</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_参考资料_21"><a class="anchor" href="#_参考资料_21"></a>70.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2018/11/30/java-resource-load/">通过源码浅析Java中的资源加载 - Throwable&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_field"><a class="anchor" href="#_field"></a>71. Field</h2>
<div class="sectionbody">
<div class="paragraph">
<p>属性操作方法 <code>Field#set(Object obj, Object value)</code> 和 <code>Field#get(Object obj)</code> 底层都是委托到 <code>jdk.internal.reflect.FieldAccessor</code> 实现。</p>
</div>
<div class="paragraph">
<p><code>FieldAccessor</code> 接口有很多的实现，<code>FieldAccessor</code> 接口实例是通过 <code>jdk.internal.reflect.ReflectionFactory</code> 这个工厂构造的：</p>
</div>
<div class="listingblock">
<div class="title">jdk.internal.reflect.ReflectionFactory</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre>    <span class="kd">public</span> <span class="nc">FieldAccessor</span> <span class="nf">newFieldAccessor</span><span class="o">(</span><span class="nc">Field</span> <span class="n">field</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">override</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">checkInitted</span><span class="o">();</span>

        <span class="nc">Field</span> <span class="n">root</span> <span class="o">=</span> <span class="n">langReflectAccess</span><span class="o">.</span><span class="na">getRoot</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">root</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// FieldAccessor will use the root unless the modifiers have</span>
            <span class="c1">// been overrridden</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()</span> <span class="o">==</span> <span class="n">field</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">override</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">root</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nc">UnsafeFieldAccessorFactory</span><span class="o">.</span><span class="na">newFieldAccessor</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">override</span><span class="o">);</span>
    <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>最终委托到 <code>UnsafeFieldAccessorFactory#newFieldAccessor()</code>。</p>
</div>
<div class="paragraph">
<p><code>UnsafeObjectFieldAccessorImpl</code> 中除了 <code>get(Object obj)</code> 和 <code>set(Object obj, Object value)</code> 方法，其他方法都是直接抛出 <code>IllegalArgumentException</code>。而 <code>get(Object obj)</code> 和 <code>set(Object obj, Object value)</code> 底层分别依赖于 <code>jdk.internal.misc.Unsafe</code> 的 <code>putObject(obj, fieldOffset, value)</code> 和 <code>getObject(obj, fieldOffset)</code> 方法。而属性的内存偏移地址是在 <code>UnsafeObjectFieldAccessorImpl</code> 的父类 <code>UnsafeFieldAccessorImpl</code> 的构造函数中计算出来的。</p>
</div>
<div class="paragraph">
<p>属性反射操作 <code>Field</code> 的 <code>setXX</code> 和 <code>getXX</code> 方法最终委托到 <code>jdk.internal.misc.Unsafe</code> 的 <code>putXX</code> 和 <code>getXX</code> 方法，而属性的内存偏移地址是通过 <code>jdk.internal.misc.Unsafe</code> 的 <code>staticFieldBase()</code>、<code>staticFieldOffset</code> 和 <code>objectFieldOffset</code> 几个方法计算的。</p>
</div>
<div class="sect2">
<h3 id="_参考资料_22"><a class="anchor" href="#_参考资料_22"></a>71.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2018/12/16/java-reflection-implementance/">深入分析Java反射(七)-简述反射调用的底层实现 - Throwable&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proxy"><a class="anchor" href="#_proxy"></a>72. Proxy</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.reflect</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-02 09:37
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LogProxy</span> <span class="kd">implements</span> <span class="nc">InvocationHandler</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="nc">Object</span> <span class="n">realObject</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">LogProxy</span><span class="o">(</span><span class="nc">Object</span> <span class="n">realObject</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">realObject</span> <span class="o">=</span> <span class="n">realObject</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="nc">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
                <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Proxy: "</span> <span class="o">+</span> <span class="n">proxy</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"start to invoke: "</span>
                    <span class="o">+</span> <span class="n">realObject</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"#"</span> <span class="o">+</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">" args ="</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
            <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">realObject</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">UserGetService</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">UserPostService</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="nf">postUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">UserGetServiceImpl</span> <span class="kd">implements</span> <span class="nc">UserGetService</span><span class="o">,</span> <span class="nc">UserPostService</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"D瓜哥-"</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">postUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"119-"</span> <span class="o">+</span> <span class="n">name</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 注意：这里不能使用 JUnit 来运行，JUnit 也是通过代理启动的，</span>
        <span class="c1">// 先于我们的测试运行，导致设置无效。</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">()</span>
                <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"jdk.proxy.ProxyGenerator.saveGeneratedFiles"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">);</span>

        <span class="nc">UserGetServiceImpl</span> <span class="n">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserGetServiceImpl</span><span class="o">();</span>
        <span class="nc">ClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="nc">UserGetService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">interfaces</span> <span class="o">=</span> <span class="nc">UserGetServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">();</span>
        <span class="nc">Object</span> <span class="n">proxy</span> <span class="o">=</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span>
                <span class="n">interfaces</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LogProxy</span><span class="o">(</span><span class="n">userService</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"UserName = "</span>
                <span class="o">+</span> <span class="o">((</span><span class="nc">UserGetService</span><span class="o">)</span> <span class="n">proxy</span><span class="o">).</span><span class="na">getById</span><span class="o">(</span><span class="mi">119</span><span class="o">));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"UserCode = "</span>
                <span class="o">+</span> <span class="o">((</span><span class="nc">UserPostService</span><span class="o">)</span> <span class="n">proxy</span><span class="o">).</span><span class="na">postUser</span><span class="o">(</span><span class="s">"diguage"</span><span class="o">));</span>

        <span class="nc">Object</span> <span class="n">proxy2</span> <span class="o">=</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span>
                <span class="n">interfaces</span><span class="o">,</span> <span class="k">new</span> <span class="nc">LogProxy</span><span class="o">(</span><span class="n">userService</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"UserName = "</span>
                <span class="o">+</span> <span class="o">((</span><span class="nc">UserGetService</span><span class="o">)</span> <span class="n">proxy2</span><span class="o">).</span><span class="na">getById</span><span class="o">(</span><span class="mi">119</span><span class="o">));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"UserCode = "</span>
                <span class="o">+</span> <span class="o">((</span><span class="nc">UserPostService</span><span class="o">)</span> <span class="n">proxy2</span><span class="o">).</span><span class="na">postUser</span><span class="o">(</span><span class="s">"diguage"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testGetCallerMethodName</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getCallerMethod</span><span class="o">());</span>

        <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">}.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getEnclosingMethod</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCallerMethod</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span>
                <span class="o">.</span><span class="na">getStackTrace</span><span class="o">()[</span><span class="mi">2</span><span class="o">]</span> <span class="c1">// 注意下标值</span>
                <span class="o">.</span><span class="na">getMethodName</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">methodName</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Proxy-newProxyInstance-sequence-diagram.png" alt="Proxy newProxyInstance sequence diagram">
</div>
</div>
<div class="paragraph">
<p>跟着代码整体走下来，所谓的"动态代理"，其实是在 <code>java.lang.reflect.ProxyGenerator.generateProxyClass(java.lang.String, java.lang.Class&lt;?&gt;[], int)</code> 中生成了一个实现了接口的代理类。生成字节码的逻辑封装在了 <code>java.lang.reflect.ProxyGenerator.generateClassFile</code> 中，按照字节码规范中规定的格式（魔数、版本号、常量池、访问标识符、当前类索引、父类索引、接口索引、字段表、方法表、附加属性），一点一点追加内容。</p>
</div>
<div class="paragraph">
<p>生成出来的类，继承了 <code>java.lang.reflect.Proxy</code>，同时实现了参数中传递的接口。在生成的类中，</p>
</div>
<div class="ulist">
<ul>
<li>
<p>包含一个参数为 <code>InvocationHandler</code> 的构造函数，用于保存代理业务的实现；</p>
</li>
<li>
<p>每一个方法都用一个静态 <code>Method</code> 来表示；</p>
</li>
<li>
<p>除了接口中的方法，还会生成 <code>boolean equals(Object obj)</code>，<code>int hashCode()</code> 和 <code>String toString()</code> 三个方法。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>调用时，通过 <code>InvocationHandler</code> 对象的 <code>Object invoke(Object proxy, Method method, Object[] args)</code> 方法来调起代理和目标对象的方法。其中，这里的 <code>Object proxy</code> 就是生成的类本身的对象；<code>Method method</code> 就是上述生成的静态 <code>Method</code> 对象；<code>Object[] args</code> 就是实际调用的参数。</p>
</div>
<div class="listingblock">
<div class="title">反编译的示例类</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.sun.proxy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.diguage.proxy.UserService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.UndeclaredThrowableException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="err">$</span><span class="nc">Proxy0</span> <span class="kd">extends</span> <span class="nc">Proxy</span> <span class="kd">implements</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Method</span> <span class="n">m0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Method</span> <span class="n">m1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Method</span> <span class="n">m2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Method</span> <span class="n">m3</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">$Proxy0</span><span class="o">(</span><span class="nc">InvocationHandler</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">var1</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">Integer</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m0</span><span class="o">,</span> <span class="o">(</span><span class="nc">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="o">|</span> <span class="nc">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="nc">Object</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">Boolean</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m1</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">var1</span><span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="o">|</span> <span class="nc">Error</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var3</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var4</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m2</span><span class="o">,</span> <span class="o">(</span><span class="nc">Object</span><span class="o">[])</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="o">|</span> <span class="nc">Error</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var2</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var3</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="nc">String</span> <span class="nf">getById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span>  <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="kd">super</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">m3</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">var1</span><span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="o">|</span> <span class="nc">Error</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">var3</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">var4</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UndeclaredThrowableException</span><span class="o">(</span><span class="n">var4</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">m0</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Object"</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"hashCode"</span><span class="o">);</span><i class="conum" data-value="1"></i><b>(1)</b>
            <span class="n">m1</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Object"</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"equals"</span><span class="o">,</span>
                     <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Object"</span><span class="o">));</span>
            <span class="n">m2</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Object"</span><span class="o">).</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"toString"</span><span class="o">);</span>
            <span class="n">m3</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.diguage.proxy.UserService"</span><span class="o">)</span>
                     <span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"getById"</span><span class="o">,</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"java.lang.Integer"</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">var2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoSuchMethodError</span><span class="o">(</span><span class="n">var2</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">var3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NoClassDefFoundError</span><span class="o">(</span><span class="n">var3</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>为了排版，做了小调整。</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>还有两点值得注意：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>运行代理时，如果想要保存生成的代理类字节码，需要系统属性 <code>jdk.proxy.ProxyGenerator.saveGeneratedFiles</code> 设置为 <code>true</code>。这个属性被解析后赋值给了 <code>java.lang.reflect.ProxyGenerator.saveGeneratedFiles</code> 字段，这个字段是 <code>final</code> 的。所以，需要在运行代码之初就要设置这个属性。所以，最好使用 <code>main</code> 方法来运行测试。否则，有可能设置失效。</p>
</li>
<li>
<p>如果代码是在 Maven 项目中运行，如果接口都是 <code>public</code> 修饰，生成的类会被保存在 <code>${project.basedir}/com/sun/proxy/</code> 目录下；如果有接口是包私有的，则生成的类为接口所在的包。如果目录不存在，则会自动创建。</p>
</li>
<li>
<p>最多可以有 <code>65535</code> 个接口；有两个解释：</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>代码中有明确限制：在 <code>java.lang.reflect.Proxy.ProxyBuilder.ProxyBuilder(java.lang.ClassLoader, java.util.List&lt;java.lang.Class&lt;?&gt;&gt;)</code> 中有 <code>interfaces.size() &gt; 65535</code> 的判断语句。</p>
</li>
<li>
<p>字节码中，对于接口数量是用一个 <code>u2</code> 变量表示的，该变量的最大值是 <code>2<sup>16</sup> - 1 = 65535</code>。</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>注解底层也是基于动态代理实现的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.reflect</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.Documented</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-08 23:34
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyAnnoTest</span> <span class="o">{</span>
    <span class="nd">@Diguage</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AnnoTest</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Diguage</span><span class="o">(</span><span class="s">"https://github.com/diguage"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AnnoTest2</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
    <span class="nd">@Documented</span>
    <span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
    <span class="kd">static</span> <span class="nd">@interface</span> <span class="nc">Diguage</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">"https://www.diguage.com"</span><span class="o">;</span>

        <span class="nc">String</span> <span class="nf">name</span><span class="o">()</span> <span class="k">default</span> <span class="s">"D瓜哥"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">getProperties</span><span class="o">()</span>
                <span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"jdk.proxy.ProxyGenerator.saveGeneratedFiles"</span><span class="o">,</span> <span class="s">"true"</span><span class="o">);</span>

        <span class="nc">Class</span><span class="o">&lt;</span><span class="nc">AnnoTest</span><span class="o">&gt;</span> <span class="n">clazz</span> <span class="o">=</span> <span class="nc">AnnoTest</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="nc">Diguage</span> <span class="n">annotation</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">Diguage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">annotation</span> <span class="o">+</span> <span class="s">" : "</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Name: "</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Value: "</span> <span class="o">+</span> <span class="n">annotation</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>

        <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Diguage</span><span class="o">&gt;</span> <span class="n">annoClass</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>


        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n----Class----"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">annoClass</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n----SuperClass----"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">annoClass</span><span class="o">.</span><span class="na">getSuperclass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n----Interfaces----"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">annoClass</span><span class="o">.</span><span class="na">getInterfaces</span><span class="o">()));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n----Methods----"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">annoClass</span><span class="o">.</span><span class="na">getDeclaredMethods</span><span class="o">())</span>
                <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">", p"</span><span class="o">,</span> <span class="s">",\n p"</span><span class="o">));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n\n=============="</span><span class="o">);</span>
        <span class="nc">Diguage</span> <span class="n">anno2</span> <span class="o">=</span> <span class="nc">AnnoTest2</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="nc">Diguage</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">anno2</span> <span class="o">+</span> <span class="s">" : "</span> <span class="o">+</span> <span class="n">anno2</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>每个注解都是一个接口声明，然后基于这个接口使用动态代理生成一个代理类。而被标注的注解，就是一个代理类的实例对象。</p>
</div>
<div class="paragraph">
<p>代理类中的 <code>InvocationHandler</code> 则是 <code>AnnotationInvocationHandler</code> 实例，实例变量 <code>Map&lt;String, Object&gt; memberValues</code> 保存着注解中成员属性的名称和值的映射，注解成员属性的名称实际上就对应着接口中抽象方法的名称。</p>
</div>
<div class="paragraph">
<p>总结</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>用反射 + 字节码生成技术来生成字节码，然后加载出来代理对象。</p>
</li>
<li>
<p>从java的角度来看这本语言,就是一个动态性语言,一切的动态性来源于类的加载方式,
在程序运行期间,可以很大程度上修改class</p>
</li>
<li>
<p><code>newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</code> 实际上从生成的 Class 文件和这个传递参数来看 jdk Proxy 仅仅对于接口进行代理, 即生成实现了接口的临时类对象.</p>
</li>
<li>
<p>由于生成的类，继承了 <code>java.lang.reflect.Proxy</code> 类，而 Java 是单继承的。所以，动态代理只能代理生成接口，不能代理类。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>既然都生成代理类了，为什么不直接继承代理类呢？这样就可以对代理类所有的方法进行增强了。</p>
</div>
<div class="sect2">
<h3 id="_思考题_2"><a class="anchor" href="#_思考题_2"></a>72.1. 思考题</h3>
<div class="paragraph">
<p>如何自己写代码来实现代码生成、加载类的动态代理？</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>如何生成代理类？-- 可以考虑直接生成 Java 代码，然后调用 <code>JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();</code> 获取编译器来编译 Java 代码。</p>
</li>
<li>
<p>如何加载类？-- 可以使用 <code>java.net.URLClassLoader</code> 来加载字节码文件。</p>
</li>
<li>
<p>如何抽象代理动作？</p>
</li>
<li>
<p>如何在方法内获取参数列表？</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_cglib"><a class="anchor" href="#_cglib"></a>72.2. CGLIB</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>通过生成子类的方式来产生代理，某些情况比动态代理运行速度要快一些。</p>
</li>
<li>
<p>不能代理 <code>final</code> 修饰的类。</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_23"><a class="anchor" href="#_参考资料_23"></a>72.3. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://www.cnblogs.com/gonjan-blog/p/6685611.html">java动态代理实现与原理详细分析 - Gonjian - 博客园</a></p>
</li>
<li>
<p><a href="https://www.fancylight.top/2019/05/22/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/#%E4%BB%A3%E7%90%86%E7%B1%BB%E6%96%87%E4%BB%B6">java动态代理 | 博客</a></p>
</li>
<li>
<p><a href="https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html">字节码增强技术探索 - 美团技术团队</a></p>
</li>
<li>
<p><a href="https://www.geeksforgeeks.org/get-name-of-current-method-being-executed-in-java/">Get name of current method being executed in Java - GeeksforGeeks</a></p>
</li>
<li>
<p><a href="http://www.throwable.club/2018/12/08/java-reflection-dynamic-proxy/">深入分析Java反射(四)-动态代理 - Throwable&#8217;s Blog</a></p>
</li>
<li>
<p><a href="http://www.throwable.club/2018/12/16/cglib-dynamic-proxy-analyze/">CGLIB动态代理原理分析 - Throwable&#8217;s Blog</a></p>
</li>
<li>
<p><a href="http://www.throwable.club/2020/03/16/annotation-implementation/">JDK中注解的底层实现 - Throwable&#8217;s Blog</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serversocket"><a class="anchor" href="#_serversocket"></a>73. ServerSocket</h2>
<div class="sectionbody">
<div class="paragraph">
<p>在纠结了 N 久之后，终于动手写程序完成了 Socket 全双工实验。实验证实，Socket 在接受的同时，还可以发送报文。</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/simplex-half-duplex-full-duplex.jpg" alt="simplex half duplex full duplex">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.net</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.StandardCharsets</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * Socket 全双工演示示例
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-03-25 23:03
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SocketFullDuplexTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">11233</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testServer</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
        <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
        <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">InputStreamReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span>
            <span class="nc">BufferedReader</span> <span class="n">bufferedReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">bufferedReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">OutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"S-"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"msg = "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
                    <span class="n">outputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
                    <span class="n">outputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>

        <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">InputStreamReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span>
            <span class="nc">BufferedReader</span> <span class="n">bufferedReader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">line</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">bufferedReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">OutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"C-"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"msg = "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
                    <span class="n">outputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="nc">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
                    <span class="n">outputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_24"><a class="anchor" href="#_参考资料_24"></a>73.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://hafizahabdullah.blogspot.com/2013/08/fp303-cn-simplex-half-duplex-and-full.html">P2E for Students: FP303 CN: Simplex, Half-Duplex and Full-Duplex</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serviceloader"><a class="anchor" href="#_serviceloader"></a>74. <code>ServiceLoader</code></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-08 10:47
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ServiceLoaderSay</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">say</span><span class="o">();</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-08 10:48
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLoaderSayHello</span> <span class="kd">implements</span> <span class="nc">ServiceLoaderSay</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">say</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello, https://www.diguage.com/"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-08 10:48
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLoaderSayGoodbye</span> <span class="kd">implements</span> <span class="nc">ServiceLoaderSay</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">say</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Goodbye, https://www.diguage.com/"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ServiceLoader</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-08 10:40
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLoaderTest</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ServiceLoader</span><span class="o">&lt;</span><span class="nc">ServiceLoaderSay</span><span class="o">&gt;</span> <span class="n">loader</span>
                <span class="o">=</span> <span class="nc">ServiceLoader</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">ServiceLoaderSay</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">ServiceLoaderSay</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">ServiceLoaderSay</span> <span class="n">say</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">say</span><span class="o">.</span><span class="na">say</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>经过测试，有几点需要注意：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>只支持 <code>public</code> 的类。D瓜哥测试，这是因为内部需要创建对象，其他访问控制不能在 <code>ServiceLoader</code> 类中创建对象。</p>
</li>
<li>
<p>不支持 <code>Outter.Inner</code> 这样的内部类 ，即使是 <code>public static class</code>。</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_参考资料_25"><a class="anchor" href="#_参考资料_25"></a>74.1. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.throwable.club/2018/11/30/java-service-loader/">浅析JDK中ServiceLoader的源码 - Throwable&#8217;s Blog</a>&#8201;&#8212;&#8201;这里的代码是基于 JDK 8 的，和 JDK 11 的代码已经相差很大。</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_string"><a class="anchor" href="#_string"></a>75. <code>String</code></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringUtils</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">switchFormat</span><span class="o">(</span><span class="kt">int</span> <span class="n">cur</span><span class="o">,</span> <span class="kt">int</span> <span class="n">length</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">""</span> <span class="o">+</span> <span class="n">cur</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">q</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">q</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
        <span class="n">str</span> <span class="o">=</span> <span class="s">"0"</span> <span class="o">+</span> <span class="n">str</span><span class="o">;</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
        <span class="n">str</span> <span class="o">=</span> <span class="s">"00"</span> <span class="o">+</span> <span class="n">str</span><span class="o">;</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
        <span class="n">str</span> <span class="o">=</span> <span class="s">"000"</span> <span class="o">+</span> <span class="n">str</span><span class="o">;</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
        <span class="n">str</span> <span class="o">=</span> <span class="s">"0000"</span> <span class="o">+</span> <span class="n">str</span><span class="o">;</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
        <span class="n">str</span> <span class="o">=</span> <span class="s">"00000"</span> <span class="o">+</span> <span class="n">str</span><span class="o">;</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">case</span> <span class="mi">6</span><span class="o">:</span>
        <span class="n">str</span> <span class="o">=</span> <span class="s">"000000"</span> <span class="o">+</span> <span class="n">str</span><span class="o">;</span>
        <span class="k">break</span><span class="o">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">str</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">format</span><span class="o">(</span><span class="kt">int</span> <span class="n">cur</span><span class="o">,</span> <span class="kt">int</span> <span class="n">len</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%0"</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="s">"d"</span><span class="o">,</span> <span class="n">cur</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.openjdk.jmh.annotations.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">StringUtils</span><span class="o">.</span><span class="na">format</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">StringUtils</span><span class="o">.</span><span class="na">switchFormat</span><span class="o">;</span>

<span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="nc">Mode</span><span class="o">.</span><span class="na">Throughput</span><span class="o">)</span>
<span class="nd">@Measurement</span><span class="o">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">10</span><span class="o">,</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">30</span><span class="o">)</span>
<span class="nd">@OutputTimeUnit</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
<span class="nd">@Warmup</span><span class="o">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">5</span><span class="o">)</span>
<span class="nd">@State</span><span class="o">(</span><span class="nc">Scope</span><span class="o">.</span><span class="na">Thread</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringUtilTest</span> <span class="o">{</span>

  <span class="c1">// TODO 怎么书写测试用例？</span>
  <span class="nd">@Param</span><span class="o">({</span><span class="s">"1"</span><span class="o">,</span> <span class="s">"2"</span><span class="o">})</span>
  <span class="kt">int</span> <span class="n">num</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">lens</span> <span class="o">=</span> <span class="o">{</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">6</span><span class="o">,</span> <span class="mi">7</span><span class="o">};</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testStringFormat</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">format</span><span class="o">(</span><span class="n">num</span><span class="o">,</span> <span class="n">num</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testSwitchFormat</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">switchFormat</span><span class="o">(</span><span class="n">num</span><span class="o">,</span> <span class="n">num</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_date"><a class="anchor" href="#_date"></a>76. <code>Date</code></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.lang3.time.FastDateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.joda.time.format.DateTimeFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.openjdk.jmh.annotations.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.text.DateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.ZoneId</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.ZonedDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.format.DateTimeFormatter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">DateFormatTest</span><span class="o">.</span><span class="na">DateFormatUtils</span><span class="o">.</span><span class="na">yyyyMMdd</span><span class="o">;</span>


<span class="nd">@BenchmarkMode</span><span class="o">(</span><span class="nc">Mode</span><span class="o">.</span><span class="na">Throughput</span><span class="o">)</span>
<span class="nd">@Measurement</span><span class="o">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">5</span><span class="o">,</span> <span class="n">timeUnit</span> <span class="o">=</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
<span class="nd">@OutputTimeUnit</span><span class="o">(</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">)</span>
<span class="nd">@Warmup</span><span class="o">(</span><span class="n">iterations</span> <span class="o">=</span> <span class="mi">3</span><span class="o">,</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">5</span><span class="o">)</span>
<span class="nd">@Fork</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
<span class="nd">@Threads</span><span class="o">(</span><span class="mi">8</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DateFormatTest</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">DateTimeFormatter</span> <span class="n">formatter</span> <span class="o">=</span> <span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="n">yyyyMMdd</span><span class="o">);</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">FastDateFormat</span> <span class="n">fastFormat</span> <span class="o">=</span> <span class="nc">FastDateFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">yyyyMMdd</span><span class="o">);</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">org</span><span class="o">.</span><span class="na">joda</span><span class="o">.</span><span class="na">time</span><span class="o">.</span><span class="na">format</span><span class="o">.</span><span class="na">DateTimeFormatter</span>
    <span class="n">jodaFormat</span> <span class="o">=</span> <span class="nc">DateTimeFormat</span><span class="o">.</span><span class="na">forPattern</span><span class="o">(</span><span class="n">yyyyMMdd</span><span class="o">);</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testSimpleDateFormat</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">SimpleDateFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="n">yyyyMMdd</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">format</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testLocalSimpleDateFormat</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">DateFormatUtils</span><span class="o">.</span><span class="na">formatDate</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testVariaFormatter</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">LocalDateTime</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">now</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="n">yyyyMMdd</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testConstFormatter</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">LocalDateTime</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">now</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">formatter</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testConstFormatterDate</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
    <span class="nc">LocalDateTime</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">ofInstant</span><span class="o">(</span><span class="n">date</span><span class="o">.</span><span class="na">toInstant</span><span class="o">(),</span> <span class="nc">ZoneId</span><span class="o">.</span><span class="na">systemDefault</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">now</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">formatter</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testConstFormatterDateZ</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">();</span>
    <span class="nc">ZonedDateTime</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">ZonedDateTime</span><span class="o">.</span><span class="na">ofInstant</span><span class="o">(</span><span class="n">date</span><span class="o">.</span><span class="na">toInstant</span><span class="o">(),</span> <span class="nc">ZoneId</span><span class="o">.</span><span class="na">systemDefault</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">now</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">formatter</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testVariaFastDateFormat</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">FastDateFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="nc">FastDateFormat</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">yyyyMMdd</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">format</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testConstFastDateFormat</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">fastFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Benchmark</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">testJodaFormat</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">org</span><span class="o">.</span><span class="na">joda</span><span class="o">.</span><span class="na">time</span><span class="o">.</span><span class="na">LocalDateTime</span> <span class="n">now</span> <span class="o">=</span> <span class="n">org</span><span class="o">.</span><span class="na">joda</span><span class="o">.</span><span class="na">time</span><span class="o">.</span><span class="na">LocalDateTime</span><span class="o">.</span><span class="na">fromDateFields</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">jodaFormat</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">now</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DateFormatUtils</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">yyyyMMdd</span> <span class="o">=</span> <span class="s">"yyyyMMdd"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">DateFormat</span><span class="o">&gt;</span> <span class="n">dateFormatThreadLocal</span>
      <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="n">yyyyMMdd</span><span class="o">));</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">formatDate</span><span class="o">(</span><span class="nc">Date</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dateFormatThreadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_serializable"><a class="anchor" href="#_serializable"></a>77. <code>Serializable</code></h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.StringJoiner</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OuterClass</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">119</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"D瓜哥"</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">StringJoiner</span><span class="o">(</span><span class="s">", "</span><span class="o">,</span> <span class="nc">OuterClass</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"["</span><span class="o">,</span> <span class="s">"]"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"age="</span> <span class="o">+</span> <span class="n">age</span><span class="o">)</span>
      <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"name='"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">InnerClass</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">iage</span> <span class="o">=</span> <span class="mi">120</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">iname</span> <span class="o">=</span> <span class="s">"https://www.diguage.com"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getIage</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">iage</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIage</span><span class="o">(</span><span class="kt">int</span> <span class="n">iage</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">iage</span> <span class="o">=</span> <span class="n">iage</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getIname</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">iname</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIname</span><span class="o">(</span><span class="nc">String</span> <span class="n">iname</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">iname</span> <span class="o">=</span> <span class="n">iname</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">StringJoiner</span><span class="o">(</span><span class="s">", "</span><span class="o">,</span> <span class="nc">InnerClass</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"["</span><span class="o">,</span> <span class="s">"]"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"iage="</span> <span class="o">+</span> <span class="n">iage</span><span class="o">)</span>
        <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"iname='"</span> <span class="o">+</span> <span class="n">iname</span> <span class="o">+</span> <span class="s">"'"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Throwable</span> <span class="o">{</span>
      <span class="n">test</span><span class="o">(</span><span class="k">new</span> <span class="nc">OuterClass</span><span class="o">());</span>
      <span class="n">test</span><span class="o">(</span><span class="k">new</span> <span class="nc">InnerClass</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(</span><span class="nc">Object</span> <span class="n">param</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"param = "</span> <span class="o">+</span> <span class="n">param</span><span class="o">);</span>
      <span class="nc">ByteArrayOutputStream</span> <span class="n">baos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayOutputStream</span><span class="o">(</span><span class="mi">10240</span><span class="o">);</span>
      <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span><span class="n">baos</span><span class="o">);</span>
      <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">param</span><span class="o">);</span>

      <span class="nc">ByteArrayInputStream</span> <span class="n">bais</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">baos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
      <span class="nc">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span><span class="n">bais</span><span class="o">);</span>
      <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"deser = "</span> <span class="o">+</span> <span class="n">object</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_netty"><a class="anchor" href="#_netty"></a>78. Netty</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Netty 和 <code>ServerSocketChannel</code> 可以互相操作吗？</p>
</div>
<div class="sect2">
<h3 id="_jdk_原生_socket_编程"><a class="anchor" href="#_jdk_原生_socket_编程"></a>78.1. JDK 原生 Socket 编程</h3>
<div class="paragraph">
<p>使用 JDK 原生的 Socket API 进行网络编程：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-21 14:31
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerSocketTest</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">HOST</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">11911</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testServer</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Server</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Server</span><span class="o">(</span><span class="no">PORT</span><span class="o">);</span>
    <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="no">HOST</span><span class="o">,</span> <span class="no">PORT</span><span class="o">);</span>
    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端启动成功"</span><span class="o">);</span>
      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"Hello, D瓜哥！"</span><span class="o">;</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端发送数据："</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
          <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="no">UTF_8</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"写入数据报错！"</span><span class="o">);</span>
          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">sleep</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sleep</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">ServerSocket</span> <span class="n">serverSocket</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Server</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务端启动成功，端口号："</span> <span class="o">+</span> <span class="n">port</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务端启动失败"</span><span class="o">);</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">doStart</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doStart</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
          <span class="k">new</span> <span class="nf">ClientHandler</span><span class="o">(</span><span class="n">socket</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务端异常"</span><span class="o">);</span>
          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ClientHandler</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MAX_DATA_LEN</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Socket</span> <span class="n">socket</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ClientHandler</span><span class="o">(</span><span class="nc">Socket</span> <span class="n">socket</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"新客户端接入"</span><span class="o">);</span>
      <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">doStart</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">doStart</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="no">MAX_DATA_LEN</span><span class="o">];</span>
          <span class="kt">int</span> <span class="n">len</span><span class="o">;</span>
          <span class="k">while</span> <span class="o">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">data</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端传来消息："</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
            <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务端读取错误失败"</span><span class="o">);</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>阻塞</p>
</li>
<li>
<p>高性能</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_server_startup"><a class="anchor" href="#_server_startup"></a>78.2. Server startup</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.Channel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.AttributeKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.LockSupport</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-04-20 22:19
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test03</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">PORT</span> <span class="o">=</span> <span class="mi">11911</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testServer</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">childOption</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">TCP_NODELAY</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">childAttr</span><span class="o">(</span><span class="nc">AttributeKey</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="s">"childAttr"</span><span class="o">),</span> <span class="kc">null</span><span class="o">)</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServerHandler</span><span class="o">())</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

          <span class="o">}</span>
        <span class="o">});</span>
      <span class="nc">ChannelFuture</span> <span class="n">f</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="no">PORT</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="n">f</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">": 端口["</span> <span class="o">+</span> <span class="no">PORT</span> <span class="o">+</span> <span class="s">"]绑定成功！"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">": 端口["</span> <span class="o">+</span> <span class="no">PORT</span> <span class="o">+</span> <span class="s">"]绑定失败！"</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">});</span>
      <span class="n">f</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nc">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ServerHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRegistered</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"channelRegistered"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"channelActive"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"handlerAdded"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
<span class="c1">//            ((ByteBuf) msg).release();</span>
<span class="c1">//            ReferenceCountUtil.release(msg);</span>
      <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
      <span class="n">ctx</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">executors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">executors</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">remoteAddress</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="no">PORT</span><span class="o">))</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClientHandler</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">executors</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ClientHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Handl"</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>两个问题</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>服务端的 Socket 在哪里初始化？</p>
</li>
<li>
<p>在哪里 accept 连接？</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Netty 服务端启动</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>创建服务端 <code>Channel</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>io.netty.bootstrap.AbstractBootstrap.bind(int)</code></p>
</li>
<li>
<p><code>io.netty.bootstrap.AbstractBootstrap.doBind(SocketAddress)</code></p>
</li>
<li>
<p><code>io.netty.bootstrap.AbstractBootstrap.initAndRegister()</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>初始化服务端 <code>Channel</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>NioServerSocketChannel.NioServerSocketChannel()</code> 在 <code>NioServerSocketChannel</code> 默认初始化函数中，使用了 JDK 内置的 <code>SelectorProvider.provider()</code> 方法返回的 <code>SelectorProvider</code> 对象。</p>
</li>
<li>
<p>在 <code>NioServerSocketChannel.newSocket(SelectorProvider)</code> 方法中，调用 <code>provider.openServerSocketChannel()</code> 来创建 <code>ServerSocketChannel</code> 对象。</p>
</li>
<li>
<p>在 <code>AbstractNioChannel.AbstractNioChannel(Channel, SelectableChannel, int)</code> 构造函数中，设置 <code>selectableChannel.configureBlocking(false)</code>。</p>
</li>
</ol>
</div>
</li>
<li>
<p>注册 Selector</p>
</li>
<li>
<p>端口绑定&#8201;&#8212;&#8201;调用底层 API，实现对端口的绑定。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>服务端 <code>Channel</code> 初始化过程</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>通过 <code>bind()</code> 进入</p>
</li>
<li>
<p><code>initAndRegister()</code></p>
</li>
<li>
<p>在 <code>AbstractBootstrap.initAndRegister()</code> 中通过 <code>channelFactory.newChannel()</code> 利用反射机制来创建 <code>Channel</code>。</p>
</li>
<li>
<p>在 <code>ServerBootstrap.init(Channel)</code> 中，初始化 <code>Channel</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>setChannelOptions</code></p>
</li>
<li>
<p><code>setAttributes</code></p>
</li>
<li>
<p>配置 <code>ChannelHandler</code>&#8201;&#8212;&#8201;配置服务端 pipeline。</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>初始化时，调用 <code>AbstractBootstrap.handler(io.netty.channel.ChannelHandler)</code>，配置 <code>ChannelHandler</code> 对象</p>
</li>
<li>
<p>通过调用 <code>AbstractBootstrap.initAndRegister()</code> 方法调用 <code>ServerBootstrap.init(Channel)</code> 方法，在其中，将 <code>ChannelHandler</code> 对象追加到 <code>Channel</code> 对象的 pipeline 的最后面。</p>
</li>
</ol>
</div>
</li>
<li>
<p>add <code>ServerBootstrapAcceptor</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>上一步执行完毕后，在 <code>ServerBootstrap.init(Channel)</code> 方法中，会创建一个 <code>ServerBootstrapAcceptor</code> 对象添加到 pipeline 后面。</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>注册 selector</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>AbstractChannel.AbstractUnsafe.register(EventLoop, ChannelPromise)</code> 入口</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>AbstractChannel.this.eventLoop = eventLoop;</code> 绑定线程</p>
</li>
<li>
<p><code>AbstractChannel.AbstractUnsafe.register0(ChannelPromise)</code> 实际注册</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>AbstractChannel.doRegister()</code> 调用底层 JDK API 注册</p>
</li>
<li>
<p><code>pipeline.invokeHandlerAddedIfNeeded()</code></p>
</li>
<li>
<p><code>pipeline.fireChannelRegistered()</code></p>
<div class="paragraph">
<p>从示例代码的输出可以看出，<code>Test03.ServerHandler</code> 中三个"事件"方法被调用的顺序是： <code>handlerAdded</code>，<code>channelRegistered</code> 和 <code>channelActive</code>。</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>端口绑定</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>AbstractChannel.AbstractUnsafe.bind(SocketAddress, ChannelPromise)</code> 入口</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>AbstractBootstrap.doBind(SocketAddress)</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>javaChannel().bind()</code> JDK 底层绑定 <code>io.netty.channel.AbstractChannel.AbstractUnsafe.bind</code></p>
<div class="olist upperalpha">
<ol class="upperalpha" type="A">
<li>
<p>` pipeline.fireChannelActive()` 传播事件</p>
</li>
</ol>
</div>
</li>
<li>
<p><code>HeadContext.readIfIsAutoRead()</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_nioeventloop"><a class="anchor" href="#_nioeventloop"></a>78.3. <code>NioEventLoop</code></h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>默认情况下，Netty 服务端起多少个线程？何时启动？</p>
</li>
<li>
<p>Netty 是如何解决 JDK 空轮询 Bug 的？</p>
</li>
<li>
<p>Netty 如何保证异步串行无锁化？</p>
</li>
</ol>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>NioEventLoop</code> 创建</p>
</li>
<li>
<p><code>NioEventLoop</code> 启动</p>
</li>
<li>
<p><code>NioEventLoop</code> 执行逻辑</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_nioeventloop_创建"><a class="anchor" href="#_nioeventloop_创建"></a>78.3.1. <code>NioEventLoop</code> 创建</h4>
<div class="paragraph">
<p><code>NioEventLoop</code> 默认是在调用 <code>NioEventLoopGroup()</code> 时被创建，默认是 2 倍的 CPU 数量（由常量 <code>MultithreadEventLoopGroup.DEFAULT_EVENT_LOOP_THREADS</code> 来定义）。</p>
</div>
<div class="paragraph">
<p>在 <code>MultithreadEventExecutorGroup.MultithreadEventExecutorGroup(int, Executor, EventExecutorChooserFactory, Object&#8230;&#8203;)</code> 构造函数中：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>创建 <code>new ThreadPerTaskExecutor(newDefaultThreadFactory())</code> 线程池；</p>
<div class="paragraph">
<p>每次执行任务都会创建一个线程实体。</p>
</div>
<div class="paragraph">
<p><code>NioEventLoop</code> 线程命名规则 <code>nioEventLoop-1-XX</code>。在 <code>io.netty.util.concurrent.DefaultThreadFactory</code> 中可以看到。</p>
</div>
<div class="paragraph">
<p>这里还有两点需要注意：创建的线程对象和 <code>Runable</code> 被分别包装成了 <code>FastThreadLocalThread</code> 和 <code>FastThreadLocalRunnable</code>，主要是对 <code>ThreadLocal</code> 做了一些优化。</p>
</div>
</li>
<li>
<p>使用 <code>for</code> 循环，利用 <code>MultithreadEventExecutorGroup.newChild(Executor, Object&#8230;&#8203;)</code> 方法创建 <code>NioEventLoop</code> 对象。</p>
<div class="paragraph">
<p>有三个作用：①保存线程执行器 <code>ThreadPerTaskExecutor</code>；②创建一个 <code>MpscQueue</code>；③创建一个 selector。</p>
</div>
<div class="paragraph">
<p>在 <code>NioEventLoop.newTaskQueue(int)</code> 方法，然后调用 <code>NioEventLoop.newTaskQueue0(int)</code> 方法，创建 <code>MpscQueue</code>。</p>
</div>
</li>
<li>
<p>调用 <code>DefaultEventExecutorChooserFactory.newChooser(EventExecutor[])</code> 方法，创建线程选择器。</p>
<div class="paragraph">
<p><code>isPowerOfTwo()</code> 判断是否是 2 的幂，如果是则返回 <code>PowerOfTwoEventExecutorChooser</code>（优化），返回 <code>index &amp; (length - 1)`；否则返回 `GenericEventExecutorChooser`（普通），返回 `abs(index % length)</code>。</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_nioeventloop_启动"><a class="anchor" href="#_nioeventloop_启动"></a>78.3.2. <code>NioEventLoop</code> 启动</h4>
<div class="ulist">
<ul>
<li>
<p>服务端启动绑定接口</p>
</li>
<li>
<p>新连接接入，通过 choose 绑定一个 <code>NioEventLoop</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在 <code>AbstractBootstrap.doBind0</code> 方法中，调用 <code>SingleThreadEventExecutor.execute(java.lang.Runnable)</code> 开始启动，再调用 <code>SingleThreadEventExecutor.execute(java.lang.Runnable, boolean)</code>，最后通过 <code>SingleThreadEventExecutor.startThread</code> 方法来启动。实际启动工作，最后委托给了 <code>SingleThreadEventExecutor.doStartThread</code> 方法来执行，这个方法中，调用 <code>SingleThreadEventExecutor.this.run();</code> 来启动 <code>NioEventLoop</code>。</p>
</div>
</div>
<div class="sect3">
<h4 id="_nioeventloop_执行逻辑"><a class="anchor" href="#_nioeventloop_执行逻辑"></a>78.3.3. <code>NioEventLoop</code> 执行逻辑</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>run() &#8594; for(;;)</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>select()</code> 检查是否有 I/O 事件</p>
</li>
<li>
<p><code>processSelectedKeys()</code> 处理 I/O 事件</p>
</li>
<li>
<p><code>SingleThreadEventExecutor.runAllTasks(long)</code> 处理异步任务队列</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>select() 方法</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>deadline 以及任务穿插逻辑处理</p>
<div class="paragraph">
<p><code>NioEventLoop.select(long)</code></p>
</div>
</li>
<li>
<p>阻塞式select</p>
</li>
<li>
<p>避免 JDK 空轮询的 Bug</p>
<div class="paragraph">
<p>在 <code>NioEventLoop.run()</code> 方法中，每次轮询，都会记录一下轮询次数 <code>selectCnt</code>；在 <code>NioEventLoop.unexpectedSelectorWakeup(selectCnt)`方法中，如果轮询次数大于 `SELECTOR_AUTO_REBUILD_THRESHOLD</code>(该值默认是 <code>512</code>，可以通过 <code>io.netty.selectorAutoRebuildThreshold</code> 参数来改)，则重建。</p>
</div>
<div class="paragraph">
<p>重建工作在 <code>NioEventLoop.rebuildSelector()</code> 方法中完成，然后又委托给 <code>NioEventLoop.rebuildSelector0()</code> 来实际执行。主要工作就是创建一个新的 <code>selector</code>，然后把老的 <code>selector</code> 上的 <code>SelectionKey</code> 注册到新的 <code>selector</code> 上。</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong><code>processSelectedKeys()</code></strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>selected keySet 优化</p>
<div class="paragraph">
<p><code>SelectedSelectionKeySet</code> 底层是一个数组。只实现了增加操作，删除操作没有实现。为什么？</p>
</div>
</li>
<li>
<p><code>processSelectedKeysOptimized()</code></p>
<div class="paragraph">
<p><code>NioEventLoop.processSelectedKeysOptimized()</code>，重点在 <code>NioEventLoop.processSelectedKey(SelectionKey, AbstractNioChannel)</code> 。</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_netty_2"><a class="anchor" href="#_netty_2"></a>78.4. Netty</h3>
<div class="paragraph">
<p>创建 bossGroup 和 workerGroup
. 创建两个线程组 bossGroup 和 workerGroup
. bossGroup 只是处理连接请求，真正的客户端业务处理，会交给 workerGroup 完成
. 两个都是无限循环
. bossGroup 和 workerGroup 含有的子线程(NioEventLoop)的个数。默认 <code>CPU 内核数 * 2</code>，在 <code>io.netty.channel.MultithreadEventLoopGroup.DEFAULT_EVENT_LOOP_THREADS</code> 常量中定义</p>
</div>
<div class="sect3">
<h4 id="_异步任务"><a class="anchor" href="#_异步任务"></a>78.4.1. 异步任务</h4>
<div class="paragraph">
<p>比如这里我们有一个非常耗时长的业务&#8594; 异步执行 &#8594; 提交该 channel 对应的 NIOEventLoop 的 taskQueue 中, 从 ctx &#8594; pipeline &#8594; eventLoop &#8594; taskQueue 可以看到提交的任务。</p>
</div>
<div class="listingblock">
<div class="title">NettyServer</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.simple</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFutureListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 17:28
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServer</span> <span class="o">{</span>
  <span class="cm">/**
   * 在 JDK 11 下启动错误： https://stackoverflow.com/a/57892679/951836
   */</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">server</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// 创建 bossGroup 和 workerGroup</span>
    <span class="c1">// 1. 创建两个线程组 bossGroup 和 workerGroup</span>
    <span class="c1">// 2. bossGroup 只是处理连接请求，真正的客户端业务处理，会交给 workerGroup 完成</span>
    <span class="c1">// 3. 两个都是无限循环</span>
    <span class="c1">// 4. bossGroup 和 workerGroup 含有的子线程(NioEventLoop)的个数</span>
    <span class="c1">//    默认 CPU 内核数 * 2，在 io.netty.channel.MultithreadEventLoopGroup.DEFAULT_EVENT_LOOP_THREADS 常量中定义</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 创建服务器端的启动对象，配置参数</span>
      <span class="nc">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="c1">// 使用链式编程进行配置</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span> <span class="c1">// 设置两个 线程组</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 使用 NioSocketChannel 作为服务器的通道实现</span>
        <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="mi">128</span><span class="o">)</span> <span class="c1">// 设置线程队列得到连接个数</span>
        <span class="o">.</span><span class="na">childOption</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_KEEPALIVE</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// 设置保持活动连接状态</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="c1">// 创建一个通道测试对象</span>
          <span class="c1">// 给 pipeline 设置处理器</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">NettyServerHandler</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span> <span class="c1">// 给 workerGroup 的 EventLoop 对应的管道设置处理器</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"....服务器 is ready..."</span><span class="o">);</span>

      <span class="c1">// 绑定一个端口并且同步，生成一个 ChannelFuture 对象</span>
      <span class="c1">// 启动服务器（并绑定端口）</span>
      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

      <span class="c1">// 给 future 注册监听器</span>
      <span class="n">future</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="nc">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"监听端口 11911 成功"</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"监听端口 11911 失败"</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">});</span>


      <span class="c1">// 对关闭通道进行监听</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

      <span class="c1">// TODO Netty 的异步模型</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">NettyServerHandler</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.simple</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * 说明：
 * 我们自定义一个 Handler 需要继承 netty 规定好的某个 HandlerAdapter
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 18:54
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServerHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
  <span class="cm">/**
   * 读取数据实际（这里我们可以读取客户端发送的消息）
   *
   * @param ctx ChannelHandlerContext 上下文对象，含有管道 pipeline，通道 channel，地址
   * @param msg 客户端发送的数据，默认是 Object
   * @throws Exception
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

<span class="c1">//    // 第一：正常情况</span>
<span class="c1">//    System.out.println("服务器读取线程 " + Thread.currentThread().getName());</span>
<span class="c1">//    System.out.println("server ctx = " + ctx);</span>
<span class="c1">//    System.out.println("看看 channel 和 pipeline 的关系");</span>
<span class="c1">//    // 从 ctx 可以拿到非常非常多的信息</span>
<span class="c1">//    Channel channel = ctx.channel();</span>
<span class="c1">//    ChannelPipeline pipeline = ctx.pipeline(); // 本质是一个双向链接</span>
<span class="c1">//</span>
<span class="c1">//    // 将 msg 转成一个 ByteBuf</span>
<span class="c1">//    // ByteBuf 是 Netty 提供的，不是 NIO 提供的 ByteBuffer</span>
<span class="c1">//    ByteBuf buf = (ByteBuf) msg;</span>
<span class="c1">//    System.out.println("客户端发送消息是：" + buf.toString(UTF_8));</span>
<span class="c1">//    System.out.println("客户端地址：" + channel.remoteAddress());</span>


    <span class="c1">// 第二种情况：</span>
    <span class="c1">// 比如这里我们有一个非常耗时长的业务-&gt; 异步执行 -&gt; 提交该 channel 对应的</span>
    <span class="c1">// NIOEventLoop 的 taskQueue 中,</span>
    <span class="c1">// 从 ctx -&gt; pipeline -&gt; eventLoop -&gt; taskQueue 可以看到提交的任务</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"hello, 客户端~(&gt;^ω^&lt;)喵 2"</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"channel code="</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">hashCode</span><span class="o">());</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"发生异常"</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">});</span>

    <span class="c1">// 定时任务</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">schedule</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">20</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">);</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"hello, 客户端~(&gt;^ω^&lt;)喵 2"</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"channel code="</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">hashCode</span><span class="o">());</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"发生异常"</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">},</span> <span class="mi">10</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 数据读取完毕
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 将数据写入到缓存，并刷新</span>
    <span class="c1">// 一般讲，我们对这个发送的数据进行编码</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"Hello, D瓜哥~, pong -&gt; O(∩_∩)O哈哈~"</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 处理异常，一般需要关闭通道
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">NettyClient</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.simple</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 19:35
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// 客户端只需要一个事件循环组即可</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 创建客户端启动对象</span>
      <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
      <span class="c1">// 设置相关参数</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span> <span class="c1">// 设置线程组</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 设置客户端通讯通道的实现类</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">NettyClientHandler</span><span class="o">());</span> <span class="c1">// 加入自己的处理器</span>
          <span class="o">}</span>
        <span class="o">});</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"....客户端 OK ..."</span><span class="o">);</span>

      <span class="c1">// 启动客户端去连接服务器端</span>
      <span class="c1">// 关于 ChannelFuture 还要分析，涉及到 Netty 的异步模型</span>
      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

      <span class="c1">// 给关闭通道进行监听</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">NettyClientHandler</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.simple</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 19:41
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClientHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
  <span class="cm">/**
   * 当通道就绪就会触发该方法
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"client "</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">);</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"Hello, D瓜哥，ping -&gt; \\(^o^)/"</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 当通道有读取事件时，会触发
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器回复的消息："</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="no">UTF_8</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器的地址："</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Netty 的异步模型，就是基于 <code>ChannelFuture</code> 和 Listener 的监听回调模型。在入站、出站整个处理链上，可以注册各种各样的 Listener，以事件来驱动它们的调用。</p>
</div>
</div>
<div class="sect3">
<h4 id="_http"><a class="anchor" href="#_http"></a>78.4.2. HTTP</h4>
<div class="paragraph">
<p><code>io.netty.handler.codec.http.DefaultHttpRequest</code> 是 <code>io.netty.handler.codec.http.HttpObject</code> 的一个实现类。</p>
</div>
<div class="paragraph">
<p>为什么刷新一次浏览器，会有两个请求？ 浏览器增加了一次访问 ico 图标的请求。</p>
</div>
<div class="paragraph">
<p>HTTP 协议用完就关闭，所以，每次 pipeline 都不一样。跟 TCP 不太一样。</p>
</div>
<div class="listingblock">
<div class="title">TestServer</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.http</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 23:33
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestServer</span> <span class="o">{</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">TestServerInitializer</span><span class="o">());</span>

      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">TestServerInitializer</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.http</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpServerCodec</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 23:33
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestServerInitializer</span> <span class="kd">extends</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 向管道加入处理器</span>
    <span class="c1">// 得到管道</span>
    <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
    <span class="c1">// 加入一个 Netty 提供的 HttpServerCodec</span>
    <span class="c1">// HttpServerCodec 的说明</span>
    <span class="c1">// 1. HttpServerCodec 是 Netty 提供的处理 HTTP 的编解码器</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"MyHttpServerCodec"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">HttpServerCodec</span><span class="o">());</span>
    <span class="c1">// 2. 增加一个自定义的 Handler</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"MyTestServerHandler"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TestServerHandler</span><span class="o">());</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pipeline</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">TestServerHandler</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.http</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.DefaultFullHttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.FullHttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpHeaderNames</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpObject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpResponseStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpVersion</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * 说明
 * &lt;p&gt;
 * 1. SimpleChannelInboundHandler 就是 ChannelInboundHandlerAdapter 的子类
 * 2. HttpObject 客户端和服务器端相互同学的数据被封装成 HttpObject。
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 23:33
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestServerHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">HttpObject</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="cm">/**
   * 读取客户端数据
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">HttpObject</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 判断 msg 是不是一个 HttpRequest 请求</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="k">instanceof</span> <span class="nc">HttpRequest</span><span class="o">)</span> <span class="o">{</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ctx 类型 "</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"pipeline hashcode="</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">hashCode</span><span class="o">()</span>
        <span class="o">+</span> <span class="s">" TestServerHandler hash="</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"msg 类型 "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端地址 "</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>

      <span class="nc">HttpRequest</span> <span class="n">httpRequest</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpRequest</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
      <span class="no">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URI</span><span class="o">(</span><span class="n">httpRequest</span><span class="o">.</span><span class="na">uri</span><span class="o">());</span>
      <span class="k">if</span> <span class="o">(</span><span class="s">"/favicon.ico"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getPath</span><span class="o">()))</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"请求了 favicon.ico，不做响应"</span><span class="o">);</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// 回复信息给浏览器(http协议)</span>
      <span class="nc">ByteBuf</span> <span class="n">content</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"Hello, D瓜哥。我是服务器"</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">);</span>
      <span class="nc">FullHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultFullHttpResponse</span><span class="o">(</span><span class="nc">HttpVersion</span><span class="o">.</span><span class="na">HTTP_1_1</span><span class="o">,</span> <span class="nc">HttpResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="n">content</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="nc">HttpHeaderNames</span><span class="o">.</span><span class="na">CONTENT_TYPE</span><span class="o">,</span> <span class="s">"text/plain"</span><span class="o">);</span>
      <span class="n">response</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="nc">HttpHeaderNames</span><span class="o">.</span><span class="na">CONTENT_LENGTH</span><span class="o">,</span> <span class="n">content</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>

      <span class="c1">// 将构建好的 response 返回</span>
      <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre>
<span class="nc">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
<span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
  <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span> <span class="c1">// 添加到 bossGroup</span>
  <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span> <span class="c1">// 添加到 workerGroup</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>核心 API</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>Bootstrap</code></p>
</li>
<li>
<p><code>ServerBootstrap</code></p>
</li>
<li>
<p><code>Channel</code></p>
</li>
<li>
<p><code>ChannelFuture</code></p>
</li>
<li>
<p><code>ChannelHandler</code></p>
</li>
<li>
<p><code>ChannelHandlerContext</code>&#8201;&#8212;&#8201;<code>ChannelHandler</code> 中包含了一个 <code>ChannelHandlerContext</code>。</p>
</li>
<li>
<p><code>ChannelInboundHandler</code> 用于处理入站 I/O 事件</p>
</li>
<li>
<p><code>ChannelOutboundHandler</code> 用于处理出站 I/O 事件</p>
</li>
<li>
<p><code>ChannelPipeline</code>&#8201;&#8212;&#8201;一个重点。<code>ChannelPipeline</code> 是一个 Handler 的集合，它负责处理和拦截 inbound 或 outbound 的事件和操作，相当于一个贯穿 Netty 的链。</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./diag-8e05e1d2f9655806729c75caa9b4d53d.svg" alt="Diagram" width="90%" height="305">
</div>
</div>
<div class="paragraph">
<p><code>ChannelHandler</code> 是一个很庞大的体系，也是 Netty 中非常核心的知识点。</p>
</div>
<div class="paragraph">
<p>在 Netty 中，每个 Channel 都有且仅有一个 <code>ChannelPipeline</code> 与之对应。</p>
</div>
</div>
<div class="sect3">
<h4 id="_channelhandlercontext"><a class="anchor" href="#_channelhandlercontext"></a>78.4.3. <code>ChannelHandlerContext</code></h4>
<div class="paragraph">
<p><code>ChannelHandlerContext</code> 和 <code>ChannelHandler</code> 属于一对一关系。</p>
</div>
</div>
<div class="sect3">
<h4 id="_channeloption"><a class="anchor" href="#_channeloption"></a>78.4.4. <code>ChannelOption</code></h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>ChannelOption.SO_BACKLOG</code>&#8201;&#8212;&#8201;对应 TCP/IP 协议 <code>listen</code> 函数中的 <code>backlog</code> 参数，用于初始化服务器可连接队列大小。服务端处理客户端连接请求是顺序处理的，所以同一时间只能处理一个客户端连接。多个客户端来的时候，服务端将不能处理的客户端连接请求放在队列中等待处理，<code>backlog</code> 参数指定了队列大小。</p>
</li>
<li>
<p><code>ChannelOption.SO_KEEPALIVE</code>&#8201;&#8212;&#8201;一直保持连接活动状态。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>可以从下面三个方面来学习网络编程</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>结合 epoll 源码，来说说 Java NIO 的实现。</p>
</li>
<li>
<p>了解 Linux 网络编程接口</p>
</li>
<li>
<p>Java JDK 中对 Linux 网络编程接口的封装</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>Unpooled</code> 操作缓冲区的。</p>
</div>
<div class="paragraph">
<p><code>HttpObjectAggregator</code> 这个 Handler 可以实现报文聚合。怎么实现的？</p>
</div>
<div class="paragraph">
<p>在自定义 Handler 之前，经历过哪些 Handler？</p>
</div>
<div class="paragraph">
<p><code>io.netty.handler.codec.ByteToMessageDecoder.decode</code> 这个方法会被反复调用，直到确定没有新的元素被添加到list，或者 <code>ByteBuf</code> 没有更多的可读字节为止。<em>这是怎么实现的？</em></p>
</div>
<div class="listingblock">
<div class="title"><code>io.netty.handler.codec.MessageToByteEncoder.write</code></div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="nc">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
<span class="hll">        <span class="k">if</span> <span class="o">(</span><span class="n">acceptOutboundMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
</span><span class="hll">            <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
</span><span class="hll">            <span class="no">I</span> <span class="n">cast</span> <span class="o">=</span> <span class="o">(</span><span class="no">I</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
</span><span class="hll">            <span class="n">buf</span> <span class="o">=</span> <span class="n">allocateBuffer</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">cast</span><span class="o">,</span> <span class="n">preferDirect</span><span class="o">);</span>
</span><span class="hll">            <span class="k">try</span> <span class="o">{</span>
</span><span class="hll">                <span class="n">encode</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">cast</span><span class="o">,</span> <span class="n">buf</span><span class="o">);</span>
</span><span class="hll">            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="hll">                <span class="nc">ReferenceCountUtil</span><span class="o">.</span><span class="na">release</span><span class="o">(</span><span class="n">cast</span><span class="o">);</span>
</span><span class="hll">            <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">            <span class="k">if</span> <span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
</span><span class="hll">                <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span><span class="hll">            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="hll">                <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
</span><span class="hll">                <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="nc">Unpooled</span><span class="o">.</span><span class="na">EMPTY_BUFFER</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span><span class="hll">            <span class="o">}</span>
</span><span class="hll">            <span class="n">buf</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="hll">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="hll">            <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
</span><span class="hll">        <span class="o">}</span>
</span>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">EncoderException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">EncoderException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">buf</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>在 <code>ReplayingDecoder</code> 不需要判断数据是否足够读取，内部会进行处理判断。它是怎么实现的？</p>
</div>
<div class="paragraph">
<p><code>ReplayingDecoder</code> 有如下问题：</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>并不是所有的 <code>ByteBuf</code> 操作都支持，如果调用了一个不支持的方法，就会抛出 <code>UnsupportedOperationException</code></p>
</li>
<li>
<p>在某些情况下可能稍慢于 <code>ByteToMessageDecoder</code>，例如网络缓慢并且消息格式复杂时，消息会被拆成多个碎片，速度变慢。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>有很多编解码器</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>LineBasedFrameDecoder</code></p>
</li>
<li>
<p><code>DelimiterBasedFrameDecoder</code></p>
</li>
<li>
<p><code>HttpObjectDecoder</code></p>
</li>
<li>
<p><code>LengthFieldBasedFrameDecoder</code></p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_tcp_粘包和拆包"><a class="anchor" href="#_tcp_粘包和拆包"></a>78.4.5. TCP 粘包和拆包</h4>
<div class="paragraph">
<p>遇到异常就关闭连接，这样做合适吗？工程化的做法应该是怎么样的？如何重连或者重试？</p>
</div>
<div class="paragraph">
<p>粘包好奇怪，为什么第一次全部接受？后面的确开始不规则接受呢？</p>
</div>
<div class="paragraph">
<p>解决粘包问题的关键是解决服务器端每次读取数据长度的问题，这个问题解决，就不会出现服务器多读或者少读数据的问题，从而避免 TCP 粘包、拆包的问题。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_源码分析"><a class="anchor" href="#_源码分析"></a>78.5. 源码分析</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>doBind</code> 方法</p>
</li>
<li>
<p><code>NioEventLoop</code> 中的 <code>run</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>io.netty.bootstrap.AbstractBootstrap.doBind</code> 建立 NIO 和 Netty 之间的联系。</p>
</div>
<div class="paragraph">
<p><code>io.netty.channel.socket.nio.NioServerSocketChannel.doBind</code> 是一个重要的点。</p>
</div>
<div class="paragraph">
<p>执行到 <code>io.netty.channel.AbstractChannel.AbstractUnsafe.safeSetSuccess</code> 方法，就说明 promise 任务成功了。</p>
</div>
<div class="paragraph">
<p><code>new NioEventLoopGroup()</code> 如果不指定参数，则默认创建的个数是内核数*2。</p>
</div>
<div class="paragraph">
<p><code>io.netty.bootstrap.AbstractBootstrap.initAndRegister</code> 是源码分析的一个关键方法。</p>
</div>
<div class="paragraph">
<p>在 <code>io.netty.bootstrap.ServerBootstrap.init</code> 方法中完成了，<code>Channel</code> 和 <code>ChannelPipeline</code> 的关联。</p>
</div>
<div class="paragraph">
<p><code>ChannelPipeline</code> 是一个双向链表，但是 <code>head</code> 和 <code>tail</code> 节点是空节点，添加和删除 Handler 都是在这两个节点之间进行。</p>
</div>
<div class="paragraph">
<p>调用 <code>ChannelPipeline</code> 的 <code>addLast</code> 方法增加 <code>ChannelHandler</code>，最后是在 <code>io.netty.channel.DefaultChannelPipeline.addLast(EventExecutorGroup, String, ChannelHandler)</code> 方法中，将 <code>ChannelHandler</code> 封装成了 <code>ChannelHandlerContext</code>，然后添加到 <code>ChannelPipeline</code> 链上的。</p>
</div>
<div class="paragraph">
<p><code>io.netty.channel.nio.NioEventLoop.run</code> 方法中封装了事件轮询。</p>
</div>
<div class="paragraph">
<p><code>io.netty.channel.socket.nio.NioServerSocketChannel.doReadMessages</code> 方法中，把 NIO 的 <code>SocketChannel</code> 封装成了 Netty 的 <code>NioSocketChannel</code> 对象。</p>
</div>
</div>
<div class="sect2">
<h3 id="_时间轮"><a class="anchor" href="#_时间轮"></a>78.6. 时间轮</h3>
<div class="imageblock">
<div class="content">
<img src="./images/time-wheel.png" alt="time wheel">
</div>
</div>
<div class="paragraph">
<p>从图中可以看到此时指针指向的是第一个槽，一共有八个槽 0~7，假设槽的时间单位为 1 秒，现在要加入一个延时 5 秒的任务，计算方式就是 <code>5 % 8 + 1 = 6</code>，即放在槽位为 6，下标为 5 的那个槽中。更具体的就是拼到槽的双向链表的尾部。</p>
</div>
<div class="paragraph">
<p>然后每秒指针顺时针移动一格，这样就扫到了下一格，遍历这格中的双向链表执行任务。然后再循环继续。</p>
</div>
<div class="paragraph">
<p>可以看到插入任务从计算槽位到插入链表，时间复杂度都是O(1)。那假设现在要加入一个50秒后执行的任务怎么办？这槽好像不够啊？难道要加槽嘛？和HashMap一样扩容？</p>
</div>
<div class="paragraph">
<p>不是的，常见有两种方式，一种是通过增加轮次的概念。<code>50 % 8 + 1 = 3</code>，即应该放在槽位是 3，下标是 2 的位置。然后 <code>(50 - 1) / 8 = 6</code>，即轮数记为 6。也就是说当循环 6 轮之后扫到下标的 2 的这个槽位会触发这个任务。Netty 中的 <code>HashedWheelTimer</code> 使用的就是这种方式。</p>
</div>
</div>
<div class="sect2">
<h3 id="_参考资料_26"><a class="anchor" href="#_参考资料_26"></a>78.7. 参考资料</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://mp.weixin.qq.com/s/xBB72hJGn8geZ7SkM0FqJw" target="_blank" rel="noopener">面试官：知道时间轮算法吗？在Netty和Kafka中如何应用的？</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_自定义_dubbo"><a class="anchor" href="#_自定义_dubbo"></a>78.8. 自定义 Dubbo</h3>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.bytebuddy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">net.bytebuddy.ByteBuddy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.bytebuddy.ClassFileVersion</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.bytebuddy.implementation.DefaultMethodCall</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.bytebuddy.implementation.MethodDelegation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">net.bytebuddy.implementation.bind.annotation.SuperCall</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Files</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.file.Path</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Callable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.stream.Collectors</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">net</span><span class="o">.</span><span class="na">bytebuddy</span><span class="o">.</span><span class="na">matcher</span><span class="o">.</span><span class="na">ElementMatchers</span><span class="o">.</span><span class="na">named</span><span class="o">;</span>


<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-07-10 09:04
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ByteBuddyTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--subclass-----------------------"</span><span class="o">);</span>
    <span class="n">saveToFile</span><span class="o">(</span><span class="n">subclass</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="s">"gen.Subclass"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--rebase-----------------------"</span><span class="o">);</span>
    <span class="n">saveToFile</span><span class="o">(</span><span class="n">rebase</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="s">"gen.Rebase"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--redefine-----------------------"</span><span class="o">);</span>
    <span class="n">saveToFile</span><span class="o">(</span><span class="n">redefine</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="s">"gen.Redefine"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveToFile</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="sc">'.'</span><span class="o">);</span>
    <span class="nc">Path</span> <span class="n">dir</span> <span class="o">=</span> <span class="nc">Path</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="sc">'.'</span><span class="o">,</span> <span class="nc">File</span><span class="o">.</span><span class="na">separatorChar</span><span class="o">));</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Files</span><span class="o">.</span><span class="na">createDirectories</span><span class="o">(</span><span class="n">dir</span><span class="o">);</span>
      <span class="nc">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="n">dir</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">name</span><span class="o">.</span><span class="na">length</span><span class="o">())</span> <span class="o">+</span> <span class="s">".class"</span><span class="o">);</span>
      <span class="nc">Files</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">LoggerInterceptor</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">log</span><span class="o">(</span><span class="nd">@SuperCall</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">zuper</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Calling database"</span><span class="o">);</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">zuper</span><span class="o">.</span><span class="na">call</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Returned from database"</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">subclass</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ByteBuddy</span><span class="o">()</span>
      <span class="o">.</span><span class="na">subclass</span><span class="o">(</span><span class="n">clazz</span><span class="o">)</span>
<span class="c1">//      .method(named("getName")).intercept(FixedValue.value("Hello World!"))</span>
      <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">named</span><span class="o">(</span><span class="s">"getInfo"</span><span class="o">)).</span><span class="na">intercept</span><span class="o">(</span><span class="nc">MethodDelegation</span><span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="nc">LoggerInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
      <span class="o">.</span><span class="na">make</span><span class="o">()</span>
      <span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">redefine</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ByteBuddy</span><span class="o">()</span>
      <span class="o">.</span><span class="na">redefine</span><span class="o">(</span><span class="n">clazz</span><span class="o">)</span>
<span class="c1">//      .method(named("getName")).intercept(FixedValue.value("Hello World!"))</span>
      <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">named</span><span class="o">(</span><span class="s">"getInfo"</span><span class="o">)).</span><span class="na">intercept</span><span class="o">(</span><span class="nc">MethodDelegation</span><span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="nc">LoggerInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
      <span class="o">.</span><span class="na">make</span><span class="o">()</span>
      <span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">rebase</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ByteBuddy</span><span class="o">()</span>
      <span class="o">.</span><span class="na">rebase</span><span class="o">(</span><span class="n">clazz</span><span class="o">)</span>
<span class="c1">//      .method(named("getName")).intercept(FixedValue.value("Hello World!"))</span>
      <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">named</span><span class="o">(</span><span class="s">"getInfo"</span><span class="o">)).</span><span class="na">intercept</span><span class="o">(</span><span class="nc">MethodDelegation</span><span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="nc">LoggerInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
      <span class="o">.</span><span class="na">make</span><span class="o">()</span>
      <span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getInfo</span><span class="o">(</span><span class="nc">String</span> <span class="n">info</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s-%d-%s"</span><span class="o">,</span> <span class="n">getName</span><span class="o">(),</span> <span class="n">getAge</span><span class="o">(),</span> <span class="n">info</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>


  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">xray</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"className = "</span> <span class="o">+</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="nc">Field</span><span class="o">[]</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getFields</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"fields: "</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Field</span> <span class="n">field</span> <span class="o">:</span> <span class="n">fields</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">" %s %s%n"</span><span class="o">,</span> <span class="n">field</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">field</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="nc">Method</span><span class="o">[]</span> <span class="n">methods</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"methodName: "</span><span class="o">);</span>
    <span class="nc">Method</span><span class="o">[]</span> <span class="n">baseMethods</span> <span class="o">=</span> <span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getMethods</span><span class="o">();</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">methodNames</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">baseMethods</span><span class="o">)</span>
      <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Method:</span><span class="o">:</span><span class="n">getName</span><span class="o">)</span>
      <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">());</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">Method</span> <span class="n">method</span> <span class="o">:</span> <span class="n">methods</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">methodNames</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
        <span class="k">continue</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
      <span class="nc">String</span> <span class="n">params</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">classes</span><span class="o">)</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Class:</span><span class="o">:</span><span class="n">getName</span><span class="o">)</span>
        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">", "</span><span class="o">));</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"  %s(%s)%n"</span><span class="o">,</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">params</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">First</span> <span class="o">{</span>
    <span class="k">default</span> <span class="nc">String</span> <span class="nf">qux</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"FOO"</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">Second</span> <span class="o">{</span>
    <span class="k">default</span> <span class="nc">String</span> <span class="nf">qux</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"BAR"</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ByteBuddy</span><span class="o">(</span><span class="nc">ClassFileVersion</span><span class="o">.</span><span class="na">JAVA_V11</span><span class="o">)</span>
      <span class="o">.</span><span class="na">subclass</span><span class="o">(</span><span class="nc">Object</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
      <span class="o">.</span><span class="na">implement</span><span class="o">(</span><span class="nc">First</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
      <span class="o">.</span><span class="na">implement</span><span class="o">(</span><span class="nc">Second</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
      <span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">named</span><span class="o">(</span><span class="s">"qux"</span><span class="o">)).</span><span class="na">intercept</span><span class="o">(</span><span class="nc">DefaultMethodCall</span><span class="o">.</span><span class="na">prioritize</span><span class="o">(</span><span class="nc">First</span><span class="o">.</span><span class="na">class</span><span class="o">))</span>
      <span class="o">.</span><span class="na">make</span><span class="o">()</span>
      <span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
    <span class="n">saveToFile</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="s">"gen.NewClass"</span><span class="o">);</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.buf</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 10:26
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyByteBuf</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test01</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 1. 创建对象，对象包含一个 byte[10] 的数组</span>
    <span class="c1">// 2. 在 Netty 的 ByteBuf 中，不需要使用 flip 进行反转</span>
    <span class="c1">//    底层维护了 readIndex 和 writeIndex</span>
    <span class="c1">// 3. 通过 readIndex、 writeIndex 和 capacity，将 buffer 分成三个区域</span>
    <span class="c1">//    3.1 0 -- readIndex 已读</span>
    <span class="c1">//    3.2 readIndex - writeIndex 可读</span>
    <span class="c1">//    3.3 writeIndex - capacity 可写</span>
    <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">buffer</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"capacity="</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
    <span class="c1">// 输出</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">getByte</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffer</span><span class="o">.</span><span class="na">capacity</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test02</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// 创建 ByteBuf</span>
    <span class="nc">ByteBuf</span> <span class="n">byteBuf</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"Hello, D瓜哥！"</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">);</span>

    <span class="c1">// 使用相关方法</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">byteBuf</span><span class="o">.</span><span class="na">hasArray</span><span class="o">())</span> <span class="o">{</span>
      <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">array</span><span class="o">();</span>
      <span class="c1">// 将 content 转成字符串</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>

      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"byteBuf="</span> <span class="o">+</span> <span class="n">byteBuf</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">byteBuf</span><span class="o">.</span><span class="na">arrayOffset</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">byteBuf</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">byteBuf</span><span class="o">.</span><span class="na">writerIndex</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">byteBuf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">byteBuf</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>

      <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span> <span class="c1">// 可读取的字符数</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">len</span><span class="o">);</span>

      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">byteBuf</span><span class="o">.</span><span class="na">getByte</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
      <span class="o">}</span>

      <span class="c1">// 按照范围读取</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">byteBuf</span><span class="o">.</span><span class="na">getCharSequence</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>


<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.chats</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.Channel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringEncoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 11:24
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatClient</span> <span class="o">{</span>
  <span class="c1">// 属性</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">host</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">GroupChatClient</span><span class="o">(</span><span class="nc">String</span> <span class="n">host</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">eventExecutors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">eventExecutors</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"decoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">StringDecoder</span><span class="o">());</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"encoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
            <span class="c1">// 加入自定义的 handler TODO</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupChatClientHandler</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span>
      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----"</span> <span class="o">+</span> <span class="n">channel</span><span class="o">.</span><span class="na">localAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">"------"</span><span class="o">);</span>
      <span class="c1">// 客户端需要输入信息，创建一个扫描器</span>
      <span class="c1">// TODO 还不能输入，调试一下，看看怎么回事？</span>
      <span class="nc">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
      <span class="k">while</span> <span class="o">(</span><span class="n">scanner</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">"\r\n"</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">eventExecutors</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Clients</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">client1</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
      <span class="k">new</span> <span class="nf">GroupChatClient</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">).</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">client2</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
      <span class="k">new</span> <span class="nf">GroupChatClient</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">).</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">client3</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
      <span class="k">new</span> <span class="nf">GroupChatClient</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">).</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.chats</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 11:32
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatClientHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.chats</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringEncoder</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 10:56
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatServer</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">GroupChatServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// 处理客户端请求</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="mi">128</span><span class="o">)</span>
        <span class="o">.</span><span class="na">childOption</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_KEEPALIVE</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="c1">// 获取 pipeline</span>
            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="c1">// 向 pipeline 加入解码器</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"decoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">StringDecoder</span><span class="o">());</span>
            <span class="c1">// 向 pipeline 加入编码器</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"encoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
            <span class="c1">// 加入自己的业务处理 handler TODO</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">GroupChatServerHandler</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Netty 服务器启动"</span><span class="o">);</span>
      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="c1">// 关闭监听</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nf">GroupChatServer</span><span class="o">(</span><span class="mi">11911</span><span class="o">).</span><span class="na">run</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.chats</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.Channel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.group.ChannelGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.group.DefaultChannelGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.concurrent.GlobalEventExecutor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 11:04
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatServerHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="c1">// 定义一个 channel 组，管理所有的 channel</span>
  <span class="c1">// GlobalEventExecutor.INSTANCE 是全局的事件执行器，是一个单例</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ChannelGroup</span> <span class="n">channelGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DefaultChannelGroup</span><span class="o">(</span><span class="nc">GlobalEventExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>

  <span class="cm">/**
   * 表示连接建立，一旦建立，第一个执行
   * &lt;p&gt;
   * 将当前 channel 加入到 channelGroup
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
    <span class="cm">/**
     * 将该客户加入聊天的信息推送给其他在线的客户端
     *
     * 该方法会将 channelGroup 中所有的 channel 遍历，并发送消息。
     *
     * 我们不需要自己遍历。
     */</span>
    <span class="n">channelGroup</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">"[客户端]"</span> <span class="o">+</span> <span class="n">channel</span><span class="o">.</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 加入群聊 at"</span> <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">" \n"</span><span class="o">);</span>
    <span class="n">channelGroup</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>

    <span class="kd">super</span><span class="o">.</span><span class="na">handlerAdded</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 表示 channel 处于活动状态，表示 xx 上线
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 上线了~"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 表示 channel 处于不活动状态，表示 xx 离线
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelInactive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 下线了"</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 断开连接，将 xx客户离开信息推送给当前在线客户
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerRemoved</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
    <span class="n">channelGroup</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">"[客户端]"</span> <span class="o">+</span> <span class="n">channel</span><span class="o">.</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 离开了\n"</span><span class="o">);</span>
    <span class="c1">// 触发这个方法后，不需要手动删除，Netty 会自动删除的</span>
    <span class="c1">//  channelGroup.remove(channel);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"channelGroup size="</span> <span class="o">+</span> <span class="n">channelGroup</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 获取当前 channel</span>
    <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
    <span class="c1">// 这时我们遍历 channelGroup，根据不同的情况，回送不同的消息</span>
    <span class="n">channelGroup</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">ch</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ch</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">"[客户]"</span> <span class="o">+</span> <span class="n">channel</span><span class="o">.</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 发送消息："</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>

      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">ch</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">"[自己]发送了消息："</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">});</span>

  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.dubbo.consumer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.diguage.truman.netty.dubbo.interfaces.HelloService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.diguage.truman.netty.dubbo.netty.NettyClient</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 17:44
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DubboClientBootstrap</span> <span class="o">{</span>
  <span class="c1">// 这里定义协议头</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">providerName</span> <span class="o">=</span> <span class="s">"#Hello#"</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NettyClient</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NettyClient</span><span class="o">();</span>
    <span class="nc">HelloService</span> <span class="n">helloService</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HelloService</span><span class="o">)</span> <span class="n">consumer</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">HelloService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">providerName</span><span class="o">);</span>
    <span class="c1">// 通过代理对象调用服务提供者的方法</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
      <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">helloService</span><span class="o">.</span><span class="na">hello</span><span class="o">(</span><span class="s">"您好啊，Dubbo~~~"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"调用结果 res="</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.dubbo.interfaces</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 16:55
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HelloService</span> <span class="o">{</span>
  <span class="nc">String</span> <span class="nf">hello</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.dubbo.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringEncoder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 17:32
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClient</span> <span class="o">{</span>
  <span class="c1">// 创建线程池</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">());</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">NettyClientHandler</span> <span class="n">client</span><span class="o">;</span>

  <span class="c1">// 使用 代理模式，创建代理对象</span>
  <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getBean</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">serviceService</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">providerName</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">(),</span>
      <span class="k">new</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]{</span><span class="n">serviceService</span><span class="o">},</span> <span class="o">(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">client</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">initClient</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">// 设置要发送给服务器的消息</span>
        <span class="c1">// providerName 协议头，args[0] 就是客户端调用 API hello(msg) 时，传的参数</span>
        <span class="n">client</span><span class="o">.</span><span class="na">setParam</span><span class="o">(</span><span class="n">providerName</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">return</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">client</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
      <span class="o">});</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">initClient</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NettyClientHandler</span><span class="o">();</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
    <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
      <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
      <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">TCP_NODELAY</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
      <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
          <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
          <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringDecoder</span><span class="o">());</span>
          <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
          <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">});</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端建立链接……"</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.dubbo.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.Callable</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 17:18
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClientHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="kd">implements</span> <span class="nc">Callable</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="nc">ChannelHandlerContext</span> <span class="n">context</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">result</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">param</span><span class="o">;</span>

  <span class="cm">/**
   * 与服务器的连接创建后，就会被调用
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">context</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 收到服务器的数据后，调用方法
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">result</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="n">notify</span><span class="o">();</span> <span class="c1">// 唤醒等待的线程</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 被代理对象调用，发送数据给服务器，-&gt; wait -&gt; 等待被唤醒(channel read) -&gt; 返回结果
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="nc">Object</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">context</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">param</span><span class="o">);</span>
    <span class="c1">// 进行 wait</span>
    <span class="n">wait</span><span class="o">();</span> <span class="c1">// 等待 channel read 方法获取的到服务器的结果后，唤醒</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setParam</span><span class="o">(</span><span class="nc">String</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">param</span> <span class="o">=</span> <span class="n">param</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.dubbo.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringEncoder</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 16:59
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServer</span> <span class="o">{</span>
  <span class="cm">/**
   * 完成对 NettyServer 的初始化和启动
   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">startServer</span><span class="o">(</span><span class="nc">String</span> <span class="n">hostname</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="mi">128</span><span class="o">)</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringDecoder</span><span class="o">());</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringEncoder</span><span class="o">());</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">NettyServerHandler</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span>
      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">hostname</span><span class="o">,</span> <span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器启动成功，服务端开始提供服务"</span><span class="o">);</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.dubbo.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.diguage.truman.netty.dubbo.provider.HelloServiceImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 17:03
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServerHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 获取客户端发送的消息，并调用服务</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"msg="</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
    <span class="c1">// 客户端在调用服务器的 API 时，需要定义一个协议</span>
    <span class="c1">// 比如每次发消息时，都必须以某个字符串开头 "#Hello#"</span>
    <span class="nc">String</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s">"#Hello#"</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="n">prefix</span><span class="o">))</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HelloServiceImpl</span><span class="o">().</span><span class="na">hello</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">prefix</span><span class="o">.</span><span class="na">length</span><span class="o">()));</span>
      <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.dubbo.provider</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.diguage.truman.netty.dubbo.netty.NettyServer</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 16:58
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DubboServerBootstrap</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">NettyServer</span><span class="o">.</span><span class="na">startServer</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.dubbo.provider</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.diguage.truman.netty.dubbo.interfaces.HelloService</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 16:55
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServiceImpl</span> <span class="kd">implements</span> <span class="nc">HelloService</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">hello</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"接收到客户端消息="</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"您好，D瓜哥！我接收到了你的消息["</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s">"] 第"</span> <span class="o">+</span> <span class="o">(++</span><span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">)</span> <span class="o">+</span> <span class="s">"次"</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="s">"对不起！没有收到你的消息！"</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.hearts</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.timeout.IdleStateHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 14:25
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span> <span class="c1">// 在 bossGroup 增加一个日志处理器</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="cm">/**
           * 加入一个 Netty 提供的 IdleStateHandler
           *
           * 说明：
           *
           * 1. IdleStateHandler 是 Netty 提供的处理空闲状态的处理器
           * 2. long readerIdleTime 表示多长时间没有读取，就会发送一个心跳检查包，检查是否是连接状态
           * 3. long writerIdleTime 表示多长时间没有写，就会发送一个心跳检查包，检查是否是连接状态
           * 4. long allIdleTime 表示多长时间没有读写，就会发送一个心跳检查包，检查是否是连接状态
           *
           * 当 IdleStateHandler 触发后，就会传递给管道的下一个 handler 去处理
           * 通过调用（触发）下一个 handler 的 userEventTriggered，在该方法中处理 IdleStateEvent(读空闲，写空闲，读写空闲)
           */</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="c1">// 调整参数，显示不同的事件</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">IdleStateHandler</span><span class="o">(</span><span class="mi">13</span><span class="o">,</span> <span class="mi">15</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
            <span class="c1">// 加入一个对空闲检测进一步处理的 handler</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyServerHandler</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span>

      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.hearts</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.timeout.IdleStateEvent</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 14:45
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServerHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">userEventTriggered</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">evt</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">evt</span> <span class="k">instanceof</span> <span class="nc">IdleStateEvent</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">IdleStateEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="o">(</span><span class="nc">IdleStateEvent</span><span class="o">)</span> <span class="n">evt</span><span class="o">;</span>
      <span class="nc">String</span> <span class="n">eventType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">state</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">READER_IDLE:</span>
          <span class="n">eventType</span> <span class="o">=</span> <span class="s">"读空闲"</span><span class="o">;</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">WRITER_IDLE:</span>
          <span class="n">eventType</span> <span class="o">=</span> <span class="s">"写空闲"</span><span class="o">;</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">ALL_IDLE:</span>
          <span class="n">eventType</span> <span class="o">=</span> <span class="s">"读写空闲"</span><span class="o">;</span>
          <span class="k">break</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">" --超时时间--"</span> <span class="o">+</span> <span class="n">eventType</span><span class="o">);</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器做相应处理"</span><span class="o">);</span>
      <span class="c1">//比如：如果发生空闲，我们关闭通道</span>
      <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.iobound</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.ByteToMessageDecoder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:53
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ByteToLongDecoder</span> <span class="kd">extends</span> <span class="nc">ByteToMessageDecoder</span> <span class="o">{</span>
  <span class="cm">/**
   * decode 会根据接收的数据，被调用多次，直到确定没有新的元素被添加到 list 或者 `ByteBuf` 没有更多的可读字节为止。
   * &lt;p&gt;
   * 如果 list out 不为空，就会将 List 的内容传递给下一个 ChannelInboundHandler 处理，该处理器方法也会被调用多次。
   *
   * @param ctx 上下文对象
   * @param in  入站的 ByteBuf
   * @param out List 集合，将解码后的数据传给下一个 handler
   * @throws Exception
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ByteToLongDecoder decode 被调用"</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">readLong</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.iobound</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.ReplayingDecoder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:53
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ByteToLongDecoder2</span> <span class="kd">extends</span> <span class="nc">ReplayingDecoder</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 在 ReplayingDecoder 不需要判断数据是否足够读取，内部会进行处理判断。</span>
    <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">readLong</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.iobound</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.diguage.truman.netty.protobuf.ClientHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:57
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IoClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// 客户端只需要一个事件循环组即可</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 创建客户端启动对象</span>
      <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
      <span class="c1">// 设置相关参数</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span> <span class="c1">// 设置线程组</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 设置客户端通讯通道的实现类</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">IoClientInitializer</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"....客户端 OK ..."</span><span class="o">);</span>

      <span class="c1">// 启动客户端去连接服务器端</span>
      <span class="c1">// 关于 ChannelFuture 还要分析，涉及到 Netty 的异步模型</span>
      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

      <span class="c1">// 给关闭通道进行监听</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.iobound</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 20:05
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IoClientHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"从服务器接受消息， msg="</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"IoClientHandler 发送数据"</span><span class="o">);</span>
    <span class="c1">//  ctx.writeAndFlush(119L); // 发送一个 long</span>
    <span class="c1">// 注意：这个实验数据！！！</span>
    <span class="c1">// 分析</span>
    <span class="c1">// 1. "abcdabcdabcdabcd" 是 16 个字节</span>
    <span class="c1">// 2. 该处理器的前一个 handler 是 LongToByteEncoder</span>
    <span class="c1">// 3. LongToByteEncoder 父类是 MessageToByteEncoder</span>
    <span class="c1">// 4. 父类的 write 调用 acceptOutboundMessage 方法来检查是不是可以接受的数据，</span>
    <span class="c1">//    是则执行子类 encode 的方法，否则直接传递到下一个 handler</span>
    <span class="c1">// 因此，在编写 Enoder 时，要注意传入的数据类型和处理的数据类型一致。否则就跳过由下一个handler处理了。</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"abcdabcdabcdabcd"</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.iobound</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 20:00
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IoClientInitializer</span> <span class="kd">extends</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
    <span class="c1">// 加入一个出站的 handler，对数据进行一个编码</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LongToByteEncoder</span><span class="o">());</span>
    <span class="c1">// 入站解码器</span>
    <span class="c1">// pipeline.addLast(new ByteToLongDecoder());</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteToLongDecoder2</span><span class="o">());</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">IoClientHandler</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.iobound</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:46
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IoServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span> <span class="c1">// 在 bossGroup 增加一个日志处理器</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">IoServerInitializer</span><span class="o">());</span>

      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.iobound</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:55
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IoServerHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"IoServerHandler 被调用"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"从客户的"</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">" 读取long="</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="mi">120L</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.iobound</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:47
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IoServerInitializer</span> <span class="kd">extends</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
    <span class="c1">// 入站的 handler 进行编码</span>
    <span class="c1">// pipeline.addLast(new ByteToLongDecoder());</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteToLongDecoder2</span><span class="o">());</span>
    <span class="c1">// 出站编码器</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">LongToByteEncoder</span><span class="o">());</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">IoServerHandler</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.iobound</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.MessageToByteEncoder</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 20:02
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LongToByteEncoder</span> <span class="kd">extends</span> <span class="nc">MessageToByteEncoder</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Long</span> <span class="n">msg</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"LongToByteEncoder encode 被调用"</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"msg="</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
    <span class="n">out</span><span class="o">.</span><span class="na">writeLong</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.protobuf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 19:41
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
  <span class="cm">/**
   * 当通道就绪就会触发该方法
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"client "</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">);</span>

    <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span>
      <span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
      <span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">119</span><span class="o">)</span>
      <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"D瓜哥"</span><span class="o">)</span>
      <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">student</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 当通道有读取事件时，会触发
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器回复的消息："</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="no">UTF_8</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器的地址："</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.protobuf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.protobuf.ProtobufEncoder</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 19:35
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProtobufClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// 客户端只需要一个事件循环组即可</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 创建客户端启动对象</span>
      <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
      <span class="c1">// 设置相关参数</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span> <span class="c1">// 设置线程组</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 设置客户端通讯通道的实现类</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="c1">// 加入 protobuf handler</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"encoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufEncoder</span><span class="o">());</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClientHandler</span><span class="o">());</span> <span class="c1">// 加入自己的处理器</span>
          <span class="o">}</span>
        <span class="o">});</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"....客户端 OK ..."</span><span class="o">);</span>

      <span class="c1">// 启动客户端去连接服务器端</span>
      <span class="c1">// 关于 ChannelFuture 还要分析，涉及到 Netty 的异步模型</span>
      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

      <span class="c1">// 给关闭通道进行监听</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.protobuf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.protobuf.ProtobufDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 16:02
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProtobufServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span> <span class="c1">// 在 bossGroup 增加一个日志处理器</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"decoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufDecoder</span><span class="o">(</span><span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">()));</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServerHandler</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span>

      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.protobuf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * 说明：
 * 我们自定义一个 Handler 需要继承 netty 规定好的某个 HandlerAdapter
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 18:54
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="cm">/**
   * 读取数据实际（这里我们可以读取客户端发送的消息）
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">student</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端发送的数据 id="</span> <span class="o">+</span> <span class="n">student</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">"，name="</span> <span class="o">+</span> <span class="n">student</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 数据读取完毕
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 将数据写入到缓存，并刷新</span>
    <span class="c1">// 一般讲，我们对这个发送的数据进行编码</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"Hello, D瓜哥~, pong -&gt; O(∩_∩)O哈哈~"</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 处理异常，一般需要关闭通道
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
</pre></td><td class="code"><pre><span class="n">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="o">;</span> <span class="c1">// 版本号</span>

<span class="n">option</span> <span class="n">java_outer_classname</span> <span class="o">=</span> <span class="s">"StudentPOJO"</span><span class="o">;</span> <span class="c1">// 生成的外部类名，同时也是文件名</span>

<span class="c1">// protobuf 使用 message 管理数据</span>
<span class="c1">// 会在 StudentPOJO 外部类生成一个内部类 Student，</span>
<span class="n">message</span> <span class="nc">Student</span> <span class="o">{</span>
    <span class="n">int32</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值</span>
    <span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// 在这个文件所在目录执行如下命令，生成Java类：</span>
<span class="c1">// protoc --java_out=. Student.proto</span>
<span class="c1">// WARNING: 需要给生成的类，加上 package 名。</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742
743
744
745
746
747
748
749
750
751
752
753
754
755
756
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
</pre></td><td class="code"><pre><span class="c1">// Generated by the protocol buffer compiler.  DO NOT EDIT!</span>
<span class="c1">// source: Student.proto</span>
<span class="kn">package</span> <span class="nn">com.diguage.truman.netty.protobuf</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">StudentPOJO</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nf">StudentPOJO</span><span class="o">()</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerAllExtensions</span><span class="o">(</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerAllExtensions</span><span class="o">(</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">registerAllExtensions</span><span class="o">(</span>
      <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span><span class="o">)</span> <span class="n">registry</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StudentOrBuilder</span> <span class="kd">extends</span>
    <span class="c1">// @@protoc_insertion_point(interface_extends:Student)</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">MessageOrBuilder</span> <span class="o">{</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值
     * &lt;/pre&gt;
     *
     * &lt;code&gt;int32 id = 1;&lt;/code&gt;
     *
     * @return The id.
     */</span>
    <span class="kt">int</span> <span class="nf">getId</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 2;&lt;/code&gt;
     *
     * @return The name.
     */</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 2;&lt;/code&gt;
     *
     * @return The bytes for name.
     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
    <span class="nf">getNameBytes</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="cm">/**
   * &lt;pre&gt;
   * protobuf 使用 message 管理数据
   * 会在 StudentPOJO 外部类生成一个内部类 Student，
   * &lt;/pre&gt;
   * &lt;p&gt;
   * Protobuf type {@code Student}
   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="kd">extends</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span> <span class="kd">implements</span>
    <span class="c1">// @@protoc_insertion_point(message_implements:Student)</span>
    <span class="nc">StudentOrBuilder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>

    <span class="c1">// Use Student.newBuilder() to construct.</span>
    <span class="kd">private</span> <span class="nf">Student</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">Student</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">name_</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">"unused"</span><span class="o">})</span>
    <span class="kd">protected</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="nf">newInstance</span><span class="o">(</span>
      <span class="nc">UnusedPrivateParameter</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">Student</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span>
    <span class="nf">getUnknownFields</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">Student</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">extensionRegistry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NullPointerException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">unknownFields</span> <span class="o">=</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readTag</span><span class="o">();</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
              <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="mi">8</span><span class="o">:</span> <span class="o">{</span>

              <span class="n">id_</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readInt32</span><span class="o">();</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="mi">18</span><span class="o">:</span> <span class="o">{</span>
              <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readStringRequireUtf8</span><span class="o">();</span>

              <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">default</span><span class="o">:</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">parseUnknownField</span><span class="o">(</span>
                <span class="n">input</span><span class="o">,</span> <span class="n">unknownFields</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">,</span> <span class="n">tag</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="o">}</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span><span class="o">(</span>
          <span class="n">e</span><span class="o">).</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span> <span class="o">=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">makeExtensionsImmutable</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
    <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">internal_static_Student_fieldAccessorTable</span>
        <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
          <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">ID_FIELD_NUMBER</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id_</span><span class="o">;</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值
     * &lt;/pre&gt;
     *
     * &lt;code&gt;int32 id = 1;&lt;/code&gt;
     *
     * @return The id.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">id_</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">NAME_FIELD_NUMBER</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span><span class="o">;</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 2;&lt;/code&gt;
     *
     * @return The name.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span>
          <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 2;&lt;/code&gt;
     *
     * @return The bytes for name.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
    <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
            <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">byte</span> <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">byte</span> <span class="n">isInitialized</span> <span class="o">=</span> <span class="n">memoizedIsInitialized</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

      <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeTo</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span> <span class="n">output</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">id_</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeInt32</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">id_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">unknownFields</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSerializedSize</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">memoizedSize</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span>

      <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">id_</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeInt32Size</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">id_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">computeStringSize</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">size</span> <span class="o">+=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">getSerializedSize</span><span class="o">();</span>
      <span class="n">memoizedSize</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">getId</span><span class="o">()</span>
        <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getName</span><span class="o">()</span>
        <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">unknownFields</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">memoizedHashCode</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">memoizedHashCode</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">41</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">19</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getDescriptor</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="no">ID_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getId</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="no">NAME_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getName</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">29</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">memoizedHashCode</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">newBuilderForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">newBuilder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Builder</span> <span class="nf">newBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Builder</span> <span class="nf">newBuilder</span><span class="o">(</span><span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">prototype</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">prototype</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">toBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="no">DEFAULT_INSTANCE</span>
        <span class="o">?</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">protected</span> <span class="nc">Builder</span> <span class="nf">newBuilderForType</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * protobuf 使用 message 管理数据
     * 会在 StudentPOJO 外部类生成一个内部类 Student，
     * &lt;/pre&gt;
     * &lt;p&gt;
     * Protobuf type {@code Student}
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="kd">extends</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Builder</span><span class="o">&gt;</span> <span class="kd">implements</span>
      <span class="c1">// @@protoc_insertion_point(builder_implements:Student)</span>
      <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">StudentOrBuilder</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
      <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
      <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">internal_static_Student_fieldAccessorTable</span>
          <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
            <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Construct using StudentPOJO.Student.newBuilder()</span>
      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">maybeForceBuilderInitialization</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">alwaysUseFieldBuilders</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
      <span class="nf">getDescriptorForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">result</span> <span class="o">=</span> <span class="n">buildPartial</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">result</span><span class="o">.</span><span class="na">isInitialized</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="nf">newUninitializedMessageException</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">buildPartial</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">id_</span> <span class="o">=</span> <span class="n">id_</span><span class="o">;</span>
        <span class="n">result</span><span class="o">.</span><span class="na">name_</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="n">onBuilt</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearField</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearOneof</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">OneofDescriptor</span> <span class="n">oneof</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearOneof</span><span class="o">(</span><span class="n">oneof</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setRepeatedField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">addRepeatedField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">addRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Message</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="nf">mergeFrom</span><span class="o">((</span><span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">other</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">other</span><span class="o">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="o">==</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setId</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="na">name_</span><span class="o">;</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">);</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">parsedMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parsePartialFrom</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">e</span><span class="o">.</span><span class="na">getUnfinishedMessage</span><span class="o">();</span>
          <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">unwrapIOException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">parsedMessage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mergeFrom</span><span class="o">(</span><span class="n">parsedMessage</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">int</span> <span class="n">id_</span><span class="o">;</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值
       * &lt;/pre&gt;
       *
       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
       *
       * @return The id.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id_</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值
       * &lt;/pre&gt;
       *
       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
       *
       * @param value The id to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">id_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值
       * &lt;/pre&gt;
       *
       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
       *
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearId</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">id_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 2;&lt;/code&gt;
       *
       * @return The name.
       */</span>
      <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span>
            <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 2;&lt;/code&gt;
       *
       * @return The bytes for name.
       */</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
      <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="nc">String</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span>
            <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
              <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 2;&lt;/code&gt;
       *
       * @param value The name to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setName</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 2;&lt;/code&gt;
       *
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearName</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="n">getDefaultInstance</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 2;&lt;/code&gt;
       *
       * @param value The bytes for name to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setNameBytes</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">checkByteStringIsUtf8</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Builder</span> <span class="nf">setUnknownFields</span><span class="o">(</span>
        <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Builder</span> <span class="nf">mergeUnknownFields</span><span class="o">(</span>
        <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>


      <span class="c1">// @@protoc_insertion_point(builder_scope:Student)</span>
    <span class="o">}</span>

    <span class="c1">// @@protoc_insertion_point(class_scope:Student)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
      <span class="no">DEFAULT_INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstance</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span>
      <span class="no">PARSER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">AbstractParser</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Student</span> <span class="nf">parsePartialFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Student</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">parser</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">getParserForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="nc">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="n">internal_static_Student_descriptor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span>
  <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
    <span class="n">internal_static_Student_fieldAccessorTable</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
  <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">descriptor</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
    <span class="n">descriptor</span><span class="o">;</span>

  <span class="kd">static</span> <span class="o">{</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]</span> <span class="n">descriptorData</span> <span class="o">=</span> <span class="o">{</span>
      <span class="s">"\n\rStudent.proto\"#\n\007Student\022\n\n\002id\030\001 \001(\005\022\014"</span> <span class="o">+</span>
        <span class="s">"\n\004name\030\002 \001(\tB\rB\013StudentPOJOb\006proto3"</span>
    <span class="o">};</span>
    <span class="n">descriptor</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
      <span class="o">.</span><span class="na">internalBuildGeneratedFileFrom</span><span class="o">(</span><span class="n">descriptorData</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span><span class="o">[]{</span>
        <span class="o">});</span>
    <span class="n">internal_static_Student_descriptor</span> <span class="o">=</span>
      <span class="n">getDescriptor</span><span class="o">().</span><span class="na">getMessageTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">internal_static_Student_fieldAccessorTable</span> <span class="o">=</span> <span class="k">new</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span><span class="o">(</span>
      <span class="n">internal_static_Student_descriptor</span><span class="o">,</span>
      <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]{</span><span class="s">"Id"</span><span class="o">,</span> <span class="s">"Name"</span><span class="o">,});</span>
  <span class="o">}</span>

  <span class="c1">// @@protoc_insertion_point(outer_class_scope)</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.protobuf2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 19:41
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientHandler</span> <span class="kd">extends</span> <span class="nc">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
  <span class="cm">/**
   * 当通道就绪就会触发该方法
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"client "</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">);</span>

    <span class="c1">// 随机发送 Student 或 Worker</span>
    <span class="kt">int</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
    <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">random</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 发送学生</span>
      <span class="n">message</span> <span class="o">=</span> <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setDataType</span><span class="o">(</span><span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span><span class="o">.</span><span class="na">StudentType</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setStudent</span><span class="o">(</span>
          <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">Student</span>
            <span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">119</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"瓜哥"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// 发送 worker</span>
      <span class="n">message</span> <span class="o">=</span> <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">setDataType</span><span class="o">(</span><span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span><span class="o">.</span><span class="na">WorkerType</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setWorker</span><span class="o">(</span>
          <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span>
            <span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"瓜哥"</span><span class="o">)</span>
            <span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">119</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">())</span>
        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 当通道有读取事件时，会触发
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="nc">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器回复的消息："</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="no">UTF_8</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器的地址："</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno">   1
   2
   3
   4
   5
   6
   7
   8
   9
  10
  11
  12
  13
  14
  15
  16
  17
  18
  19
  20
  21
  22
  23
  24
  25
  26
  27
  28
  29
  30
  31
  32
  33
  34
  35
  36
  37
  38
  39
  40
  41
  42
  43
  44
  45
  46
  47
  48
  49
  50
  51
  52
  53
  54
  55
  56
  57
  58
  59
  60
  61
  62
  63
  64
  65
  66
  67
  68
  69
  70
  71
  72
  73
  74
  75
  76
  77
  78
  79
  80
  81
  82
  83
  84
  85
  86
  87
  88
  89
  90
  91
  92
  93
  94
  95
  96
  97
  98
  99
 100
 101
 102
 103
 104
 105
 106
 107
 108
 109
 110
 111
 112
 113
 114
 115
 116
 117
 118
 119
 120
 121
 122
 123
 124
 125
 126
 127
 128
 129
 130
 131
 132
 133
 134
 135
 136
 137
 138
 139
 140
 141
 142
 143
 144
 145
 146
 147
 148
 149
 150
 151
 152
 153
 154
 155
 156
 157
 158
 159
 160
 161
 162
 163
 164
 165
 166
 167
 168
 169
 170
 171
 172
 173
 174
 175
 176
 177
 178
 179
 180
 181
 182
 183
 184
 185
 186
 187
 188
 189
 190
 191
 192
 193
 194
 195
 196
 197
 198
 199
 200
 201
 202
 203
 204
 205
 206
 207
 208
 209
 210
 211
 212
 213
 214
 215
 216
 217
 218
 219
 220
 221
 222
 223
 224
 225
 226
 227
 228
 229
 230
 231
 232
 233
 234
 235
 236
 237
 238
 239
 240
 241
 242
 243
 244
 245
 246
 247
 248
 249
 250
 251
 252
 253
 254
 255
 256
 257
 258
 259
 260
 261
 262
 263
 264
 265
 266
 267
 268
 269
 270
 271
 272
 273
 274
 275
 276
 277
 278
 279
 280
 281
 282
 283
 284
 285
 286
 287
 288
 289
 290
 291
 292
 293
 294
 295
 296
 297
 298
 299
 300
 301
 302
 303
 304
 305
 306
 307
 308
 309
 310
 311
 312
 313
 314
 315
 316
 317
 318
 319
 320
 321
 322
 323
 324
 325
 326
 327
 328
 329
 330
 331
 332
 333
 334
 335
 336
 337
 338
 339
 340
 341
 342
 343
 344
 345
 346
 347
 348
 349
 350
 351
 352
 353
 354
 355
 356
 357
 358
 359
 360
 361
 362
 363
 364
 365
 366
 367
 368
 369
 370
 371
 372
 373
 374
 375
 376
 377
 378
 379
 380
 381
 382
 383
 384
 385
 386
 387
 388
 389
 390
 391
 392
 393
 394
 395
 396
 397
 398
 399
 400
 401
 402
 403
 404
 405
 406
 407
 408
 409
 410
 411
 412
 413
 414
 415
 416
 417
 418
 419
 420
 421
 422
 423
 424
 425
 426
 427
 428
 429
 430
 431
 432
 433
 434
 435
 436
 437
 438
 439
 440
 441
 442
 443
 444
 445
 446
 447
 448
 449
 450
 451
 452
 453
 454
 455
 456
 457
 458
 459
 460
 461
 462
 463
 464
 465
 466
 467
 468
 469
 470
 471
 472
 473
 474
 475
 476
 477
 478
 479
 480
 481
 482
 483
 484
 485
 486
 487
 488
 489
 490
 491
 492
 493
 494
 495
 496
 497
 498
 499
 500
 501
 502
 503
 504
 505
 506
 507
 508
 509
 510
 511
 512
 513
 514
 515
 516
 517
 518
 519
 520
 521
 522
 523
 524
 525
 526
 527
 528
 529
 530
 531
 532
 533
 534
 535
 536
 537
 538
 539
 540
 541
 542
 543
 544
 545
 546
 547
 548
 549
 550
 551
 552
 553
 554
 555
 556
 557
 558
 559
 560
 561
 562
 563
 564
 565
 566
 567
 568
 569
 570
 571
 572
 573
 574
 575
 576
 577
 578
 579
 580
 581
 582
 583
 584
 585
 586
 587
 588
 589
 590
 591
 592
 593
 594
 595
 596
 597
 598
 599
 600
 601
 602
 603
 604
 605
 606
 607
 608
 609
 610
 611
 612
 613
 614
 615
 616
 617
 618
 619
 620
 621
 622
 623
 624
 625
 626
 627
 628
 629
 630
 631
 632
 633
 634
 635
 636
 637
 638
 639
 640
 641
 642
 643
 644
 645
 646
 647
 648
 649
 650
 651
 652
 653
 654
 655
 656
 657
 658
 659
 660
 661
 662
 663
 664
 665
 666
 667
 668
 669
 670
 671
 672
 673
 674
 675
 676
 677
 678
 679
 680
 681
 682
 683
 684
 685
 686
 687
 688
 689
 690
 691
 692
 693
 694
 695
 696
 697
 698
 699
 700
 701
 702
 703
 704
 705
 706
 707
 708
 709
 710
 711
 712
 713
 714
 715
 716
 717
 718
 719
 720
 721
 722
 723
 724
 725
 726
 727
 728
 729
 730
 731
 732
 733
 734
 735
 736
 737
 738
 739
 740
 741
 742
 743
 744
 745
 746
 747
 748
 749
 750
 751
 752
 753
 754
 755
 756
 757
 758
 759
 760
 761
 762
 763
 764
 765
 766
 767
 768
 769
 770
 771
 772
 773
 774
 775
 776
 777
 778
 779
 780
 781
 782
 783
 784
 785
 786
 787
 788
 789
 790
 791
 792
 793
 794
 795
 796
 797
 798
 799
 800
 801
 802
 803
 804
 805
 806
 807
 808
 809
 810
 811
 812
 813
 814
 815
 816
 817
 818
 819
 820
 821
 822
 823
 824
 825
 826
 827
 828
 829
 830
 831
 832
 833
 834
 835
 836
 837
 838
 839
 840
 841
 842
 843
 844
 845
 846
 847
 848
 849
 850
 851
 852
 853
 854
 855
 856
 857
 858
 859
 860
 861
 862
 863
 864
 865
 866
 867
 868
 869
 870
 871
 872
 873
 874
 875
 876
 877
 878
 879
 880
 881
 882
 883
 884
 885
 886
 887
 888
 889
 890
 891
 892
 893
 894
 895
 896
 897
 898
 899
 900
 901
 902
 903
 904
 905
 906
 907
 908
 909
 910
 911
 912
 913
 914
 915
 916
 917
 918
 919
 920
 921
 922
 923
 924
 925
 926
 927
 928
 929
 930
 931
 932
 933
 934
 935
 936
 937
 938
 939
 940
 941
 942
 943
 944
 945
 946
 947
 948
 949
 950
 951
 952
 953
 954
 955
 956
 957
 958
 959
 960
 961
 962
 963
 964
 965
 966
 967
 968
 969
 970
 971
 972
 973
 974
 975
 976
 977
 978
 979
 980
 981
 982
 983
 984
 985
 986
 987
 988
 989
 990
 991
 992
 993
 994
 995
 996
 997
 998
 999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036
1037
1038
1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049
1050
1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104
1105
1106
1107
1108
1109
1110
1111
1112
1113
1114
1115
1116
1117
1118
1119
1120
1121
1122
1123
1124
1125
1126
1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143
1144
1145
1146
1147
1148
1149
1150
1151
1152
1153
1154
1155
1156
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167
1168
1169
1170
1171
1172
1173
1174
1175
1176
1177
1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188
1189
1190
1191
1192
1193
1194
1195
1196
1197
1198
1199
1200
1201
1202
1203
1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214
1215
1216
1217
1218
1219
1220
1221
1222
1223
1224
1225
1226
1227
1228
1229
1230
1231
1232
1233
1234
1235
1236
1237
1238
1239
1240
1241
1242
1243
1244
1245
1246
1247
1248
1249
1250
1251
1252
1253
1254
1255
1256
1257
1258
1259
1260
1261
1262
1263
1264
1265
1266
1267
1268
1269
1270
1271
1272
1273
1274
1275
1276
1277
1278
1279
1280
1281
1282
1283
1284
1285
1286
1287
1288
1289
1290
1291
1292
1293
1294
1295
1296
1297
1298
1299
1300
1301
1302
1303
1304
1305
1306
1307
1308
1309
1310
1311
1312
1313
1314
1315
1316
1317
1318
1319
1320
1321
1322
1323
1324
1325
1326
1327
1328
1329
1330
1331
1332
1333
1334
1335
1336
1337
1338
1339
1340
1341
1342
1343
1344
1345
1346
1347
1348
1349
1350
1351
1352
1353
1354
1355
1356
1357
1358
1359
1360
1361
1362
1363
1364
1365
1366
1367
1368
1369
1370
1371
1372
1373
1374
1375
1376
1377
1378
1379
1380
1381
1382
1383
1384
1385
1386
1387
1388
1389
1390
1391
1392
1393
1394
1395
1396
1397
1398
1399
1400
1401
1402
1403
1404
1405
1406
1407
1408
1409
1410
1411
1412
1413
1414
1415
1416
1417
1418
1419
1420
1421
1422
1423
1424
1425
1426
1427
1428
1429
1430
1431
1432
1433
1434
1435
1436
1437
1438
1439
1440
1441
1442
1443
1444
1445
1446
1447
1448
1449
1450
1451
1452
1453
1454
1455
1456
1457
1458
1459
1460
1461
1462
1463
1464
1465
1466
1467
1468
1469
1470
1471
1472
1473
1474
1475
1476
1477
1478
1479
1480
1481
1482
1483
1484
1485
1486
1487
1488
1489
1490
1491
1492
1493
1494
1495
1496
1497
1498
1499
1500
1501
1502
1503
1504
1505
1506
1507
1508
1509
1510
1511
1512
1513
1514
1515
1516
1517
1518
1519
1520
1521
1522
1523
1524
1525
1526
1527
1528
1529
1530
1531
1532
1533
1534
1535
1536
1537
1538
1539
1540
1541
1542
1543
1544
1545
1546
1547
1548
1549
1550
1551
1552
1553
1554
1555
1556
1557
1558
1559
1560
1561
1562
1563
1564
1565
1566
1567
1568
1569
1570
1571
1572
1573
1574
1575
1576
1577
1578
1579
1580
1581
1582
1583
1584
1585
1586
1587
1588
1589
1590
1591
1592
1593
1594
1595
1596
1597
1598
1599
1600
1601
1602
1603
1604
1605
1606
1607
1608
1609
1610
1611
1612
1613
1614
1615
1616
1617
1618
1619
1620
1621
1622
1623
1624
1625
1626
1627
1628
1629
1630
1631
1632
1633
1634
1635
1636
1637
1638
1639
1640
1641
1642
1643
1644
1645
1646
1647
1648
1649
1650
1651
1652
1653
1654
1655
1656
1657
1658
1659
1660
1661
1662
1663
1664
1665
1666
1667
1668
1669
1670
1671
1672
1673
1674
1675
1676
1677
1678
1679
1680
1681
1682
1683
1684
1685
1686
1687
1688
1689
1690
1691
1692
1693
1694
1695
1696
1697
1698
1699
1700
1701
1702
1703
1704
1705
1706
1707
1708
1709
1710
1711
1712
1713
1714
1715
1716
1717
1718
1719
1720
1721
1722
1723
1724
1725
1726
1727
1728
1729
1730
1731
1732
1733
1734
1735
1736
1737
1738
1739
1740
1741
1742
1743
1744
1745
1746
1747
1748
1749
1750
1751
1752
1753
1754
1755
1756
1757
1758
1759
1760
1761
1762
1763
1764
1765
1766
1767
1768
1769
1770
1771
1772
1773
1774
1775
1776
1777
1778
1779
1780
1781
1782
1783
1784
1785
1786
1787
1788
1789
1790
1791
1792
1793
1794
1795
1796
1797
1798
1799
1800
1801
1802
1803
1804
1805
1806
1807
1808
1809
1810
1811
1812
1813
1814
1815
1816
1817
1818
1819
1820
1821
1822
1823
1824
1825
1826
1827
1828
1829
1830
1831
1832
1833
1834
1835
1836
1837
1838
1839
1840
1841
1842
1843
1844
1845
1846
1847
1848
1849
1850
1851
1852
1853
1854
1855
1856
1857
1858
1859
1860
1861
1862
1863
1864
1865
1866
1867
1868
1869
1870
1871
1872
1873
1874
1875
1876
1877
1878
1879
1880
1881
1882
1883
1884
1885
1886
1887
1888
1889
1890
1891
1892
1893
1894
1895
1896
1897
1898
1899
1900
1901
1902
1903
1904
1905
1906
1907
1908
1909
1910
1911
1912
1913
1914
1915
1916
1917
1918
1919
1920
1921
1922
1923
1924
1925
1926
1927
1928
1929
1930
1931
1932
1933
1934
1935
1936
1937
1938
1939
1940
1941
1942
1943
1944
1945
1946
1947
1948
1949
1950
1951
1952
1953
1954
1955
1956
1957
1958
1959
1960
1961
1962
1963
1964
1965
1966
1967
1968
1969
1970
1971
1972
1973
1974
1975
1976
1977
1978
1979
1980
1981
1982
1983
1984
1985
1986
1987
1988
1989
1990
1991
1992
1993
1994
1995
1996
1997
1998
1999
2000
2001
2002
2003
2004
2005
2006
2007
2008
2009
2010
2011
2012
2013
2014
2015
2016
2017
2018
2019
2020
2021
2022
2023
2024
2025
2026
2027
2028
2029
2030
2031
2032
2033
2034
2035
2036
2037
2038
2039
2040
2041
2042
2043
2044
2045
2046
2047
2048
2049
2050
2051
2052
2053
2054
2055
2056
2057
2058
2059
2060
2061
2062
2063
2064
2065
2066
2067
2068
2069
2070
2071
2072
2073
2074
2075
2076
2077
2078
2079
2080
2081
2082
2083
2084
2085
2086
2087
2088
2089
2090
2091
2092
2093
2094
2095
2096
2097
2098
2099
2100
2101
2102
2103
2104
2105
2106
2107
2108
2109
2110
2111
2112
2113
2114
2115
2116
2117
2118
2119
2120
2121
2122
2123
2124
2125
2126
2127
2128
2129
2130
2131
2132
2133
2134
2135
2136
2137
2138
2139
2140
2141
2142
2143
2144
2145
2146
2147
2148
2149
2150
2151
2152
2153
2154
2155
2156
2157
2158
2159
2160
2161
2162
2163
2164
2165
2166
2167
2168
2169
2170
2171
2172
2173
2174
2175
2176
2177
2178
2179
2180
2181
2182
2183
2184
2185
2186
2187
2188
2189
2190
2191
2192
2193
2194
2195
2196
2197
2198
2199
2200
2201
2202
2203
2204
2205
2206
2207
2208
2209
2210
2211
2212
2213
2214
2215
2216
2217
2218
2219
2220
2221
2222
2223
2224
2225
2226
2227
2228
2229
2230
2231
2232
2233
2234
2235
2236
2237
2238
2239
2240
2241
2242
2243
2244
2245
2246
2247
2248
2249
2250
2251
2252
2253
2254
2255
2256
2257
2258
2259
2260
2261
2262
2263
2264
2265
2266
2267
2268
2269
2270
2271
2272
2273
2274
2275
2276
2277
2278
2279
2280
2281
2282
2283
2284
2285
2286
2287
2288
2289
2290
2291
2292
2293
2294
2295
2296
2297
2298
2299
2300
2301
2302
2303
2304
2305
2306
2307
2308
2309
2310
2311
2312
2313
2314
2315
2316
2317
2318
2319
2320
2321
2322
2323
2324
2325
2326
2327
2328
2329
2330
2331
2332
2333
2334
2335
2336
2337
2338
2339
2340
2341
2342
2343
2344
2345
2346
2347
2348
2349
2350
2351
2352
2353
2354
2355
2356
2357
2358
2359
2360
2361
2362
2363
2364
2365
2366
2367
2368
2369
2370
2371
2372
2373
2374
2375
2376
2377
2378
2379
2380
2381
2382
2383
2384
2385
2386
2387
2388
2389
2390
2391
2392
2393
2394
2395
2396
2397
2398
2399
2400
2401
2402
2403
2404
2405
2406
2407
2408
2409
2410
2411
2412
2413
2414
2415
2416
2417
2418
2419
2420
2421
2422
2423
2424
2425
2426
2427
2428
2429
2430
2431
2432
2433
2434
2435
2436
2437
2438
2439
2440
2441
2442
2443
2444
2445
2446
2447
2448
2449
2450
2451
2452
2453
2454
2455
2456
2457
2458
2459
2460
2461
2462
2463
2464
2465
2466
2467
2468
2469
2470
2471
2472
2473
2474
2475
2476
2477
2478
2479
2480
2481
2482
2483
2484
2485
2486
2487
2488
2489
2490
2491
2492
2493
2494
2495
2496
2497
2498
2499
2500
2501
2502
2503
2504
2505
2506
2507
2508
2509
2510
2511
2512
2513
2514
2515
2516
2517
2518
2519
2520
2521
2522
2523
2524
2525
2526
2527
2528
2529
2530
2531
2532
2533
2534
2535
2536
2537
2538
2539
2540
2541
2542
2543
2544
2545
2546
2547
2548
2549
2550
2551
2552
2553
2554
2555
2556
2557
2558
2559
2560
2561
2562
2563
2564
2565
2566
2567
2568
2569
2570
2571
2572
2573
2574
2575
2576
2577
2578
2579
2580
2581
2582
2583
2584
2585
2586
2587
2588
2589
2590
2591
2592
2593
2594
2595
2596
2597
2598
2599
2600
2601
2602
2603
2604
2605
2606
2607
2608
2609
2610
2611
2612
2613
2614
2615
2616
2617
2618
2619
2620
2621
2622
2623
2624
2625
2626
2627
2628
2629
2630
2631
2632
2633
2634
2635
2636
2637
2638
2639
2640
2641
2642
2643
2644
2645
2646
2647
2648
2649
2650
2651
2652
2653
2654
2655
2656
2657
2658
2659
2660
2661
2662
2663
2664
2665
2666
2667
2668
2669
2670
2671
2672
2673
2674
2675
2676
2677
2678
2679
2680
2681
2682
2683
2684
2685
2686
2687
2688
2689
2690
2691
2692
2693
2694
2695
2696
2697
2698
2699
2700
2701
2702
2703
2704
2705
2706
2707
2708
2709
2710
2711
2712
2713
2714
2715
2716
2717
2718
2719
2720
2721
2722
2723
2724
2725
2726
2727
2728
2729
2730
2731
2732
2733
2734
2735
2736
2737
2738
2739
2740
2741
2742
2743
2744
2745
2746
2747
2748
2749
2750
2751
2752
2753
2754
2755
2756
2757
2758
2759
2760
2761
2762
2763
2764
2765
2766
2767
2768
2769
2770
2771
2772
2773
2774
2775
2776
2777
2778
2779
2780
2781
2782
2783
2784
2785
2786
2787
2788
2789
2790
2791
2792
2793
2794
2795
2796
2797
2798
2799
2800
2801
2802
2803
2804
2805
2806
2807
2808
2809
2810
2811
2812
2813
2814
2815
2816
2817
2818
2819
2820
2821
2822
2823
2824
2825
</pre></td><td class="code"><pre><span class="c1">// Generated by the protocol buffer compiler.  DO NOT EDIT!</span>
<span class="c1">// source: Student.proto</span>

<span class="kn">package</span> <span class="nn">com.diguage.truman.netty.protobuf2</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MyDataInfo</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nf">MyDataInfo</span><span class="o">()</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerAllExtensions</span><span class="o">(</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerAllExtensions</span><span class="o">(</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">registerAllExtensions</span><span class="o">(</span>
      <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span><span class="o">)</span> <span class="n">registry</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyMessageOrBuilder</span> <span class="kd">extends</span>
    <span class="c1">// @@protoc_insertion_point(interface_extends:MyMessage)</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">MessageOrBuilder</span> <span class="o">{</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * 用 data_type 来标识传的是哪一个枚举类型？
     * &lt;/pre&gt;
     *
     * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;
     *
     * @return The enum numeric value on the wire for dataType.
     */</span>
    <span class="kt">int</span> <span class="nf">getDataTypeValue</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * 用 data_type 来标识传的是哪一个枚举类型？
     * &lt;/pre&gt;
     *
     * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;
     *
     * @return The dataType.
     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span> <span class="nf">getDataType</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
     *
     * @return Whether the student field is set.
     */</span>
    <span class="kt">boolean</span> <span class="nf">hasStudent</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
     *
     * @return The student.
     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getStudent</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span> <span class="nf">getStudentOrBuilder</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
     *
     * @return Whether the worker field is set.
     */</span>
    <span class="kt">boolean</span> <span class="nf">hasWorker</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
     *
     * @return The worker.
     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getWorker</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span> <span class="nf">getWorkerOrBuilder</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataBodyCase</span> <span class="nf">getDataBodyCase</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Protobuf type {@code MyMessage}
   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MyMessage</span> <span class="kd">extends</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span> <span class="kd">implements</span>
    <span class="c1">// @@protoc_insertion_point(message_implements:MyMessage)</span>
    <span class="nc">MyMessageOrBuilder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>

    <span class="c1">// Use MyMessage.newBuilder() to construct.</span>
    <span class="kd">private</span> <span class="nf">MyMessage</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">MyMessage</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">dataType_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">"unused"</span><span class="o">})</span>
    <span class="kd">protected</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="nf">newInstance</span><span class="o">(</span>
      <span class="nc">UnusedPrivateParameter</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">MyMessage</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span>
    <span class="nf">getUnknownFields</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">MyMessage</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">extensionRegistry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NullPointerException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">unknownFields</span> <span class="o">=</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readTag</span><span class="o">();</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
              <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="mi">8</span><span class="o">:</span> <span class="o">{</span>
              <span class="kt">int</span> <span class="n">rawValue</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readEnum</span><span class="o">();</span>

              <span class="n">dataType_</span> <span class="o">=</span> <span class="n">rawValue</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="mi">18</span><span class="o">:</span> <span class="o">{</span>
              <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span> <span class="n">subBuilder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">subBuilder</span> <span class="o">=</span> <span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">).</span><span class="na">toBuilder</span><span class="o">();</span>
              <span class="o">}</span>
              <span class="n">dataBody_</span> <span class="o">=</span>
                <span class="n">input</span><span class="o">.</span><span class="na">readMessage</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">parser</span><span class="o">(),</span> <span class="n">extensionRegistry</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">subBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">subBuilder</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
                <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">subBuilder</span><span class="o">.</span><span class="na">buildPartial</span><span class="o">();</span>
              <span class="o">}</span>
              <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="mi">26</span><span class="o">:</span> <span class="o">{</span>
              <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span> <span class="n">subBuilder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">subBuilder</span> <span class="o">=</span> <span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">).</span><span class="na">toBuilder</span><span class="o">();</span>
              <span class="o">}</span>
              <span class="n">dataBody_</span> <span class="o">=</span>
                <span class="n">input</span><span class="o">.</span><span class="na">readMessage</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">parser</span><span class="o">(),</span> <span class="n">extensionRegistry</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">subBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">subBuilder</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
                <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">subBuilder</span><span class="o">.</span><span class="na">buildPartial</span><span class="o">();</span>
              <span class="o">}</span>
              <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">default</span><span class="o">:</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">parseUnknownField</span><span class="o">(</span>
                <span class="n">input</span><span class="o">,</span> <span class="n">unknownFields</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">,</span> <span class="n">tag</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="o">}</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span><span class="o">(</span>
          <span class="n">e</span><span class="o">).</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span> <span class="o">=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">makeExtensionsImmutable</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_MyMessage_descriptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
    <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_MyMessage_fieldAccessorTable</span>
        <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * 定义一个枚举
     * &lt;/pre&gt;
     * &lt;p&gt;
     * Protobuf enum {@code MyMessage.DataType}
     */</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="nc">DataType</span>
      <span class="kd">implements</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ProtocolMessageEnum</span> <span class="o">{</span>
      <span class="cm">/**
       * &lt;pre&gt;
       * 在 proto3 中，要求 enum 的编号从 0 开始
       * &lt;/pre&gt;
       *
       * &lt;code&gt;StudentType = 0;&lt;/code&gt;
       */</span>
      <span class="nc">StudentType</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span>
      <span class="cm">/**
       * &lt;code&gt;WorkerType = 1;&lt;/code&gt;
       */</span>
      <span class="nc">WorkerType</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
      <span class="no">UNRECOGNIZED</span><span class="o">(-</span><span class="mi">1</span><span class="o">),</span>
      <span class="o">;</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 在 proto3 中，要求 enum 的编号从 0 开始
       * &lt;/pre&gt;
       *
       * &lt;code&gt;StudentType = 0;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">StudentType_VALUE</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="cm">/**
       * &lt;code&gt;WorkerType = 1;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WorkerType_VALUE</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>


      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getNumber</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="no">UNRECOGNIZED</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalArgumentException</span><span class="o">(</span>
            <span class="s">"Can't get the number of an unknown enum value."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * @param value The numeric wire value of the corresponding enum entry.
       * @return The enum associated with the given numeric wire value.
       * @deprecated Use {@link #forNumber(int)} instead.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Deprecated</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="nc">DataType</span> <span class="nf">valueOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">forNumber</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="cm">/**
       * @param value The numeric wire value of the corresponding enum entry.
       * @return The enum associated with the given numeric wire value.
       */</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="nc">DataType</span> <span class="nf">forNumber</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
            <span class="k">return</span> <span class="nc">StudentType</span><span class="o">;</span>
          <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
            <span class="k">return</span> <span class="nc">WorkerType</span><span class="o">;</span>
          <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Internal</span><span class="o">.</span><span class="na">EnumLiteMap</span><span class="o">&lt;</span><span class="nc">DataType</span><span class="o">&gt;</span>
      <span class="nf">internalGetValueMap</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">internalValueMap</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Internal</span><span class="o">.</span><span class="na">EnumLiteMap</span><span class="o">&lt;</span>
        <span class="nc">DataType</span><span class="o">&gt;</span> <span class="n">internalValueMap</span> <span class="o">=</span>
        <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Internal</span><span class="o">.</span><span class="na">EnumLiteMap</span><span class="o">&lt;</span><span class="nc">DataType</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="kd">public</span> <span class="nc">DataType</span> <span class="nf">findValueByNumber</span><span class="o">(</span><span class="kt">int</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">DataType</span><span class="o">.</span><span class="na">forNumber</span><span class="o">(</span><span class="n">number</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">};</span>

      <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">EnumValueDescriptor</span>
      <span class="nf">getValueDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="no">UNRECOGNIZED</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalStateException</span><span class="o">(</span>
            <span class="s">"Can't get the descriptor of an unrecognized enum value."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">getDescriptor</span><span class="o">().</span><span class="na">getValues</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">ordinal</span><span class="o">());</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">EnumDescriptor</span>
      <span class="nf">getDescriptorForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getDescriptor</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">EnumDescriptor</span>
      <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">().</span><span class="na">getEnumTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">DataType</span><span class="o">[]</span> <span class="no">VALUES</span> <span class="o">=</span> <span class="n">values</span><span class="o">();</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="nc">DataType</span> <span class="nf">valueOf</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">EnumValueDescriptor</span> <span class="n">desc</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">desc</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">!=</span> <span class="n">getDescriptor</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalArgumentException</span><span class="o">(</span>
            <span class="s">"EnumValueDescriptor is not for this type."</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">desc</span><span class="o">.</span><span class="na">getIndex</span><span class="o">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="no">UNRECOGNIZED</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="no">VALUES</span><span class="o">[</span><span class="n">desc</span><span class="o">.</span><span class="na">getIndex</span><span class="o">()];</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>

      <span class="kd">private</span> <span class="nf">DataType</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// @@protoc_insertion_point(enum_scope:MyMessage.DataType)</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">dataBody_</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">enum</span> <span class="nc">DataBodyCase</span>
      <span class="kd">implements</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Internal</span><span class="o">.</span><span class="na">EnumLite</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">AbstractMessage</span><span class="o">.</span><span class="na">InternalOneOfEnum</span> <span class="o">{</span>
      <span class="no">STUDENT</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span>
      <span class="no">WORKER</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>
      <span class="no">DATABODY_NOT_SET</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>

      <span class="kd">private</span> <span class="nf">DataBodyCase</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * @param value The number of the enum to look for.
       * @return The enum associated with the given number.
       * @deprecated Use {@link #forNumber(int)} instead.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Deprecated</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="nc">DataBodyCase</span> <span class="nf">valueOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">forNumber</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="nc">DataBodyCase</span> <span class="nf">forNumber</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
            <span class="k">return</span> <span class="no">STUDENT</span><span class="o">;</span>
          <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
            <span class="k">return</span> <span class="no">WORKER</span><span class="o">;</span>
          <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
            <span class="k">return</span> <span class="no">DATABODY_NOT_SET</span><span class="o">;</span>
          <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getNumber</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="o">;</span>

    <span class="kd">public</span> <span class="nc">DataBodyCase</span>
    <span class="nf">getDataBodyCase</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nc">DataBodyCase</span><span class="o">.</span><span class="na">forNumber</span><span class="o">(</span>
        <span class="n">dataBodyCase_</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DATA_TYPE_FIELD_NUMBER</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">dataType_</span><span class="o">;</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * 用 data_type 来标识传的是哪一个枚举类型？
     * &lt;/pre&gt;
     *
     * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;
     *
     * @return The enum numeric value on the wire for dataType.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getDataTypeValue</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dataType_</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * 用 data_type 来标识传的是哪一个枚举类型？
     * &lt;/pre&gt;
     *
     * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;
     *
     * @return The dataType.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span> <span class="nf">getDataType</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"deprecation"</span><span class="o">)</span>
      <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span> <span class="n">result</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">dataType_</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span><span class="o">.</span><span class="na">UNRECOGNIZED</span> <span class="o">:</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">STUDENT_FIELD_NUMBER</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="cm">/**
     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
     *
     * @return Whether the student field is set.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasStudent</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
     *
     * @return The student.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getStudent</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span> <span class="nf">getStudentOrBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">WORKER_FIELD_NUMBER</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>

    <span class="cm">/**
     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
     *
     * @return Whether the worker field is set.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasWorker</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
     *
     * @return The worker.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getWorker</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span> <span class="nf">getWorkerOrBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">byte</span> <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">byte</span> <span class="n">isInitialized</span> <span class="o">=</span> <span class="n">memoizedIsInitialized</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

      <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeTo</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span> <span class="n">output</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataType_</span> <span class="o">!=</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span><span class="o">.</span><span class="na">StudentType</span><span class="o">.</span><span class="na">getNumber</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeEnum</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">dataType_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeMessage</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeMessage</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">unknownFields</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSerializedSize</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">memoizedSize</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span>

      <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataType_</span> <span class="o">!=</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span><span class="o">.</span><span class="na">StudentType</span><span class="o">.</span><span class="na">getNumber</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeEnumSize</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">dataType_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeMessageSize</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeMessageSize</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">size</span> <span class="o">+=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">getSerializedSize</span><span class="o">();</span>
      <span class="n">memoizedSize</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">dataType_</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">dataType_</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getDataBodyCase</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getDataBodyCase</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">switch</span> <span class="o">(</span><span class="n">dataBodyCase_</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">getStudent</span><span class="o">()</span>
            <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getStudent</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">getWorker</span><span class="o">()</span>
            <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getWorker</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
        <span class="k">default</span><span class="o">:</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">unknownFields</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">memoizedHashCode</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">memoizedHashCode</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">41</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">19</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getDescriptor</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="no">DATA_TYPE_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">dataType_</span><span class="o">;</span>
      <span class="k">switch</span> <span class="o">(</span><span class="n">dataBodyCase_</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
          <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="no">STUDENT_FIELD_NUMBER</span><span class="o">;</span>
          <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getStudent</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
          <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="no">WORKER_FIELD_NUMBER</span><span class="o">;</span>
          <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getWorker</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
        <span class="k">default</span><span class="o">:</span>
      <span class="o">}</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">29</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">memoizedHashCode</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">newBuilderForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">newBuilder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Builder</span> <span class="nf">newBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Builder</span> <span class="nf">newBuilder</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">prototype</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">prototype</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">toBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="no">DEFAULT_INSTANCE</span>
        <span class="o">?</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">protected</span> <span class="nc">Builder</span> <span class="nf">newBuilderForType</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Protobuf type {@code MyMessage}
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="kd">extends</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Builder</span><span class="o">&gt;</span> <span class="kd">implements</span>
      <span class="c1">// @@protoc_insertion_point(builder_implements:MyMessage)</span>
      <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessageOrBuilder</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
      <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_MyMessage_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
      <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_MyMessage_fieldAccessorTable</span>
          <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
            <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Construct using com.diguage.truman.netty.protobuf2.MyDataInfo.MyMessage.newBuilder()</span>
      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">maybeForceBuilderInitialization</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">alwaysUseFieldBuilders</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">dataType_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
      <span class="nf">getDescriptorForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_MyMessage_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">result</span> <span class="o">=</span> <span class="n">buildPartial</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">result</span><span class="o">.</span><span class="na">isInitialized</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="nf">newUninitializedMessageException</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">buildPartial</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">dataType_</span> <span class="o">=</span> <span class="n">dataType_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">dataBody_</span> <span class="o">=</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">dataBody_</span> <span class="o">=</span> <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">dataBody_</span> <span class="o">=</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">dataBody_</span> <span class="o">=</span> <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">result</span><span class="o">.</span><span class="na">dataBodyCase_</span> <span class="o">=</span> <span class="n">dataBodyCase_</span><span class="o">;</span>
        <span class="n">onBuilt</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearField</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearOneof</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">OneofDescriptor</span> <span class="n">oneof</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearOneof</span><span class="o">(</span><span class="n">oneof</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setRepeatedField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">addRepeatedField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">addRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Message</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="nf">mergeFrom</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">)</span> <span class="n">other</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">other</span><span class="o">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="o">==</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">dataType_</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setDataTypeValue</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getDataTypeValue</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getDataBodyCase</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nl">STUDENT:</span> <span class="o">{</span>
            <span class="n">mergeStudent</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getStudent</span><span class="o">());</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">case</span> <span class="nl">WORKER:</span> <span class="o">{</span>
            <span class="n">mergeWorker</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getWorker</span><span class="o">());</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">case</span> <span class="nl">DATABODY_NOT_SET:</span> <span class="o">{</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">);</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">parsedMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parsePartialFrom</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">)</span> <span class="n">e</span><span class="o">.</span><span class="na">getUnfinishedMessage</span><span class="o">();</span>
          <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">unwrapIOException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">parsedMessage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mergeFrom</span><span class="o">(</span><span class="n">parsedMessage</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">int</span> <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">dataBody_</span><span class="o">;</span>

      <span class="kd">public</span> <span class="nc">DataBodyCase</span>
      <span class="nf">getDataBodyCase</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">DataBodyCase</span><span class="o">.</span><span class="na">forNumber</span><span class="o">(</span>
          <span class="n">dataBodyCase_</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearDataBody</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>


      <span class="kd">private</span> <span class="kt">int</span> <span class="n">dataType_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 用 data_type 来标识传的是哪一个枚举类型？
       * &lt;/pre&gt;
       *
       * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;
       *
       * @return The enum numeric value on the wire for dataType.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getDataTypeValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dataType_</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 用 data_type 来标识传的是哪一个枚举类型？
       * &lt;/pre&gt;
       *
       * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;
       *
       * @param value The enum numeric value on the wire for dataType to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setDataTypeValue</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">dataType_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 用 data_type 来标识传的是哪一个枚举类型？
       * &lt;/pre&gt;
       *
       * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;
       *
       * @return The dataType.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span> <span class="nf">getDataType</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"deprecation"</span><span class="o">)</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span> <span class="n">result</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">dataType_</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span><span class="o">.</span><span class="na">UNRECOGNIZED</span> <span class="o">:</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 用 data_type 来标识传的是哪一个枚举类型？
       * &lt;/pre&gt;
       *
       * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;
       *
       * @param value The dataType to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setDataType</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">dataType_</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">getNumber</span><span class="o">();</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 用 data_type 来标识传的是哪一个枚举类型？
       * &lt;/pre&gt;
       *
       * &lt;code&gt;.MyMessage.DataType data_type = 1;&lt;/code&gt;
       *
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearDataType</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">dataType_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span><span class="o">&gt;</span> <span class="n">studentBuilder_</span><span class="o">;</span>

      <span class="cm">/**
       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
       *
       * @return Whether the student field is set.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasStudent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
       *
       * @return The student.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getStudent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setStudent</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setStudent</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builderForValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">builderForValue</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">builderForValue</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeStudent</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
            <span class="n">dataBody_</span> <span class="o">!=</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">)</span>
              <span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">value</span><span class="o">).</span><span class="na">buildPartial</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearStudent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">onChanged</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">getStudentBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getStudentFieldBuilder</span><span class="o">().</span><span class="na">getBuilder</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span> <span class="nf">getStudentOrBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">getMessageOrBuilder</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
       */</span>
      <span class="kd">private</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span><span class="o">&gt;</span>
      <span class="nf">getStudentFieldBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(!(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="n">studentBuilder_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
            <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span><span class="o">&gt;(</span>
            <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">,</span>
            <span class="n">getParentForChildren</span><span class="o">(),</span>
            <span class="n">isClean</span><span class="o">());</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">;</span>
        <span class="k">return</span> <span class="n">studentBuilder_</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span><span class="o">&gt;</span> <span class="n">workerBuilder_</span><span class="o">;</span>

      <span class="cm">/**
       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
       *
       * @return Whether the worker field is set.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasWorker</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
       *
       * @return The worker.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getWorker</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setWorker</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setWorker</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builderForValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">builderForValue</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">builderForValue</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeWorker</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
            <span class="n">dataBody_</span> <span class="o">!=</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">)</span>
              <span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">value</span><span class="o">).</span><span class="na">buildPartial</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearWorker</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">onChanged</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
       */</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">getWorkerBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">getWorkerFieldBuilder</span><span class="o">().</span><span class="na">getBuilder</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span> <span class="nf">getWorkerOrBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">getMessageOrBuilder</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
       */</span>
      <span class="kd">private</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span><span class="o">&gt;</span>
      <span class="nf">getWorkerFieldBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(!(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="mi">3</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="n">workerBuilder_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
            <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span><span class="o">&gt;(</span>
            <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">,</span>
            <span class="n">getParentForChildren</span><span class="o">(),</span>
            <span class="n">isClean</span><span class="o">());</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">;</span>
        <span class="k">return</span> <span class="n">workerBuilder_</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Builder</span> <span class="nf">setUnknownFields</span><span class="o">(</span>
        <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Builder</span> <span class="nf">mergeUnknownFields</span><span class="o">(</span>
        <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>


      <span class="c1">// @@protoc_insertion_point(builder_scope:MyMessage)</span>
    <span class="o">}</span>

    <span class="c1">// @@protoc_insertion_point(class_scope:MyMessage)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
      <span class="no">DEFAULT_INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">getDefaultInstance</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">MyMessage</span><span class="o">&gt;</span>
      <span class="no">PARSER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">AbstractParser</span><span class="o">&lt;</span><span class="nc">MyMessage</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">MyMessage</span> <span class="nf">parsePartialFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">MyMessage</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">MyMessage</span><span class="o">&gt;</span> <span class="nf">parser</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">MyMessage</span><span class="o">&gt;</span> <span class="nf">getParserForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StudentOrBuilder</span> <span class="kd">extends</span>
    <span class="c1">// @@protoc_insertion_point(interface_extends:Student)</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">MessageOrBuilder</span> <span class="o">{</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值
     * &lt;/pre&gt;
     *
     * &lt;code&gt;int32 id = 1;&lt;/code&gt;
     *
     * @return The id.
     */</span>
    <span class="kt">int</span> <span class="nf">getId</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 2;&lt;/code&gt;
     *
     * @return The name.
     */</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 2;&lt;/code&gt;
     *
     * @return The bytes for name.
     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
    <span class="nf">getNameBytes</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="cm">/**
   * &lt;pre&gt;
   * 会在 StudentPOJO 外部类生成一个内部类 Student，
   * &lt;/pre&gt;
   * &lt;p&gt;
   * Protobuf type {@code Student}
   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="kd">extends</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span> <span class="kd">implements</span>
    <span class="c1">// @@protoc_insertion_point(message_implements:Student)</span>
    <span class="nc">StudentOrBuilder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>

    <span class="c1">// Use Student.newBuilder() to construct.</span>
    <span class="kd">private</span> <span class="nf">Student</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">Student</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">name_</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">"unused"</span><span class="o">})</span>
    <span class="kd">protected</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="nf">newInstance</span><span class="o">(</span>
      <span class="nc">UnusedPrivateParameter</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">Student</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span>
    <span class="nf">getUnknownFields</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">Student</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">extensionRegistry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NullPointerException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">unknownFields</span> <span class="o">=</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readTag</span><span class="o">();</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
              <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="mi">8</span><span class="o">:</span> <span class="o">{</span>

              <span class="n">id_</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readInt32</span><span class="o">();</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="mi">18</span><span class="o">:</span> <span class="o">{</span>
              <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readStringRequireUtf8</span><span class="o">();</span>

              <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">default</span><span class="o">:</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">parseUnknownField</span><span class="o">(</span>
                <span class="n">input</span><span class="o">,</span> <span class="n">unknownFields</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">,</span> <span class="n">tag</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="o">}</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span><span class="o">(</span>
          <span class="n">e</span><span class="o">).</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span> <span class="o">=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">makeExtensionsImmutable</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
    <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Student_fieldAccessorTable</span>
        <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">ID_FIELD_NUMBER</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id_</span><span class="o">;</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值
     * &lt;/pre&gt;
     *
     * &lt;code&gt;int32 id = 1;&lt;/code&gt;
     *
     * @return The id.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">id_</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">NAME_FIELD_NUMBER</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span><span class="o">;</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 2;&lt;/code&gt;
     *
     * @return The name.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span>
          <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 2;&lt;/code&gt;
     *
     * @return The bytes for name.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
    <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
            <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">byte</span> <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">byte</span> <span class="n">isInitialized</span> <span class="o">=</span> <span class="n">memoizedIsInitialized</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

      <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeTo</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span> <span class="n">output</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">id_</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeInt32</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">id_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">unknownFields</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSerializedSize</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">memoizedSize</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span>

      <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">id_</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeInt32Size</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">id_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">computeStringSize</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">size</span> <span class="o">+=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">getSerializedSize</span><span class="o">();</span>
      <span class="n">memoizedSize</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">getId</span><span class="o">()</span>
        <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getName</span><span class="o">()</span>
        <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">unknownFields</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">memoizedHashCode</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">memoizedHashCode</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">41</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">19</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getDescriptor</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="no">ID_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getId</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="no">NAME_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getName</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">29</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">memoizedHashCode</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">newBuilderForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">newBuilder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Builder</span> <span class="nf">newBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Builder</span> <span class="nf">newBuilder</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">prototype</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">prototype</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">toBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="no">DEFAULT_INSTANCE</span>
        <span class="o">?</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">protected</span> <span class="nc">Builder</span> <span class="nf">newBuilderForType</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;pre&gt;
     * 会在 StudentPOJO 外部类生成一个内部类 Student，
     * &lt;/pre&gt;
     * &lt;p&gt;
     * Protobuf type {@code Student}
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="kd">extends</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Builder</span><span class="o">&gt;</span> <span class="kd">implements</span>
      <span class="c1">// @@protoc_insertion_point(builder_implements:Student)</span>
      <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
      <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
      <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Student_fieldAccessorTable</span>
          <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
            <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Construct using com.diguage.truman.netty.protobuf2.MyDataInfo.Student.newBuilder()</span>
      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">maybeForceBuilderInitialization</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">alwaysUseFieldBuilders</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
      <span class="nf">getDescriptorForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">result</span> <span class="o">=</span> <span class="n">buildPartial</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">result</span><span class="o">.</span><span class="na">isInitialized</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="nf">newUninitializedMessageException</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">buildPartial</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">id_</span> <span class="o">=</span> <span class="n">id_</span><span class="o">;</span>
        <span class="n">result</span><span class="o">.</span><span class="na">name_</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="n">onBuilt</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearField</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearOneof</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">OneofDescriptor</span> <span class="n">oneof</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearOneof</span><span class="o">(</span><span class="n">oneof</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setRepeatedField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">addRepeatedField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">addRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Message</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="nf">mergeFrom</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">other</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">other</span><span class="o">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="o">==</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setId</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="na">name_</span><span class="o">;</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">);</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">parsedMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parsePartialFrom</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">e</span><span class="o">.</span><span class="na">getUnfinishedMessage</span><span class="o">();</span>
          <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">unwrapIOException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">parsedMessage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mergeFrom</span><span class="o">(</span><span class="n">parsedMessage</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">int</span> <span class="n">id_</span><span class="o">;</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值
       * &lt;/pre&gt;
       *
       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
       *
       * @return The id.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id_</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值
       * &lt;/pre&gt;
       *
       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
       *
       * @param value The id to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">id_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;pre&gt;
       * 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值
       * &lt;/pre&gt;
       *
       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
       *
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearId</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">id_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 2;&lt;/code&gt;
       *
       * @return The name.
       */</span>
      <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span>
            <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 2;&lt;/code&gt;
       *
       * @return The bytes for name.
       */</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
      <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="nc">String</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span>
            <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
              <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 2;&lt;/code&gt;
       *
       * @param value The name to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setName</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 2;&lt;/code&gt;
       *
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearName</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="n">getDefaultInstance</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 2;&lt;/code&gt;
       *
       * @param value The bytes for name to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setNameBytes</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">checkByteStringIsUtf8</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Builder</span> <span class="nf">setUnknownFields</span><span class="o">(</span>
        <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Builder</span> <span class="nf">mergeUnknownFields</span><span class="o">(</span>
        <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>


      <span class="c1">// @@protoc_insertion_point(builder_scope:Student)</span>
    <span class="o">}</span>

    <span class="c1">// @@protoc_insertion_point(class_scope:Student)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
      <span class="no">DEFAULT_INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstance</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span>
      <span class="no">PARSER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">AbstractParser</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Student</span> <span class="nf">parsePartialFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Student</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">parser</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">Student</span><span class="o">&gt;</span> <span class="nf">getParserForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">WorkerOrBuilder</span> <span class="kd">extends</span>
    <span class="c1">// @@protoc_insertion_point(interface_extends:Worker)</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">MessageOrBuilder</span> <span class="o">{</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 1;&lt;/code&gt;
     *
     * @return The name.
     */</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 1;&lt;/code&gt;
     *
     * @return The bytes for name.
     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
    <span class="nf">getNameBytes</span><span class="o">();</span>

    <span class="cm">/**
     * &lt;code&gt;int32 age = 2;&lt;/code&gt;
     *
     * @return The age.
     */</span>
    <span class="kt">int</span> <span class="nf">getAge</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Protobuf type {@code Worker}
   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span> <span class="kd">implements</span>
    <span class="c1">// @@protoc_insertion_point(message_implements:Worker)</span>
    <span class="nc">WorkerOrBuilder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>

    <span class="c1">// Use Worker.newBuilder() to construct.</span>
    <span class="kd">private</span> <span class="nf">Worker</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">Worker</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">name_</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">"unused"</span><span class="o">})</span>
    <span class="kd">protected</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="nf">newInstance</span><span class="o">(</span>
      <span class="nc">UnusedPrivateParameter</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">Worker</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span>
    <span class="nf">getUnknownFields</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">Worker</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">extensionRegistry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NullPointerException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">unknownFields</span> <span class="o">=</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readTag</span><span class="o">();</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
              <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="mi">10</span><span class="o">:</span> <span class="o">{</span>
              <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readStringRequireUtf8</span><span class="o">();</span>

              <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="mi">16</span><span class="o">:</span> <span class="o">{</span>

              <span class="n">age_</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readInt32</span><span class="o">();</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">default</span><span class="o">:</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">parseUnknownField</span><span class="o">(</span>
                <span class="n">input</span><span class="o">,</span> <span class="n">unknownFields</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">,</span> <span class="n">tag</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="o">}</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span><span class="o">(</span>
          <span class="n">e</span><span class="o">).</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span> <span class="o">=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">makeExtensionsImmutable</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Worker_descriptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
    <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Worker_fieldAccessorTable</span>
        <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">NAME_FIELD_NUMBER</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span><span class="o">;</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 1;&lt;/code&gt;
     *
     * @return The name.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span>
          <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * &lt;code&gt;string name = 1;&lt;/code&gt;
     *
     * @return The bytes for name.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
    <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
            <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">AGE_FIELD_NUMBER</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age_</span><span class="o">;</span>

    <span class="cm">/**
     * &lt;code&gt;int32 age = 2;&lt;/code&gt;
     *
     * @return The age.
     */</span>
    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">age_</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">byte</span> <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">byte</span> <span class="n">isInitialized</span> <span class="o">=</span> <span class="n">memoizedIsInitialized</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

      <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeTo</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span> <span class="n">output</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">age_</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeInt32</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">age_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">unknownFields</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSerializedSize</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">memoizedSize</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span>

      <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">computeStringSize</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">age_</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeInt32Size</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">age_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">size</span> <span class="o">+=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">getSerializedSize</span><span class="o">();</span>
      <span class="n">memoizedSize</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(!</span><span class="n">getName</span><span class="o">()</span>
        <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">getAge</span><span class="o">()</span>
        <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">getAge</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">unknownFields</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">memoizedHashCode</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">memoizedHashCode</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="mi">41</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">19</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getDescriptor</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="no">NAME_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getName</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="no">AGE_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getAge</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="mi">29</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">memoizedHashCode</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span>
      <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
        <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="no">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">newBuilderForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">newBuilder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Builder</span> <span class="nf">newBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Builder</span> <span class="nf">newBuilder</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">prototype</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">prototype</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">toBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="no">DEFAULT_INSTANCE</span>
        <span class="o">?</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">protected</span> <span class="nc">Builder</span> <span class="nf">newBuilderForType</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Builder</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Protobuf type {@code Worker}
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="kd">extends</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="nc">Builder</span><span class="o">&gt;</span> <span class="kd">implements</span>
      <span class="c1">// @@protoc_insertion_point(builder_implements:Worker)</span>
      <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
      <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Worker_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
      <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Worker_fieldAccessorTable</span>
          <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
            <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Construct using com.diguage.truman.netty.protobuf2.MyDataInfo.Worker.newBuilder()</span>
      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">maybeForceBuilderInitialization</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">alwaysUseFieldBuilders</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

        <span class="n">age_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
      <span class="nf">getDescriptorForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Worker_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">result</span> <span class="o">=</span> <span class="n">buildPartial</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">result</span><span class="o">.</span><span class="na">isInitialized</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="nf">newUninitializedMessageException</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">buildPartial</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">name_</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="n">result</span><span class="o">.</span><span class="na">age_</span> <span class="o">=</span> <span class="n">age_</span><span class="o">;</span>
        <span class="n">onBuilt</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearField</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearOneof</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">OneofDescriptor</span> <span class="n">oneof</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearOneof</span><span class="o">(</span><span class="n">oneof</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setRepeatedField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">addRepeatedField</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">addRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Message</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="nf">mergeFrom</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">other</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">other</span><span class="o">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="o">==</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="na">name_</span><span class="o">;</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setAge</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">);</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">parsedMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="no">PARSER</span><span class="o">.</span><span class="na">parsePartialFrom</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">e</span><span class="o">.</span><span class="na">getUnfinishedMessage</span><span class="o">();</span>
          <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">unwrapIOException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">parsedMessage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mergeFrom</span><span class="o">(</span><span class="n">parsedMessage</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 1;&lt;/code&gt;
       *
       * @return The name.
       */</span>
      <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span>
            <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 1;&lt;/code&gt;
       *
       * @return The bytes for name.
       */</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
      <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="nc">String</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span>
            <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
              <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 1;&lt;/code&gt;
       *
       * @param value The name to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setName</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 1;&lt;/code&gt;
       *
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearName</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="n">getDefaultInstance</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;string name = 1;&lt;/code&gt;
       *
       * @param value The bytes for name to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setNameBytes</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">checkByteStringIsUtf8</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">int</span> <span class="n">age_</span><span class="o">;</span>

      <span class="cm">/**
       * &lt;code&gt;int32 age = 2;&lt;/code&gt;
       *
       * @return The age.
       */</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">age_</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;int32 age = 2;&lt;/code&gt;
       *
       * @param value The age to set.
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">setAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">age_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
       * &lt;code&gt;int32 age = 2;&lt;/code&gt;
       *
       * @return This builder for chaining.
       */</span>
      <span class="kd">public</span> <span class="nc">Builder</span> <span class="nf">clearAge</span><span class="o">()</span> <span class="o">{</span>

        <span class="n">age_</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Builder</span> <span class="nf">setUnknownFields</span><span class="o">(</span>
        <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="nc">Builder</span> <span class="nf">mergeUnknownFields</span><span class="o">(</span>
        <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>


      <span class="c1">// @@protoc_insertion_point(builder_scope:Worker)</span>
    <span class="o">}</span>

    <span class="c1">// @@protoc_insertion_point(class_scope:Worker)</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
      <span class="no">DEFAULT_INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getDefaultInstance</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span>
      <span class="no">PARSER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">AbstractParser</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
      <span class="kd">public</span> <span class="nc">Worker</span> <span class="nf">parsePartialFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Worker</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span> <span class="nf">parser</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="nc">Worker</span><span class="o">&gt;</span> <span class="nf">getParserForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">diguage</span><span class="o">.</span><span class="na">truman</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">protobuf2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="no">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="n">internal_static_MyMessage_descriptor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span>
  <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
    <span class="n">internal_static_MyMessage_fieldAccessorTable</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="n">internal_static_Student_descriptor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span>
  <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
    <span class="n">internal_static_Student_fieldAccessorTable</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="n">internal_static_Worker_descriptor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span>
  <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
    <span class="n">internal_static_Worker_fieldAccessorTable</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
  <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">descriptor</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
    <span class="n">descriptor</span><span class="o">;</span>

  <span class="kd">static</span> <span class="o">{</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]</span> <span class="n">descriptorData</span> <span class="o">=</span> <span class="o">{</span>
      <span class="s">"\n\rStudent.proto\"\244\001\n\tMyMessage\022&amp;\n\tdata_ty"</span> <span class="o">+</span>
        <span class="s">"pe\030\001 \001(\0162\023.MyMessage.DataType\022\033\n\007student"</span> <span class="o">+</span>
        <span class="s">"\030\002 \001(\0132\010.StudentH\000\022\031\n\006worker\030\003 \001(\0132\007.Wor"</span> <span class="o">+</span>
        <span class="s">"kerH\000\"+\n\010DataType\022\017\n\013StudentType\020\000\022\016\n\nWo"</span> <span class="o">+</span>
        <span class="s">"rkerType\020\001B\n\n\010dataBody\"#\n\007Student\022\n\n\002id\030"</span> <span class="o">+</span>
        <span class="s">"\001 \001(\005\022\014\n\004name\030\002 \001(\t\"#\n\006Worker\022\014\n\004name\030\001 "</span> <span class="o">+</span>
        <span class="s">"\001(\t\022\013\n\003age\030\002 \001(\005B2\n\"com.diguage.truman.n"</span> <span class="o">+</span>
        <span class="s">"etty.protobuf2B\nMyDataInfoH\001b\006proto3"</span>
    <span class="o">};</span>
    <span class="n">descriptor</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
      <span class="o">.</span><span class="na">internalBuildGeneratedFileFrom</span><span class="o">(</span><span class="n">descriptorData</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span><span class="o">[]{</span>
        <span class="o">});</span>
    <span class="n">internal_static_MyMessage_descriptor</span> <span class="o">=</span>
      <span class="n">getDescriptor</span><span class="o">().</span><span class="na">getMessageTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">internal_static_MyMessage_fieldAccessorTable</span> <span class="o">=</span> <span class="k">new</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span><span class="o">(</span>
      <span class="n">internal_static_MyMessage_descriptor</span><span class="o">,</span>
      <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]{</span><span class="s">"DataType"</span><span class="o">,</span> <span class="s">"Student"</span><span class="o">,</span> <span class="s">"Worker"</span><span class="o">,</span> <span class="s">"DataBody"</span><span class="o">,});</span>
    <span class="n">internal_static_Student_descriptor</span> <span class="o">=</span>
      <span class="n">getDescriptor</span><span class="o">().</span><span class="na">getMessageTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">internal_static_Student_fieldAccessorTable</span> <span class="o">=</span> <span class="k">new</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span><span class="o">(</span>
      <span class="n">internal_static_Student_descriptor</span><span class="o">,</span>
      <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]{</span><span class="s">"Id"</span><span class="o">,</span> <span class="s">"Name"</span><span class="o">,});</span>
    <span class="n">internal_static_Worker_descriptor</span> <span class="o">=</span>
      <span class="n">getDescriptor</span><span class="o">().</span><span class="na">getMessageTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="n">internal_static_Worker_fieldAccessorTable</span> <span class="o">=</span> <span class="k">new</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span><span class="o">(</span>
      <span class="n">internal_static_Worker_descriptor</span><span class="o">,</span>
      <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]{</span><span class="s">"Name"</span><span class="o">,</span> <span class="s">"Age"</span><span class="o">,});</span>
  <span class="o">}</span>

  <span class="c1">// @@protoc_insertion_point(outer_class_scope)</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.protobuf2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.protobuf.ProtobufEncoder</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 19:35
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProtobufClient2</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// 客户端只需要一个事件循环组即可</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 创建客户端启动对象</span>
      <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
      <span class="c1">// 设置相关参数</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span> <span class="c1">// 设置线程组</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 设置客户端通讯通道的实现类</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="c1">// 加入 protobuf handler</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"encoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufEncoder</span><span class="o">());</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ClientHandler</span><span class="o">());</span> <span class="c1">// 加入自己的处理器</span>
          <span class="o">}</span>
        <span class="o">});</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"....客户端 OK ..."</span><span class="o">);</span>

      <span class="c1">// 启动客户端去连接服务器端</span>
      <span class="c1">// 关于 ChannelFuture 还要分析，涉及到 Netty 的异步模型</span>
      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

      <span class="c1">// 给关闭通道进行监听</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.protobuf2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.diguage.truman.netty.protobuf.StudentPOJO</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.protobuf.ProtobufDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 16:02
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProtobufServer2</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span> <span class="c1">// 在 bossGroup 增加一个日志处理器</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">"decoder"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ProtobufDecoder</span><span class="o">(</span><span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">()));</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ServerHandler</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span>

      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.protobuf2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * 说明：
 * 我们自定义一个 Handler 需要继承 netty 规定好的某个 HandlerAdapter
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-27 18:54
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="cm">/**
   * 读取数据实际（这里我们可以读取客户端发送的消息）
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span> <span class="n">dataType</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getDataType</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">dataType</span> <span class="o">==</span> <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span><span class="o">.</span><span class="na">StudentType</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getStudent</span><span class="o">();</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"学生 id="</span> <span class="o">+</span> <span class="n">student</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">", name="</span> <span class="o">+</span> <span class="n">student</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">dataType</span> <span class="o">==</span> <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataType</span><span class="o">.</span><span class="na">WorkerType</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getWorker</span><span class="o">();</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"工人 name="</span> <span class="o">+</span> <span class="n">worker</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">", age="</span> <span class="o">+</span> <span class="n">worker</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"传输类型不正确！"</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 数据读取完毕
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 将数据写入到缓存，并刷新</span>
    <span class="c1">// 一般讲，我们对这个发送的数据进行编码</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"Hello, D瓜哥~, pong -&gt; O(∩_∩)O哈哈~"</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 处理异常，一般需要关闭通道
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="n">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="o">;</span> <span class="c1">// 版本号</span>
<span class="n">option</span> <span class="n">optimize_for</span> <span class="o">=</span> <span class="no">SPEED</span><span class="o">;</span>
<span class="n">option</span> <span class="n">java_package</span> <span class="o">=</span> <span class="s">"com.diguage.truman.netty.protobuf2"</span><span class="o">;</span>

<span class="n">option</span> <span class="n">java_outer_classname</span> <span class="o">=</span> <span class="s">"MyDataInfo"</span><span class="o">;</span> <span class="c1">// 生成的外部类名，同时也是文件名</span>

<span class="c1">// protobuf 使用 message 管理数据</span>
<span class="c1">// protobuf 可以使用 message 管理其他的 message</span>

<span class="n">message</span> <span class="nc">MyMessage</span> <span class="o">{</span>
    <span class="c1">// 定义一个枚举</span>
    <span class="kd">enum</span> <span class="nc">DataType</span> <span class="o">{</span>
        <span class="nc">StudentType</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="c1">// 在 proto3 中，要求 enum 的编号从 0 开始</span>
        <span class="nc">WorkerType</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 用 data_type 来标识传的是哪一个枚举类型？</span>
    <span class="nc">DataType</span> <span class="n">data_type</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

    <span class="c1">// 表示每次枚举类型最多只能出现其中的一个，节省空间</span>
    <span class="n">oneof</span> <span class="n">dataBody</span> <span class="o">{</span>
        <span class="nc">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="nc">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1">// 会在 StudentPOJO 外部类生成一个内部类 Student，</span>
<span class="n">message</span> <span class="nc">Student</span> <span class="o">{</span>
    <span class="n">int32</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">// 在 Student 类中有一个属性名称为 id 类型为 int32，1表示属性序号，不是值</span>
    <span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">message</span> <span class="nc">Worker</span> <span class="o">{</span>
    <span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="n">int32</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
<span class="o">}</span>

<span class="c1">// 在这个文件所在目录执行如下命令，生成Java类：</span>
<span class="c1">// protoc --java_out=. Student.proto</span>
<span class="c1">// WARNING: 需要给生成的类，加上 package 名。</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:57
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcpClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// 客户端只需要一个事件循环组即可</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 创建客户端启动对象</span>
      <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
      <span class="c1">// 设置相关参数</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span> <span class="c1">// 设置线程组</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 设置客户端通讯通道的实现类</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">TcpClientInitializer</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"....客户端 OK ..."</span><span class="o">);</span>

      <span class="c1">// 启动客户端去连接服务器端</span>
      <span class="c1">// 关于 ChannelFuture 还要分析，涉及到 Netty 的异步模型</span>
      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

      <span class="c1">// 给关闭通道进行监听</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 20:05
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcpClientHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">ByteBuf</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">msg</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()];</span>
    <span class="n">msg</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端接收到消息="</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端接收到消息量="</span> <span class="o">+</span> <span class="o">(++</span><span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 使用客户端发送10条数据</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">"Hello，D瓜哥！~~"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">);</span>
      <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 20:00
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcpClientInitializer</span> <span class="kd">extends</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">TcpClientHandler</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.diguage.truman.netty.iobound.IoServerInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:46
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcpServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span> <span class="c1">// 在 bossGroup 增加一个日志处理器</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">TcpServerInitializer</span><span class="o">());</span>

      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 10:42
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcpServerHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">ByteBuf</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">msg</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()];</span>
    <span class="n">msg</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>

    <span class="c1">// 将 bytes 转成字符串</span>
    <span class="nc">String</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器接收到数据="</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器接收到消息量="</span> <span class="o">+</span> <span class="o">(++</span><span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>

    <span class="c1">// 服务器回送数据给客户端，回送一个随机ID</span>
    <span class="nc">ByteBuf</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">"  "</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">);</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:47
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcpServerInitializer</span> <span class="kd">extends</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">TcpServerHandler</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcprotocol</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.ReplayingDecoder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 11:18
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageDecoder</span> <span class="kd">extends</span> <span class="nc">ReplayingDecoder</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n\nMessageDecoder decode 被调用"</span><span class="o">);</span>
    <span class="c1">// 需要将得到的二进制字节码 -&gt; MessageProtocol 数据包</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">len</span><span class="o">];</span>
    <span class="n">in</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
    <span class="c1">// 封装成 MessageProtocol 对象，放入out，传递给下一个 handler 业务处理</span>
    <span class="nc">MessageProtocol</span> <span class="n">msp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageProtocol</span><span class="o">();</span>
    <span class="n">msp</span><span class="o">.</span><span class="na">setLen</span><span class="o">(</span><span class="n">len</span><span class="o">);</span>
    <span class="n">msp</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
    <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">msp</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcprotocol</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.MessageToByteEncoder</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 11:15
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageEncoder</span> <span class="kd">extends</span> <span class="nc">MessageToByteEncoder</span><span class="o">&lt;</span><span class="nc">MessageProtocol</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">MessageProtocol</span> <span class="n">msg</span><span class="o">,</span> <span class="nc">ByteBuf</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"MessageEncoder encode 方法被调用"</span><span class="o">);</span>
    <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getLen</span><span class="o">());</span>
    <span class="n">out</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getContent</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcprotocol</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 11:09
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageProtocol</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">len</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getLen</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">len</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLen</span><span class="o">(</span><span class="kt">int</span> <span class="n">len</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">len</span> <span class="o">=</span> <span class="n">len</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getContent</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">content</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContent</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcprotocol</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 20:05
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcpClientHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">MessageProtocol</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">MessageProtocol</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 接收到数据，并处理</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getLen</span><span class="o">();</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端接收到信息如下："</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"长度="</span> <span class="o">+</span> <span class="n">len</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"消息="</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端接收到消息包数量="</span> <span class="o">+</span> <span class="o">(++</span><span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 使用客户端发送10条数据</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello，D瓜哥！~~"</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span>
      <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="no">UTF_8</span><span class="o">);</span>
      <span class="c1">// 创建协议包</span>
      <span class="nc">MessageProtocol</span> <span class="n">msp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageProtocol</span><span class="o">();</span>
      <span class="n">msp</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
      <span class="n">msp</span><span class="o">.</span><span class="na">setLen</span><span class="o">(</span><span class="n">content</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>

      <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">msp</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcprotocol</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 20:00
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcpClientInitializer</span> <span class="kd">extends</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageEncoder</span><span class="o">());</span><span class="c1">// TODO 必须放在 handler 上面吗？</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageDecoder</span><span class="o">());</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">TcpClientHandler</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcprotocol</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">charset</span><span class="o">.</span><span class="na">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-29 10:42
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcpServerHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">MessageProtocol</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">MessageProtocol</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">// 接收到数据，并处理</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getLen</span><span class="o">();</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器接收到信息如下："</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"长度="</span> <span class="o">+</span> <span class="n">len</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"消息="</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="no">UTF_8</span><span class="o">));</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器接收到消息包数量="</span> <span class="o">+</span> <span class="o">(++</span><span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>

    <span class="nc">String</span> <span class="n">responseContent</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">responseContentBytes</span> <span class="o">=</span> <span class="n">responseContent</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="no">UTF_8</span><span class="o">);</span>
    <span class="nc">MessageProtocol</span> <span class="n">messageProtocol</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageProtocol</span><span class="o">();</span>
    <span class="n">messageProtocol</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">responseContentBytes</span><span class="o">);</span>
    <span class="n">messageProtocol</span><span class="o">.</span><span class="na">setLen</span><span class="o">(</span><span class="n">responseContentBytes</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>

    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">messageProtocol</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcprotocol</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:47
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcpServerInitializer</span> <span class="kd">extends</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageDecoder</span><span class="o">());</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageEncoder</span><span class="o">());</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">TcpServerHandler</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcprotocol</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:57
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcprotocolClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="c1">// 客户端只需要一个事件循环组即可</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="c1">// 创建客户端启动对象</span>
      <span class="nc">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bootstrap</span><span class="o">();</span>
      <span class="c1">// 设置相关参数</span>
      <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span> <span class="c1">// 设置线程组</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 设置客户端通讯通道的实现类</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">TcpClientInitializer</span><span class="o">());</span>
      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"....客户端 OK ..."</span><span class="o">);</span>

      <span class="c1">// 启动客户端去连接服务器端</span>
      <span class="c1">// 关于 ChannelFuture 还要分析，涉及到 Netty 的异步模型</span>
      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

      <span class="c1">// 给关闭通道进行监听</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.tcprotocol</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 19:46
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TcprotocolServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="nc">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="mi">128</span><span class="o">)</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span> <span class="c1">// 在 bossGroup 增加一个日志处理器</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">TcpServerInitializer</span><span class="o">());</span>

      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.ws</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpObjectAggregator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpServerCodec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.stream.ChunkedWriteHandler</span><span class="o">;</span>

<span class="cm">/**
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 14:56
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="nc">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NioEventLoopGroup</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerBootstrap</span><span class="o">();</span>
      <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
        <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="nc">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nc">LoggingHandler</span><span class="o">(</span><span class="nc">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span> <span class="c1">// 在 bossGroup 增加一个日志处理器</span>
        <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelInitializer</span><span class="o">&lt;</span><span class="nc">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="nc">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
            <span class="c1">// 因为基于 HTTP 协议，使用 HTTP 的编解码器</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">HttpServerCodec</span><span class="o">());</span>
            <span class="c1">// 是以块方法写，加 ChunkedWriteHandler 处理器</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChunkedWriteHandler</span><span class="o">());</span>
            <span class="cm">/**
             * 说明
             * 1. HTTP 数据在传输过程中是分段的，HttpObjectAggregator 就可以将多个段聚合
             * 2. 这就是为什么，当浏览器发送大量数据时，就会发出多次 HTTP 请求
             */</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">HttpObjectAggregator</span><span class="o">(</span><span class="mi">8192</span><span class="o">));</span>
            <span class="cm">/**
             * 说明
             * 1. 对应 WebSocket，它的数据是以帧(frame)形式传递
             * 2. 可以看到 WebSocketFrame 下面有六个子类
             * 3. 浏览器请求时： ws://localhost:11911/hello
             * 4. WebSocketServerProtocolHandler 核心功能是将 HTTP 协议升级为 WS 协议，保持长连接
             *    这一点可以观察浏览器的链接信息，可以看到协议升级的过程。
             */</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">WebSocketServerProtocolHandler</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">));</span>

            <span class="c1">// 自定义 Handler，处理业务逻辑</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nc">TextWebSocketFrameHandler</span><span class="o">());</span>
          <span class="o">}</span>
        <span class="o">});</span>

      <span class="nc">ChannelFuture</span> <span class="n">future</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">11911</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
      <span class="n">future</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
      <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="java"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="code"><pre><span class="kn">package</span> <span class="nn">com.diguage.truman.netty.ws</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.websocketx.TextWebSocketFrame</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>

<span class="cm">/**
 * TextWebSocketFrame 类型，表示一个文本帧
 *
 * @author D瓜哥, https://www.diguage.com/
 * @since 2020-06-28 15:05
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TextWebSocketFrameHandler</span> <span class="kd">extends</span> <span class="nc">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="nc">TextWebSocketFrame</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">TextWebSocketFrame</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器收到消息："</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">text</span><span class="o">());</span>
    <span class="c1">// 回复消息</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="nc">TextWebSocketFrame</span><span class="o">(</span><span class="s">"服务器时间："</span>
      <span class="o">+</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">text</span><span class="o">()));</span>
  <span class="o">}</span>

  <span class="cm">/**
   * 当 Web 客户端连接后，出发方法
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"handlerAdded 被调用"</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">id</span><span class="o">().</span><span class="na">asLongText</span><span class="o">());</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"handlerAdded 被调用"</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">id</span><span class="o">().</span><span class="na">asShortText</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerRemoved</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"handlerRemoved 被调用"</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">id</span><span class="o">().</span><span class="na">asLongText</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="nc">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"发生异常："</span> <span class="o">+</span> <span class="n">cause</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="html"><table class="linenotable"><tbody><tr><td class="linenos gl"><pre class="lineno"> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Title<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"application/javascript"</span><span class="nt">&gt;</span>
    <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="dl">"</span><span class="s2">ws://localhost:11911/hello</span><span class="dl">"</span><span class="p">)</span>
        <span class="c1">// 相当于 channel Read0，event 收到服务器回送的消息</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ele</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">responseText</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">ele</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">ele</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
        <span class="p">};</span>
        <span class="c1">// 连接开启</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">ele</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">responseText</span><span class="dl">"</span><span class="p">);</span>
            <span class="nx">ele</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">连接开启了...</span><span class="dl">"</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">当前浏览器不支持 WebSocket</span><span class="dl">"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">连接未开启！</span><span class="dl">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;form</span> <span class="na">onsubmit=</span><span class="s">"return false"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"message"</span> <span class="na">style=</span><span class="s">"height: 300px;width: 300px;"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">value=</span><span class="s">"发送消息"</span> <span class="na">onclick=</span><span class="s">"send(this.form.message.value)"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">id=</span><span class="s">"responseText"</span> <span class="na">style=</span><span class="s">"height: 300px;width: 300px;"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">value=</span><span class="s">"清空消息"</span> <span class="na">onclick=</span><span class="s">"document.getElementById('responseText').value=''"</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></td></tr></tbody></table></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-07-18 16:15:11 UTC
</div>
</div>
</body>
</html>